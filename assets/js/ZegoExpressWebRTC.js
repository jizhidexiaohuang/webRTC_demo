!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("zego-express-engine-webrtm"));else if("function"==typeof define&&define.amd)define(["zego-express-engine-webrtm"],t);else{var r="object"==typeof exports?t(require("zego-express-engine-webrtm")):t(e["zego-express-engine-webrtm"]);for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}("undefined"!=typeof self?self:this,(function(e){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(i,o,function(t){return e[t]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=10)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoDataReport=t.ZegoLogger=t.ZegoExpressWebRTMEngine=t.getReportSeq=t.getSeq=t.QUALITY_CONSTANT=t.QualityGrade=t.REPORT_ACTION=t.ENUM_RETRY_STATE=t.ENUM_PLAY_STATE_UPDATE=t.ENUM_PUBLISH_STATE_UPDATE=t.LinkedList=t.ListNode=t.E_CLIENT_TYPE=t.ENUM_SOURCE_TYPE=t.ENUM_DISPATCH_TYPE=t.ENUM_BROADCASTER_STATUS=t.ENUM_PLAY_SOURCE_TYPE=t.ENUM_PUBLISH_STATE_NEGO=t.ENUM_PUSH_SIGNAL_SUB_CMD=t.ENUM_SIGNAL_SUB_CMD=t.QUALITYLEVEL=t.MIXSTREAM_ERROR_CODE=t.SERVER_ERROR_CODE=t.ENUM_STREAM_UPDATE_CMD=t.MINIUM_HEARTBEAT_INTERVAL=t.STREAM_DELETE_REASON=t.ENUM_NETWORK_STATE=t.ENUM_RUN_STATE=t.ENUM_STREAM_UPDATE_TYPE=t.ENUM_STREAM_SUB_CMD=t.ENUM_PUBLISH_STREAM_STATE=t.MAX_RETRY_CONNECT_INTERVAL=t.MAX_TRANS_DATA_LENGTH=t.MAX_TRANS_TYPE_LENGTH=t.MAX_MIX_TASK_ID_LENGTH=t.MAX_MESSAGE_LENGTH=t.MAX_ROOM_ID_LENGTH=t.MAX_USER_NAME_LENGTH=t.MAX_USER_ID_LENGTH=t.MAX_STREAM_ID_LENGTH=t.MAX_TRY_HEARTBEAT_COUNT=t.SEND_MSG_TIMEOUT=t.SEND_MSG_RESET=t.MAX_TRY_CONNECT_COUNT=t.ENUM_CONNECT_STATE=t.ENUM_PROBE_STATE=t.ENUM_PLAY_STATE_NEGO=t.ENUM_PLAYER_STATE=t.ENUM_PLAY_STATE=t.ENUM_PUBLISH_STATE=t.ENUM_SCREEM_RESOLUTION_TYPE=t.ENUM_RESOLUTION_TYPE=t.ENUM_SIGNAL_STATE=t.ERROR_CODES=t.sdkErrorList=t.ENUM_REMOTE_TYPE=t.LOG_LEVEL=t.ENUM_LOG_LEVEL=t.ROOMVERSION=t.PROTO_VERSION=void 0,t.PROTO_VERSION="2.5.0",t.ROOMVERSION="V1",function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.warn=2]="warn",e[e.error=3]="error",e[e.report=99]="report",e[e.disable=100]="disable"}(t.ENUM_LOG_LEVEL||(t.ENUM_LOG_LEVEL={})),t.LOG_LEVEL={debug:0,info:1,warn:2,error:3,report:99,disable:100},function(e){e[e.disable=0]="disable",e[e.websocket=1]="websocket",e[e.https=2]="https"}(t.ENUM_REMOTE_TYPE||(t.ENUM_REMOTE_TYPE={})),t.sdkErrorList={CLIENT:"Client.",SERVER:"Server.",SUCCESS:{code:"Success",msg:"success."},PARAM:{code:"Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"Error.requencyLimited",msg:"Frequency Limited."}},t.ERROR_CODES={ROOM_SESSION_ID_ERR:1000000152,FETCH_TRANS_UNKNOWN_CHANNEL:1000001108,FETCH_TRANS_UNKNOWN_TYPE:1000001109,FETCH_TRANS_WRONG_SEQ:1000001110},function(e){e[e.disconnected=0]="disconnected",e[e.connecting=1]="connecting",e[e.connected=2]="connected"}(t.ENUM_SIGNAL_STATE||(t.ENUM_SIGNAL_STATE={})),t.ENUM_RESOLUTION_TYPE={LOW:{width:320,height:240,frameRate:15,bitRate:300},MEDIUM:{width:640,height:480,frameRate:15,bitRate:800},HIGH:{width:1280,height:720,frameRate:20,bitRate:1500}},t.ENUM_SCREEM_RESOLUTION_TYPE={LOW:{frameRate:20,bitRate:800},MEDIUM:{frameRate:15,bitRate:1200},HIGH:{frameRate:5,bitRate:2e3}},t.ENUM_PUBLISH_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,publishing:6,stop:7,didNotStart:8},t.ENUM_PLAY_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,playing:6,stop:7,didNotStart:8},t.ENUM_PLAYER_STATE={start:0,playing:1,stop:2},t.ENUM_PLAY_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5,iceDisconnected:6},t.ENUM_PROBE_STATE={tryProbe:0,probed:2},t.ENUM_CONNECT_STATE={disconnect:0,connecting:1,connected:2},t.MAX_TRY_CONNECT_COUNT=1,t.SEND_MSG_RESET=2,t.SEND_MSG_TIMEOUT=1,t.MAX_TRY_HEARTBEAT_COUNT=5,t.MAX_STREAM_ID_LENGTH=256,t.MAX_USER_ID_LENGTH=64,t.MAX_USER_NAME_LENGTH=256,t.MAX_ROOM_ID_LENGTH=128,t.MAX_MESSAGE_LENGTH=1024,t.MAX_MIX_TASK_ID_LENGTH=256,t.MAX_TRANS_TYPE_LENGTH=128,t.MAX_TRANS_DATA_LENGTH=4096,t.MAX_RETRY_CONNECT_INTERVAL=12,t.ENUM_PUBLISH_STREAM_STATE={waiting_url:1,tryPublish:2,update_info:3,publishing:4,stop:5,retryPublish:6},t.ENUM_STREAM_SUB_CMD={liveNone:0,liveBegin:2001,liveEnd:2002,liveUpdate:2003},t.ENUM_STREAM_UPDATE_TYPE={added:1,deleted:0},function(e){e[e.logout=0]="logout",e[e.trylogin=1]="trylogin",e[e.login=2]="login"}(t.ENUM_RUN_STATE||(t.ENUM_RUN_STATE={})),function(e){e[e.offline=0]="offline",e[e.online=1]="online"}(t.ENUM_NETWORK_STATE||(t.ENUM_NETWORK_STATE={})),t.STREAM_DELETE_REASON={0:{code:1,description:"user_stop_publishing_stream_normal"},1:{code:2,description:"user_heart_beat_timeout"},2:{code:3,description:"user_repeat_login"},3:{code:4,description:"user_kicked_out"},4:{code:5,description:"user_offline"},100:{code:6,description:"remove_by_server"}},t.MINIUM_HEARTBEAT_INTERVAL=3e3,t.ENUM_STREAM_UPDATE_CMD={added:12001,deleted:12002,updated:12003},t.SERVER_ERROR_CODE=1e4,t.MIXSTREAM_ERROR_CODE=1e4,function(e){e[e.low=1]="low",e[e.stantard=2]="stantard",e[e.hight=3]="hight",e[e.custome=4]="custome"}(t.QUALITYLEVEL||(t.QUALITYLEVEL={})),t.ENUM_SIGNAL_SUB_CMD={none:0,joinLiveRequest:1001,joinLiveResult:1002,joinLiveInvite:1003,joinLiveStop:1004},t.ENUM_PUSH_SIGNAL_SUB_CMD={none:0,pushJoinLiveRequest:11001,pushJoinLiveResult:11002,pushJoinLiveInvite:11003,pushJoinLiveStop:11004},t.ENUM_PUBLISH_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5,iceDisconnected:6},function(e){e[e.cdn=0]="cdn",e[e.ultra=1]="ultra"}(t.ENUM_PLAY_SOURCE_TYPE||(t.ENUM_PLAY_SOURCE_TYPE={})),function(e){e[e.stop=0]="stop",e[e.start=1]="start"}(t.ENUM_BROADCASTER_STATUS||(t.ENUM_BROADCASTER_STATUS={})),function(e){e[e.cdn=0]="cdn",e[e.ultra=1]="ultra",e[e.customUrl=2]="customUrl"}(t.ENUM_DISPATCH_TYPE||(t.ENUM_DISPATCH_TYPE={})),function(e){e[e.CDN=0]="CDN",e[e.BGP=1]="BGP"}(t.ENUM_SOURCE_TYPE||(t.ENUM_SOURCE_TYPE={})),function(e){e[e.ClientType_None=0]="ClientType_None",e[e.ClientType_H5=1]="ClientType_H5",e[e.ClientType_SmallPragram=2]="ClientType_SmallPragram",e[e.ClientType_Webrtc=3]="ClientType_Webrtc"}(t.E_CLIENT_TYPE||(t.E_CLIENT_TYPE={}));var i=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this._id=null,this.next=null,this.prev=null,this._id=e,this._data=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id?this._id:null},set:function(e){this._id=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e},enumerable:!1,configurable:!0}),e.prototype.hasNext=function(){return this.next&&this.next.id},e.prototype.hasPrev=function(){return this.prev&&this.prev.id},e}();t.ListNode=i;var o=function(){function e(){this.start=new i,this.end=new i,this._idCounter=0,this._numNodes=0,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null}return e.prototype.insertBefore=function(e,t){var r=new i(this._idCounter,t);return r.next=e,r.prev=e.prev,e.prev&&(e.prev.next=r),e.prev=r,++this._idCounter,++this._numNodes,r},e.prototype.addLast=function(e){return this.insertBefore(this.end,e)},e.prototype.add=function(e){return this.addLast(e)},e.prototype.getFirst=function(){return 0===this._numNodes?null:this.start.next},e.prototype.getLast=function(){return 0===this._numNodes?null:this.end.prev},e.prototype.size=function(){return this._numNodes},e.prototype.getFromFirst=function(e){var t=0,r=this.start.next;if(e>=0)for(;t<e&&null!==r;)r=r.next,++t;else r=null;if(null===r)throw"Index out of bounds.";return r},e.prototype.get=function(e){return 0===e?this.getFirst():e===this._numNodes-1?this.getLast():this.getFromFirst(e)},e.prototype.remove=function(e){return e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),--this._numNodes,e},e.prototype.removeFirst=function(){var e=null;return this._numNodes>0&&this.start.next&&(e=this.remove(this.start.next)),e},e.prototype.removeLast=function(){var e=null;return this._numNodes>0&&this.end.prev&&(e=this.remove(this.end.prev)),e},e.prototype.removeAll=function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},e.prototype.each=function(e){for(var t=this.start;t.hasNext();)e(t=t.next)},e.prototype.find=function(e){for(var t=this.start,r=!1,i=null;t.hasNext()&&!r;)e(t=t.next)&&(i=t,r=!0);return i},e.prototype.map=function(e){for(var t=this.start,r=[];t.hasNext();)e(t=t.next)&&r.push(t);return r},e.prototype.push=function(e){return this.addLast(e)},e.prototype.unshift=function(e){this._numNodes>0?this.insertBefore(this.start.next,e):this.insertBefore(this.end,e)},e.prototype.pop=function(){return this.removeLast()},e.prototype.shift=function(){return this.removeFirst()},e}();t.LinkedList=o,t.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},t.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2,stop:3},t.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},t.REPORT_ACTION={eventStart:"eventStart",eventEndWithMsgInfo:"eventEndWithMsgInfo",addEventMsg:"addEventMsg",addEvent:"addEvent",eventEnd:"eventEnd",addMsgInfo:"addMsgInfo"},function(e){e[e.Unknown=-1]="Unknown",e[e.Excellent=0]="Excellent",e[e.Good=1]="Good",e[e.Middle=2]="Middle",e[e.Poor=3]="Poor",e[e.Die=4]="Die"}(t.QualityGrade||(t.QualityGrade={})),function(e){e[e.MinQuality=0]="MinQuality",e[e.DieQuality=0]="DieQuality",e[e.PoorMinQuality=1]="PoorMinQuality",e[e.MiddleMinQuality=30]="MiddleMinQuality",e[e.GoodMinQuality=60]="GoodMinQuality",e[e.ExcellentMinQuality=85]="ExcellentMinQuality",e[e.MaxQuality=100]="MaxQuality"}(t.QUALITY_CONSTANT||(t.QUALITY_CONSTANT={}));var s=r(11);Object.defineProperty(t,"getSeq",{enumerable:!0,get:function(){return s.getSeq}}),Object.defineProperty(t,"getReportSeq",{enumerable:!0,get:function(){return s.getReportSeq}}),Object.defineProperty(t,"ZegoExpressWebRTMEngine",{enumerable:!0,get:function(){return s.ZegoExpressWebRTMEngine}}),Object.defineProperty(t,"ZegoLogger",{enumerable:!0,get:function(){return s.ZegoLogger}}),Object.defineProperty(t,"ZegoDataReport",{enumerable:!0,get:function(){return s.ZegoDataReport}})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoWechatLogEvent=t.ZegoRTCLogEvent=void 0;var i=r(4),o=function(e){return e};t.ZegoRTCLogEvent={kZegoTaskCreateStream:{event:"/sdk/create_stream",error:{kBrowserNotSupportError:i.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT,kParamError:i.errorCodeList.PUBLISHER_PARAM,kScreenCancelError:i.errorCodeList.PUBLISH_SCREEN_CANCELED,kScreenFailedError:i.errorCodeList.PUBLISHER_SCREEN_FAILED,kScreenNotSupportError:i.errorCodeList.PUBLISH_SCREEN_NOT_SUPPORT,kHttpsRequiredError:i.errorCodeList.PUBLISHER_HTTPS_REQUIRED,kGetUserMediaError:i.errorCodeList.PUBLISHER_GET_USER_MEDIA_FAIL},stream_type:o,screen:o,camera:o,custom:o},kZegoTaskPublishStart:{event:"/sdk/api/publish_request",error:{kPublishParamError:i.errorCodeList.PUBLISHER_PARAM,kPublishNetworkTimeoutError:i.errorCodeList.TIMEOUT,kPublishDispatchTimeoutError:i.errorCodeList.DISPATCH_TIMEOUT,kPublishDispatchError:i.errorCodeList.DISPATCH_ERROR,kPublishNetworkBrokenError:i.errorCodeList.NETWORK_BROKEN,kPublishNoPreviewError:i.errorCodeList.PUBLISH_NO_PREVIEW,kPublishNoLoginError:i.errorCodeList.NOT_LOGIN,kPublishRetryTimeoutError:i.errorCodeList.PUBLISHER_RETRY_TIMEOUT,kPublishSessionClosedError:i.errorCodeList.PUBLISHER_SESSION_CLOSED,kPublishNegoTimeoutError:i.errorCodeList.PUBLISHER_SERVER_NEGO_TIMEOUT,kCreateOfferError:i.errorCodeList.PUBLISHER_CREATE_OFFER_ERROR,kSetLocalDescError:i.errorCodeList.PUBLISHER_SET_LOCAL_DESC_ERROR,kSessionTimeoutError:i.errorCodeList.PUBLISHER_SESSION_TIMEOUT,kSessionRequestError:i.errorCodeList.PUBLISHER_SESSION_REQUEST_FAIL,kSetRemoteDescError:i.errorCodeList.PUBLISHER_SET_REMOTE_DESC_ERROR,kMediaConnectionError:i.errorCodeList.PUBLISHER_MEDIA_CONNECTION_ERROR,kWebsocketDisconnectedError:i.errorCodeList.PUBLISHER_WEBSOCKET_DISCONNECTED,kMediaDescError:i.errorCodeList.PUBLISHER_MEDIA_DESC_ERROR,kCandidateError:i.errorCodeList.PUBLISHER_CANDIDATE_ERROR,kIsPublishing:i.errorCodeList.PUBLISHER_IS_PUBLISHING,kClientIPChangedError:i.errorCodeList.PUBLISHER_CLIENT_IP_CHANGED,kTTLOverTimeError:i.errorCodeList.PUBLISHER_TTL_OVERTIME},publishOption:o,message:o,session_id:o,stream:o,video_en_codec_id:o,cap_w:o,cap_h:o,w:o,h:o,video_en_fps:o,video_en_bps:o,audio_c_channel_count:o,audio_en_bps:o,aec_level:o,ans_level:o,agc:o,traffic_control_min_video_bitrate:o},kZegoTaskVideoCaptureSize:{event:"sdk/api/publish_video_c_size",session_id:o,w:o,h:o},kZegoTaskRePublish:{event:"/sdk/republish",stream:o},kZegoTaskPublishStop:{event:"/sdk/stop_publish",error:{kParamError:i.errorCodeList.PUBLISHER_PARAM},stream:o},kZegoTaskPlayStart:{event:"/sdk/api/play_request",error:{kStreamIDNullError:i.errorCodeList.STREAM_ID_NULL,kPlayParamError:i.errorCodeList.PLAYER_PARAM,kPlayStreamIDToLongError:i.errorCodeList.STREAMID_TOO_LONG,kPlayStreamIDInvalidCharacterError:i.errorCodeList.STREAM_ID_INVALID_CHARACTER,kPlayNoLoginError:i.errorCodeList.NOT_LOGIN,kPlayRepeatedPullError:i.errorCodeList.REPEATED_PULL,kPlayNetworkTimeoutError:i.errorCodeList.TIMEOUT,kPlayDispatchTimeoutError:i.errorCodeList.DISPATCH_TIMEOUT,kPlayDispatchError:i.errorCodeList.DISPATCH_ERROR,kPlayNetworkBrokenError:i.errorCodeList.NETWORK_BROKEN,kPlayRetryTimeoutError:i.errorCodeList.PLAYER_RETRY_TIMEOUT,kPlaySessionClosedError:i.errorCodeList.PLAYER_SESSION_CLOSED,kPlaySessionResetError:i.errorCodeList.PLAYER_SESSION_RESET,kPlayNegoTimeoutError:i.errorCodeList.PLAYER_SERVER_NEGO_TIMEOUT,kCreateOfferError:i.errorCodeList.PLAYER_CREATE_OFFER_ERROR,kSetLocalDescError:i.errorCodeList.PLAYER_SET_LOCAL_DESC_ERROR,kSessionRequestError:i.errorCodeList.PLAYER_SESSION_REQUEST_FAIL,kSessionTimeoutError:i.errorCodeList.PLAYER_SESSION_TIMEOUT,kSetRemoteDescError:i.errorCodeList.PLAYER_SET_REMOTE_DESC_ERROR,kMediaConnectionError:i.errorCodeList.PLAYER_MEDIA_CONNECTION_ERROR,kWebsocketDisconnectedError:i.errorCodeList.PLAYER_WEBSOCKET_DISCONNECTED,kCandidateError:i.errorCodeList.PLAYER_CANDIDATE_ERROR,kMediaDescError:i.errorCodeList.PLAYER_MEDIA_DESC_ERROR,kIsPlaying:i.errorCodeList.PLAYER_IS_PLAYING,kClientIPChangedError:i.errorCodeList.PLAYER_CLIENT_IP_CHANGED,kTTLOverTimeError:i.errorCodeList.PLAYER_TTL_OVERTIME,kProbeTimeOutError:i.errorCodeList.PLAYER_PROBE_TIMEOUT},playOption:o,message:o,session_id:o,stream:o,audio_activate:o,video_activate:o},kZegoTaskRePlay:{event:"/sdk/replay",stream:o},kZegoTaskPlayStop:{event:"/sdk/stop_play",error:{kParamError:i.errorCodeList.PUBLISHER_PARAM},stream:o},kZegoPlayContentChanged:{event:"/sdk/play_content_changed",session_id:o,video_activate:o,audio_activate:o},kZegoTaskMixStart:{event:"/mix/start_mix",error:{kParamError:i.errorCodeList.INPUT_PARAM,kTaskIDNullError:i.errorCodeList.MIXER_TASK_ID_NULL,kTaskIDToLongError:i.errorCodeList.MIXER_TASK_ID_TOO_LONG,kTaskIDInvalidCharacterError:i.errorCodeList.MIXER_TASK_ID_INVALID_CHARACTER,kInputListNullError:i.errorCodeList.MIXER_INPUTLIST_NULL,kOutputListNullError:i.errorCodeList.MIXER_OUTPUTLIST_NULL,kOutputTargetInvalidError:i.errorCodeList.MIXER_OUTPUT_TARGET_INVALID,kOutputNoTargetError:i.errorCodeList.MIXER_NO_OUTPUT_TARGET,kRequestError:i.errorCodeList.MIXER_START_REQUEST_ERROR,kInternalError:i.errorCodeList.MIXER_INNER_ERROR},mix_stream_id:o,stream_cnt:o,input_stream_list:o,output_target_list:o},kZegoTaskMixStop:{event:"/mix/stop_mix",error:{kParamError:i.errorCodeList.INPUT_PARAM,kTaskIDNullError:i.errorCodeList.MIXER_TASK_ID_NULL,kRequestError:i.errorCodeList.MIXER_STOP_REQUEST_ERROR,kInternalError:i.errorCodeList.MIXER_INNER_ERROR}},kZegoTaskMixConfig:{event:"/mix/config_mix",error:{kParamError:i.errorCodeList.INPUT_PARAM,kVideoConfigInvalidError:i.errorCodeList.MIXER_VIDEO_CONFIG_INVALID,kBackgroundImageUrlInvalidError:i.errorCodeList.MIXER_BACKGROUND_IMAGE_URL_INVALID},config:o},kZegoTaskEnumDevices:{event:"/device/list",error:{kBrowserNotSupportError:i.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT,kEnumDevicesError:i.errorCodeList.ENUMERATE_DEVICES_FAIL},dev_list:o},kZegoTaskAudioOutput:{event:"/device/audio_capture",error:{kBrowserNotSupportError:i.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT,kEnumDevicesError:i.errorCodeList.ENUMERATE_DEVICES_FAIL},session_id:o,device:o},kZegoTaskVideoCapture:{event:"/device/video_capture",error:{kBrowserNotSupportError:i.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT,kEnumDevicesError:i.errorCodeList.ENUMERATE_DEVICES_FAIL},session_id:o,device:o},kZegoTaskDeviceInterrupt:{event:"/device/interrupt",error:{kBrowserNotSupportError:i.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT,kEnumDevicesError:i.errorCodeList.ENUMERATE_DEVICES_FAIL},session_id:o,interrupt:o},kZegoTaskSetDebug:"/sdk/set_debug",kZegoTaskSetLog:"/sdk/set_log_config",kZegoTaskUseVideoDevice:{event:"/device/api/video_c",error:{kParamError:i.errorCodeList.INPUT_PARAM,kDevicesNoFoundError:i.errorCodeList.DEVICE_NOT_FOUND,kLocalStreamError:i.errorCodeList.LOCALSTREAM_WRONG},device:o},kZegoTaskUseAudioDevice:{event:"/device/api/audio_c",error:{kParamError:i.errorCodeList.INPUT_PARAM,kDevicesNoFoundError:i.errorCodeList.DEVICE_NOT_FOUND,kLocalStreamError:i.errorCodeList.LOCALSTREAM_WRONG},device:o},kZegoTaskCheckSystemRequirements:{event:"/sdk/check_system",capability:o},kZegoTaskMutePublishVideo:"/sdk/mute_publish_video",kZegoTaskMutePublishAudio:"/sdk/mute_publish_audio",kZegoTaskMutePlayVideo:"/sdk/mute_play_video",kZegoTaskMutePlayAudio:"/sdk/mute_play_audio",kZegoTaskRemoteCameraUpdate:{event:"/sdk/remote_camera_update",stream:o,status:o},kZegoTaskRemoteMicUpdate:{event:"/sdk/remote_mic_update",stream:o,status:o},kZegoTaskGetSoundLevel:{event:"/sdk/get_sound_level",error:{kGetSoundLevelError:i.errorCodeList.GET_SOUND_LEVEL_FAIL}},kZegoTaskStopSoundLevel:"/sdk/stop_sound_level",kZegoTaskAddPublishCdnUrl:{event:"/sdk/add_publish_cdn_url",error:{kParamError:i.errorCodeList.INPUT_PARAM}},kZegoTaskRemovePublishCdnUrl:{event:"/sdk/remove_publish_cdn_url",error:{kParamError:i.errorCodeList.INPUT_PARAM},stream:o,target_url:o},kZegoTaskClearPublishCdnUrl:{event:"/sdk/clear_publish_cdn_url",error:{kParamError:i.errorCodeList.INPUT_PARAM}},kZegoTaskPublishTarget:{event:"/sdk/publish_target",error:{kParamError:i.errorCodeList.INPUT_PARAM,kPublishStreamNoFoundError:i.errorCodeList.PUBLISHER_STREAM_NO_FOUND}},kZegoTaskDestroyStream:{event:"/sdk/destroy_stream",error:{kLocalStreamError:i.errorCodeList.LOCALSTREAM_WRONG}},kZegoTaskScreenSharingEnded:"/sdk/screen_share_end",kZegoTaskAudioOutputChanged:{event:"/device/api/audio_output",session_id:o,stream:o,device:o,reason:o},kZegoEventPublishStat:"/sdk/publish_stat_report",kZegoEventPlayStat:"/sdk/play_stat_report",kZegoSetAudioConfig:{event:"/sdk/set_audio_config",error:{kParamError:i.errorCodeList.INPUT_PARAM}},kZegoSetVideoConfig:{event:"/sdk/set_video_config",error:{kParamError:i.errorCodeList.INPUT_PARAM,kLocalStreamError:i.errorCodeList.LOCALSTREAM_WRONG}},kZegoReplaceTrack:{event:"/sdk/replace_track",error:{kParamError:i.errorCodeList.INPUT_PARAM}},kZegoTaskLiveRoomGetStreamUpdateInfo:{event:"/liveroom/get_stream_update_info",stream_update_type:o,update_stream:o},kZegoTaskLiveRoomGetStreamExtraInfo:{event:"/liveroom/get_stream_extra_info",update_stream:o},kZegoTaskLiveRoomSendStreamExtraInfo:{event:"/liveroom/send_stream_extra_info",error:{kParamError:i.errorCodeList.INPUT_PARAM,kExtraInfoNullError:i.errorCodeList.PUBLISHER_EXTRA_INFO_NULL,kNoLoginError:i.errorCodeList.NOT_LOGIN,kPublishStreamNoFoundError:i.errorCodeList.PUBLISHER_STREAM_NO_FOUND},stream:o,stream_extra_info:o,room_sid:o},kZegoTaskPlayDecodeFirstVideoFrame:{event:"/sdk/play_decode_first_video_frame",session_id:o,fft_consumed:o},kZegoVisibilityChange:{event:"/app/background"},kZegoSetCaptureVolume:{event:"/sdk/set_capture_volume",error:{kParamError:i.errorCodeList.INPUT_PARAM}},kZegoListener:{event:"/sdk/listener"}},t.ZegoWechatLogEvent={kZegoTaskCheckSystemRequirements:{event:"/sdk/check_system",error:{kCheckSystemGetSettingFailError:i.errorCodeList.WX_GETSETTING_FAIL},capability:o},kZegoTaskPublishStart:{event:"/sdk/api/publish_request",error:{kPublishStreamIDNullError:i.errorCodeList.STREAM_ID_NULL,kPublishParamError:i.errorCodeList.PUBLISHER_PARAM,kPublishStreamIDTooLongError:i.errorCodeList.STREAMID_TOO_LONG,kPublishStreamIDInvalidCharacterError:i.errorCodeList.STREAM_ID_INVALID_CHARACTER,kPublishNetworkTimeoutError:i.errorCodeList.TIMEOUT,kPublishDispatchTimeoutError:i.errorCodeList.DISPATCH_TIMEOUT,kPublishDispatchError:i.errorCodeList.DISPATCH_ERROR,kPublishNetworkBrokenError:i.errorCodeList.NETWORK_BROKEN,kPublishNoLoginError:i.errorCodeList.NOT_LOGIN,kPublishRetryTimeoutError:i.errorCodeList.PUBLISHER_RETRY_TIMEOUT,kIsPublishing:i.errorCodeList.PUBLISHER_IS_PUBLISHING},publishOption:o,stream:o,message:o},kZegoTaskPlayStart:{event:"/sdk/api/play_request",error:{kPlayStreamIDNullError:i.errorCodeList.STREAM_ID_NULL,kPlayParamError:i.errorCodeList.PLAYER_PARAM,kPlayStreamIDTooLongError:i.errorCodeList.STREAMID_TOO_LONG,kPlayStreamIDInvalidCharacterError:i.errorCodeList.STREAM_ID_INVALID_CHARACTER,kPlayNoLoginError:i.errorCodeList.NOT_LOGIN,kPlayRepeatedPullError:i.errorCodeList.REPEATED_PULL,kPlayNetworkTimeoutError:i.errorCodeList.TIMEOUT,kPlayDispatchTimeoutError:i.errorCodeList.DISPATCH_TIMEOUT,kPlayDispatchError:i.errorCodeList.DISPATCH_ERROR,kPlayNetworkBrokenError:i.errorCodeList.NETWORK_BROKEN,kPlayRetryTimeoutError:i.errorCodeList.PLAYER_RETRY_TIMEOUT,kIsPlaying:i.errorCodeList.PLAYER_IS_PLAYING},playOption:o,message:o,session_id:o,stream:o,audio_activate:o,video_activate:o},kZegoEventPublishStat:"/sdk/publish_stat_report",kZegoEventPlayStat:"/sdk/play_stat_report",kZegoTaskRePublish:"/sdk/republish",kZegoTaskRePlay:"/sdk/replay",kZegoTaskPublishStop:{event:"/sdk/stop_publish",error:{kParamError:i.errorCodeList.PUBLISHER_PARAM},stream:o},kZegoTaskPlayStop:{event:"/sdk/stop_play",error:{kParamError:i.errorCodeList.PUBLISHER_PARAM},stream:o},kZegoTaskLiveRoomGetStreamUpdateInfo:{event:"/liveroom/get_stream_update_info",stream_update_type:o,update_stream:o},kZegoTaskLiveRoomGetStreamExtraInfo:{event:"/liveroom/get_stream_extra_info",update_stream:o},kZegoTaskMixStart:{event:"/mix/start_mix",error:{kParamError:i.errorCodeList.INPUT_PARAM,kTaskIDNullError:i.errorCodeList.MIXER_TASK_ID_NULL,kTaskIDToLongError:i.errorCodeList.MIXER_TASK_ID_TOO_LONG,kTaskIDInvalidCharacterError:i.errorCodeList.MIXER_TASK_ID_INVALID_CHARACTER,kInputListNullError:i.errorCodeList.MIXER_INPUTLIST_NULL,kOutputListNullError:i.errorCodeList.MIXER_OUTPUTLIST_NULL,kOutputTargetInvalidError:i.errorCodeList.MIXER_OUTPUT_TARGET_INVALID,kOutputNoTargetError:i.errorCodeList.MIXER_NO_OUTPUT_TARGET,kRequestError:i.errorCodeList.MIXER_START_REQUEST_ERROR,kInternalError:i.errorCodeList.MIXER_INNER_ERROR},mix_stream_id:o,stream_cnt:o,input_stream_list:o,output_target_list:o},kZegoTaskMixStop:{event:"/mix/stop_mix",error:{kParamError:i.errorCodeList.INPUT_PARAM,kTaskIDNullError:i.errorCodeList.MIXER_TASK_ID_NULL,kRequestError:i.errorCodeList.MIXER_STOP_REQUEST_ERROR,kInternalError:i.errorCodeList.MIXER_INNER_ERROR}},kZegoTaskMixConfig:{event:"/mix/config_mix",error:{kParamError:i.errorCodeList.INPUT_PARAM,kVideoConfigInvalidError:i.errorCodeList.MIXER_VIDEO_CONFIG_INVALID,kBackgroundImageUrlInvalidError:i.errorCodeList.MIXER_BACKGROUND_IMAGE_URL_INVALID},config:o}}},function(e,t,r){"use strict";var i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function n(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,n)}c((i=i.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,i,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function n(s){return function(n){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],i=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,n])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.ClientUtil=void 0;var s=r(0),a=r(1),n=r(12),c=function(){function e(){}return e.checkIllegalCharacters=function(e){return/^([0-9a-zA-Z#!$%&()`'+-;<=.>@^_~,\\*])+$/.test(e)&&/^[^:/]*$/g.test(e)},e.isUrl=function(e){return!!(e.startsWith("rtmp://")||e.startsWith("https://")&&e.endsWith(".flv")||e.startsWith("https://")&&e.endsWith(".m3u8"))},e.registerCallback=function(e,t,r){var i,o;t.success&&(i=t.success,r[e+"SuccessCallback"]=i),t.error&&(o=t.error,r[e+"ErrorCallback"]=o)},e.actionErrorCallback=function(e,t){return t[e+"ErrorCallback"]},e.actionSuccessCallback=function(e,t){return t[e+"SuccessCallback"]},e.logReportCallback=function(t,r,i,o){e.registerCallback(t,{success:function(t,o){for(var s=[],a=2;a<arguments.length;a++)s[a-2]=arguments[a];e.dataReportEvent(r,i,t,o,s)}},o)},e.actionLogReportCallback=function(t,r,i,o,s){e.actionSuccessCallback(t,r)&&e.actionSuccessCallback(t,r)(i,o)},e.getServerError=function(e){var t={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",1010:"token expired",1011:"token format error",2002:"biz channel error",1e9:"liveroom cmd error, code:"};if(0===e)return{code:0,message:""};var r={code:0,message:"liveroom cmd error"};return r.code=e,r.message=e>1e9?t[1e9]+e:t[e]?t[e]+" code:"+e:"unknown error code:"+e,r},e.unregisterCallback=function(e,t){delete t[e+"SuccessCallback"],delete t[e+"ErrorCallback"]},e.decodeServerError=function(e,t){var r={code:-1,message:"server error"};return e>1e9&&(r.code=e-1e9+52e6),t&&(r.message=t),r},e.getLiveRoomError=function(e){return e>1e9?{1105:"ROOM_MAX_USER_COUNT",1012:"PUBLISHER_ERROR_REPETITIVE_PUBLISH_STREAM",2002:"ROOM_ERROR_AUTHENTICATION_FAILED",2003:"ROOM_ERROR_LOGIN_TIMEOUT"}[e-1e9]||"":{1:"PARSE_JSON_ERROR",1001:"LOGIN_PROCESSING",1002:"LIVEROMM_REQUEST_ERROR",1003:"ZPUSH_REQUEST_FAIL",1004:"ZPUSH_REQUEST_FAIL",1005:"ZPUSH_REQUEST_FAIL",1006:"LOGIN_STATE_WRONG",1007:"ZPUSH_REQUEST_FAIL",1008:"TOKEN_ERROR",1009:"DIAPATCH_ERROR",1010:"TOKEN_EXPIRED",1011:"TOKEN_ERROR",1012:"SUBCMD_ERROR",1101:"ZEGO_AUTH_ERROR",2001:"BIZ_CHANNEL_ERROR",2002:"BIZ_CHANNEL_ERROR"}[e]||"ROOM_INNER_ERROR"},e.mixServerError=function(e){var t={82000001:"kMixStreamFailError",82000002:"kMixStreamInputError",82000003:"kMixStreamAuthError",82000150:"kMixStreamNotExistError",82000151:"kMixStreamStartMixError",82000152:"kMixStreamStopMixError",82000155:"kMixStreamInputFormatError",82000156:"kMixStreamOutputFormatError",82000157:"kMixStreamNotOpenError",82000158:"kMixStreamInputExceedError",82000159:"kMixStreamDispatchError",82000160:"kMixStreamStopMixOwnerError",82000170:"kMixStreamWaterMarkParamError",82000171:"kMixStreamWaterMarkImageError",82000190:"kMixStreamQpsOverloadError"},r={1:"MIXER_START_REQUEST_ERROR",3:"MIXER_AUTHENTICATION_FAILED",150:"MIXER_INPUT_STREAM_NOT_EXISTS",151:"MIXER_START_REQUEST_ERROR",152:"MIXER_STOP_REQUEST_ERROR",153:"MIXER_INPUT_PARAMETERS_ERROR",154:"MIXER_EXCEED_MAX_OUTPUT_COUNT",155:"MIXER_INPUT_PARAMETERS_ERROR",156:"MIXER_VIDEO_CONFIG_INVALID",157:"MIXER_NO_SERVICES",158:"MIXER_EXCEED_MAX_INPUT_COUNT",159:"MIXER_START_REQUEST_ERROR",160:"MIXER_NOT_OWNER_STOPMIXER",170:"MIXER_WATERMARK_PARAMETERS_ERROR",171:"MIXER_WATERMARK_NULL",190:"MIXER_START_REQUEST_ERROR"},i=[];if(e>1e9){var o=e-1e9+82e6;i[0]=t[o]?t[o]:"",i[1]=r[e-1e9]?r[e-1e9]:""}return i},e.getKickoutError=function(e){var t={};switch(e){case 1:t.code=63000001,t.message="zpush multiple login kickout",t.name="MULTIPLE_LOGIN_KICKOUT";break;case 2:t.code=63000002,t.message="zpush manual kickout",t.name="MANUAL_KICKOUT";break;case 3:t.code=63000003,t.message="kickout reason = "+e;break;case 4:t.code=63000001,t.message="zpush multiple login kickout",t.name="MULTIPLE_LOGIN_KICKOUT";break;default:t.code=e,t.message="kickout reason = "+e}return t},e.dataReportEvent=function(e,t,r,i,o){switch(r){case"eventStart":e.eventStart(t,i);break;case"eventEndWithMsgInfo":e.eventEndWithMsgInfo(t,i,o[0]);break;case"addEventMsg":e.addEventMsg(t,i,o[0],o[1]);break;case"addEvent":e.addEvent(t,i);break;case"eventEnd":e.eventEnd(t,i);break;case"addMsgInfo":e.addMsgInfo(t,o[0])}},e.isKeepTryLogin=function(e){switch(e){case 1002:case 1003:return!0;default:return!1}},e.mergeStreamList=function(e,t,r,i){var o,s=[],a=[],n=[];r||(r=[]);for(var c=0;c<r.length;c++)if(r[c].anchor_id_name!=e){o=!1;for(var d=0;d<t.length;d++)if(r[c].stream_id===t[d].stream_id){r[c].extra_info!==t[d].extra_info&&n.push(r[c]),o=!0;break}o||s.push(r[c])}for(var l=0;l<t.length;l++){o=!1;for(var u=0;u<r.length;u++)if(t[l].stream_id===r[u].stream_id){o=!0;break}o||a.push(t[l])}t.splice(0);for(c=0;c<r.length;c++)t.push(r[c]);i(s,a,n)},e.checkInteger=function(e,t){return 0==t?"number"==typeof e&&e%1==0&&e>=0:"number"==typeof e&&e%1==0&&e>0},e.checkValidNumber=function(e,t,r){return t=t||1,r=r||1e4,"number"==typeof e&&e%1==0&&e>=t&&e<=r},e.uuid=function(e,t){var r,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(t=t||i.length,e)for(r=0;r<e;r++)o[r]=i[0|Math.random()*t];else{var s=void 0;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",r=0;r<36;r++)o[r]||(s=0|16*Math.random(),o[r]=i[19==r?3&s|8:s])}return o.join("")},e.supportDetection=function(e,t,r,s){return i(this,void 0,void 0,(function(){var i,a,n,c,d,l,u,p;return o(this,(function(o){switch(o.label){case 0:return i={webRTC:!1,customCapture:!1,camera:!1,microphone:!1,videoCodec:{H264:!1,H265:!1,VP8:!1,VP9:!1},screenSharing:e,errInfo:{}},s&&"screenSharing"===s?[2,t({result:e,errInfo:i.errInfo})]:s&&"customCapture"!==s||(((a=document.createElement("video")).captureStream||a.mozCaptureStream)&&(i.customCapture=!0),"customCapture"!==s)?(n=navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,c="https:"!==window.location.protocol&&"file:"!==window.location.protocol&&-1==window.location.hostname.indexOf("127.0.0.1")&&-1==window.location.hostname.indexOf("localhost"),s&&"camera"!==s&&"microphone"!==s?[3,9]:n?c?(i.camera=!1,console.error("webrtc requires https or localhost"),[3,9]):[3,1]:[3,9]):(t({result:i.customCapture,errInfo:i.errInfo}),[2]);case 1:if(s&&"camera"!==s)return[3,5];o.label=2;case 2:return o.trys.push([2,4,,5]),[4,navigator.mediaDevices.getUserMedia({video:!0})];case 3:return(d=o.sent())&&(i.camera=!0)&&d.getTracks().forEach((function(e){return e.stop()})),[3,5];case 4:return l=o.sent(),i.errInfo.camera={name:l.name,message:l.message},console.error("camera devices detect error: ",l.name,l.message),[3,5];case 5:if(s&&"microphone"!==s)return[3,9];o.label=6;case 6:return o.trys.push([6,8,,9]),[4,navigator.mediaDevices.getUserMedia({audio:!0})];case 7:return(u=o.sent())&&(i.microphone=!0)&&u.getTracks().forEach((function(e){return e.stop()})),[3,9];case 8:return p=o.sent(),i.errInfo.microphone={name:p.name,message:p.message},console.error("microphone devices detect error: ",p.name,p.message),[3,9];case 9:return"camera"===s||"microphone"===s?(t({result:i[s],errInfo:i.errInfo}),[2]):(this.supportVideoCodeType((function(e,r){s||(i.videoCodec.H264=e.H264,i.videoCodec.H265=e.H265,i.videoCodec.VP8=e.VP8,i.videoCodec.VP9=e.VP9,i.webRTC=e.webRTC),r&&("string"==typeof r?i.errInfo.extendedDate=r:i.errInfo.webRTC={name:r.name,message:r.message},console.error("videoCodec detect error: "+r)),t&&t(s?{result:e[s],errInfo:i.errInfo}:i)}),r,s),[2])}}))}))},e.getDevices=function(e,t){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then((function(t){for(var r=[],i=[],o=[],s=0;s<t.length;s++){var a=t[s];"audioinput"===a.kind&&r.push({deviceName:a.label,deviceID:a.deviceId}),"audiooutput"===a.kind&&i.push({deviceName:a.label,deviceID:a.deviceId}),"videoinput"===a.kind&&o.push({deviceName:a.label,deviceID:a.deviceId})}e&&e({microphones:r,speakers:i,cameras:o})})).catch((function(e){console.error("enumerate devices wrong "+e),t&&t(a.ZegoRTCLogEvent.kZegoTaskEnumDevices.error.kEnumDevicesError)})):t&&t(a.ZegoRTCLogEvent.kZegoTaskEnumDevices.error.kBrowserNotSupportError)},e.compareVersion=function(e,t){e=e.split("."),t=t.split(".");for(var r=Math.max(e.length,t.length);e.length<r;)e.push("0");for(;t.length<r;)t.push("0");for(var i=0;i<r;i++){var o=parseInt(e[i]),s=parseInt(t[i]);if(o>s)return 1;if(o<s)return-1}return 0},e.isSupportLive=function(e,t){var r="当前微信版本过低，无法使用相关组件",i="需要摄像头和录音功能的授权",o=wx.getSystemInfoSync().SDKVersion,s={code:0,msg:""};this.compareVersion(o,"1.7.0")<0&&(s={code:10001,msg:r},e&&e(s)),wx.getSetting({success:function(t){var r=t.authSetting;r["scope.camera"]&&r["scope.record"]||(s={code:10002,msg:i}),e&&e(s)},fail:function(e){console.error("get setting error",e),t&&t(e)}})},e.supportVideoCodeType=function(e,t,r){return i(this,void 0,void 0,(function(){var i,s,a,c,d,l,u,p,h,g;return o(this,(function(o){switch(o.label){case 0:return i={webRTC:!1,H264:!1,VP8:!1,VP9:!1,H265:!1},r?1!==t||"VP8"!==r&&"H264"!==r?[3,2]:[4,(g=new n.CheckModule).checkSupportByType(r)]:[3,2];case 1:return"boolean"==typeof(s=o.sent())?(i[r]=s,[2,e(i)]):(i[r]=!1,[2,e(i,s)]);case 2:if("webRTC"!==r&&1!==t)return[3,7];o.label=3;case 3:return o.trys.push([3,5,,6]),[4,(new RTCPeerConnection).createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})];case 4:return o.sent(),i.webRTC=!0,[3,6];case 5:return a=o.sent(),e&&e(i,a),[3,6];case 6:if("webRTC"===r)return[2,e(i)];o.label=7;case 7:if(1===t){for(c="",l=[],u=0,p=d=["VP8","H264"];u<p.length;u++)h=p[u],g=new n.CheckModule,l.push(g.checkSupportByType(h));return Promise.all(l).then((function(t){t.forEach((function(e,t){"boolean"==typeof e?i[d[t]]=!0:(i[d[t]]=!1,c=e)})),c?e(i,c):e(i)})),[2]}try{(new RTCPeerConnection).createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then((function(t){if(i.webRTC=!0,t&&t.sdp){var o=t.sdp.split("\r\n");if(i.H264=o.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("H264/")>-1})),"H264"===r)return e(i);if(i.VP8=o.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("VP8/")>-1})),"VP8"===r)return e(i);i.VP9=o.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("VP9/")>-1})),i.H265=o.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("H265/")>-1})),e&&e(i)}}))}catch(t){e&&e(i,t)}return[2]}}))}))},e.inlineWorker=function(e){if(Worker&&e){var t=e.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],r=URL.createObjectURL(new window.Blob([t],{type:"text/javascript"}));return new Worker(r)}return null},e.getBrowser=function(){var e=window.navigator.userAgent,t=null!=window.ActiveXObject&&-1!=e.indexOf("MSIE"),r=-1!=e.indexOf("Firefox"),i=null!=window.opr,o=e.indexOf("Chrome")&&window.chrome,s=-1!=e.indexOf("Safari")&&-1!=e.indexOf("Version");return t?"IE":r?"Firefox":i?"Opera":o?"Chrome":s?"Safari":"Unkown"},e.getPublisherStateType=function(e){return 0==e||1==e?0==e?"PUBLISHING":"NO_PUBLISH":"PUBLISH_REQUESTING"},e.getPlayerStateType=function(e){return 0==e||1==e?0==e?"PLAYING":"NO_PLAY":"PLAY_REQUESTING"},e.getSteamUpdateType=function(e){return 0==e?"DELETE":"ADD"},e.checkScreenParams=function(t,r){if("object"==typeof t&&void 0!==t.videoQuality&&!e.checkInteger(t.videoQuality))return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," videoQuality must be integer number"),!1;if("object"==typeof t&&4===t.videoQuality){if(void 0===t.bitRate)return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate is required when videoQuality is 4"),!1;if(!e.checkInteger(t.bitRate))return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate must be integer number"),!1;if(t.bitRate>10240)return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate cannot greater than 10 Mbps"),!1;if(void 0===t.frameRate)return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," frameRate is required when videoQuality is 4"),!1;if(!e.checkInteger(t.frameRate))return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," frameRate must be integer number"),!1;if(void 0===t.width)return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," width is required when videoQuality is 4"),!1;if(!e.checkInteger(t.width))return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," width must be integer number"),!1;if(void 0===t.height)return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," height is required when videoQuality is 4"),!1;if(!e.checkInteger(t.height))return r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," height must be integer number"),!1}return!0},e.checkCameraParams=function(t,r){return t.width&&e.checkValidNumber(t.width)?t.height&&e.checkValidNumber(t.height)?t.frameRate&&e.checkValidNumber(t.frameRate)?!(!t.bitRate||!e.checkValidNumber(t.bitRate))||(r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate must be integer number"),!1):(r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," frameRate must be integer number"),!1):(r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," height must be integer number"),!1):(r(a.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," width must be integer number"),!1)},e.isParamEmpty=function(e){return null!=e&&""!==e},e.isTypeString=function(e){return"string"==typeof e},e.isTooLong=function(e,t){return!(e.length>=t)},e.isReDispatch=function(e){var t=e.message.match(/action:(\d+)/),r=t?Number(t[1]):NaN;return[a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kTTLOverTimeError,a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kClientIPChangedError,a.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kTTLOverTimeError,a.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kClientIPChangedError].includes(e)||[6].includes(r)},e.arrAvg=function(e,t,r){return e.push(t),e.length>r&&e.shift(),e.reduce((function(e,t){return e+t}))/e.length},e.getNetQuality=function(e,t,r){if(void 0!==r){return.15*this.calcQualityOfJitter(r)+.85*Math.min(this.calcQualityOfRtt(e),this.calcQualityOfLostRate(t,!1))}return Math.min(this.calcQualityOfRtt(e),this.calcQualityOfLostRate(t,!0))},e.calcQualityOfRtt=function(e){return e<600?97-Math.pow(.09*e,1.1):18*Math.exp(.002*(600-e))},e.calcQualityOfJitter=function(e){return e<=50?98-Math.pow(e,1.15):s.QUALITY_CONSTANT.PoorMinQuality},e.calcQualityOfLostRate=function(e,t){if(t){var r=e;return r<=55?99-Math.pow(.8*r,1.18):s.QUALITY_CONSTANT.PoorMinQuality}var i=100*e;return i<=40?96-Math.pow(i,1.22):s.QUALITY_CONSTANT.PoorMinQuality},e.quality2QualityGrade=function(e){s.QualityGrade.Unknown;return e>=s.QUALITY_CONSTANT.ExcellentMinQuality?s.QualityGrade.Excellent:e>=s.QUALITY_CONSTANT.GoodMinQuality?s.QualityGrade.Good:e>=s.QUALITY_CONSTANT.MiddleMinQuality?s.QualityGrade.Middle:e>=s.QUALITY_CONSTANT.PoorMinQuality?s.QualityGrade.Poor:s.QualityGrade.Die},e}();t.ClientUtil=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZEGO_WECHATMINI_ACTION=t.ZEGO_WEBRTC_ACTION=void 0,function(e){e.CONSTRUCTOR="zc.0",e.CHECK_SUPPORT="zc.csr",e.CREATE_STREAM="zc.cs",e.DESTROY_STREAM="zc.ds",e.START_PUBLISHING_STREAM="zc.sps.0",e.START_PLAYING_STREAM="zc.sps.1",e.STOP_PUBLISHING_STREAM="zc.sps.0.0",e.STOP_PLAYING_STREAM="zc.sps.1.0",e.BIND_WINDOW_LISTENER="zc.wl",e.MUTE_PUBLISH_STREAM_VIDEO="zc.mpsv.0",e.MUTE_PUBLISH_STREAM_AUDIO="zc.mpsa.0",e.MUTE_PLAY_STREAM_VIDEO="zc.mpsv.1",e.MUTE_PLAY_STREAM_AUDIO="zc.mpsa.1",e.SET_AUDIO_OUTPUT="zc.sao",e.SET_CUSTOM_SIGNAL_URL="zc.scsu",e.SET_TURN_OVER_TCP_ONLY="zc.stoto",e.SET_VIDEO_CONFIG="zc.svc",e.SET_AUDIO_CONFIG="zc.sac",e.REPLACE_TRACK="zc.rp",e.PRELOAD_EFFECT="zc.pe.0",e.PLAY_EFFECT="zc.pe.1",e.PAUSE_EFFECT="zc.pe.2",e.RESUME_EFFECT="zc.re",e.STOP_EFFECT="zc.se",e.UNLOAD_EFFECT="zc.ue",e.SET_EFFECT_VOLUME="zc.sev",e.START_MIXING_AUDIO="zc.sma.0",e.STOP_MIXING_AUDIO="zc.sma.1",e.MIXING_BUFFER="zc.mb",e.STOP_MIXING_BUFFER="zc.smb",e.SET_MIXING_AUDIO_VOLUME="zc.smav",e.ENABLE_STREAM="zc.es",e.RDH_ACTIVE="zc.rdh.a",e.RDH_MAX_TIME="zc.rdh.m",e.RDH_WEBRTC_URL_RSP="zc.rdh.hfwur",e.PUBLISH_STATE_HANDLE="zc.psh.0",e.PLAY_STATE_HANDLE="zc.psh.1",e.STATECENTER_ACTION_LISTENER="zc.sc.al",e.SIGNAL_SET_SESSION_INFO="zc.s.ssi",e.SIGNAL_RESET_CONNECT_TIMER="zc.s.rct",e.SIGNAL_BIND_WEBSOCKET_HANDLE="zc.s.bwh",e.SIGNAL_RESET_CHECK_MESSAGE="zc.s.rcm",e.SIGNAL_UPDATE_TOKEN="zc.s.ut",e.SIGNAL_SEND_MESSAGE_WITH_CALLBACK="zc.s.smwc",e.SIGNAL_CONNECT_SERVER="zc.s.cs.0",e.SIGNAL_START_CONNECT_TIMER="zc.s.sct",e.SIGNAL_DISCONNECT_SERVER="zc.s.dc",e.SIGNAL_CREATE_SESSION="zc.s.cs.1",e.SIGNAL_REMOVE_SESSION="zc.s.rs",e.SIGNAL_SEND_REMOVE_SESSION="zc.s.srs",e.SIGNAL_SEND_MESSAGE="zc.s.sm",e.SIGNAL_HANDLE_RESPOND_DATA="zc.s.hrd",e.SIGNAL_ADD_SESSION="zc.s.as",e.SIGNAL_HANDLE_PUSH_DATA="zc.s.hpd",e.SIGNAL_HANDLE_PUSH_RESET_SESSION_DATA="zc.s.hprsd",e.SIGNAL_SEND_MEDIA_DESC="zc.s.smd",e.SIGNAL_SEND_CANDIDATE_INFO="zc.s.sci",e.SIGNAL_SEND_MEDIA_DESC_ACK="zc.s.smda",e.SIGNAL_SEND_CANDIDATE_INFO_ACK="zc.s.scia",e.SIGNAL_SEND_CLOSE_SESSION_ACK="zc.s.scsa",e.SIGNAL_SEND_RESET_SESSION_ACK="zc.s.srsa",e.SIGNAL_REGISTER_PUSH_CALLBACK="zc.s.rpc",e.SIGNAL_CHECK_MESSAGE_TIMEOUT="zc.s.cmt",e.SIGNAL_SEND_HEARTBEAT="zc.s.sh",e.SIGNAL_QUALITY_REPORT="zc.s.qr",e.SIGNAL_SEND_STREAM_STATUS="zc.s.sss",e.SIGNAL_ACTIVE_PLAY_VIDEO_STREAM="zc.s.apvs",e.SIGNAL_ACTIVE_PLAY_AUDIO_STREAM="zc.s.apas",e.SIGNAL_SEND_BROADCAST_STATUS="zc.s.sbs",e.SIGNAL_SEND_NET_PROBE="zc.s.snp",e.SIGNAL_SEND_NET_QUALITY_INFO_PUSH_ACK="zc.s.npa",e.PUBLISHER_START_PUBLISH="zc.p.0.sp",e.PUBLISHER_PUBLISH_SUCCESS="zc.p.ps",e.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS="zc.p.0.ocpss",e.PUBLISHER_HANDLE_CREATE_SESSION_WITH_SDP="zc.p.0.hcsws",e.PUBLISHER_ON_CREATE_OFFER_SUCCESS="zc.p.0.ocos",e.PUBLISHER_ON_SET_LOCAL_DESCRIPTION_SUCCESS="zc.p.0.oslds",e.PUBLISHER_ON_GET_REMOTE_DESCRIPTION="zc.p.0.ogrd",e.PUBLISHER_ON_RECV_MEDIA_DESC="zc.p.0.ormd",e.PUBLISHER_ON_RECV_CANDIDATE_INFO="zc.p.0.orci.0",e.PUBLISHER_ON_RECV_PUBLISH_EVENT="zc.p.0.orpe",e.PUBLISHER_ON_RECV_CLIENT_INFO="zc.p.0.orci.1",e.PUBLISHER_ON_ICE_CANDIDATE="zc.p.0.oic",e.PUBLISHER_ON_CONNECTION_STATE_CHANGE="zc.p.0.ocsc",e.PUBLISHER_ON_ICE_CONNECTION_STATE_CHANGE="zc.p.0.oicsc",e.PUBLISHER_RESET_PUBLISH="zc.p.0.rp",e.PUBLISHER_SET_PLAYER_QUALITY_TIMER="zc.p.0.spqt",e.PUBLISHER_UPLOAD_PUBLISH_QUALITY="zc.p.0.upq",e.PUBLISHER_ON_RECV_RESET_SESSION="zc.p.0.orrs",e.PUBLISHER_ON_RECV_CLOSE_SESSION="zc.p.0.orcs",e.PUBLISHER_SEND_CANDIDATE_INFO="zc.p.0.sci",e.PUBLISHER_STATE_ERROR="zc.p.0.psr",e.PUBLISHER_STOP_PUBLISH="zc.p.0.sp",e.PUBLISHER_ON_DISCONNECT="zc.p.0.od",e.PUBLISHER_START_SOUND_LEVEL="zc.p.0.ssl.0",e.PUBLISHER_STOP_SOUND_LEVEL="zc.p.0.ssl.1",e.PUBLISHER_PLAY_EFFECT="zc.p.0.pe.0",e.PUBLISHER_PAUSE_EFFECT="zc.p.0.pe.1",e.PUBLISHER_RESUME_EFFECT="zc.p.0.re",e.PUBLISHER_STOP_EFFECT="zc.p.0.se",e.PUBLISHER_START_MIXING_AUDIO="zc.p.0.sma.0",e.PUBLISHER_STOP_MIXING_AUDIO="zc.p.0.sma.1",e.PUBLISHER_MIXING_BUFFER="zc.p.0.mb",e.PUBLISHER_SET_MIXING_AUDIO_VOLUME="zc.p.0.smav",e.PUBLISHER_HANDLE_ENC_BITRATE="zc.p.0.heb",e.PUBLISHER_ON_RECV_NET_QUALITY_INFO="zc.p.0.nqi",e.PLAYER_START_PLAY="zc.p.sp.1",e.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS="zc.p.ocpss.1",e.PLAYER_HANDLE_CREATE_SESSION_WITH_SDP="zc.p.hcsws.1",e.PLAYER_ON_CREATE_OFFER_SUCCESS="zc.p.ocos.1",e.PLAYER_ON_SET_LOCAL_DESCRIPTION_SUCCESS="zc.p.oslds.1",e.PLAYER_ON_RECV_MEDIA_DESC="zc.p.ormd.1",e.PLAYER_ON_RECV_CANDIDATE_INFO="zc.p.orci.1",e.PLAYER_ON_RECV_PLAY_EVENT="zc.p.orpe.1",e.PLAYER_ON_RECV_CLIENT_INFO="zc.p.orci.1.1",e.PLAYER_ON_ICE_CANDIDATE="zc.p.oic.1",e.PLAYER_ON_CONNECTION_STATE_CHANGE="zc.p.ocsc.1",e.PLAYER_ON_ICE_CONNECTION_STATE_CHANGE="zc.p.oicsc.1",e.PLAYER_RESET_PLAY="zc.p.rp.1",e.PLAYER_SET_PLAYER_QUALITY_TIMER="zc.p.spqt.1",e.PLAYER_UPLOAD_PLAYER_QUALITY="zc.p.upq.1",e.PLAYER_ON_RECV_RESET_SESSION="zc.p.orrs.1",e.PLAYER_ON_RECV_CLOSE_SESSION="zc.p.orcs.1",e.PLAYER_ON_RECV_STREAM_STATUS="zc.p.orss.1",e.PLAYER_ON_GOT_REMOTE_STREAM="zc.p.ogrs.1",e.PLAYER_SEND_CANDIDATE_INFO="zc.p.sci.1",e.PLAYER_STATE_ERROR="zc.p.psr.1",e.PLAYER_STOP_PLAY="zc.p.sp.1",e.PLAYER_ON_DISCONNECT="zc.p.od.1",e.PLAYER_START_SOUND_LEVEL="zc.p.ssl.1",e.PLAYER_STOP_SOUND_LEVEL="zc.p.ssl.1.1",e.PLAYER_ON_RECV_NET_QUALITY_INFO="zc.p.1.nqi",e.PUBLISH_SET_CAPTURE_VOLUME="zc.p.scv",e.STREAMHANDLER_MERGE_STREAM_BY_STREAM_SEQ="zc.sh.msbss",e.STREAMHANDLER_MERGE_STREAM="zc.sh.ms",e.STREAMHANDLER_PATCH_STREAM_LIST="zc.sh.psl"}(t.ZEGO_WEBRTC_ACTION||(t.ZEGO_WEBRTC_ACTION={})),function(e){e.ADD_PUBLISH_CDN_URL="zw.apcu",e.REMOVE_PUBLISH_CDN_URL="zw.rpcu",e.STOP_MIXER_TASK="zw.smt",e.ON_PUBLISH_STATE_UPDATE="zw.w.opsu",e.ON_PUBLISH_STATE_UPDATE_HANDLE="zw.w.opsuh",e.WECHATMINI_SETPREFERPLAYSOURCETYPE="zw.w.sppst.1",e.WECHATMINI_BIND_LISTENER="zw.w.bl",e.WECHATMINI_DELETE_LISTENER="zw.w.dl",e.WECHATMINI_UPDATE_PLAYER_STATE="zw.w.ups",e.WECHATMINI_UPDATE_PLAYER_NET_STATUS="zw.w.upns",e.WECHATMINI_SET_CUSTOM_SIGNAL_URL="zw.w.scsu",e.WECHATMINI_GET_NEXT_URL="zw.w.gnu",e.WECHATMINI_BIND_STREAM_CENTER_HANDLER="zw.w.bsch",e.WECHATMINI_BIND_RTM_LISTENER="zw.w.brl",e.PUBLISHMODULE_SET_PREFER_PUBLISH_SOURCE_TYPE="zw.pu.sppst.0",e.PUBLISHMODULE_START_PUBLISHING_STREAM="zw.pu.sps.0",e.PUBLISHMODULE_STOP_PUBLISHING_STREAM="zw.pu.sps.0.0",e.PUBLISHMODULE_FETCH_PUBLISH_STREAM_URL="zw.pu.fpsu.0",e.PUBLISHMODULE_HANDLE_FETCH_STREAM_PUBLISH_URL_RSP="zw.pu.hfspur.0",e.PUBLISHMODULE_DO_PUBLISH_STREAM="zw.pu.dps.0",e.PUBLISHMODULE_UPDATE_STREAM_INFO="zw.pu.upi",e.PUBLISHMODULE_HANDLE_STREAM_UPDATE_RSP="zw.pu.hsur",e.PLAYMODULE_START_PLAYING_STREAM="zw.pl.sps.1",e.PLAYMODULE_STOP_PLAYING_STREAM="zw.pl.sps.1.0",e.PLAYMODULE_START_PLAYING_STREAM_FROM_CDN="zw.pl.spsfc",e.PLAYMODULE_START_PLAYING_STREAM_FROM_BGP="zw.pl.spsfb",e.PLAYMODULE_DO_PLAY_STREAM="zw.pl.dps",e.PLAYMODULE_FETCH_PLAY_STREAM_URL="zw.pl.fpsu",e.PLAYMODULE_HANDLE_FETCH_STREAM_URL_RSP="zw.pl.hfsur",e.STREAMCENTERWECHAT_RESET="zw.scw.r.0",e.STREAMCENTERWECHAT_START_PUBLISHING_STREAM="zw.scw.sps.0",e.STREAMCENTERWECHAT_START_PLAYING_STREAM="zw.scw.sps.1",e.STREAMCENTERWECHAT_START_PLAYER="zw.scw.sp.0",e.STREAMCENTERWECHAT_ON_STREAM_URL_UPDATE="zw.scw.opuu.0",e.STREAMCENTERWECHAT_UPDATE_PLAYER_STATE="zw.scw.ups.0",e.STREAMCENTERWECHAT_UPDATE_PLAYER_NET_STATUS="zw.scw.upns",e.STREAMCENTERWECHAT_UPDATE_PUBLISHING_STATE="zw.scw.ups.0.0",e.STREAMCENTERWECHAT_UPDATE_PLAYING_STATE="zw.scw.ups.1.0",e.STREAMCENTERWECHAT_GET_NEXT_URL="zw.scw.gnu",e.STREAMCENTERWECHAT_STOP_PUBLISHING_STREAM="zw.scw.sps.0.0",e.STREAMCENTERWECHAT_STOP_PLAYING_STREAM="zw.scw.sps.1.0",e.STREAMCENTERWECHAT_STOP_PLAYER="zw.scw.sp.1",e.STREAMCENTERWECHAT_ON_PLAY_START="zw.scw.ops.0",e.STREAMCENTERWECHAT_ON_PLAY_STOP="zw.scw.ops.1",e.STREAMCENTERWECHAT_ON_PLAY_RETRY="zw.scw.opr",e.PLAYWECHAT_TRY_START_PLAYER="zw.pw.tsp.0",e.PLAYWECHAT_UPDATE_EVENT="zw.pw.ue",e.PLAYWECHAT_GET_PLAY_URL="zw.pw.gpu"}(t.ZEGO_WECHATMINI_ACTION||(t.ZEGO_WECHATMINI_ACTION={}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errorCodeList=t.innerErrList=void 0,t.innerErrList={SUCCESS:{code:0,message:""},SEND_MSG_TIMEOUT:{code:"Error.Timeout",message:"send customessage timeout."}},t.errorCodeList={NOT_LOGIN:{code:1000002,message:"not login room"},STREAMID_TOO_LONG:{code:1000014,message:"stream ID is too long"},STREAM_ID_NULL:{code:1000015,message:"streamID is empty"},STREAM_ID_INVALID_CHARACTER:{code:1000016,message:"stream ID contains illegal characters"},NETWORK_BROKEN:{code:1000017,message:"network is broken"},LOCALSTREAM_WRONG:{code:1000018,message:"local stream wrong"},GET_SOUND_LEVEL_FAIL:{code:1000019,message:"get sound level error"},INPUT_PARAM:{code:1100001,message:"input parm error."},TIMEOUT:{code:1100002,message:"network timeout."},SOCKET_CLOSE:{code:1100003,msg:"socket close"},UNKNOWN_SERVER_ERROR:{code:1100999,message:"unknown server error"},INIT_SDK_WRONG:{code:1101e3,message:"init sdk wrong"},WX_GETSETTING_FAIL:{code:1101001,message:"wx getsetting fail"},USER_ID_NULL:{code:1002005,message:"user ID is empty"},USER_ID_INVALID_CHARACTER:{code:1002006,message:"user ID contains illegal characters"},USER_ID_TOO_LONG:{code:1002007,message:"user ID is too long"},USER_NAME_NULL:{code:1002008,message:"username is empty"},USER_NAME_TOO_LONG:{code:1002010,message:"username is too long"},ROOM_ID_NULL:{code:1002011,message:"room ID is empty"},ROOM_ID_INVALID_CHARACTER:{code:1002012,message:"room ID contains illegal characters"},ROOM_ID_TOO_LONG:{code:1002013,message:"room ID is too long"},LOGIN_TIMEOUT:{code:1002031,message:"login timeout"},ROOM_MAX_USER_COUNT:{code:1002034,message:"users logging into the room exceeds the maximum number"},MULTIPLE_LOGIN_KICKOUT:{code:1002050,message:"kickout may be the same user ID login other"},ROOM_RETRY_TIMEOUT:{code:1002053,message:"network is broken and login fail."},MANUAL_KICKOUT:{code:1002055,message:"server has sent a signal to kick out"},ROOM_INNER_ERROR:{code:1002099,message:"room inner error"},HEARTBEAT_TIMEOUT:{code:1102001,message:"heartbeat timeout."},PARSE_JSON_ERROR:{code:1102011,message:"parse json error."},LOGIN_PROCESSING:{code:1102012,message:"login is processing."},LIVEROMM_REQUEST_ERROR:{code:1102013,message:"liveroom request error."},ZPUSH_REQUEST_FAIL:{code:1102014,message:"zpush request fail."},LOGIN_STATE_WRONG:{code:1102015,message:"user login state is wrong."},TOKEN_ERROR:{code:1102016,message:"token error"},DISPATCH_ERROR:{code:1102017,message:"dispatch error"},TOKEN_EXPIRED:{code:1102018,message:"token expired"},SUBCMD_ERROR:{code:1102019,message:"subcmd error."},ZEGO_AUTH_ERROR:{code:1102020,message:"zego auth error."},BIZ_CHANNEL_ERROR:{code:1102021,message:"biz channel error."},DISPATCH_TIMEOUT:{code:1102022,message:"dispatch request timeout"},CONNECT_FAILED:{code:1102023,message:"connect signal fail"},PUBLISHER_EXTRA_INFO_NULL:{code:1003050,message:"extra info of publshing stream is null"},PUBLISHER_EXTRA_INFO_TOO_LONG:{code:1003051,message:"stream extra info is too long"},PUBLISHER_PARAM:{code:1103001,message:"input parm error"},PUBLISHER_BROWSER_NOT_SUPPORT:{code:1103002,message:"browser do not support"},PUBLISHER_DISPATCH_FAIL:{code:1103003,message:"dispatch request error"},PUBLISHER_SCREEN_FAILED:{code:1103010,message:"screen fail"},ENUMERATE_DEVICES_FAIL:{code:1103011,message:"enumerate devices fail"},PUBLISHER_DISPATCH_REQUEST_FAIL:{code:1103020,message:"dispatch request fail"},PUBLISHER_SESSION_REQUEST_FAIL:{code:1103021,message:"session request fail"},PUBLISHER_CREATE_OFFER_ERROR:{code:1103022,message:"create offer error"},PUBLISHER_SET_LOCAL_DESC_ERROR:{code:1103023,message:"setLocalDescription error"},PUBLISHER_MEDIA_DESC_ERROR:{code:1103024,message:"mediaDesc error"},PUBLISHER_SET_REMOTE_DESC_ERROR:{code:1103025,message:"other side offer error"},PUBLISHER_CANDIDATE_ERROR:{code:1103026,message:"candidate error"},PUBLISHER_SESSION_CLOSED:{code:1103027,message:"server session closed"},PUBLISHER_MEDIA_CONNECTION_ERROR:{code:1103028,message:"ice connection error"},PUBLISHER_CONSTRAINTS_ERROR:{code:1103029,message:"constraint error"},PUBLISHER_SERVER_NEGO_TIMEOUT:{code:1103030,message:"negotiation timeout"},PUBLISH_NOT_PUBLISH:{code:1103040,message:"publisher not found"},PUBLISH_DEVICE_OUT_ERR:{code:1103041,message:"device change "},PUBLISH_SCREEN_CANCELED:{code:1103042,message:"screen canceled"},PUBLISH_SCREEN_NOT_SUPPORT:{code:1103043,message:"screen not support"},PUBLISH_NO_PREVIEW:{code:1103044,message:"stream is not from zego"},VIDEO_DEVICE_FALSE:{code:1103045,message:"video is false"},AUDIO_DEVICE_FALSE:{code:1103046,message:"audio is false"},TRACK_NOT_FOUND:{code:1103047,message:"track is not found"},DEVICE_NOT_FOUND:{code:1103048,message:"device is not found"},REPEATED_PULL:{code:1103049,message:"repeated pull same stream"},PUBLISHER_WEBSOCKET_DISCONNECTED:{code:1103050,message:"websocket disconnected"},PUBLISHER_RETRY_TIMEOUT:{code:1103051,message:"publisher retry timeout"},PUBLISHER_CDN_PUSH_ERROR:{code:1103052,message:"publisher cdn push error"},PUBLISHER_HTTPS_REQUIRED:{code:1103053,message:"https is required"},PUBLISHER_NO_PREVIEW:{code:1103054,message:"no preview"},PUBLISHER_STREAM_NO_FOUND:{code:1103055,message:"publish stream no found"},PUBLISHER_IS_PUBLISHING:{code:1103056,message:"publish is publishing"},PUBLISHER_DECODE_AUDIO_FAIL:{code:1103057,message:"decode audio data fail"},PUBLISHER_CLIENT_IP_CHANGED:{code:1103058,message:"client ip changed"},PUBLISHER_TTL_OVERTIME:{code:1103059,message:"ttl over time"},PUBLISHER_SESSION_TIMEOUT:{code:1103060,message:"session request timeout"},PUBLISHER_GET_USER_MEDIA_FAIL:{code:1103061,message:"get media fail"},PLAYER_PARAM:{code:1104001,message:"input parm error"},PLAYER_DISPATCH_REQUEST_FAIL:{code:1104020,message:"dispatch request fail"},PLAYER_SESSION_REQUEST_FAIL:{code:1104021,message:"session request fail"},PLAYER_CREATE_OFFER_ERROR:{code:1104022,message:"create offer error"},PLAYER_SET_LOCAL_DESC_ERROR:{code:1104023,message:"setLocalDescription error"},PLAYER_MEDIA_DESC_ERROR:{code:1104024,message:"mediaDesc error"},PLAYER_SET_REMOTE_DESC_ERROR:{code:1104025,message:"other side offer error"},PLAYER_CANDIDATE_ERROR:{code:1104026,message:"candidate error"},PLAYER_SESSION_CLOSED:{code:1104027,message:"server session closed"},PLAYER_MEDIA_CONNECTION_ERROR:{code:1104028,message:"ice connection error"},PLAYER_WEBSOCKET_DISCONNECTED:{code:1104029,message:"websocket disconnected"},PLAYER_SERVER_NEGO_TIMEOUT:{code:1104030,message:"negotiation timeout"},PLAYER_RETRY_TIMEOUT:{code:1104031,message:"player retry timeout"},PLAYER_IS_PLAYING:{code:1104032,message:"player is playing"},PLAYER_CLIENT_IP_CHANGED:{code:1104033,message:"client ip changed"},PLAYER_TTL_OVERTIME:{code:1104034,message:"ttl is over time"},PLAYER_SESSION_RESET:{code:1104035,message:"reset session push"},PLAYER_SESSION_TIMEOUT:{code:1104036,message:"session request timeout"},PLAYER_PROBE_TIMEOUT:{code:1104037,message:"probe time out"},MIXER_NO_SERVICES:{code:1005e3,message:"no mix stream service"},MIXER_TASK_ID_NULL:{code:1005001,message:"mixer task is null"},MIXER_TASK_ID_TOO_LONG:{code:1005002,message:"task ID is too long"},MIXER_TASK_ID_INVALID_CHARACTER:{code:1005003,message:"task ID contains illegal characters"},MIXER_NO_OUTPUT_TARGET:{code:1005005,message:"task configuration does not specify output"},MIXER_OUTPUT_TARGET_INVALID:{code:1005006,message:"stream output target is incorrect"},MIXER_START_REQUEST_ERROR:{code:1005010,message:"start mixer task fail, possibly due to network reasons"},MIXER_STOP_REQUEST_ERROR:{code:1005011,message:"stop mixer task fail, possibly due to network reasons"},MIXER_NOT_OWNER_STOPMIXER:{code:1005012,message:" maxed task must be stopped by the start user of the task"},MIXER_INPUTLIST_NULL:{code:1005020,message:"Mixed stream task input list is null"},MIXER_OUTPUTLIST_NULL:{code:1005021,message:"Mixed stream task output list is null"},MIXER_VIDEO_CONFIG_INVALID:{code:1005023,message:"invalid mixed stream task video configuration"},MIXER_EXCEED_MAX_INPUT_COUNT:{code:1005025,message:"more than the maximum number of input streams"},MIXER_INPUT_STREAM_NOT_EXISTS:{code:1005026,message:"Input stream does not exist"},MIXER_INPUT_PARAMETERS_ERROR:{code:1005027,message:"stream input parameters are wrong"},MIXER_EXCEED_MAX_OUTPUT_COUNT:{code:1005030,message:"more than the maximum number of output streams"},MIXER_AUTHENTICATION_FAILED:{code:1005050,message:"mixed stream authentication failed"},MIXER_WATERMARK_NULL:{code:1005061,mag:"input watermark is null"},MIXER_WATERMARK_PARAMETERS_ERROR:{code:1005062,message:"input watermark parameter is wrong"},MIXER_WATERMARK_URL_INVALID:{code:1005063,message:"illegal input watermark URL"},MIXER_BACKGROUND_IMAGE_URL_INVALID:{code:1005067,message:"illegal input background image URL"},MIXER_INNER_ERROR:{code:1005099,message:"mixed stream internal error"},DEVICE_ERROR_TYPE_UNPLUGGED:{code:1006006,message:"the device is unplugged"},IM_CONTENT_NULL:{code:1009001,message:"message content is empty"},IM_CONTENT_TOO_LONG:{code:1009002,message:"message content is too long"},IM_SEND_FAILED:{code:1009010,message:"failed to send message"},FREQ_LIMITED:{code:1109001,message:"frequency limited."}}},function(e,t,r){"use strict";var i=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var s=arguments[t],a=0,n=s.length;a<n;a++,o++)i[o]=s[a];return i};Object.defineProperty(t,"__esModule",{value:!0}),t.SdpUtil=void 0;var o=function(){function e(){}return e.zegoSdp=function(e){var t=e.split("\r\n"),r=[],o=[];t.forEach((function(e){var t=e.match(/a=rtpmap:(\d+)\s+((H264\/90000)|(opus\/48000\/2))/);t&&t[1]&&t[2]&&("H264/90000"===t[2]&&r.push(t[1]),"opus/48000/2"===t[2]&&o.push(t[1]))}));var s=[];return t.map((function(e){var t=!0,a=e.match(/((a=rtcp-fb:)|(a=rtpmap:)|(a=fmtp:))(\d+)/);if(a&&a[5]&&(i(r,o).some((function(e){return e==a[5]}))||(t=!1)),e.indexOf("m=video")>-1){var n=e.split(" ");e=i([n[0],n[1],n[2]],r).join(" ")}else if(e.indexOf("m=audio")>-1){n=e.split(" ");e=i([n[0],n[1],n[2]],o).join(" ")}t&&s.push(e)})),s.join("\r\n")},e.getSDPByVideDecodeType=function(e,t){var r={str:"",arr:[],obj:{H264:[],H265:[],VP8:[],VP9:[],OHTER:[]}};if(!e.includes("m=video"))return e;var o=/m=video.+/.exec(e)[0];o=o.match(/[\s|\d]+/g)[1].replace(" ",""),r.str=o,r.arr=r.str.split(" "),r.arr.forEach((function(t){var i=new RegExp("a=rtpmap:"+t+".+").exec(e)[0];i.includes("H264")?r.obj.H264.push(t):i.includes("H265")?r.obj.H265.push(t):i.includes("VP8")?r.obj.VP8.push(t):i.includes("VP9")?r.obj.VP9.push(t):r.obj.OHTER.push(t)})),r.obj.OHTER.forEach((function(t){var i=new RegExp("a=fmtp:"+t+".+apt=(\\d+)").exec(e),o=i&&i[1];o&&(r.obj.H264.includes(o)?r.obj.H264.push(t):r.obj.H265.includes(o)?r.obj.H265.push(t):r.obj.VP8.includes(o)?r.obj.VP8.push(t):r.obj.VP9.includes(o)&&r.obj.VP9.push(t))}));var s=[];return"VP9"===t?s=i(r.obj.H265,r.obj.H264,r.obj.VP8):"VP8"===t?s=i(r.obj.H265,r.obj.H264,r.obj.VP9):"H264"===t?s=i(r.obj.H265,r.obj.VP8,r.obj.VP9):"H265"===t&&(s=i(r.obj.VP8,r.obj.H264,r.obj.VP9)),s.forEach((function(t){var i=r.arr.indexOf(t);r.arr.splice(i,1);var o=new RegExp("a=rtpmap:"+t+".+\\s\\n","g"),s=new RegExp("a=rtcp-fb:"+t+".+\\s\\n","g"),a=new RegExp("a=fmtp:"+t+".+\\s\\n","g");e=(e=(e=e.replace(o,"")).replace(s,"")).replace(a,"")})),e=e.replace(o,r.arr.join(" "))},e}();t.SdpUtil=o},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoWebRTC=void 0;var o=r(0),s=r(2),a=r(13),n=r(14),c=r(3),d=r(1),l=r(15),u=function(){function e(e,t,r){this.mediaEleSources=[],this.logger=e,this.dataReport=t,this.ac=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),this.stateCenter=new a.StateCenter(this.logger,this.dataReport),this.stateCenter.clientType="webrtc",this.RTM=r,this.rtcModules=new l.RTCModules(this.logger,this.dataReport,this.stateCenter,this.RTM,this.ac),this.stateCenter.networkState=navigator?navigator.onLine?o.ENUM_NETWORK_STATE.online:o.ENUM_NETWORK_STATE.offline:o.ENUM_NETWORK_STATE.online}return e.prototype.mutePublishStreamVideo=function(e,t){this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PUBLISH_STREAM_VIDEO+" call");var r=o.getReportSeq();if(this.dataReport.newReport(r,d.ZegoRTCLogEvent.kZegoTaskMutePublishVideo),"boolean"!=typeof t)return this.logger.error(c.ZEGO_WEBRTC_ACTION.MUTE_PUBLISH_STREAM_VIDEO+" option error"),!1;var i=this.rtcModules.advancedModule.enableStream(e,{video:!t});return this.dataReport.uploadReport(r),this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PUBLISH_STREAM_VIDEO+" end"),i},e.prototype.mutePublishStreamAudio=function(e,t){this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PUBLISH_STREAM_AUDIO+" call");var r=o.getReportSeq();if(this.dataReport.newReport(r,d.ZegoRTCLogEvent.kZegoTaskMutePublishAudio),"boolean"!=typeof t)return this.logger.error(c.ZEGO_WEBRTC_ACTION.MUTE_PUBLISH_STREAM_AUDIO+" option error"),!1;var i=this.rtcModules.advancedModule.enableStream(e,{audio:!t});return this.dataReport.uploadReport(r),this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PUBLISH_STREAM_AUDIO+" end"),i},e.prototype.mutePlayStreamVideo=function(e,t){this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PLAY_STREAM_VIDEO+" call "+e+" "+t);var r=o.getReportSeq();this.dataReport.newReport(r,d.ZegoRTCLogEvent.kZegoTaskMutePlayVideo);var i=this.rtcModules.playModule.mutePlayStream(e,"video",t);return this.dataReport.uploadReport(r),this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PLAY_STREAM_VIDEO+" end"),i},e.prototype.mutePlayStreamAudio=function(e,t){this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PLAY_STREAM_AUDIO+" call "+e+" "+t);var r=o.getReportSeq();this.dataReport.newReport(r,d.ZegoRTCLogEvent.kZegoTaskMutePlayAudio);var i=this.rtcModules.playModule.mutePlayStream(e,"audio",t);return this.dataReport.uploadReport(r),this.logger.info(c.ZEGO_WEBRTC_ACTION.MUTE_PLAY_STREAM_AUDIO+"end"),i},e.prototype.setAudioOutput=function(e,t){return this.logger.info(c.ZEGO_WEBRTC_ACTION.SET_AUDIO_OUTPUT+" call"),"string"!=typeof t?(this.logger.error("audiooutput is not string"),!1):this.rtcModules.playModule.setStreamAudioOutput(e,t)},e.prototype.setCustomSignalUrl=function(e){if(this.logger.info(c.ZEGO_WEBRTC_ACTION.SET_CUSTOM_SIGNAL_URL+" call: "+e),e&&0!=e.length){var t=!0;e.forEach((function(e){return 0!=e.indexOf("wss://")&&(t=!1)})),t?this.stateCenter.customUrl=e:this.logger.error(c.ZEGO_WEBRTC_ACTION.SET_CUSTOM_SIGNAL_URL+" url is not correct")}else this.logger.error(c.ZEGO_WEBRTC_ACTION.SET_CUSTOM_SIGNAL_URL+" param error")},e.prototype.setQualityMonitorCycle=function(e){return"number"==typeof e&&e>=1e3?(this.rtcModules.streamCenter.setQualityMonitorCycle(e),!0):(this.logger.error("zc.sqmc.0 time must be number and bigger than 1000"),!1)},e.prototype.startPlayingStream=function(e,t){return this.logger.info(c.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+"call by user"),this.rtcModules.playModule.startPlayingStream(e,t)},e.prototype.stopPlayingStream=function(e){this.logger.info(c.ZEGO_WEBRTC_ACTION.STOP_PLAYING_STREAM+"call by user"),this.rtcModules.playModule.stopPlayingStream(e)},e.prototype.setTurnOverTcpOnly=function(e){this.logger.info(c.ZEGO_WEBRTC_ACTION.SET_TURN_OVER_TCP_ONLY+" call "+e),"boolean"==typeof e?this.stateCenter.turnOverTcpOnly=e:this.logger.error("zc.p.stoto.0 param must be param")},e.prototype.createStream=function(e){return this.rtcModules.publishModule.createStream(e)},e.prototype.destroyStream=function(e){this.rtcModules.publishModule.destroyStream(e)},e.prototype.startPublishingStream=function(e,t,r){return this.logger.info(c.ZEGO_WEBRTC_ACTION.START_PUBLISHING_STREAM+"call by user"),this.rtcModules.publishModule.startPublishingStream(e,t,r)},e.prototype.stopPublishingStream=function(e){return this.logger.info(c.ZEGO_WEBRTC_ACTION.STOP_PUBLISHING_STREAM+"call by user"),this.rtcModules.publishModule.stopPublishingStream(e)},e.prototype.setVideoConfig=function(e,t){return this.rtcModules.advancedModule.setVideoConfig(e,t)},e.prototype.setAudioConfig=function(e,t){return this.rtcModules.advancedModule.setAudioConfig(e,t)},e.prototype.replaceTrack=function(e,t){return this.rtcModules.advancedModule.replaceTrack(e,t)},e.prototype.preloadEffect=function(e,t,r){this.rtcModules.audioMixModule.preloadEffect(e,t,r)},e.prototype.playEffect=function(e,t,r){this.rtcModules.audioMixModule.playEffect(e,t,r)},e.prototype.pauseEffect=function(e,t){return this.rtcModules.audioMixModule.pauseEffect(e,t)},e.prototype.resumeEffect=function(e,t){return this.rtcModules.audioMixModule.resumeEffect(e,t)},e.prototype.stopEffect=function(e,t){return this.rtcModules.audioMixModule.stopEffect(e,t)},e.prototype.unloadEffect=function(e){return this.rtcModules.audioMixModule.unloadEffect(e)},e.prototype.setEffectVolume=function(e,t,r){return this.rtcModules.audioMixModule.setEffectVolume(e,t,r)},e.prototype.startMixingAudio=function(e,t){return this.rtcModules.audioMixModule.startMixingAudio(e,t)},e.prototype.stopMixingAudio=function(e,t){return this.rtcModules.audioMixModule.stopMixingAudio(e,t)},e.prototype.mixingBuffer=function(e,t,r,i){this.rtcModules.audioMixModule.mixingBuffer(e,t,r,i)},e.prototype.stopMixingBuffer=function(e,t){return this.rtcModules.audioMixModule.stopMixingBuffer(e,t)},e.prototype.setMixingAudioVolume=function(e,t,r){return this.rtcModules.audioMixModule.setMixingAudioVolume(e,t,r)},e.prototype.checkSystemRequirements=function(t,r){var i=this,a=navigator&&navigator.mediaDevices&&(e.screenShotReady||"getDisplayMedia"in navigator.mediaDevices);return this.logger.info(c.ZEGO_WEBRTC_ACTION.CHECK_SUPPORT+" call"+navigator.userAgent),new Promise((function(e){var n=o.getReportSeq();i.dataReport.newReport(n,d.ZegoRTCLogEvent.kZegoTaskCheckSystemRequirements.event);var c=r||"all",l=function(t){i.dataReport.addMsgInfo(n,{capability:d.ZegoRTCLogEvent.kZegoTaskCheckSystemRequirements.capability(t)}),i.dataReport.uploadReport(n);var r=i.stateCenter.checkList.indexOf(c);i.stateCenter.checkList.splice(r,1),e(t)};return["webRTC","customCapture","camera","microphone","screenSharing","H264","VP8","all"].includes(c)&&[0,1].includes(t)?i.stateCenter.checkList.includes(c)||i.stateCenter.checkList.includes("all")?l({result:!1,errInfo:{extendedDate:"The last test of the same type has not returned a result "}}):(i.stateCenter.checkList.push(c),void s.ClientUtil.supportDetection(a,l,t,r)):l({result:!1,errInfo:{extendedDate:"param error"}})}))},e.prototype.enumDevices=function(){var e=this;return this.logger.info("zc.ed.0 call"),new Promise((function(t,r){var i=o.getReportSeq();e.dataReport.newReport(i,d.ZegoRTCLogEvent.kZegoTaskEnumDevices.event);s.ClientUtil.getDevices((function(r){var o=[];r.cameras.forEach((function(e){return o.push({device:e.deviceName,type:0})})),r.microphones.forEach((function(e){return o.push({device:e.deviceName,type:1})})),r.speakers.forEach((function(e){return o.push({device:e.deviceName,type:2})})),e.dataReport.addMsgInfo(i,{dev_list:d.ZegoRTCLogEvent.kZegoTaskEnumDevices.dev_list(o)}),e.dataReport.uploadReport(i),t(r)}),(function(t){e.dataReport.addMsgInfo(i,t),e.dataReport.uploadReport(i),r(t)}))}))},e.prototype.getAudioInfo=function(e,t,r){if(!e)return this.logger.error("loclStream is empty!"),!1;var o=i({},r);return new n.MediaUtil(this.ac,o).connectToSource(e,(function(e){t(e)}))},e.prototype.getSoundLevel=function(e,t,r){this.rtcModules.audioMixModule.getSoundLevel(e,t,r)},e.prototype.stopSoundLevel=function(e){this.logger.info("zc.ssl call");var t=o.getReportSeq();this.dataReport.newReport(t,d.ZegoRTCLogEvent.kZegoTaskStopSoundLevel);var r=this.stateCenter.audioStreamList[e.id];r.mic.disconnect(),r.script.disconnect(),delete this.stateCenter.audioStreamList[e.id],this.dataReport.uploadReport(t)},e.handleDataAvailable=function(t){t.data&&t.data.size>0&&e.recordedBlobs.push(t.data)},e.prototype.startRecord=function(t){var r=this,i=t.captureStream();e.recordedBlobs=[];var s={mimeType:"video/webm;codecs=vp9"};o.MediaRecorder.isTypeSupported(s.mimeType)||(s={mimeType:"video/webm;codecs=vp8"},o.MediaRecorder.isTypeSupported(s.mimeType)||(s={mimeType:"video/webm"},o.MediaRecorder.isTypeSupported(s.mimeType)||(s={mimeType:""})));try{e.mediaRecorder=new o.MediaRecorder(i,s)}catch(e){return void this.logger.error("Exception while creating ZegoMediaRecorder:",e)}e.mediaRecorder.onstop=function(e){r.logger.warn("Recorder stopped: "+e)},e.mediaRecorder.ondataavailable=e.handleDataAvailable,e.mediaRecorder.start(10)},e.prototype.stopRecord=function(){e.mediaRecorder?e.mediaRecorder.stop():this.logger.warn("please invoke startRecord first")},e.prototype.resumeRecord=function(){e.mediaRecorder?e.mediaRecorder.resume():this.logger.warn("please invoke startRecord first")},e.prototype.pauseRecord=function(){e.mediaRecorder?e.mediaRecorder.pause():this.logger.warn("please invoke startRecord first")},e.prototype.saveRecord=function(t){if(e.mediaRecorder&&e.recordedBlobs){var r=new Blob(e.recordedBlobs,{type:"video/webm"}),i=window.URL.createObjectURL(r),o=document.createElement("a");o.style.display="none",o.href=i,o.download=t+".webm",document.body.appendChild(o),o.click(),setTimeout((function(){document.body.removeChild(o),window.URL.revokeObjectURL(i)}),100)}else this.logger.warn("please invoke startRecord first")},e.prototype.takeSnapShot=function(e,t){if(e&&0!==e.videoHeight){var r=document.createElement("canvas");r.width=e.videoWidth,r.height=e.videoHeight;var i=r.getContext("2d");i&&i.drawImage(e,0,0,r.width,r.height),t.src=r.toDataURL("image/jpeg")}else this.logger.error("video can not empty")},e.prototype.saveSnapShot=function(e,t){if(e&&0!==e.videoHeight){var r=document.createElement("canvas");r.width=e.videoWidth,r.height=e.videoHeight;var i=r.getContext("2d");i&&i.drawImage(e,0,0,r.width,r.height),r.toBlob((function(e){var r=window.URL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=r,i.download=t+".jpeg",document.body.appendChild(i),i.click(),setTimeout((function(){document.body.removeChild(i),window.URL.revokeObjectURL(r)}),100)}))}else this.logger.error("video can not empty")},e.prototype.useVideoDevice=function(e,t){return this.rtcModules.advancedModule.useVideoDevice(e,t)},e.prototype.useAudioDevice=function(e,t){return this.rtcModules.advancedModule.useAudioDevice(e,t)},e.prototype.setSoundLevelDelegate=function(e,t){this.logger.info("zc.ssd.0 call"),"boolean"==typeof e?t&&(!s.ClientUtil.checkInteger(t)||t<100||t>3e3)?this.logger.error("zc.ssd.0 soundLevel interval must be integer number which is between 100 and 3000"):this.rtcModules.streamCenter.setSoundLevelDelegate(e,t):this.logger.error("zc.ssd.0 param 1 must be boolean")},e.prototype.on=function(e,t){return this.rtcModules.bindListener(e,t)},e.prototype.off=function(e,t){return this.rtcModules.deleteListener(e,t)},e.prototype.getVersion=function(){return o.PROTO_VERSION},e.prototype.setStreamExtraInfo=function(e,t){return this.rtcModules.streamHandler.setStreamExtraInfo(e,t)},e.prototype.addPublishCdnUrl=function(e,t){return this.logger.info("zg.cm.apu call ",e,t),this.rtcModules.streamHandler.publishTarget({type:"addpush",streamID:e,pushUrl:t})},e.prototype.removePublishCdnUrl=function(e,t){return this.logger.info("zg.cm.apu call ",e,t),this.rtcModules.streamHandler.publishTarget({type:"delpush",streamID:e,pushUrl:t})},e.prototype.startMixerTask=function(e){var t=this;return new Promise((function(r,i){e.outputConfig&&e.outputConfig.outputFps&&(e.outputConfig.outputFPS=e.outputConfig.outputFps);var a=o.getReportSeq();t.dataReport.newReport(a,d.ZegoRTCLogEvent.kZegoTaskMixStart.event),s.ClientUtil.logReportCallback("kZegoTaskMixStart"+e.taskID,t.dataReport,a,t.stateCenter.reportList);t.rtcModules.streamHandler.updateMixStream(e,(function(i){t.dataReport.uploadReport(a),s.ClientUtil.unregisterCallback("kZegoTaskMixStart"+e.taskID,t.stateCenter.reportList),r(i)}),(function(r){var o,n,c;r.errorCode<2e9&&r.errorCode>1e9?(o=s.ClientUtil.mixServerError(r.errorCode)[0],c=errorList[o],n=s.ClientUtil.mixServerError(r.errorCode)[1]):r.errorCode<1e6&&(c=s.ClientUtil.decodeServerError(r.errorCode,r.extendedData),n=s.ClientUtil.getLiveRoomError(r.errorCode)),c?t.dataReport.addMsgInfo(a,c):t.dataReport.addMsgInfo(a,r),t.dataReport.uploadReport(a),s.ClientUtil.unregisterCallback("kZegoTaskMixStart"+e.taskID,t.stateCenter.reportList),n&&(r.errorCode=errorCodeList[n].code),i(r)}))}))},e.prototype.setMixerTaskConfig=function(e){var t=this;return new Promise((function(r,i){var a=o.getReportSeq();t.dataReport.newReport(a,d.ZegoRTCLogEvent.kZegoTaskMixConfig.event),s.ClientUtil.logReportCallback("kZegoTaskMixConfig",t.dataReport,a,t.stateCenter.reportList),t.rtcModules.streamHandler.setMixerTaskConfig(e).then((function(e){t.dataReport.uploadReport(a),s.ClientUtil.unregisterCallback("kZegoTaskMixConfig",t.stateCenter.reportList),r(e)})).catch((function(e){t.dataReport.addMsgInfo(a,e),t.dataReport.uploadReport(a),s.ClientUtil.unregisterCallback("kZegoTaskMixConfig",t.stateCenter.reportList),i(e)}))}))},e.prototype.stopMixerTask=function(e){var t=this;return new Promise((function(r,i){var a=o.getReportSeq();if(t.dataReport.newReport(a,d.ZegoRTCLogEvent.kZegoTaskMixStop.event),!e||"string"!=typeof e||e.length>o.MAX_MIX_TASK_ID_LENGTH||!s.ClientUtil.checkIllegalCharacters(e))return t.logger.error("zb.rh.lg taskID must be string less 256"),t.dataReport.addMsgInfo(a,{error:d.ZegoRTCLogEvent.kZegoTaskMixStop.error.kParamError.code,message:d.ZegoRTCLogEvent.kZegoTaskMixStop.error.kParamError.message+" param taskID error"}),t.dataReport.uploadReport(a),void i({errorCode:d.ZegoRTCLogEvent.kZegoTaskMixStop.error.kParamError.code,extendedData:d.ZegoRTCLogEvent.kZegoTaskMixStop.error.kParamError.message+" param taskID error"});t.rtcModules.streamHandler.stopMixStream(e,(function(e){t.dataReport.uploadReport(a),r(e)}),(function(e){var r,n,c;e.errorCode<2e9&&e.errorCode>1e9?(r=s.ClientUtil.mixServerError(e.errorCode-o.MIXSTREAM_ERROR_CODE)[0],n=errorList[r],c=s.ClientUtil.mixServerError(e.errorCode-o.MIXSTREAM_ERROR_CODE)[1]):e.errorCode<1e6&&(n=s.ClientUtil.decodeServerError(e.errorCode,e.extendedData),c=s.ClientUtil.getLiveRoomError(e.errorCode)),n?t.dataReport.addMsgInfo(a,n):t.dataReport.addMsgInfo(a,e),t.dataReport.uploadReport(a),c&&(e.errorCode=errorCodeList[c].code),i(e)}))}))},e.prototype.setCaptureVolume=function(e,t){return this.rtcModules.publishModule.setCaptureVolume(e,t)},e.screenShotReady=!1,e}();t.ZegoWebRTC=u,window.addEventListener("message",(function(e){var t=e.data.type,r=e.origin;r!==window.location.origin&&console.warn("ScreenStream: you should discard foreign event from origin:",r),"SS_PING"===t&&(u.screenShotReady=!0)}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoPreview=void 0;var i=r(0),o=r(1),s=function(){function e(e){var t=this;this.localStream=null,this.videoInfo={},this.previewSuc=!1,this.isScreen=!1,this.micTrack=null,this.gainNode=null,this.enableMicrophone=function(e,r){if(!t.localStream)return t.logger.error("zp.em.2 no localStream"),!1;for(var o in t.localStream.getAudioTracks().forEach((function(t){t.enabled=e})),t.micTrack&&(t.micTrack.enabled=e),r.publisherList){var s=r.publisherList[o].publisher;s.localStream==t.localStream&&s.signal.sendStreamStatus(i.getSeq(),s.sessionId,t.localStream.getVideoTracks()[0]&&!0===t.localStream.getVideoTracks()[0].enabled?0:2,e?0:2,s.streamId)}return t.logger.debug("zp.em.2 call success"),!0},this.enableCamera=function(e,r){if(!t.localStream)return t.logger.error("zp.ec.2 no localStream"),!1;for(var o in t.localStream.getVideoTracks().forEach((function(r){if(r.enabled=e,e&&void 0!==typeof r.getSettings().width&&r.getSettings().width>0){var i=r.getSettings().width-1;r.applyConstraints({width:i}),setTimeout((function(){r.applyConstraints({width:t.videoInfo.width})}),200)}})),r.publisherList){var s=r.publisherList[o].publisher;s.localStream==t.localStream&&s.signal.sendStreamStatus(i.getSeq(),s.sessionId,e?0:2,t.localStream.getAudioTracks()[0]&&1==t.localStream.getAudioTracks()[0].enabled?0:2,s.streamId)}return t.logger.debug("zp.ec.2 call success"),!0},this.logger=e}return e.prototype.getMediaStreamConstraints=function(e,t){var r={audio:null,video:null};if(r.audio=!0,r.video={width:640,height:480,frameRate:15,bitRate:800},e.audio?void 0===e.audioInput&&void 0===e.ANS&&void 0===e.AGC&&void 0===e.AEC&&void 0===e.channelCount?(r.audio={},r.audio.noiseSuppression=!0,r.audio.autoGainControl=!0,r.audio.echoCancellation=!0,r.audio.channelCount=1):(r.audio={},void 0!==e.audioInput&&null!==e.audioInput&&(r.audio.deviceId=e.audioInput),void 0!==e.ANS&&(r.audio.noiseSuppression=e.ANS),void 0!==e.AGC&&(r.audio.autoGainControl=e.AGC),void 0!==e.AEC&&(r.audio.echoCancellation=e.AEC),void 0!==e.channelCount&&(r.audio.channelCount=e.channelCount)):!1===e.audio&&(r.audio=!1),e.video){var o=640,s=480,a=15,n=800;if(1===e.videoQuality?(o=i.ENUM_RESOLUTION_TYPE.LOW.width,s=i.ENUM_RESOLUTION_TYPE.LOW.height,a=i.ENUM_RESOLUTION_TYPE.LOW.frameRate,n=i.ENUM_RESOLUTION_TYPE.LOW.bitRate):2===e.videoQuality?(o=i.ENUM_RESOLUTION_TYPE.MEDIUM.width,s=i.ENUM_RESOLUTION_TYPE.MEDIUM.height,a=i.ENUM_RESOLUTION_TYPE.MEDIUM.frameRate,n=i.ENUM_RESOLUTION_TYPE.MEDIUM.bitRate):3===e.videoQuality?(o=i.ENUM_RESOLUTION_TYPE.HIGH.width,s=i.ENUM_RESOLUTION_TYPE.HIGH.height,a=i.ENUM_RESOLUTION_TYPE.HIGH.frameRate,n=i.ENUM_RESOLUTION_TYPE.HIGH.bitRate):4===e.videoQuality?(o=e.width,s=e.height,a=e.frameRate,n=e.bitRate||800):this.logger.info("zp.gmsc.2 use default"),t&&(e.width&&(o=e.width),e.height&&(s=e.height),e.frameRate&&(a=e.frameRate),e.bitRate&&(n=e.bitRate)),!1===e.horizontal){var c=s;s=o,o=c}if(!0===e.isSwitch){c=s;s=o,o=c}r.video={width:o,height:s,frameRate:a,bitRate:n},null!=e.facingMode?r.video.facingMode=e.facingMode:null!=e.videoInput&&null!=e.videoInput&&""!=e.videoInput&&(r.video.deviceId={exact:e.videoInput}),this.logger.info("zp.gmsc.2 width: "+o+" height: "+s+" rate: "+a)}else!1===e.video&&(r.video=!1);return r},e.prototype.startPreview=function(e,t,r){var i=this;if(this.logger.debug("zp.sv.2 called"),this.mediaStreamConfig=e,void 0!==navigator.mediaDevices&&null!=navigator.mediaDevices.getUserMedia){if(e.source instanceof MediaStream){var s=e.source.getVideoTracks(),a=s.length>0?s[0].getSettings():{width:0,height:0,frameRate:0};return this.logger.debug("zp.sv.2 use external media stream"),this.previewSuc=!0,this.localStream=e.source,e.source.getAudioTracks().length>0&&(this.micTrack=e.source.getAudioTracks()[0]),this.videoInfo={width:a.width,height:a.height,frameRate:a.frameRate,bitRate:e.bitRate||0,channelCount:e.channelCount||(this.micTrack&&this.micTrack.getSettings?this.micTrack.getSettings().channelCount:1),audioBitrate:1e3*e.audioBitrate||48e3},void(t&&t(this.localStream))}if(e.source instanceof HTMLMediaElement){var n=this.captureStream(e.source,e);n?(this.videoInfo.bitRate=e.bitRate||0,this.previewSuc=!0,n.getAudioTracks().length>0&&(this.micTrack=n.getAudioTracks()[0]),t&&t(n)):r&&r(o.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kBrowserNotSupportError)}else{var c=this.getMediaStreamConstraints(e);this.videoInfo=c.video,this.videoInfo&&(this.videoInfo.audioBitrate=1e3*e.audioBitrate||48e3),this.mediaStreamConfig.video=!!c.video,this.mediaStreamConfig.audio=!!c.audio,this.logger.info("zp.sv.2 ",JSON.stringify(c)),navigator.mediaDevices.getUserMedia(c).then((function(r){i.logger.info("zp.sv.2 success"),i.localStream=r,i.previewSuc=!0,r.getAudioTracks().length>0&&(i.micTrack=r.getAudioTracks()[0]),i.videoInfo&&(i.videoInfo.channelCount=e.channelCount||(i.micTrack&&i.micTrack.getSettings?i.micTrack.getSettings().channelCount:1)),t&&t(r)}),(function(e){if(i.logger.info("zp.sv.2 failed ",e.name," ",e.message),r){var t=o.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kGetUserMediaError;t.message=t.message+" "+e.name+e.message,r(t)}}))}}else r&&r(o.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kBrowserNotSupportError)},e.prototype.captureStream=function(e,t){if(!e)return this.logger.info("zp.cs.2 no local video"),null;var r;if(e.captureStream)r=e.captureStream(),this.logger.debug("zp.cs.2 captureStream");else{if(!e.mozCaptureStream)return this.logger.info("zp.cs.2 don't support"),null;r=e.mozCaptureStream(),this.logger.debug("zp.cs.2 mozCaptureStream")}return 0==r.getTracks().length?(this.logger.error("zp.cs.2 external capture tracks no found"),null):(this.localStream=r,this.videoInfo={width:e.videoWidth,height:e.videoHeight,frameRate:0,bitRate:0,channelCount:t.channelCount||(this.micTrack&&this.micTrack.getSettings?this.micTrack.getSettings().channelCount:1),audioBitrate:1e3*t.audioBitrate||48e3},this.logger.debug("zp.cs.2 called success"),this.localStream)},e.prototype.stopPreview=function(){if(this.logger.info("zp.sv.2.1 called"),this.localStream){var e=this.localStream.getTracks();e.reverse(),e.forEach((function(e){e.stop()})),this.micTrack&&this.micTrack.stop(),this.localStream=null,this.videoInfo={}}},e}();t.ZegoPreview=s},function(e,t,r){e.exports=function e(t,r,i){function o(a,n){if(!r[a]){if(!t[a]){if(s)return s(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var d=r[a]={exports:{}};t[a][0].call(d.exports,(function(e){return o(t[a][1][e]||e)}),d,d.exports,e,t,r,i)}return r[a].exports}for(var s=!1,a=0;a<i.length;a++)o(i[a]);return o}({1:[function(e,t,r){"use strict";var i=(0,e("./adapter_factory.js").adapterFactory)({window:window});t.exports=i},{"./adapter_factory.js":2}],2:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.window,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},d=i.log,l=i.detectBrowser(t),u={browserDetails:l,commonShim:c,extractVersion:i.extractVersion,disableLog:i.disableLog,disableWarnings:i.disableWarnings};switch(l.browser){case"chrome":if(!o||!o.shimPeerConnection||!r.shimChrome)return d("Chrome shim is not included in this adapter release."),u;d("adapter.js shimming chrome."),u.browserShim=o,o.shimGetUserMedia(t),o.shimMediaStream(t),o.shimPeerConnection(t),o.shimOnTrack(t),o.shimAddTrackRemoveTrack(t),o.shimGetSendersWithDtmf(t),o.shimGetStats(t),o.shimSenderReceiverGetStats(t),o.fixNegotiationNeeded(t),c.shimRTCIceCandidate(t),c.shimConnectionState(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t),c.removeAllowExtmapMixed(t);break;case"firefox":if(!a||!a.shimPeerConnection||!r.shimFirefox)return d("Firefox shim is not included in this adapter release."),u;d("adapter.js shimming firefox."),u.browserShim=a,a.shimGetUserMedia(t),a.shimPeerConnection(t),a.shimOnTrack(t),a.shimRemoveStream(t),a.shimSenderGetStats(t),a.shimReceiverGetStats(t),a.shimRTCDataChannel(t),c.shimRTCIceCandidate(t),c.shimConnectionState(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t);break;case"edge":if(!s||!s.shimPeerConnection||!r.shimEdge)return d("MS edge shim is not included in this adapter release."),u;d("adapter.js shimming edge."),u.browserShim=s,s.shimGetUserMedia(t),s.shimGetDisplayMedia(t),s.shimPeerConnection(t),s.shimReplaceTrack(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t);break;case"safari":if(!n||!r.shimSafari)return d("Safari shim is not included in this adapter release."),u;d("adapter.js shimming safari."),u.browserShim=n,n.shimRTCIceServerUrls(t),n.shimCreateOfferLegacy(t),n.shimCallbacksAPI(t),n.shimLocalStreamsAPI(t),n.shimRemoteStreamsAPI(t),n.shimTrackEventTransceiver(t),n.shimGetUserMedia(t),c.shimRTCIceCandidate(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t),c.removeAllowExtmapMixed(t);break;default:d("Unsupported browser!")}return u};var i=d(e("./utils")),o=d(e("./chrome/chrome_shim")),s=d(e("./edge/edge_shim")),a=d(e("./firefox/firefox_shim")),n=d(e("./safari/safari_shim")),c=d(e("./common_shim"));function d(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return o.shimGetUserMedia}});var s=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return s.shimGetDisplayMedia}}),r.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},r.shimOnTrack=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._ontrackpoly||(this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(i){var o=void 0;o=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===i.track.id})):{track:i.track};var s=new Event("track");s.track=i.track,s.receiver=o,s.transceiver={receiver:o},s.streams=[t.stream],r.dispatchEvent(s)})),t.stream.getTracks().forEach((function(i){var o=void 0;o=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===i.id})):{track:i};var s=new Event("track");s.track=i,s.receiver=o,s.transceiver={receiver:o},s.streams=[t.stream],r.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else a.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e}))},r.shimGetSendersWithDtmf=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){var o=r.apply(this,arguments);return o||(o=t(this,e),this._senders.push(o)),o};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){o.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach((function(e){r._senders.push(t(r,e))}))};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],a.apply(this,[e]),e.getTracks().forEach((function(e){var r=t._senders.find((function(t){return t.track===e}));r&&t._senders.splice(t._senders.indexOf(r),1)}))}}else if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var n=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=n.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},r.shimGetStats=function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,i){var o=this,s=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof arguments[0]))return t.apply(this,[]);var a=function(e){var t={};return e.result().forEach((function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){r[t]=e.stat(t)})),t[r.id]=r})),t},n=function(e){return new Map(Object.keys(e).map((function(t){return[t,e[t]]})))};if(arguments.length>=2){var c=function(e){s[1](n(a(e)))};return t.apply(this,[c,arguments[0]])}return new Promise((function(e,r){t.apply(o,[function(t){e(n(a(t)))},r])})).then(r,i)}}},r.shimSenderReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return a.filterStats(t,e.track,!0)}))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var o=e.RTCPeerConnection.prototype.getReceivers;o&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=o.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t}),a.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return a.filterStats(t,e.track,!1)}))}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,i=void 0,o=void 0;return this.getSenders().forEach((function(e){e.track===t&&(r?o=!0:r=e)})),this.getReceivers().forEach((function(e){return e.track===t&&(i?o=!0:i=e),e.track===t})),o||r&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return s.apply(this,arguments)}}}},r.shimAddTrackRemoveTrackWithNative=n,r.shimAddTrackRemoveTrack=function(e){if(e.RTCPeerConnection){var t=a.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return n(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((function(e){if(r.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){var o=new e.MediaStream(t.getTracks());this._streams[t.id]=o,this._reverseStreams[o.id]=t,t=o}i.apply(this,[t])};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},o.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var i=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var o=[].slice.call(arguments,1);if(1!==o.length||!o[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var s=this.getSenders().find((function(e){return e.track===t}));if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var a=this._streams[r.id];if(a)a.addTrack(t),Promise.resolve().then((function(){i.dispatchEvent(new Event("negotiationneeded"))}));else{var n=new e.MediaStream([t]);this._streams[r.id]=n,this._reverseStreams[n.id]=r,this.addStream(n)}return this.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this,t=arguments,i=arguments.length&&"function"==typeof arguments[0];return i?r.apply(this,[function(r){var i=d(e,r);t[0].apply(null,[i])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(this,arguments).then((function(t){return d(e,t)}))}}));var s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=l(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};var c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=c.get.apply(this);return""===e.type?e:d(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var r=void 0;Object.keys(this._streams).forEach((function(i){t._streams[i].getTracks().find((function(t){return e.track===t}))&&(r=t._streams[i])})),r&&(1===r.getTracks().length?this.removeStream(this._reverseStreams[r.id]):r.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function d(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var i=e._reverseStreams[t],o=e._streams[i.id];r=r.replace(new RegExp(o.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}function l(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var i=e._reverseStreams[t],o=e._streams[i.id];r=r.replace(new RegExp(i.id,"g"),o.id)})),new RTCSessionDescription({type:t.type,sdp:r})}},r.shimPeerConnection=function(e){if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}));var t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},r.fixNegotiationNeeded=function(e){a.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){if("stable"===e.target.signalingState)return e}))};var a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js"));function n(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var i=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(i)&&this._shimmedLocalStreams[r.id].push(i):this._shimmedLocalStreams[r.id]=[r,i],i};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var i=this.getSenders();r.apply(this,arguments);var o=this.getSenders().filter((function(e){return-1===i.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(o)};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(r){var i=t._shimmedLocalStreams[r].indexOf(e);-1!==i&&t._shimmedLocalStreams[r].splice(i,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]})),o.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((function(t){var i=r.video&&r.video.width,o=r.video&&r.video.height,s=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:s||3}},i&&(r.video.mandatory.maxWidth=i),o&&(r.video.mandatory.maxHeight=o),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices){var r=o.detectBrowser(e),a=function(e){if("object"!==(void 0===e?"undefined":i(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var o="object"===i(e[r])?e[r]:{ideal:e[r]};void 0!==o.exact&&"number"==typeof o.exact&&(o.min=o.max=o.exact);var s=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==o.ideal){t.optional=t.optional||[];var a={};"number"==typeof o.ideal?(a[s("min",r)]=o.ideal,t.optional.push(a),(a={})[s("max",r)]=o.ideal,t.optional.push(a)):(a[s("",r)]=o.ideal,t.optional.push(a))}void 0!==o.exact&&"number"!=typeof o.exact?(t.mandatory=t.mandatory||{},t.mandatory[s("",r)]=o.exact):["min","max"].forEach((function(e){void 0!==o[e]&&(t.mandatory=t.mandatory||{},t.mandatory[s(e,r)]=o[e])}))}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,o){if(r.version>=61)return o(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===i(e.audio)){var n=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};n((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),n(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=a(e.audio)}if(e&&"object"===i(e.video)){var c=e.video.facingMode;c=c&&("object"===(void 0===c?"undefined":i(c))?c:{ideal:c});var d=r.version<66;if(c&&("user"===c.exact||"environment"===c.exact||"user"===c.ideal||"environment"===c.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||d)){delete e.video.facingMode;var l=void 0;if("environment"===c.exact||"environment"===c.ideal?l=["back","rear"]:"user"!==c.exact&&"user"!==c.ideal||(l=["front"]),l)return t.mediaDevices.enumerateDevices().then((function(t){var r=(t=t.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return l.some((function(t){return e.label.toLowerCase().includes(t)}))}));return!r&&t.length&&l.includes("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=c.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=a(e.video),s("chrome: "+JSON.stringify(e)),o(e)}))}e.video=a(e.video)}return s("chrome: "+JSON.stringify(e)),o(e)},c=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,i){n(e,(function(e){t.webkitGetUserMedia(e,r,(function(e){i&&i(c(e))}))}))}.bind(t),t.mediaDevices.getUserMedia){var d=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e,(function(e){return d(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(c(e))}))}))}}}};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js")),s=o.log},{"../utils.js":15}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimRTCIceCandidate=function(e){if(!(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),o=a.default.parseCandidate(e.candidate),s=Object.assign(r,o);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,n.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t}))}},r.shimMaxMessageSize=function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=n.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=function(e){if(!e||!e.sdp)return!1;var t=a.default.splitSections(e.sdp);return t.shift(),t.some((function(e){var t=a.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},i=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r},o=function(e){var r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},s=function(e,r){var i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);var o=a.default.matchPrefix(e.sdp,"a=max-message-size:");return o.length>0?i=parseInt(o[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,r(arguments[0])){var e=i(arguments[0]),t=o(e),a=s(arguments[0],e),n=void 0;n=0===t&&0===a?Number.POSITIVE_INFINITY:0===t||0===a?Math.max(t,a):Math.min(t,a);var d={};Object.defineProperty(d,"maxMessageSize",{get:function(){return n}}),this._sctp=d}return c.apply(this,arguments)}}},r.shimSendThrowTypeError=function(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},n.wrapPeerConnectionEvent(e,"datachannel",(function(e){return r(e.channel,e.target),e}))}function r(e,t){var r=e.send;e.send=function(){var i=arguments[0],o=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&o>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}},r.shimConnectionState=function(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;var r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}},r.removeAllowExtmapMixed=function(e){if(e.RTCPeerConnection){var t=n.detectBrowser(e);if(!("chrome"===t.browser&&t.version>=71)){var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((function(e){return"a=extmap-allow-mixed"!==e.trim()})).join("\n")),r.apply(this,arguments)}}}};var o,s=e("sdp"),a=(o=s)&&o.__esModule?o:{default:o},n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("./utils"))},{"./utils":15,sdp:17}],7:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var o=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),r.shimPeerConnection=function(e){var t=a.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var i=(0,d.default)(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,n.filterIceServers)(e.iceServers,t.version),a.log("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype},r.shimReplaceTrack=function(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)};var s,a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils")),n=e("./filtericeservers"),c=e("rtcpeerconnection-shim"),d=(s=c)&&s.__esModule?s:{default:s}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.filterIceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&i.deprecated("RTCIceServer.url","RTCIceServer.urls");var o="string"==typeof t;return o&&(t=[t]),t=t.filter((function(e){if(0===e.indexOf("stun:"))return!1;var t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r})),delete e.url,e.urls=o?t[0]:t,!!t.length}}))};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}},{}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetUserMedia=function(e){var t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch((function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))}))}}},{}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return o.shimGetUserMedia}});var s=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return s.shimGetDisplayMedia}}),r.shimOnTrack=function(e){"object"===(void 0===e?"undefined":i(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimPeerConnection=function(e){var t=a.detectBrowser(e);if("object"===(void 0===e?"undefined":i(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}));var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var o={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,i){return s.apply(this,[e||null]).then((function(e){if(t.version<53&&!r)try{e.forEach((function(e){e.type=o[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,r){e.set(r,Object.assign({},t,{type:o[t.type]||t.type}))}))}return e})).then(r,i)}}},r.shimSenderGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpSender.prototype))){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},r.shimReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpReceiver.prototype))){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r}),a.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},r.shimRemoveStream=function(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;a.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(r){r.track&&e.getTracks().includes(r.track)&&t.removeTrack(r)}))})},r.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)};var a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){var i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Promise.reject(i)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}},{}],13:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t=o.detectBrowser(e),r=e&&e.navigator,s=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,i){o.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var a=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},n=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===(void 0===e?"undefined":i(e))&&"object"===i(e.audio)&&(e=JSON.parse(JSON.stringify(e)),a(e.audio,"autoGainControl","mozAutoGainControl"),a(e.audio,"noiseSuppression","mozNoiseSuppression")),n(e)},s&&s.prototype.getSettings){var c=s.prototype.getSettings;s.prototype.getSettings=function(){var e=c.apply(this,arguments);return a(e,"mozAutoGainControl","autoGainControl"),a(e,"mozNoiseSuppression","noiseSuppression"),e}}if(s&&s.prototype.applyConstraints){var d=s.prototype.applyConstraints;s.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===(void 0===e?"undefined":i(e))&&(e=JSON.parse(JSON.stringify(e)),a(e,"autoGainControl","mozAutoGainControl"),a(e,"noiseSuppression","mozNoiseSuppression")),d.apply(this,[e])}}}};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],14:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimLocalStreamsAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getTracks().forEach((function(i){return t.call(r,i,e)}))},e.RTCPeerConnection.prototype.addTrack=function(e,r){return r&&(this._localStreams?this._localStreams.includes(r)||this._localStreams.push(r):this._localStreams=[r]),t.call(this,e,r)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r=this._localStreams.indexOf(e);if(-1!==r){this._localStreams.splice(r,1);var i=e.getTracks();this.getSenders().forEach((function(e){i.includes(e.track)&&t.removeTrack(e)}))}})}},r.shimRemoteStreamsAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((function(e){if(t._remoteStreams||(t._remoteStreams=[]),!t._remoteStreams.includes(e)){t._remoteStreams.push(e);var r=new Event("addstream");r.stream=e,t.dispatchEvent(r)}}))})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}}))}),t.apply(e,arguments)}}},r.shimCallbacksAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,o=t.createAnswer,s=t.setLocalDescription,a=t.setRemoteDescription,n=t.addIceCandidate;t.createOffer=function(e,t){var i=arguments.length>=2?arguments[2]:arguments[0],o=r.apply(this,[i]);return t?(o.then(e,t),Promise.resolve()):o},t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],i=o.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};var c=function(e,t,r){var i=s.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i};t.setLocalDescription=c,c=function(e,t,r){var i=a.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setRemoteDescription=c,c=function(e,t,r){var i=n.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.addIceCandidate=c}},r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var r=t.mediaDevices,i=r.getUserMedia.bind(r);t.mediaDevices.getUserMedia=function(e){return i(s(e))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,i){t.mediaDevices.getUserMedia(e).then(r,i)}.bind(t))},r.shimConstraints=s,r.shimRTCIceServerUrls=function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var i=[],s=0;s<e.iceServers.length;s++){var a=e.iceServers[s];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(o.deprecated("RTCIceServer.url","RTCIceServer.urls"),(a=JSON.parse(JSON.stringify(a))).urls=a.url,delete a.url,i.push(a)):i.push(e.iceServers[s])}e.iceServers=i}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},r.shimTrackEventTransceiver=function(e){"object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find((function(e){return"audio"===e.receiver.track.kind}));!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var i=this.getTransceivers().find((function(e){return"video"===e.receiver.track.kind}));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"));function s(e){return e&&void 0!==e.video?Object.assign({},e,{video:o.compactObject(e.video)}):e}},{"../utils":15}],15:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.extractVersion=a,r.wrapPeerConnectionEvent=function(e,t,r){if(e.RTCPeerConnection){var i=e.RTCPeerConnection.prototype,o=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return o.apply(this,arguments);var s=function(e){var t=r(e);t&&i(t)};return this._eventMap=this._eventMap||{},this._eventMap[i]=s,o.apply(this,[e,s])};var s=i.removeEventListener;i.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return s.apply(this,arguments);var i=this._eventMap[r];return delete this._eventMap[r],s.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},r.disableLog=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):(o=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},r.disableWarnings=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):(s=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},r.log=function(){if("object"===("undefined"==typeof window?"undefined":i(window))){if(o)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},r.deprecated=function(e,t){s&&console.warn(e+" is deprecated, please use "+t+" instead.")},r.detectBrowser=function(e){var t=e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=a(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=a(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=a(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=a(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return r},r.compactObject=function e(t){return"object"!==(void 0===t?"undefined":i(t))?t:Object.keys(t).reduce((function(r,o){var s="object"===i(t[o]),a=s?e(t[o]):t[o],n=s&&!Object.keys(a).length;return void 0===a||n?r:Object.assign(r,function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},o,a))}),{})},r.walkStats=n,r.filterStats=function(e,t,r){var i=r?"outbound-rtp":"inbound-rtp",o=new Map;if(null===t)return o;var s=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)})),s.forEach((function(t){e.forEach((function(r){r.type===i&&r.trackId===t.id&&n(e,r,o)}))})),o};var o=!0,s=!0;function a(e,t,r){var i=e.match(t);return i&&i.length>=r&&parseInt(i[r],10)}function n(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((function(i){i.endsWith("Id")?n(e,e.get(t[i]),r):i.endsWith("Ids")&&t[i].forEach((function(t){n(e,e.get(t),r)}))})))}},{}],16:[function(e,t,r){"use strict";var i=e("sdp");function o(e,t,r,o,s){var a=i.writeRtpDescription(e.kind,t);if(a+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":s||"active"),a+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var n=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=n;var c="msid:"+(o?o.id:"-")+" "+n+"\r\n";a+="a="+c,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),a}function s(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},o=function(e,t,r,o){var s=i(e.parameters.apt,r),a=i(t.parameters.apt,o);return s&&a&&s.name.toLowerCase()===a.name.toLowerCase()};return e.codecs.forEach((function(i){for(var s=0;s<t.codecs.length;s++){var a=t.codecs[s];if(i.name.toLowerCase()===a.name.toLowerCase()&&i.clockRate===a.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&a.parameters.apt&&!o(i,a,e.codecs,t.codecs))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(i.numChannels,a.numChannels),r.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter((function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var i=0;i<t.headerExtensions.length;i++){var o=t.headerExtensions[i];if(e.uri===o.uri){r.headerExtensions.push(o);break}}})),r}function a(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function n(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function c(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}t.exports=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function d(t,r,i,o){var s=new Event("track");s.track=r,s.receiver=i,s.transceiver={receiver:i},s.streams=o,e.setTimeout((function(){t._dispatchEvent("track",s)}))}var l=function(r){var o=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){o[e]=s[e].bind(s)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var o="string"==typeof i;return o&&(i=[i]),i=i.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=o?i[0]:i,!!i.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var a=r.iceCandidatePoolSize;a>0;a--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=i.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,i={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)i.iceTransport=this.transceivers[0].iceTransport,i.dtlsTransport=this.transceivers[0].dtlsTransport;else{var o=this._createIceAndDtlsTransports();i.iceTransport=o.iceTransport,i.dtlsTransport=o.dtlsTransport}return t||this.transceivers.push(i),i},l.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var i;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var o=0;o<this.transceivers.length;o++)this.transceivers[o].track||this.transceivers[o].kind!==t.kind||(i=this.transceivers[o]);return i||(i=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),i.track=t,i.stream=r,i.rtpSender=new e.RTCRtpSender(t,i.dtlsTransport),i.rtpSender},l.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var i=e.clone();e.getTracks().forEach((function(e,t){var r=i.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))})),i.getTracks().forEach((function(e){r.addTrack(e,i)}))}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw c("InvalidAccessError","Sender was not created by this connection.");var i=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(i)&&this.localStreams.indexOf(i)>-1&&this.localStreams.splice(this.localStreams.indexOf(i),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))},l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},l.prototype._createIceGatherer=function(t,r){var i=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var o=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(o,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;o.state=r?"completed":"gathering",null!==i.transceivers[t].bufferedCandidateEvents&&i.transceivers[t].bufferedCandidateEvents.push(e)},o.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),o},l.prototype._gather=function(t,r){var o=this,s=this.transceivers[r].iceGatherer;if(!s.onlocalcandidate){var a=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),s.onlocalcandidate=function(e){if(!(o.usingBundle&&r>0)){var a=new Event("icecandidate");a.candidate={sdpMid:t,sdpMLineIndex:r};var n=e.candidate,c=!n||0===Object.keys(n).length;if(c)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else{"new"===s.state&&(s.state="gathering"),n.component=1,n.ufrag=s.getLocalParameters().usernameFragment;var d=i.writeCandidate(n);a.candidate=Object.assign(a.candidate,i.parseCandidate(d)),a.candidate.candidate=d,a.candidate.toJSON=function(){return{candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex,usernameFragment:a.candidate.usernameFragment}}}var l=i.getMediaSections(o._localDescription.sdp);l[a.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+a.candidate.candidate+"\r\n",o._localDescription.sdp=i.getDescription(o._localDescription.sdp)+l.join("");var u=o.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==o.iceGatheringState&&(o.iceGatheringState="gathering",o._emitGatheringStateChange()),c||o._dispatchEvent("icecandidate",a),u&&(o._dispatchEvent("icecandidate",new Event("icecandidate")),o.iceGatheringState="complete",o._emitGatheringStateChange())}},e.setTimeout((function(){a.forEach((function(e){s.onlocalcandidate(e)}))}),0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var i=new e.RTCDtlsTransport(r);return i.ondtlsstatechange=function(){t._updateConnectionState()},i.onerror=function(){Object.defineProperty(i,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:i}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,r,o){var a=s(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(a.encodings=e.sendEncodingParameters,a.rtcp={cname:i.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(a.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(a)),o&&e.rtpReceiver&&a.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?a.encodings=e.recvEncodingParameters:a.encodings=[{}],a.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(a.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(a.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(a))},l.prototype.setLocalDescription=function(e){var t,r,o=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!a("setLocalDescription",e.type,o.signalingState)||o._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+o.signalingState));if("offer"===e.type)t=i.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=i.parseRtpParameters(e);o.transceivers[t].localCapabilities=r})),o.transceivers.forEach((function(e,t){o._gather(e.mid,t)}));else if("answer"===e.type){t=i.splitSections(o._remoteDescription.sdp),r=t.shift();var n=i.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var a=o.transceivers[t],c=a.iceGatherer,d=a.iceTransport,l=a.dtlsTransport,u=a.localCapabilities,p=a.remoteCapabilities;if(!(i.isRejected(e)&&0===i.matchPrefix(e,"a=bundle-only").length||a.rejected)){var h=i.getIceParameters(e,r),g=i.getDtlsParameters(e,r);n&&(g.role="server"),o.usingBundle&&0!==t||(o._gather(a.mid,t),"new"===d.state&&d.start(c,h,n?"controlling":"controlled"),"new"===l.state&&l.start(g));var m=s(u,p);o._transceive(a,m.codecs.length>0,!1)}}))}return o._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?o._updateSignalingState("have-local-offer"):o._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(o){var l=this;if(-1===["offer","answer"].indexOf(o.type))return Promise.reject(c("TypeError",'Unsupported type "'+o.type+'"'));if(!a("setRemoteDescription",o.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+o.type+" in state "+l.signalingState));var u={};l.remoteStreams.forEach((function(e){u[e.id]=e}));var p=[],h=i.splitSections(o.sdp),g=h.shift(),m=i.matchPrefix(g,"a=ice-lite").length>0,E=i.matchPrefix(g,"a=group:BUNDLE ").length>0;l.usingBundle=E;var f=i.matchPrefix(g,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!f&&f.substr(14).split(" ").indexOf("trickle")>=0,h.forEach((function(a,c){var d=i.splitLines(a),h=i.getKind(a),f=i.isRejected(a)&&0===i.matchPrefix(a,"a=bundle-only").length,_=d[0].substr(2).split(" ")[2],S=i.getDirection(a,g),T=i.parseMsid(a),C=i.getMid(a)||i.generateIdentifier();if(f||"application"===h&&("DTLS/SCTP"===_||"UDP/DTLS/SCTP"===_))l.transceivers[c]={mid:C,kind:h,protocol:_,rejected:!0};else{var R,v,I,L,y,P,A,k,O;!f&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(h,!0));var b,N,M=i.parseRtpParameters(a);f||(b=i.getIceParameters(a,g),(N=i.getDtlsParameters(a,g)).role="client"),A=i.parseRtpEncodingParameters(a);var U=i.parseRtcpParameters(a),D=i.matchPrefix(a,"a=end-of-candidates",g).length>0,w=i.matchPrefix(a,"a=candidate:").map((function(e){return i.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===o.type||"answer"===o.type)&&!f&&E&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==o.type||f)"answer"!==o.type||f||(v=(R=l.transceivers[c]).iceGatherer,I=R.iceTransport,L=R.dtlsTransport,y=R.rtpReceiver,P=R.sendEncodingParameters,k=R.localCapabilities,l.transceivers[c].recvEncodingParameters=A,l.transceivers[c].remoteCapabilities=M,l.transceivers[c].rtcpParameters=U,w.length&&"new"===I.state&&(!m&&!D||E&&0!==c?w.forEach((function(e){n(R.iceTransport,e)})):I.setRemoteCandidates(w)),E&&0!==c||("new"===I.state&&I.start(v,b,"controlling"),"new"===L.state&&L.start(N)),!s(R.localCapabilities,R.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&R.sendEncodingParameters[0].rtx&&delete R.sendEncodingParameters[0].rtx,l._transceive(R,"sendrecv"===S||"recvonly"===S,"sendrecv"===S||"sendonly"===S),!y||"sendrecv"!==S&&"sendonly"!==S?delete R.rtpReceiver:(O=y.track,T?(u[T.stream]||(u[T.stream]=new e.MediaStream),r(O,u[T.stream]),p.push([O,y,u[T.stream]])):(u.default||(u.default=new e.MediaStream),r(O,u.default),p.push([O,y,u.default]))));else{(R=l.transceivers[c]||l._createTransceiver(h)).mid=C,R.iceGatherer||(R.iceGatherer=l._createIceGatherer(c,E)),w.length&&"new"===R.iceTransport.state&&(!D||E&&0!==c?w.forEach((function(e){n(R.iceTransport,e)})):R.iceTransport.setRemoteCandidates(w)),k=e.RTCRtpReceiver.getCapabilities(h),t<15019&&(k.codecs=k.codecs.filter((function(e){return"rtx"!==e.name}))),P=R.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var B,Z=!1;"sendrecv"===S||"sendonly"===S?(Z=!R.rtpReceiver,y=R.rtpReceiver||new e.RTCRtpReceiver(R.dtlsTransport,h),Z&&(O=y.track,T&&"-"===T.stream||(T?(u[T.stream]||(u[T.stream]=new e.MediaStream,Object.defineProperty(u[T.stream],"id",{get:function(){return T.stream}})),Object.defineProperty(O,"id",{get:function(){return T.track}}),B=u[T.stream]):(u.default||(u.default=new e.MediaStream),B=u.default)),B&&(r(O,B),R.associatedRemoteMediaStreams.push(B)),p.push([O,y,B]))):R.rtpReceiver&&R.rtpReceiver.track&&(R.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===R.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(r,t)})),R.associatedRemoteMediaStreams=[]),R.localCapabilities=k,R.remoteCapabilities=M,R.rtpReceiver=y,R.rtcpParameters=U,R.sendEncodingParameters=P,R.recvEncodingParameters=A,l._transceive(l.transceivers[c],!1,Z)}}})),void 0===l._dtlsRole&&(l._dtlsRole="offer"===o.type?"active":"passive"),l._remoteDescription={type:o.type,sdp:o.sdp},"offer"===o.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(u).forEach((function(t){var r=u[t];if(r.getTracks().length){if(-1===l.remoteStreams.indexOf(r)){l.remoteStreams.push(r);var i=new Event("addstream");i.stream=r,e.setTimeout((function(){l._dispatchEvent("addstream",i)}))}p.forEach((function(e){var t=e[0],i=e[1];r.id===e[2].id&&d(l,t,i,[r])}))}})),p.forEach((function(e){e[2]||d(l,e[0],e[1],[])})),e.setTimeout((function(){l&&l.transceivers&&l.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},l.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var s=r.transceivers.filter((function(e){return"audio"===e.kind})).length,a=r.transceivers.filter((function(e){return"video"===e.kind})).length,n=arguments[0];if(n){if(n.mandatory||n.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==n.offerToReceiveAudio&&(s=!0===n.offerToReceiveAudio?1:!1===n.offerToReceiveAudio?0:n.offerToReceiveAudio),void 0!==n.offerToReceiveVideo&&(a=!0===n.offerToReceiveVideo?1:!1===n.offerToReceiveVideo?0:n.offerToReceiveVideo)}for(r.transceivers.forEach((function(e){"audio"===e.kind?--s<0&&(e.wantReceive=!1):"video"===e.kind&&--a<0&&(e.wantReceive=!1)}));s>0||a>0;)s>0&&(r._createTransceiver("audio"),s--),a>0&&(r._createTransceiver("video"),a--);var d=i.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(o,s){var a=o.track,n=o.kind,c=o.mid||i.generateIdentifier();o.mid=c,o.iceGatherer||(o.iceGatherer=r._createIceGatherer(s,r.usingBundle));var d=e.RTCRtpSender.getCapabilities(n);t<15019&&(d.codecs=d.codecs.filter((function(e){return"rtx"!==e.name}))),d.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),o.remoteCapabilities&&o.remoteCapabilities.codecs&&o.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),d.headerExtensions.forEach((function(e){(o.remoteCapabilities&&o.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var l=o.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];a&&t>=15019&&"video"===n&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),o.wantReceive&&(o.rtpReceiver=new e.RTCRtpReceiver(o.dtlsTransport,n)),o.localCapabilities=d,o.sendEncodingParameters=l})),"max-compat"!==r._config.bundlePolicy&&(d+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){d+=o(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,d+="a="+i.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"))}));var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},l.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var a=i.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(a+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),a+="a=ice-options:trickle\r\n";var n=i.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,i){if(!(i+1>n)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?a+="m=application 0 DTLS/SCTP 5000\r\n":a+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?a+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(a+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(a+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var d=s(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,a+=o(e,d,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}}));var d=new e.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(d)},l.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(o,s){if(!r._remoteDescription)return s(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var a=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<r.transceivers.length;d++)if(r.transceivers[d].mid===e.sdpMid){a=d;break}var l=r.transceivers[a];if(!l)return s(c("OperationError","Can not add ICE candidate"));if(l.rejected)return o();var u=Object.keys(e.candidate).length>0?i.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return o();if(u.component&&1!==u.component)return o();if((0===a||a>0&&l.iceTransport!==r.transceivers[0].iceTransport)&&!n(l.iceTransport,u))return s(c("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2)),(t=i.getMediaSections(r._remoteDescription.sdp))[a]+="a="+(u.type?p:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=i.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var h=0;h<r.transceivers.length&&(r.transceivers[h].rejected||(r.transceivers[h].iceTransport.addRemoteCandidate({}),(t=i.getMediaSections(r._remoteDescription.sdp))[h]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=i.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));h++);o()}))},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)})),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var i=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&i.push(e[t].getStats())}))})),Promise.all(i).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var i=r.prototype.getStats;r.prototype.getStats=function(){return i.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var i;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(i=e[r]).type]||i.type,t.set(r,e[r])})),t}))}}}));var u=["createOffer","createAnswer"];return u.forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),l}},{sdp:17}],17:[function(e,t,r){"use strict";var i={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},i.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},i.getDescription=function(e){var t=i.splitSections(e);return t&&t[0]},i.getMediaSections=function(e){var t=i.splitSections(e);return t.shift(),t},i.matchPrefix=function(e,t){return i.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},i.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1];break;case"ufrag":r.ufrag=t[i+1],r.usernameFragment=t[i+1];break;default:r[t[i]]=t[i+1]}return r},i.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},i.parseIceOptions=function(e){return e.substr(14).split(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},i.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t,r={},i=e.substr(e.indexOf(" ")+1).split(";"),o=0;o<i.length;o++)r[(t=i[o].trim().split("="))[0].trim()]=t[1];return r},i.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(r.attribute=e.substr(t+1,i-t-1),r.value=e.substr(i+1)):r.attribute=e.substr(t+1),r},i.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},i.getMid=function(e){var t=i.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},i.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},i.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:i.matchPrefix(e+t,"a=fingerprint:").map(i.parseFingerprint)}},i.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},i.getIceParameters=function(e,t){var r=i.splitLines(e);return{usernameFragment:(r=r.concat(i.splitLines(t))).filter((function(e){return 0===e.indexOf("a=ice-ufrag:")}))[0].substr(12),password:r.filter((function(e){return 0===e.indexOf("a=ice-pwd:")}))[0].substr(10)}},i.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=i.splitLines(e)[0].split(" "),o=3;o<r.length;o++){var s=r[o],a=i.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(a){var n=i.parseRtpMap(a),c=i.matchPrefix(e,"a=fmtp:"+s+" ");switch(n.parameters=c.length?i.parseFmtp(c[0]):{},n.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(i.parseRtcpFb),t.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(n.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(i.parseExtmap(e))})),t},i.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=i.writeRtpMap(e),r+=i.writeFmtp(e),r+=i.writeRtcpFb(e)}));var o=0;return t.codecs.forEach((function(e){e.maxptime>o&&(o=e.maxptime)})),o>0&&(r+="a=maxptime:"+o+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=i.writeExtmap(e)})),r},i.parseRtpEncodingParameters=function(e){var t,r=[],o=i.parseRtpParameters(e),s=-1!==o.fecMechanisms.indexOf("RED"),a=-1!==o.fecMechanisms.indexOf("ULPFEC"),n=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=n.length>0&&n[0].ssrc,d=i.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),o.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(i.rtx={ssrc:t}),r.push(i),s&&((i=JSON.parse(JSON.stringify(i))).fec={ssrc:c,mechanism:a?"red+ulpfec":"red"},r.push(i))}})),0===r.length&&c&&r.push({ssrc:c});var l=i.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=l}))),r},i.parseRtcpParameters=function(e){var t={},r=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var o=i.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=o.length>0,t.compound=0===o.length;var s=i.matchPrefix(e,"a=rtcp-mux");return t.mux=s.length>0,t},i.parseMsid=function(e){var t,r=i.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var o=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return o.length>0?{stream:(t=o[0].value.split(" "))[0],track:t[1]}:void 0},i.generateSessionId=function(){return Math.random().toString().substr(2,21)},i.writeSessionBoilerplate=function(e,t,r){var o=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||i.generateSessionId())+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.writeMediaSection=function(e,t,r,o){var s=i.writeRtpDescription(e.kind,t);if(s+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),s+="a=mid:"+e.mid+"\r\n",e.direction?s+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var a="msid:"+o.id+" "+e.rtpSender.track.id+"\r\n";s+="a="+a,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),s},i.getDirection=function(e,t){for(var r=i.splitLines(e),o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substr(2)}return t?i.getDirection(t):"sendrecv"},i.getKind=function(e){return i.splitLines(e)[0].split(" ")[0].substr(2)},i.isRejected=function(e){return"0"===e.split(" ",2)[1]},i.parseMLine=function(e){var t=i.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},i.parseOLine=function(e){var t=i.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},i.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=i.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=i)},{}]},{},[1])(1)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RetryHandler=void 0;var i=function(){function e(){this.RETRY_MAX_TIME=300,this.RETRY_START_TIME_INTERVAL=4,this.RETRY_CONTINUE_COUNT=2,this.RETRY_MAX_TIME_INTERVAL=32,this.retryStartTime=0,this.retryActiveCount=1,this.isOverTime=!1}return e.prototype.init=function(e,t,r,i){this.invalid(),this.stopMaxTime(),this.isOverTime=!1,"number"==typeof e&&e<3600&&(this.RETRY_MAX_TIME=e),"number"==typeof t&&(this.RETRY_START_TIME_INTERVAL=t),"number"==typeof r&&(this.RETRY_CONTINUE_COUNT=r),"number"==typeof i&&(this.RETRY_MAX_TIME_INTERVAL=i)},e.prototype.invalid=function(){this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=null,this.retryStartTime=0,this.retryActiveCount=1},e}();t.RetryHandler=i},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.ClientUtil=t.ZegoExpressEngine=void 0;var s=r(6),a=r(0),n=r(2);Object.defineProperty(t,"ClientUtil",{enumerable:!0,get:function(){return n.ClientUtil}});var c=function(e){function t(t,r){var i=this;return a.ZegoExpressWebRTMEngine.version="2.5.0",(i=e.call(this,t,r)||this).zegoWebRTC=new s.ZegoWebRTC(i.logger,i.dataReport,i.zegoWebRTM),i}return o(t,e),t.prototype.checkSystemRequirements=function(e,t){return void 0===t&&(t=0),this.zegoWebRTC.checkSystemRequirements(t,e)},t.prototype.createStream=function(e){return this.zegoWebRTC.createStream(e)},t.prototype.enumDevices=function(){return this.zegoWebRTC.enumDevices()},t.prototype.mutePlayStreamAudio=function(e,t){return this.zegoWebRTC.mutePlayStreamAudio(e,t)},t.prototype.mutePlayStreamVideo=function(e,t){return this.zegoWebRTC.mutePlayStreamVideo(e,t)},t.prototype.off=function(e,t){return this.zegoWebRTM.stateCenter.listenerList[e]?this.zegoWebRTM.off(e,t):!!this.zegoWebRTC.stateCenter.listenerList[e]&&this.zegoWebRTC.off(e,t)},t.prototype.on=function(e,t){return this.zegoWebRTM.stateCenter.listenerList[e]?this.zegoWebRTM.on(e,t):!!this.zegoWebRTC.stateCenter.listenerList[e]&&this.zegoWebRTC.on(e,t)},t.prototype.replaceTrack=function(e,t){return this.zegoWebRTC.replaceTrack(e,t)},t.prototype.setAudioConfig=function(e,t){return this.zegoWebRTC.setAudioConfig(e,t)},t.prototype.setCaptureVolume=function(e,t){return this.zegoWebRTC.setCaptureVolume(e,t)},t.prototype.setMixerTaskConfig=function(e){return this.zegoWebRTC.setMixerTaskConfig(e)},t.prototype.setMixingAudioVolume=function(e,t,r){return this.zegoWebRTC.setMixingAudioVolume(e,t,r)},t.prototype.setSoundLevelDelegate=function(e,t){return this.zegoWebRTC.setSoundLevelDelegate(e,t)},t.prototype.setVideoConfig=function(e,t){return this.zegoWebRTC.setVideoConfig(e,t)},t.prototype.startMixerTask=function(e){return this.zegoWebRTC.startMixerTask(e)},t.prototype.startMixingAudio=function(e,t){return this.zegoWebRTC.startMixingAudio(e,t)},t.prototype.startPlayingStream=function(e,t){return this.zegoWebRTC.startPlayingStream(e,t)},t.prototype.stopMixerTask=function(e){return this.zegoWebRTC.stopMixerTask(e)},t.prototype.stopMixingAudio=function(e,t){return this.zegoWebRTC.stopMixingAudio(e,t)},t.prototype.stopPlayingStream=function(e){return this.zegoWebRTC.stopPlayingStream(e)},t.prototype.useAudioDevice=function(e,t){return this.zegoWebRTC.useAudioDevice(e,t)},t.prototype.destroyStream=function(e){return this.zegoWebRTC.destroyStream(e)},t.prototype.startPublishingStream=function(e,t,r){return this.zegoWebRTC.startPublishingStream(e,t,r)},t.prototype.stopPublishingStream=function(e){return this.zegoWebRTC.stopPublishingStream(e)},t.prototype.addPublishCdnUrl=function(e,t){return 3===arguments.length?this.zegoWebRTC.addPublishCdnUrl(arguments[0],arguments[2]):this.zegoWebRTC.addPublishCdnUrl(e,t)},t.prototype.removePublishCdnUrl=function(e,t){return 3===arguments.length?this.zegoWebRTC.removePublishCdnUrl(arguments[0],arguments[2]):this.zegoWebRTC.removePublishCdnUrl(e,t)},t.prototype.setStreamExtraInfo=function(e,t){return this.zegoWebRTC.setStreamExtraInfo(e,t)},t.prototype.mutePublishStreamVideo=function(e,t){return this.zegoWebRTC.mutePublishStreamVideo(e,t)},t.prototype.mutePublishStreamAudio=function(e,t){return this.zegoWebRTC.mutePublishStreamAudio(e,t)},t.prototype.useVideoDevice=function(e,t){return this.zegoWebRTC.useVideoDevice(e,t)},t}(a.ZegoExpressWebRTMEngine);t.ZegoExpressEngine=c},function(t,r){t.exports=e},function(e,t,r){"use strict";var i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function n(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,n)}c((i=i.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,i,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function n(s){return function(n){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],i=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,n])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.CheckModule=void 0;var s=r(5),a=function(){function e(){var e=this;this.iceconnectionstatechangeTimes=0,this.isCheckAll=!1;var t=document.createElement("canvas");t.getContext("2d").fillStyle="rgba(255, 255, 255, 0)";try{this.localStream=t.captureStream()}catch(e){console.error("canvas captureStream error",e)}this.timer=setTimeout((function(){e.resolve("Detection timeout"),e.hangup()}),5e3)}return e.prototype.checkSupportByType=function(e){return i(this,void 0,void 0,(function(){var t,r,i=this;return o(this,(function(o){switch(o.label){case 0:return this.checkType=e,t={},this.localPc=new RTCPeerConnection(t),this.remotePc=new RTCPeerConnection(t),r=new Promise((function(e){return i.resolve=e})),this.localPc.addEventListener("icecandidate",(function(e){return i.onIceCandidate(i.localPc,e)})),this.remotePc.addEventListener("icecandidate",(function(e){return i.onIceCandidate(i.remotePc,e)})),this.remotePc.addEventListener("iceconnectionstatechange",(function(t){"connected"===i.remotePc.iceConnectionState&&(i.iceconnectionstatechangeResult=!0),2==++i.iceconnectionstatechangeTimes&&i.iceCandidate&&(clearTimeout(i.timer),"connected"===i.remotePc.iceConnectionState?i.resolve(!0):i.resolve("The browser does not support "+e+" format"),i.hangup())})),this.localStream.getTracks().forEach((function(e){return i.localPc.addTrack(e,i.localStream)})),[4,this.check(e)];case 1:return o.sent(),[4,r];case 2:return[2,o.sent()]}}))}))},e.prototype.check=function(e){return i(this,void 0,void 0,(function(){var t,r;return o(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.localPc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})];case 1:return(t=i.sent()).sdp=s.SdpUtil.getSDPByVideDecodeType(t.sdp,e),this.onCreateOfferSuccess(t),[3,3];case 2:return r=i.sent(),this.onCreateSessionDescriptionError(r),[3,3];case 3:return[2]}}))}))},e.prototype.onCreateOfferSuccess=function(e){return i(this,void 0,void 0,(function(){var t,r,i,s;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,this.localPc.setLocalDescription(e)];case 1:return o.sent(),[3,3];case 2:return t=o.sent(),this.onSetSessionDescriptionError(t),[2];case 3:return o.trys.push([3,5,,6]),[4,this.remotePc.setRemoteDescription(e)];case 4:return o.sent(),[3,6];case 5:return r=o.sent(),this.onSetSessionDescriptionError(r),[2];case 6:return o.trys.push([6,9,,10]),[4,this.remotePc.createAnswer()];case 7:return i=o.sent(),[4,this.onCreateAnswerSuccess(i)];case 8:return o.sent(),[3,10];case 9:return s=o.sent(),this.onCreateSessionDescriptionError(s),[2];case 10:return[2]}}))}))},e.prototype.onCreateAnswerSuccess=function(e){return i(this,void 0,void 0,(function(){var t,r;return o(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.remotePc.setLocalDescription(e)];case 1:return i.sent(),[3,3];case 2:return t=i.sent(),this.onSetSessionDescriptionError(t),[2];case 3:return i.trys.push([3,5,,6]),[4,this.localPc.setRemoteDescription(e)];case 4:return i.sent(),[3,6];case 5:return r=i.sent(),this.onSetSessionDescriptionError(r),[2];case 6:return[2]}}))}))},e.prototype.onIceCandidate=function(e,t){return i(this,void 0,void 0,(function(){var r;return o(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.getOtherPc(e).addIceCandidate(t.candidate)];case 1:return i.sent(),[3,3];case 2:return r=i.sent(),console.error(this.checkType,this.getPcName(e)+" addIceCandidate error",r),clearTimeout(this.timer),this.hangup(),this.resolve(r),[3,3];case 3:return"remotePc"===this.getPcName(e)&&t.candidate&&(this.iceCandidate=!0),this.iceconnectionstatechangeResult&&"localPc"===this.getPcName(e)&&(clearTimeout(this.timer),this.hangup(),this.resolve(!0)),[2]}}))}))},e.prototype.getOtherPc=function(e){return e===this.localPc?this.remotePc:this.localPc},e.prototype.getPcName=function(e){return e===this.localPc?"localPc":"remotePc"},e.prototype.onCreateSessionDescriptionError=function(e){console.error("Failed to create session description: "+e.toString()),clearTimeout(this.timer),this.hangup(),this.resolve(e)},e.prototype.onSetSessionDescriptionError=function(e){console.error("Failed to set session description: "+e.toString()),clearTimeout(this.timer),this.hangup(),this.resolve(e)},e.prototype.hangup=function(){this.localPc.close(),this.remotePc.close(),this.iceconnectionstatechangeTimes=0,this.localStream.getTracks().forEach((function(e){return e.stop()}))},e}();t.CheckModule=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StateCenter=void 0;var i=r(0),o=r(3),s=r(0),a=r(1),n=function(){function e(e,t){this.logger=e,this.dataReport=t,this.debug=!1,this.testEnvironment=!1,this.pullLimited=!0,this.configOK=!1,this.relateService=[],this.role=2,this.maxMemberCount=0,this.roomCreateFlag=1,this.callbackList={},this.streamQuerying=!1,this.streamSeq=0,this.streamList=[],this.publishStreamList={},this.isResetRoom=!1,this.streamUrlMap={},this.cmdCallback={},this.customUrl=[],this.customPlayUrl=[],this.turnOverTcpOnly=!1,this.customSetTcpOrUdp=!1,this.supportUdp=!1,this.audioEffectBuffer={},this.audioBitRate=48e3,this.cdnSeq=0,this.listenerList={roomStreamUpdate:[],streamExtraInfoUpdate:[],playerStateUpdate:[],publisherStateUpdate:[],screenSharingEnded:[],publishQualityUpdate:[],playQualityUpdate:[],remoteCameraStatusUpdate:[],remoteMicStatusUpdate:[],soundLevelUpdate:[],videoDeviceStateChanged:[],audioDeviceStateChanged:[],deviceError:[],_deviceError:[],_remoteCameraStatusUpdate:[],_remoteMicStatusUpdate:[],_streamUpdated:[]},this.reportList={},this.reportSeqList={startPublish:{},rePublish:{},startPlay:{},rePlay:{},stopPublish:{},stopPlay:{}},this.streamTrigger={},this.mixStreamAdvance={},this.audioStreamList={},this.deviceInfos=null,this.deviceChangeTimer=null,this.deviceStateOut=!1,this.networkState=s.ENUM_NETWORK_STATE.offline,this.streamRetryTime=300,this.checkList=[],this.anchor_info={anchor_id:"",anchor_id_name:"",anchor_nick_name:""},this.streamConnectTime=0,this.streamInfoList={},this.clientIP=""}return e.prototype.getRequestId=function(){return this.idName+"-"+s.getSeq()},e.prototype.getSignalCmdContent=function(e,t,r){var i={request_id:e,room_id:this.roomid,from_userid:this.idName,from_username:this.nickName,to_userid:t};return null!=r&&(i.result=r),JSON.stringify(i)},e.prototype.actionListener=function(e){for(var t=this,r=[],s=1;s<arguments.length;s++)r[s-1]=arguments[s];if(!["playQualityUpdate","publishQualityUpdate"].includes(e)&&this.listenerList[e]){var n=i.getReportSeq();this.dataReport.newReport(n,a.ZegoRTCLogEvent.kZegoListener.event),this.dataReport.addMsgInfo(n,{listener:e,params:r}),this.dataReport.uploadReport(n)}this.listenerList[e]&&this.listenerList[e].forEach((function(i){try{setTimeout((function(){i.apply(void 0,r)}),0)}catch(r){t.logger.error(o.ZEGO_WEBRTC_ACTION.STATECENTER_ACTION_LISTENER+" "+e+" "+r)}}))},e}();t.StateCenter=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaUtil=void 0;var i=r(2),o=function(){function e(e,t){var r=this,i=t.type,o=t.channels,s=void 0===o?1:o,a=t.bufferSize,n=void 0===a?0:a,c=t.sampleBit,d=void 0===c?16:c,l=t.sampleRate,u=void 0===l?44100:l;this.instant=0,this.slow=0,this.clip=0,this.context=e,this.type=i,this.channels=s,this.bufferSize=n,this.sampleBit=d,this.sampleRate=u,this.script=e.createScriptProcessor(n,s,s);(new Date).getTime();this.script.addEventListener("audioprocess",(function(e){var t,o=e.inputBuffer.getChannelData(0),s=0,a=0;for(t=0;t<o.length;++t)s+=o[t]*o[t],Math.abs(o[t])>.99&&(a+=1);if(r.instant=Math.sqrt(s/o.length),r.slow=.95*r.slow+.05*r.instant,r.clip=a/o.length,"pcm"===i||"wav"===i){for(var n=[],c=0;c<r.channels;c++)n.push(e.inputBuffer.getChannelData(c));r.recorderBuffer(n)}})),"pcm"!==i&&"wav"!==i||this.initRecorderBuffer(i)}return e.prototype.connectToSource=function(e,t){try{this.mic=this.context.createMediaStreamSource(e),this.mic.connect(this.script),this.script.connect(this.context.destination),void 0!==t&&t(null)}catch(e){console.error(e),void 0!==t&&t(e)}return this},e.prototype.recorderBuffer=function(e){this.worker.postMessage({command:"record",val:e})},e.prototype.initRecorderBuffer=function(e){var t=this,r=this;this.worker=i.ClientUtil.inlineWorker((function(){var e,r,i,o,s,a,n=[],c=t;function d(e,t,r){for(var i=0;i<r.length;i++,t+=2){var o=Math.max(-1,Math.min(1,r[i]));e.setInt16(t,o<0?32768*o:32767*o,!0)}}function l(e,t,r){for(var i=0;i<r.length;i++,t++){var o=Math.max(-1,Math.min(1,r[i])),s=o<0?128*o:127*o;s+=128,e.setInt8(t,s)}}function u(e,t,r){for(var i=0;i<r.length;i++)e.setUint8(t+i,r.charCodeAt(i))}function p(e,t){for(var r=new Float32Array(t.length/e),i=0,o=0;i<r.length;)r[i]=t[o],o+=e,i++;return r}function h(e,t,r){for(var i=new Float32Array(t*e.length),o=0,s=0;s<r[0].length;s++)i.set(r[0][s],o),o+=r[0][s].length;return i}function g(e,t){for(var r=new Float32Array(e.length+t.length),i=0;i<e.length+t.length;i+=2)r[i]=e[i/2>>0],r[i+1]=t[i/2>>0];return r}function m(t){var r,i;if(1==e)r=h(n[0],s,n),1!=t&&(i=p(t,r));else if(2==e){var o=h(n[0],s,n),a=h(n[1],s,n);1!=t?i=g(p(t,o),p(t,a)):r=g(o,a)}return 1!=t?i:r}function E(e){var t=function(e,t){var i;8==t?i=e.length:16==t&&(i=e.length,i*=2);var o=new ArrayBuffer(i),s=new DataView(o);return 8==t?l(s,0,e):16==r&&d(s,0,e),s}(m(e),r);c.postMessage({command:"exportPcmLive",val:t})}function f(t){var o=function(t,o){var s;8==o?s=t.length:16==r&&(s=t.length,s*=2);var a=new ArrayBuffer(s+44),n=new DataView(a),c=i,p=r,h=e;return u(n,0,"RIFF"),n.setUint32(4,36+s,!0),u(n,8,"WAVE"),u(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,h,!0),n.setUint32(24,c,!0),n.setUint32(28,c*h*(p/8),!0),n.setUint16(32,h*(p/8),!0),n.setUint16(34,p,!0),u(n,36,"data"),n.setUint32(40,s,!0),8==r?l(n,44,t):16==r&&d(n,44,t),n}(m(t),r);c.postMessage({command:"exportWav",val:o})}t.onmessage=function(t){switch(t.data.command){case"init":c=t.data.val,e=c.sampleChannel,r=c.sampleBit,i=c.sampleRate,o=c.oldSampleRate,s=c.bufferSize,a=c.type;break;case"record":!function(t){for(var r=0;r<e;r++)n[r]||(n[r]=[]),n[r].push(t[r]);var s=Math.round(o/i);"pcm"===a?E(s):"wav"===a&&f(s),n=[]}(t.data.val)}var c}})),this.worker.postMessage({command:"init",val:{sampleChannel:this.channels,sampleBit:this.sampleBit,sampleRate:this.sampleRate,oldSampleRate:this.context.sampleRate,bufferSize:this.bufferSize,type:e}}),this.worker.onmessage=function(e){switch(e.data.command){case"exportPcmLive":r.onReceiveBuffer(e.data.val);break;case"exportWav":r.onReceiveWav(e.data.val)}}},e.prototype.onReceiveBuffer=function(e){},e.prototype.onReceiveWav=function(e){},e.prototype.writeString=function(e,t,r){for(var i=0;i<r.length;i++)e.setUint8(t+i,r.charCodeAt(i))},e.prototype.writeBuffer=function(e,t,r){for(var i=0;i<r.byteLength;i++)e.setUint8(t+i,r[i])},e.prototype.concatenation=function(e){for(var t=0,r=0;r<e.length;++r)t+=e[r].buffer.byteLength;var i=new Uint8Array(t),o=0;for(r=0;r<e.length;++r)i.set(new Uint8Array(e[r].buffer),o),o+=e[r].buffer.byteLength;return i},e.prototype.encodeWave=function(e){var t=this.concatenation(e),r=t.byteLength,i=new ArrayBuffer(r+44),o=new DataView(i),s=this.sampleRate,a=this.sampleBit,n=this.channels;return this.writeString(o,0,"RIFF"),o.setUint32(4,36+r,!0),this.writeString(o,8,"WAVE"),this.writeString(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,n,!0),o.setUint32(24,s,!0),o.setUint32(28,s*n*(a/8),!0),o.setUint16(32,n*(a/8),!0),o.setUint16(34,a,!0),this.writeString(o,36,"data"),o.setUint32(40,r,!0),this.writeBuffer(o,44,t),o},e.prototype.stop=function(){this.mic.disconnect(),this.script.disconnect()},e}();t.MediaUtil=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RTCModules=void 0;var i=r(0),o=r(1),s=r(2),a=r(16),n=r(17),c=r(25),d=r(26),l=r(27),u=r(28),p=function(){function e(e,t,r,i,o){this.logger=e,this.dataReport=t,this.stateCenter=r,this.rtm=i,this.ac=o,this.mediaEleSources=[],this.streamCenter=new n.ZegoStreamCenterWeb(this.logger,this.stateCenter,this.dataReport,this.rtm,this.ac,this.mediaEleSources),this.streamHandler=new a.StreamHandler(this.logger,this.stateCenter,this.rtm,this.dataReport,this.streamCenter),this.publishModule=new c.PublishModule(this.logger,this.dataReport,this.stateCenter,this.streamCenter,this.streamHandler,this.rtm),this.playModule=new d.PlayModule(this.logger,this.dataReport,this.stateCenter,this.streamCenter,this.rtm),this.advancedModule=new u.AdvancedModule(this.logger,this.dataReport,this.streamCenter),this.audioMixModule=new l.AudioMixModule(this.logger,this.dataReport,this.stateCenter,this.streamCenter,this.ac),this.init()}return e.prototype.init=function(){this.bindWindowListener(),this.bindRTMListener(),this.bindStreamHandler(),this.bindStreamCenterHandler()},e.prototype.bindWindowListener=function(){var e=this,t=navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPhone/i)?"pagehide":"unload";window.addEventListener(t,(function(){for(var t in window.event&&(window.event.cancelBubble=!0),e.streamCenter.publisherList)e.publishModule.stopPublishingStream(t);for(var t in e.streamCenter.playerList)e.playModule.stopPlayingStream(t)})),window.addEventListener("message",(function(t){var r=t.data,i=r.type,o=r.streamId,a=r.canRequestAudioTrack;"SS_DIALOG_SUCCESS"===i&&e.screenStreamFrom(o,a,s.ClientUtil.actionSuccessCallback("screenShare",e.stateCenter.callbackList)),"SS_DIALOG_CANCEL"===i&&s.ClientUtil.actionSuccessCallback("screenShare",e.stateCenter.callbackList)(!1,null,i)})),window.addEventListener("offline",(function(t){for(var r in e.logger.info("zc.off.0 newtwork is broken"),e.stateCenter.networkState=i.ENUM_NETWORK_STATE.offline,e.streamCenter.publisherList){(o=e.streamCenter.publisherList[r].retryStreamHandler).startMaxTime(),o.invalid()}for(var r in e.streamCenter.playerList){var o;(o=e.streamCenter.playerList[r].retryStreamHandler).startMaxTime(),o.invalid()}})),window.addEventListener("online",(function(t){for(var r in e.logger.info("zc.on.0 network is online"),e.stateCenter.networkState=i.ENUM_NETWORK_STATE.online,e.streamCenter.publisherList){var s=e.streamCenter.publisherList[r].publisher,a=e.streamCenter.publisherList[r].retryStreamHandler;s.state==i.ENUM_PUBLISH_STATE.stop||s.stateNego!==i.ENUM_PUBLISH_STATE_NEGO.iceConnected?!a.isOverTime&&a.publishStateHandle(i.ENUM_PUBLISH_STATE_UPDATE.error,r,o.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishNetworkBrokenError):s.state==i.ENUM_PUBLISH_STATE.publishing&&a.stopMaxTime()}for(var r in e.streamCenter.playerList){var n=e.streamCenter.playerList[r].player;a=e.streamCenter.playerList[r].retryStreamHandler;n.state==i.ENUM_PLAY_STATE.stop||n.stateNego!==i.ENUM_PLAY_STATE_NEGO.iceConnected?!a.isOverTime&&a.playStateHandle(i.ENUM_PLAY_STATE_UPDATE.error,r,o.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayNetworkBrokenError):n.state==i.ENUM_PLAY_STATE.playing&&a.stopMaxTime()}})),window.addEventListener("visibilitychange",(function(t){if(Object.keys(e.streamCenter.publisherList).length>0||Object.keys(e.streamCenter.playerList).length>0){var r=i.getReportSeq();e.dataReport.newReport(r,o.ZegoRTCLogEvent.kZegoVisibilityChange.event),e.dataReport.uploadReport(r)}}))},e.prototype.bindRTMListener=function(){var e=this;this.rtm._on("roomLoginResponse",(function(t){e.logger.info("zc.rlr call"),e.stateCenter.appid=e.rtm.getAppID(),e.stateCenter.idName=e.rtm.getUserID(),e.stateCenter.token=e.rtm.getToken(),e.stateCenter.testEnvironment=e.rtm.isTestEnvironment(),e.stateCenter.roomid=e.rtm.getRoomID(),e.streamCenter.setSessionInfo(e.stateCenter.appid,e.stateCenter.idName,e.stateCenter.token,e.stateCenter.testEnvironment),e.streamHandler.handleStreamStart(t),e.logger.info("zc.rlr end")})),this.rtm._on("HBResponse",(function(t){e.streamHandler.patchStreamList(t)})),this.rtm._on("_roomStateUpdate",(function(t,r,i,o){"DISCONNECTED"==r?(e.logger.info(i+" "),e.stateCenter.isResetRoom=!0,e.stateCenter.streamList=[],e.streamCenter.reset(),e.streamHandler.reset()):e.logger.info("zc.rsu "+t+" state")}))},e.prototype.bindStreamCenterHandler=function(){var e=this;this.streamCenter.onPlayStateUpdate=function(t,r,o){var a=e.stateCenter.reportSeqList.startPlay[r],n=e.streamCenter.playerList[r];if(1==t&&n&&s.ClientUtil.isReDispatch(o)){var c=n.player,d=n.retryDispatchHandler,l=n.playOption;return 0!=c.sessionId&&c.signal&&c.shouldSendCloseSession()&&(c.signal.sendCloseSession(i.getSeq(),c.sessionId,1),c.signal.removeSession(c.sessionId),c.closeSessionSignal=!0),c.resetPlay(),d.stopMaxTime(),d.invalid(),d.initStream(r,l,!1),void(e.rtm.isLogin()?(d.startMaxTime(),d.active(0)):e.streamCenter.playerList[r].isReDispatch=!0)}n&&n.player&&(0==t||1==t)&&a&&(e.dataReport.eventEndWithMsgInfo(a,"PlayState",{type:t}),1==t&&o&&e.dataReport.addMsgInfo(a,o),e.dataReport.uploadReport(a),delete e.stateCenter.reportSeqList.startPlay[r]),1===t&&e.streamCenter.playErrorCallBackList[r]&&(e.streamCenter.playErrorCallBackList[r]({errorCode:o&&o.code,extendedData:o&&o.message}),delete e.streamCenter.playErrorCallBackList[r],e.logger.info("zc.opsu.1 stop play called by sdk"),e.playModule.stopPlayingStream(r)),e.stateCenter.actionListener("playerStateUpdate",{state:s.ClientUtil.getPlayerStateType(t),streamID:r,errorCode:o&&o.code,extendedData:o&&o.message})},this.streamCenter.onPublishStateUpdate=function(t,r,i){e.onPublishStateUpdateHandle(t,r,i)},this.streamCenter.onPublishQualityUpdate=function(t,r){e.stateCenter.actionListener("publishQualityUpdate",t,r)},this.streamCenter.onPlayQualityUpdate=function(t,r){e.stateCenter.actionListener("playQualityUpdate",t,r)},this.streamCenter.onRemoteCameraStatusUpdate=function(t,r,s){var a=i.getReportSeq();e.dataReport.newReport(a,o.ZegoRTCLogEvent.kZegoTaskRemoteCameraUpdate.event),e.dataReport.addMsgInfo(a,{stream:o.ZegoRTCLogEvent.kZegoTaskRemoteCameraUpdate.stream(t),status:o.ZegoRTCLogEvent.kZegoTaskRemoteCameraUpdate.status(r)}),e.dataReport.uploadReport(a),e.stateCenter.actionListener("remoteCameraStatusUpdate",t,r),e.stateCenter.actionListener("_remoteCameraStatusUpdate",t,s)},this.streamCenter.onRemoteMicStatusUpdate=function(t,r,s){var a=i.getReportSeq();e.dataReport.newReport(a,o.ZegoRTCLogEvent.kZegoTaskRemoteMicUpdate.event),e.dataReport.addMsgInfo(a,{stream:o.ZegoRTCLogEvent.kZegoTaskRemoteMicUpdate.stream(t),status:o.ZegoRTCLogEvent.kZegoTaskRemoteMicUpdate.status(r)}),e.dataReport.uploadReport(a),e.stateCenter.actionListener("remoteMicStatusUpdate",t,r),e.stateCenter.actionListener("_remoteMicStatusUpdate",t,s)},this.streamCenter.onSoundLevelUpdate=function(t){e.stateCenter.actionListener("soundLevelUpdate",t)}},e.prototype.bindStreamHandler=function(){var e=this;this.streamHandler.onStreamUpdated=function(t,r,a){var n=a.map((function(e){return{streamID:e.streamID,user:e.user,extraInfo:e.extraInfo,urlsFLV:e.urlFlv,urlsRTMP:e.urlRtmp,urlsHLS:e.urlHls,urlsHttpsFLV:e.urlHttpsFlv,urlsHttpsHLS:e.urlHttpsHls}})),c={};if(0===r){var d=a.map((function(e){return{stream_id:e.streamID,code:i.STREAM_DELETE_REASON[e.closeType]&&i.STREAM_DELETE_REASON[e.closeType].code||0,description:i.STREAM_DELETE_REASON[e.closeType]&&i.STREAM_DELETE_REASON[e.closeType].description||"unknown"}}));c.stream_delete_reason=d}var l=i.getReportSeq();if(e.dataReport.newReport(l,o.ZegoRTCLogEvent.kZegoTaskLiveRoomGetStreamUpdateInfo.event),e.dataReport.addMsgInfo(l,{stream_update_type:o.ZegoRTCLogEvent.kZegoTaskLiveRoomGetStreamUpdateInfo.stream_update_type(1===r?"added":"deleted"),update_stream:o.ZegoRTCLogEvent.kZegoTaskLiveRoomGetStreamUpdateInfo.update_stream(n)}),e.dataReport.uploadReport(l),e.stateCenter.actionListener("roomStreamUpdate",t,s.ClientUtil.getSteamUpdateType(r),n,Object.keys(c).length>0?JSON.stringify(c):""),e.stateCenter.actionListener("_streamUpdated",r,a),1===r){var u=[];n.forEach((function(e){e.extraInfo&&u.push({streamID:e.streamID,user:e.user,extraInfo:e.extraInfo})})),u.length>0&&e.stateCenter.actionListener("streamExtraInfoUpdate",t,u)}},this.streamHandler.onPublishStateUpdate=function(t,r,i){e.logger.info("zb.opsu ",r);var o=e.stateCenter.reportSeqList.startPublish[r],a=e.streamCenter.publisherList[r];a&&a.publisher&&(0==t||1==t)&&o&&(e.dataReport.eventEndWithMsgInfo(o,"PublishState",{type:t}),1==t&&e.dataReport.addMsgInfo(o,i),e.dataReport.uploadReport(o),delete e.stateCenter.reportSeqList.startPublish[r]),e.stateCenter.actionListener("publisherStateUpdate",{state:s.ClientUtil.getPublisherStateType(t),streamID:r,errorCode:i.code,extendedData:i.message})},this.streamHandler.onStreamExtraInfoUpdated=function(t,r){var s=r.map((function(e){return{streamID:e.streamID,user:e.user,extraInfo:e.extraInfo}})),a=i.getReportSeq();e.dataReport.newReport(a,o.ZegoRTCLogEvent.kZegoTaskLiveRoomGetStreamExtraInfo.event),e.dataReport.addMsgInfo(a,{update_stream:o.ZegoRTCLogEvent.kZegoTaskLiveRoomGetStreamExtraInfo.update_stream(s)}),e.dataReport.uploadReport(a),e.stateCenter.actionListener("streamExtraInfoUpdate",t,s)}},e.prototype.screenStreamFrom=function(e,t,r){var i={};i.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}},i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:window.screen.width,maxHeight:window.screen.height}},!t&&(i.audio=!1),navigator.mediaDevices.getUserMedia(i).then((function(e){r(!0,e)})).catch((function(e){r(!1,null,e)}))},e.prototype.onPublishStateUpdateHandle=function(e,t,r){if(this.logger.info("zc.opsuh.0 call"),0==e)this.stateCenter.publishStreamList[t]&&([i.ENUM_PUBLISH_STREAM_STATE.tryPublish,i.ENUM_PUBLISH_STREAM_STATE.retryPublish].includes(this.stateCenter.publishStreamList[t].state)&&!this.stateCenter.streamList.find((function(e){return e.stream_id==t}))?(this.stateCenter.publishStreamList[t].state=i.ENUM_PUBLISH_STREAM_STATE.update_info,this.streamHandler.updateStreamInfo(t,i.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[t].extra_info)):(this.stateCenter.publishStreamList[t].state=i.ENUM_PUBLISH_STREAM_STATE.publishing,this.WebrtcOnPublishStateUpdateHandle(e,t,r)));else{var o=this.streamCenter.publisherList[t];if(1==e&&o&&s.ClientUtil.isReDispatch(r)){var a=o.publisher,n=o.retryDispatchHandler,c=o.publishOption;return 0!=a.sessionId&&a.signal&&a.shouldSendCloseSession()&&(a.signal.sendCloseSession(i.getSeq(),a.sessionId,1),a.signal.removeSession(a.sessionId),a.closeSessionSignal=!0),a.resetPublish(),n.stopMaxTime(),n.invalid(),n.initStream(t,c,!0),void(this.rtm.isLogin()?(n.startMaxTime(),n.active(0)):this.streamCenter.publisherList[t].isReDispatch=!0)}this.streamHandler.onPublishStateUpdate(e,t,r),1==e&&(this.logger.info("zc.opsuh.0 stop publish called by sdk"),this.publishModule.stopPublishingStream(t))}},e.prototype.WebrtcOnPublishStateUpdateHandle=function(e,t,r){this.stateCenter.publishStreamList[t].state==i.ENUM_PUBLISH_STREAM_STATE.publishing&&this.streamHandler.onPublishStateUpdate(e,t,r)},e.prototype.bindListener=function(e,t){return this.stateCenter.listenerList[e]?"function"!=typeof t?(this.logger.error("zc.o.0 listener callBack must be funciton"),!1):(-1==this.stateCenter.listenerList[e].indexOf(t)&&this.stateCenter.listenerList[e].push(t),!0):(this.logger.error("zc.o.0 event "+e+" no found"),!1)},e.prototype.deleteListener=function(e,t){if(!this.stateCenter.listenerList[e])return this.logger.error("zc.o.1 listener no found"),!1;var r=this.stateCenter.listenerList[e];return t?r.splice(r.indexOf(t),1):this.stateCenter.listenerList[e]=[],!0},e}();t.RTCModules=p},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StreamHandler=void 0;var i=r(0),o=r(2),s=r(0),a=r(1),n=r(4),c=r(3),d=function(){function e(e,t,r,i,o){this.minStreamSeq=0,this.streamSeqMergeMap=null,this.streamListHBMergeInterval=2e3,this.streamListMergeInterval=5e3,this.logger=e,this.rtm=r,this.stateCenter=t,this.dataReport=i,this.streamCenter=o}return e.prototype.setCDNInfo=function(e,t){e.urlFlv=t.urls_flv instanceof Array?t.urls_flv[0]:"string"==typeof t.urls_flv?t.urls_flv:"",e.urlHls=t.urls_m3u8 instanceof Array?t.urls_m3u8[0]:"string"==typeof t.urls_m3u8?t.urls_m3u8:"",e.urlHttpsFlv=t.urls_https_flv instanceof Array?t.urls_https_flv[0]:"string"==typeof t.urls_https_flv?t.urls_https_flv:"",e.urlHttpsHls=t.urls_https_m3u8 instanceof Array?t.urls_https_m3u8[0]:"string"==typeof t.urls_https_m3u8?t.urls_https_m3u8:"",e.urlRtmp=t.urls_rtmp instanceof Array?t.urls_rtmp[0]:"string"==typeof t.urls_rtmp?t.urls_rtmp:""},e.prototype.onStreamUpdated=function(e,t,r){},e.prototype.onStreamExtraInfoUpdated=function(e,t){},e.prototype.handleStreamStart=function(e){var t=this;this.logger.info("zb.sh.hss call stream update"),e.body?(this.streamListHBMergeInterval=e.body.stream_list_hb_wait_merge_time||2e3,this.streamListMergeInterval=e.body.stream_list_push_merge_timeout||5e3,this.stateCenter.streamQuerying=!1,this.rtm.modules.service.on("stream",(function(e){t.handleStreamUpdateRsp(e)})),this.rtm.modules.service.on("push_stream_update",(function(e){t.handlePushStreamUpdateMsg(e)})),this.handleFullUpdateStream(e.body.stream_seq,e.body.stream_info||[]),this.handleReconnectStream(e.body.stream_info),this.logger.info("zb.sh.hss call end")):this.logger.error("zb.sh.hss server response wrong")},e.prototype.onPublishStateUpdate=function(e,t,r){},e.prototype.updateStreamInfo=function(e,t,r,s){var a=this;void 0===r&&(r=""),this.logger.debug("zb.sh.usi call");var c={stream_id:e,extra_info:r},d=JSON.stringify(c),l={sub_cmd:t,stream_msg:d};this.stateCenter.streamInfoList[e]={},this.stateCenter.streamInfoList[e].seq=this.rtm.modules.service.sendMessage("stream",l,(function(e,t){a.handleStreamUpdateRsp(e)}),(function(c,d){if(a.stateCenter.isResetRoom||a.rtm.modules.service.isDisConnect()||!c.code||c.code!=n.errorCodeList.TIMEOUT.code||a.stateCenter.streamInfoList[e].seq!=d){if(c.body&&c.body.err_code){var l=o.ClientUtil.getServerError(c.body.err_code);s&&s(l,d)}}else 2001==t&&a.stateCenter.publishStreamList[e]&&a.stateCenter.publishStreamList[e].state==i.ENUM_PUBLISH_STREAM_STATE.update_info||2002==t?setTimeout((function(){a.updateStreamInfo(e,t,r,s)}),0):s&&s(n.errorCodeList.TIMEOUT)})),this.logger.info("zb.sh.usi call success cmd "+t)},e.prototype.handleStreamUpdateRsp=function(e){if(this.rtm.modules.service.isDisConnect())this.logger.error("zb.sh.hsur not login");else if(0==e.body.err_code){this.logger.info("zb.sh.hsur stream seq "+this.stateCenter.streamSeq+" server seq "+e.body.stream_seq),this.stateCenter.streamSeq=e.body.stream_seq;for(var t=function(t){var o=e.body.stream_info[t].stream_id;if(!r.stateCenter.publishStreamList[o])return r.logger.info("hsur.0 stream is not exist"),{value:void 0};r.stateCenter.publishStreamList[o].state==i.ENUM_PUBLISH_STREAM_STATE.update_info&&(r.stateCenter.publishStreamList[o].state=i.ENUM_PUBLISH_STREAM_STATE.publishing,r.stateCenter.streamList.find((function(e){return e.stream_id==o}))||r.stateCenter.streamList.push(e.body.stream_info[t]),r.onPublishStateUpdate(0,o,{code:0,message:""})),delete r.stateCenter.streamInfoList[o]},r=this,o=0;o<e.body.stream_info.length;o++){var s=t(o);if("object"==typeof s)return s.value}}else this.logger.error("zb.sh.hsur stream update error "+e.body.err_code)},e.prototype.handleFetchStreamListRsp=function(e){this.logger.info("zb.sh.hfslr call"),this.stateCenter.streamQuerying=!1,0===e.body.err_code?this.stateCenter.streamSeq!==e.body.stream_seq?(this.handleFullUpdateStream(e.body.stream_seq,e.body.stream_info),this.logger.info("zb.sh.hfslr call success")):this.logger.info("zb.sh.hfslr same seq"):this.logger.info("zb.sh.hfslr server error=",e.body.err_code)},e.prototype.handleFullUpdateStream=function(e,t){var r=this;this.logger.info("zb.sh.hfus call"),this.stateCenter.streamSeq=e,this.logger.debug("zb.sh.hfus server seq "+this.stateCenter.streamSeq),o.ClientUtil.mergeStreamList(this.stateCenter.idName,this.stateCenter.streamList,t,(function(e,t,o){0!==e.length&&(r.logger.debug("zb.sh.hfus callback addstream"),r.onStreamUpdated(r.stateCenter.roomid,i.ENUM_STREAM_UPDATE_TYPE.added,r.makeCallbackStreamList(e))),0!==t.length&&(r.logger.debug("zb.sh.hfus callback delstream"),r.onStreamUpdated(r.stateCenter.roomid,i.ENUM_STREAM_UPDATE_TYPE.deleted,r.makeCallbackStreamList(t))),0!==o.length&&(r.logger.debug("zb.sh.hfus callback updatestream"),r.onStreamExtraInfoUpdated(r.stateCenter.roomid,r.makeCallbackStreamList(o)))})),this.logger.info("zb.sh.hfus call success")},e.prototype.handlePushStreamUpdateMsg=function(e){if(this.logger.info("zb.sh.hpsum call"),e.body.stream_info&&0!==e.body.stream_info.length){if(e.body.stream_info.length+this.stateCenter.streamSeq!==e.body.stream_seq)return this.logger.info("zb.sh.hpsum call updatestream"),void this.fetchStreamList();switch(this.stateCenter.streamSeq=e.body.stream_seq,e.body.stream_cmd){case i.ENUM_STREAM_UPDATE_CMD.added:this.handleAddedStreamList(e.body.stream_info);break;case i.ENUM_STREAM_UPDATE_CMD.deleted:this.handleDeletedStreamList(e.body.stream_info);break;case i.ENUM_STREAM_UPDATE_CMD.updated:this.handleUpdatedStreamList(e.body.stream_info)}this.logger.info("zb.sh.hpsum call success")}else this.logger.info("zb.sh.hpsum, emtpy list")},e.prototype.handleAddedStreamList=function(e){this.logger.debug("zb.sh.hasl call");for(var t,r=[],o=0;o<e.length;o++)if(e[o].anchor_id_name!=this.stateCenter.idName){t=!1;for(var s=0;s<this.stateCenter.streamList.length;s++)if(e[o].stream_id===this.stateCenter.streamList[s].stream_id){t=!0;break}t||r.push(e[o])}else this.logger.debug("hdsl.0 have self stream added");if(0!==r.length){this.logger.debug("zb.sh.hasl callback addstream");for(var a=0;a<r.length;a++)this.stateCenter.streamList.push(r[a]);this.onStreamUpdated(this.stateCenter.roomid,i.ENUM_STREAM_UPDATE_TYPE.added,this.makeCallbackStreamList(r))}this.logger.info("zb.sh.hasl call success")},e.prototype.handleDeletedStreamList=function(e){this.logger.debug("zb.sh.hdsl call");for(var t=[],r=0;r<e.length;r++)if(e[r].anchor_id_name!=this.stateCenter.idName){for(var o=this.stateCenter.streamList.length-1;o>=0;o--)if(e[r].stream_id===this.stateCenter.streamList[o].stream_id){this.stateCenter.streamList.splice(o--,1),t.push(e[r]);break}}else this.logger.debug("zb.sh.hdsl have self stream deleted");0!==t.length&&(this.logger.debug("zb.sh.hdsl callback delstream"),this.onStreamUpdated(this.stateCenter.roomid,i.ENUM_STREAM_UPDATE_TYPE.deleted,this.makeCallbackStreamList(t))),this.logger.info("zb.sh.hdsl call")},e.prototype.handleUpdatedStreamList=function(e){this.logger.debug("zb.sh.husl call");for(var t=[],r=0;r<e.length;r++)if(e[r].anchor_id_name!=this.stateCenter.idName){for(var i=0;i<this.stateCenter.streamList.length;i++)if(e[r].stream_id===this.stateCenter.streamList[i].stream_id){e[r].extra_info!==this.stateCenter.streamList[i].extra_info&&(this.stateCenter.streamList[i]=e[r],t.push(e[r]));break}}else this.logger.debug("hsul.0 have self stream updated");0!==t.length&&(this.logger.debug("zb.sh.husl callback updatestream"),this.onStreamExtraInfoUpdated(this.stateCenter.roomid,this.makeCallbackStreamList(t))),this.logger.info("zb.sh.husl call success")},e.prototype.fetchStreamList=function(){if(this.logger.info("zb.sh.fsl call"),this.rtm.modules.service.isDisConnect())this.logger.info("zb.sh.fsl state error");else if(this.stateCenter.streamQuerying)this.logger.info("zb.sh.fsl already doing");else{this.stateCenter.streamQuerying=!0,this.logger.debug("zb.sh.fsl send fetch request");this.rtm.modules.service.sendMessage("stream_info",{reserve:0},this.handleFetchStreamListRsp.bind(this),(function(e,t){})),this.logger.info("zb.sh.fsl call success")}},e.prototype.handleReconnectStream=function(e){this.logger.info("zb.sh.hrs call");var t=this.streamCenter.publisherList,r=this.streamCenter.playerList,o=function(r){if(t[r].publisher.state!=i.ENUM_PUBLISH_STATE.publishing||e.find((function(e){return e.stream_id==r}))){if(t[r].publisher.state==i.ENUM_PUBLISH_STATE.stop&&e.find((function(e){return e.stream_id==r}))){s.updateStreamInfo(r,i.ENUM_STREAM_SUB_CMD.liveEnd);for(var o=0;o<s.stateCenter.streamList.length;o++)if(s.stateCenter.streamList[o].stream_id==r){s.stateCenter.streamList.splice(o--,1);break}}}else s.updateStreamInfo(r,i.ENUM_STREAM_SUB_CMD.liveBegin,s.stateCenter.publishStreamList[r].extra_info)},s=this;for(var a in t)o(a);for(var a in t){if(t[a].isReDispatch)this.logger.info("zb.sh.hrs "+a+"retry dispatch"),(n=t[a].retryDispatchHandler).stopMaxTime(),n.invalid(),n.initStream(a,t[a].publishOption,!0),n.active(0),t[a].isReDispatch=!1}for(var a in r){var n;if(r[a].isReDispatch)this.logger.info("zb.sh.hrs "+a+"retry dispatch"),(n=r[a].retryDispatchHandler).stopMaxTime(),n.invalid(),n.initStream(a,r[a].playOption,!1),n.active(0),r[a].isReDispatch=!1}this.logger.info("zb.sh.hrs end")},e.prototype.makeCallbackStreamList=function(e){var t=[];if(e&&e.length>0)for(var r=0;r<e.length;r++){var i={user:{userID:e[r].anchor_id_name,userName:e[r].anchor_nick_name},extraInfo:e[r].extra_info,streamID:e[r].stream_id,roomID:"",urlFlv:"",urlRtmp:"",urlHls:"",urlHttpsFlv:"",urlHttpsHls:"",streamGID:e[r].stream_gid,closeType:e[r].close_type};this.setCDNInfo(i,e[r]),t.push(i)}return t},e.prototype.updateMixStream=function(e,t,r){var c,d=this;if(this.logger.info("zb.sh.ums call"),!e.noTaskID&&!e.taskID)return this.logger.error("zb.sh.ums no taskId found"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kTaskIDNullError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kTaskIDNullError.message}),!1;if(!e.noTaskID&&"string"!=typeof e.taskID)return this.logger.error("zb.rh.lg taskId must be string"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(!e.noTaskID&&e.taskID.length>i.MAX_MIX_TASK_ID_LENGTH)return this.logger.error("zb.sh.ums taskId is too long"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kTaskIDToLongError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kTaskIDToLongError.message}),!1;if(!e.noTaskID&&!o.ClientUtil.checkIllegalCharacters(e.taskID))return this.logger.error("zb.sh.ums task ID contains illegal characters"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kTaskIDInvalidCharacterError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kTaskIDInvalidCharacterError.message}),!1;if(!e.inputList||0==e.inputList.length)return this.logger.error("zb.sh.ums input list wrong"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kInputListNullError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kInputListNullError.message}),!1;e.inputList.forEach((function(e){"AUDIO"===e.contentType&&(!e.layout&&(e.layout={top:0,left:0,bottom:0,right:0}),e.layout.top=0,e.layout.left=0,e.layout.bottom=1,e.layout.right=1)}));for(var l=e.inputList.every((function(e){return"AUDIO"===e.contentType})),u=0;u<e.inputList.length;u++){var p=e.inputList[u];if("object"!=typeof p.layout)return this.logger.error("zb.sh.ums input layout must be object"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(!(o.ClientUtil.checkInteger(p.layout.top,!1)&&o.ClientUtil.checkInteger(p.layout.bottom,!1)&&o.ClientUtil.checkInteger(p.layout.left,!1)&&o.ClientUtil.checkInteger(p.layout.right,!1)))return this.logger.error("zb.sh.ums top、left、bottom、right must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1}if(!e.outputList||0==e.outputList.length)return this.logger.error("zb.sh.ums no output list found"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputListNullError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputListNullError.message}),!1;if(e.outputList.some((function(e){return"string"==typeof e&&!o.ClientUtil.isUrl(e)&&!o.ClientUtil.checkIllegalCharacters(e)||"object"==typeof e&&e.target&&!o.ClientUtil.isUrl(e.target)&&!o.ClientUtil.checkIllegalCharacters(e.target)})))return this.logger.error("zb.sh.ums stream output target is incorrect"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputTargetInvalidError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputTargetInvalidError.message}),!1;if(!(l||e.outputConfig&&"object"==typeof e.outputConfig))return this.logger.error("zb.sh.ums no output config found"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputNoTargetError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputNoTargetError.message}),!1;if(l&&(void 0===e.outputConfig&&(e.outputConfig={outputBitrate:0,outputFPS:0,outputWidth:0,outputHeight:0}),e.outputConfig.outputBitrate=.001,e.outputConfig.outputFPS=1,e.outputConfig.outputWidth=1,e.outputConfig.outputHeight=1),!(l||e.outputConfig.outputBitrate&&o.ClientUtil.checkInteger(e.outputConfig.outputBitrate)))return this.logger.error("zb.sh.ums bitrate param is required and must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(!e.outputConfig.outputFPS||!o.ClientUtil.checkInteger(e.outputConfig.outputFPS))return this.logger.error("zb.sh.ums fps param is required and must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(!e.outputConfig.outputWidth||!o.ClientUtil.checkInteger(e.outputConfig.outputWidth))return this.logger.error("zb.sh.ums width param is required and must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(!e.outputConfig.outputHeight||!o.ClientUtil.checkInteger(e.outputConfig.outputHeight))return this.logger.error("zb.sh.ums height param is required and must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(void 0!==e.outputConfig.outputAudioCodecID&&!o.ClientUtil.checkInteger(e.outputConfig.outputAudioCodecID,!1))return this.logger.error("zb.sh.ums AudioCodecID param must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(void 0!==e.outputConfig.outputAudioBitrate&&!o.ClientUtil.checkInteger(e.outputConfig.outputAudioBitrate))return this.logger.error("zb.sh.ums AudioBitrate param must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;if(void 0!==e.outputConfig.outputAudioChannels&&!o.ClientUtil.checkInteger(e.outputConfig.outputAudioChannels,!1))return this.logger.error("zb.sh.ums AudioChannels param must be integer number"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kParamError.message}),!1;var h=0;e.outputConfig.singleStreamPassThrough&&"boolean"==typeof e.outputConfig.singleStreamPassThrough&&(h=e.outputConfig.singleStreamPassThrough?1:0);var g={task_id:e.taskID,id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:i.PROTO_VERSION,bypass:h},m=this.stateCenter.mixStreamAdvance;m&&(m.videoCodec&&(g.extra_params=[{key:"video_encode",value:m.videoCodec}]),m.backgroundColor&&(g.output_bg_color=m.backgroundColor),m.backgroundImage&&(g.output_bg_image=m.backgroundImage),m.waterMark&&(g.watermark=m.waterMark),m.extraParams&&(!g.extra_params&&(g.extra_params=[]),(c=g.extra_params).push.apply(c,m.extraParams)));var E=[];for(u=0;u<e.inputList.length;u++){var f=e.inputList[u],_=f.streamID;this.stateCenter.testEnvironment&&(_="zegotest-"+this.stateCenter.appid+"-"+f.streamID),E.push({stream_id:_,content_control:"AUDIO"===f.contentType?1:0,rect:{layer:u,top:f.layout.top,left:f.layout.left,bottom:f.layout.bottom,right:f.layout.right}})}g.MixInput=E,o.ClientUtil.actionSuccessCallback("kZegoTaskMixStart"+e.taskID,this.stateCenter.reportList)&&o.ClientUtil.actionSuccessCallback("kZegoTaskMixStart"+e.taskID,this.stateCenter.reportList)(s.REPORT_ACTION.addMsgInfo,void 0,{mix_stream_id:a.ZegoRTCLogEvent.kZegoTaskMixStart.mix_stream_id(e.taskID),stream_cnt:a.ZegoRTCLogEvent.kZegoTaskMixStart.stream_cnt(E.length),input_stream_list:a.ZegoRTCLogEvent.kZegoTaskMixStart.input_stream_list(E)});var S=[];e.outputList.forEach((function(t){var i={},o="";if("string"==typeof t)o=t;else{if("object"!=typeof t||!t.target)return d.logger.error("zb.sh.ums output target required"),r({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputTargetInvalidError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kOutputTargetInvalidError.message}),!1;o=t.target}o.startsWith("rtmp://")||o.startsWith("https://")&&o.endsWith(".flv")||o.startsWith("https://")&&o.endsWith(".m3u8")?i.mixurl=o:d.stateCenter.testEnvironment?i.stream_id="zegotest-"+d.stateCenter.appid+"-"+o:i.stream_id=o,i.bitrate=1e3*e.outputConfig.outputBitrate,i.fps=e.outputConfig.outputFPS,i.width=e.outputConfig.outputWidth,i.height=e.outputConfig.outputHeight,e.outputConfig.outputAudioCodecID&&(i.audio_enc_id=e.outputConfig.outputAudioCodecID),"vp8"===m.videoCodec?i.audio_enc_id=3:"h264"===m.videoCodec&&(i.audio_enc_id=0),e.outputConfig.outputAudioBitrate&&(i.audio_bitrate=1e3*e.outputConfig.outputAudioBitrate),e.outputConfig.outputAudioChannels&&(i.audio_channel_cnt=e.outputConfig.outputAudioChannels),d.stateCenter.testEnvironment?i.testenv=1:i.testenv=0,S.push(i)})),g.MixOutput=S,o.ClientUtil.actionSuccessCallback("kZegoTaskMixStart"+e.taskID,this.stateCenter.reportList)&&o.ClientUtil.actionSuccessCallback("kZegoTaskMixStart"+e.taskID,this.stateCenter.reportList)(s.REPORT_ACTION.addMsgInfo,void 0,{output_target_list:a.ZegoRTCLogEvent.kZegoTaskMixStart.output_target_list(S)});var T={channel:"zeus",cmd:"start_mix",req_body:JSON.stringify(g)};return this.logger.debug("zb.sh.ums send command"),this.sendBizChannelRequest(T,(function(e,s,a){d.logger.debug("zb.sh.ums receive message");var n="zegotest-"+d.stateCenter.appid+"-";if(0!=a.length){for(var c=JSON.parse(a),l=[],u=0;u<c.play.length;u++){var p={rtmpURL:"",hlsURL:"",flvURL:""},h=c.play[u].stream_alias||"";d.stateCenter.testEnvironment&&h&&h.startsWith(n)&&(h=h.slice(n.length)),p.streamID=h,c.play[u].rtmp_url&&c.play[u].rtmp_url.length>0&&(p.rtmpURL=c.play[u].rtmp_url),c.play[u].hls_url&&c.play[u].hls_url.length>0&&(p.hlsURL=c.play[u].hls_url),c.play[u].hdl_url&&c.play[u].hdl_url.length>0&&(p.flvURL=c.play[u].hdl_url),l.push(p)}if(t){var g={mixerOutputList:l};t({errorCode:0,extendedData:JSON.stringify(g)})}}else r&&r({errorCode:o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+1).code,extendedData:""})}),(function(e,t,i){if("number"==typeof e){d.logger.debug("zb.sh.ums error: "+e);var s=[];if(1000000150==e&&0!=i.length)for(var c=JSON.parse(i),l="zegotest-"+d.stateCenter.appid+"-",u=0;u<c.non_exist_streams.length;u++){var p=c.non_exist_streams[u];d.stateCenter.testEnvironment&&p.startsWith(l)?s.push(p.slice(l.length)):s.push(p)}r&&r({errorCode:o.ClientUtil.getServerError(e).code,extendedData:""})}else{d.logger.debug("zb.sh.ums error code "+e.code);var h=void 0;h=e==n.errorCodeList.TIMEOUT?a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kRequestError:a.ZegoRTCLogEvent.kZegoTaskMixStart.error.kInternalError,r&&r({errorCode:h.code,extendedData:""})}})),!0},e.prototype.sendBizChannelRequest=function(e,t,r,i){var o=this;void 0===i&&(i=!1),e=Object.assign(e,{is_retry_req:i?1:0}),this.rtm.modules.service.sendMessage("biz_channel",e,(function(e,r){t(e.header.seq,e.body.cmd,e.body.rsp_body)}),(function(i,s){var a=i.body.err_code,n=i.message.body.rsp_body;"number"!=typeof a||2002!==a?r(a,s,n):o.sendBizChannelRequest(e,t,r,!0)}))},e.prototype.setMixerTaskConfig=function(e){var t=this;return new Promise((function(r,i){var n,c={},d={};if(e&&e.videoCodec){var l=e.videoCodec.toLowerCase();if(-1==["vp8","h264"].indexOf(l))return t.logger.error("zb.sh.ums param videoCode error"),i({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kVideoConfigInvalidError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kVideoConfigInvalidError.message}),!1;c.videoCodec=l,d.video_codec=l}if(e.backgroundColor){if(!o.ClientUtil.checkInteger(e.backgroundColor))return t.logger.error("zb.sh.ums param backgroundColor must be integer number"),i({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kParamError.message}),!1;c.backgroundColor=e.backgroundColor,d.background_color=e.backgroundColor}if(e.backgroundImage){if("string"!=typeof e.backgroundImage)return t.logger.error("zb.sh.ums param outputBgImage error"),i({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kParamError.message}),!1;if(!e.backgroundImage.startsWith("preset-id://")||!e.backgroundImage.endsWith(".jpg")&&!e.backgroundImage.endsWith(".png"))return t.logger.error("zb.sh.ums illegal input background image URL"),i({errorCode:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kBackgroundImageUrlInvalidError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskMixConfig.error.kBackgroundImageUrlInvalidError.message}),!1;c.backgroundImage=e.backgroundImage,d.background_image=e.backgroundImage}e.waterMark&&(c.waterMark=e.waterMark,d.water_mark=e.waterMark),e.extraParams&&(c.extraParams||(c.extraParams=[]),(n=c.extraParams).push.apply(n,e.extraParams)),t.stateCenter.mixStreamAdvance=c,o.ClientUtil.actionSuccessCallback("kZegoTaskMixConfig",t.stateCenter.reportList)&&o.ClientUtil.actionSuccessCallback("kZegoTaskMixConfig",t.stateCenter.reportList)(s.REPORT_ACTION.addMsgInfo,void 0,{config:a.ZegoRTCLogEvent.kZegoTaskMixConfig.config(d)}),r({errorCode:0,extendedData:""})}))},e.prototype.stopMixStream=function(e,t,r,s,c){var d=this;this.logger.info("zb.sh.sms call");var l={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:i.PROTO_VERSION};"string"==typeof e&&(l.task_id=e),null!=s?this.stateCenter.testEnvironment?l.stream_id="zegotest-"+this.stateCenter.appid+"-"+s:l.stream_id=s:null!=c&&(l.mixurl=c);var u={channel:"zeus",cmd:"stop_mix",req_body:JSON.stringify(l)};return this.sendBizChannelRequest(u,(function(){t&&t({errorCode:0})}),(function(e){if("number"==typeof e)r&&r({errorCode:o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+e).code,extendedData:""});else{d.logger.error("zb.sh.sms stop mix fail "+JSON.stringify(e));var t=void 0;t=e==n.errorCodeList.TIMEOUT?a.ZegoRTCLogEvent.kZegoTaskMixStop.error.kRequestError:a.ZegoRTCLogEvent.kZegoTaskMixStop.error.kInternalError,r&&r({errorCode:t.code,extendedData:""})}})),!0},e.prototype.updateStreamExtraInfo=function(e,t){return this.logger.info("zb.sh.usei call"),this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].extra_info=t,this.stateCenter.publishStreamList[e].state>=i.ENUM_PUBLISH_STREAM_STATE.update_info&&this.updateStreamInfo(e,i.ENUM_STREAM_SUB_CMD.liveUpdate,t)),!0},e.prototype.setStreamExtraInfo=function(e,t){var r=this;return new Promise((function(i,o){r._handleStreamInfo(e,t,o),i({errorCode:0,extendedData:""})}))},e.prototype._setStreamExtraInfo=function(e,t){return this._handleStreamInfo(e,t)},e.prototype._handleStreamInfo=function(e,t,r){var o=i.getReportSeq();if(this.dataReport.newReport(o,a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.event),this.dataReport.addMsgInfo(o,{stream:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.stream(e),stream_extra_info:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.stream_extra_info(t),room_sid:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.room_sid(this.stateCenter.sessionid)}),"string"!=typeof e||""==e)return this.logger.error("zb.ssei streamID must be string and not empty"),this.dataReport.addMsgInfo(o,{error:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.code,message:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.message+" streamID must be string and not empty"}),this.dataReport.uploadReport(o),r&&r({errorCode:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.message}),!1;if(void 0===t||""===t)return this.logger.error("zb.ssei extraInfo is empty"),this.dataReport.addMsgInfo(o,{error:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.code,message:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.message+" extraInfo is empty"}),this.dataReport.uploadReport(o),r&&r({errorCode:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kExtraInfoNullError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kExtraInfoNullError.message}),!1;if("string"!=typeof t||""==t)return this.logger.error("zb.ssei extraInfo must be string"),this.dataReport.addMsgInfo(o,{error:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.code,message:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.message+" extraInfo must be string"}),this.dataReport.uploadReport(o),r&&r({errorCode:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kParamError.message}),!1;if(this.rtm.modules.service.isDisConnect())return this.logger.error("zb.ssei not login"),this.dataReport.uploadReport(o,void 0,a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kNoLoginError),r&&r({errorCode:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kNoLoginError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kNoLoginError.message}),!1;if(!this.stateCenter.publishStreamList[e])return this.logger.error("zb.ssei publish stream no found"),this.dataReport.addMsgInfo(o,a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kPublishStreamNoFoundError),this.dataReport.uploadReport(o),r&&r({errorCode:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kPublishStreamNoFoundError.code,extendedData:a.ZegoRTCLogEvent.kZegoTaskLiveRoomSendStreamExtraInfo.error.kPublishStreamNoFoundError.message}),!1;var s=this.updateStreamExtraInfo(e,t);return this.dataReport.uploadReport(o),s},e.prototype.publishTarget=function(e){var t=this,r=i.getReportSeq();switch(e.type){case"addpush":this.dataReport.newReport(r,a.ZegoRTCLogEvent.kZegoTaskAddPublishCdnUrl.event);break;case"delpush":case"clearpush":this.dataReport.newReport(r,a.ZegoRTCLogEvent.kZegoTaskRemovePublishCdnUrl.event)}return this.dataReport.addMsgInfo(r,{stream:a.ZegoRTCLogEvent.kZegoTaskRemovePublishCdnUrl.stream(e.streamID),target_url:a.ZegoRTCLogEvent.kZegoTaskRemovePublishCdnUrl.target_url(e.pushUrl)}),new Promise((function(i,s){var n=function(e,i){t.logger.error("zb.pt"+(i||e.message)),t.dataReport.addMsgInfo(r,{error:e.code,message:e.message+(i||"")}),t.dataReport.uploadReport(r),s({errorCode:e.code,extendedData:e.message+(i?" "+i:"")})};e.streamID&&"string"==typeof e.streamID||n(a.ZegoRTCLogEvent.kZegoTaskPublishTarget.error.kParamError,"stream id type error"),e.pushUrl&&"string"==typeof e.pushUrl||n(a.ZegoRTCLogEvent.kZegoTaskPublishTarget.error.kParamError,"push url error"),t.stateCenter.publishStreamList[e.streamID]||n(a.ZegoRTCLogEvent.kZegoTaskPublishTarget.error.kPublishStreamNoFoundError);t._publishTarget(e,(function(e){t.dataReport.uploadReport(r),i(e)}),(function(e){var i=o.ClientUtil.getServerError(e.errorCode),a=o.ClientUtil.decodeServerError(i.code,i.message);t.dataReport.addMsgInfo(r,a),t.dataReport.uploadReport(r),s(e)}))}))},e.prototype._publishTarget=function(e,t,r){var s=this;if(-1==["addpush","delpush","clearpush"].indexOf(e.type))return this.logger.error("zb.sh.pt cdn push type error"),void(r&&r({errorCode:n.errorCodeList.PUBLISHER_CDN_PUSH_ERROR.code,extendedData:n.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT.message+" type error"}));this.logger.info("zb.sh.ptcall");var a=Math.ceil((new Date).getTime()/1e3),c=e.streamID;this.stateCenter.testEnvironment&&(c="zegotest-"+this.stateCenter.appid+"-"+e.streamID);var d={appid:this.stateCenter.appid,biz_type:0,timestamp:a,seq:this.stateCenter.cdnSeq++,version:1*i.PROTO_VERSION,stream_id:c,pushurl:e.pushUrl},l={channel:"media",cmd:e.type,req_body:JSON.stringify(d)};this.logger.debug("zb.sh.pt send command"),this.sendBizChannelRequest(l,(function(a,c,d){if(s.logger.info("zb.sh.pt receive message"),0!=d.length){var l=JSON.parse(d),u=l.code,p=l.message;u&&0!=u?(s.logger.error("zb.sh.pt "+e.type+" error code: "+u+" "+p),r&&r({errorCode:n.errorCodeList.UNKNOWN_SERVER_ERROR.code,extendedData:n.errorCodeList.UNKNOWN_SERVER_ERROR.message+" cmd: "+e.type+" "+u+" "+p+"  "})):(s.logger.info("zb.sh.pt "+e.type+" success"),t&&t({errorCode:0,extendedData:""}))}else r&&r({errorCode:o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+1).code,extendedData:o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+1).message})}),(function(t,i,o){s.logger.info("zb.sh.pt error: "+t);var a="";2001==t?a="invalid channel":2002==t&&(a="bizchannel error"),s.logger.error("zb.sh.pt "+a),r&&r({errorCode:n.errorCodeList.UNKNOWN_SERVER_ERROR.code,extendedData:n.errorCodeList.UNKNOWN_SERVER_ERROR.message+" cmd: "+e.type+" "+t+" "+a+"  "})}))},e.prototype.patchStreamList=function(e){var t=this;e.body.stream_seq===this.stateCenter.streamSeq||this.streamSeqMergeMap||(this.logger.info(c.ZEGO_WEBRTC_ACTION.STREAMHANDLER_PATCH_STREAM_LIST+" call update stream "+this.stateCenter.streamSeq+" server "+e.body.stream_seq),this.streamSeqMergeTimer&&clearTimeout(this.streamSeqMergeTimer),this.streamSeqMergeTimer=setTimeout((function(){t.handleMergeTimeout()}),this.streamListHBMergeInterval)),this.minStreamSeq=e.body.stream_seq},e.prototype.mergeStreamByStreamSeq=function(e,t,r){var i=this;this.streamSeqMergeMap||(this.logger.warn(c.ZEGO_WEBRTC_ACTION.STREAMHANDLER_MERGE_STREAM_BY_STREAM_SEQ+" new merge stream list "+this.stateCenter.streamSeq+" server "+t),this.streamSeqMergeMap={},this.streamSeqMergeTimer&&clearTimeout(this.streamSeqMergeTimer),this.streamSeqMergeTimer=setTimeout((function(){i.handleMergeTimeout()}),this.streamListMergeInterval)),this.logger.info(c.ZEGO_WEBRTC_ACTION.STREAMHANDLER_MERGE_STREAM_BY_STREAM_SEQ+" "+this.streamSeqMergeMap+" "+e+" "+t+" "+r),this.streamSeqMergeMap[t]={cmd:e,streamList:r}},e.prototype.handleMergeTimeout=function(){var e=Object.keys(this.streamSeqMergeMap).map((function(e){return+e})).sort((function(e,t){return e-t}));e[e.length-1]-e[0]+1===e.length||e[e.length-1]>=this.minStreamSeq?this.mergeStream(e):(this.streamSeqMergeMap=null,this.fetchStreamList())},e.prototype.mergeStream=function(e){var t=this;this.logger.info(c.ZEGO_WEBRTC_ACTION.STREAMHANDLER_MERGE_STREAM+" merge streamList "+this.stateCenter.streamSeq+" streamSeqList "+e.join(","));var r=e[e.length-1],o=[];e.forEach((function(e){if(t.streamSeqMergeMap&&t.streamSeqMergeMap[e])switch(t.streamSeqMergeMap[e].cmd){case i.ENUM_STREAM_UPDATE_CMD.added:t.streamSeqMergeMap[e].streamList.forEach((function(e){var t=o.findIndex((function(t){return t.stream_id==e.stream_id}));-1!==t&&o.splice(t),o.push(e)}));break;case i.ENUM_STREAM_UPDATE_CMD.deleted:t.streamSeqMergeMap[e].streamList.forEach((function(e){var t=o.findIndex((function(t){return t.stream_id==e.stream_id}));-1!==t&&o.splice(t)}));break;case i.ENUM_STREAM_UPDATE_CMD.updated:t.streamSeqMergeMap[e].streamList.forEach((function(e){var t=o.findIndex((function(t){return t.stream_id==e.stream_id}));-1!==t&&o.splice(t),o.push(e)}))}})),this.streamSeqMergeMap=null,this.logger.info(c.ZEGO_WEBRTC_ACTION.STREAMHANDLER_MERGE_STREAM+" "+o),this.handleFullUpdateStream(r,o)},e.prototype.reset=function(){this.minStreamSeq=0,this.streamSeqMergeMap=null,this.streamSeqMergeTimer&&(clearTimeout(this.streamSeqMergeTimer),this.streamSeqMergeTimer=void 0),this.streamListHBMergeInterval=2e3,this.streamListMergeInterval=5e3},e}();t.StreamHandler=d},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoStreamCenterWeb=void 0;var s=r(7),a=r(18),n=r(20),c=r(0),d=r(21),l=r(22),u=r(23),p=r(24),h=r(4),g=r(1),m=function(e){function t(t,r,i,o,s,a){var n=e.call(this)||this;return n.testEnvironment=!1,n.heartbeatTimer=null,n.heartbeatInterval=1e4,n.qualityTimerInterval=3e3,n.previewStreamList=[],n.signalList={},n.chargeInfos={itemtype:"ChargeInfos",timestamp_begin:0,timestamp_end:0,timestamp_diff_flag:0,timestamp_diff:0,infos:[]},n.chargeInfosTimer=null,n.chargeInfosInterval=6e4,n.chargeInfoSeq=0,n.soundLevelDelegate=!1,n.soundLevelInterval=1e3,n.isPeer=!1,n.probeList={},n.playerList={},n.publisherList={},n.playSuccessCallBackList={},n.playErrorCallBackList={},n.tryCountConnectInterval=3e3,n.checkMessageTimeout=function(){for(var e in n.signalList)n.signalList[e].signal&&n.signalList[e].signal.checkMessageTimeout()},n.getAllInUseUrl=function(){var e=[];for(var t in n.signalList)e.push(t);return e},n.onDisconnectHandle=function(e){if(n.logger.info("zsc.od.0 call"),n.signalList[e]){for(var t=n.signalList[e],r=0;r<t.publishConnectedList.length;r++){var i=n.publisherList[t.publishConnectedList[r]];i&&i.publisher&&i.publisher.onDisconnect()}for(r=0;r<t.playConnectedList.length;r++){var o=n.playerList[t.playConnectedList[r]];o&&o.player&&o.player.onDisconnect()}delete n.signalList[e],n.stopSignalHeartbeat(),n.stopChargeInfosUpload(),n.stopSoundLevel()}},n.logger=t,n.stateCenter=r,n.dataReport=i,n.rtm=o,n.ac=s,n.mediaEleSources=a,n}return o(t,e),t.prototype.onSignalDisconnected=function(e){},t.prototype.setQualityMonitorCycle=function(e){var t=this;return this.logger.debug("zsc.qmc.0 timeInterval "+e),0==Object.keys(this.publisherList).length?this.qualityTimerInterval=e:Object.keys(this.publisherList).forEach((function(r){t.publisherList[r].publisher.qualityTimeInterval=e,t.publisherList[r].publisher.setPublishQualityTimer()})),!0},t.prototype.setSessionInfo=function(e,t,r,i){this.logger.debug("zsc.ssi.0 called"),this.appid=e,this.userid=t,this.token=r,this.testEnvironment=i},t.prototype.onPlayStateUpdate=function(e,t,r){},t.prototype.onPlayQualityUpdate=function(e,t){},t.prototype.onPublishStateUpdate=function(e,t,r){},t.prototype.onPublishQualityUpdate=function(e,t){},t.prototype.onUpdateHeartBeatIntervalHandle=function(e){e!=this.heartbeatInterval&&(this.logger.debug("zsc.uhb.0 update "+e),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatInterval=e,this.startSignalHeartbeat())},t.prototype.setPublishStateStart=function(e,t,r){var i=this;this.logger.info("zsc.pss.0 call "+e);var o=this.publisherList[e],s=this.stateCenter.reportSeqList.startPublish[e];if(this.dataReport.eventStart(s,"setPublishState"),o)return this.logger.error("zsc.pss.0 publisher already exist"),this.dataReport.eventEndWithMsgInfo(s,"setPublishState",{message:"publisher already exist"}),this.dataReport.uploadReport(s,void 0,g.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kIsPublishing),delete this.stateCenter.reportSeqList.startPublish[e],!1;var n=new a.ZegoPublish(this.logger,this.dataReport,this.qualityTimerInterval,this,this.ac,this.mediaEleSources,this.stateCenter);n.state=c.ENUM_PUBLISH_STATE.start,n.isPeer=this.isPeer,n.reportSeq=this.stateCenter.reportSeqList.startPublish[e];var d=t.getVideoTracks()[0]&&t.getVideoTracks()[0].label,l=t.getAudioTracks()[0]&&t.getAudioTracks()[0].label,h=t.getVideoTracks()[0]&&t.getVideoTracks()[0].getSettings().deviceId,m=t.getAudioTracks()[0]&&t.getAudioTracks()[0].getSettings().deviceId,E=new u.RetryStreamHandler(this.logger,this.stateCenter,this);return this.publisherList[e]={seq:0,localStream:t,publisher:n,serverUrls:[],ttl:0,isCenterNode:!1,streamID:e,publishOption:r,cameraLabel:d||"",microLabel:l||"",cameraDeviceId:h||"",microDeviceId:m||"",deviceStateCount:0,retryStreamHandler:E,retryDispatchHandler:new p.RetryDispatchHandler(this.logger,this.stateCenter,this.rtm,this)},n.onPublishStateUpdate=function(t,r,o,s){var a=i.publisherList[r];a?E.publishStateHandle(t,a.streamID,o,s):i.logger.error("zsc.psuh.0 cannot find publish "+e)},n.onPublishQualityUpdate=function(t,r){var o=i.publisherList[t];o?(i.stateCenter.deviceStateOut&&0===r.audio.audioBitrate?(o.deviceStateCount++,o.deviceStateCount>=2&&(o.deviceStateCount=0,i.stateCenter.deviceStateOut=!1,i.logger.warn("zsc.pss.0 publish audio error by device"))):o.deviceStateCount=0,i.onPublishQualityUpdate(o.streamID,r)):i.logger.error("zsc.psuh.0 cannot find publish "+e)},this.dataReport.eventStart(n.reportSeq,"GetSignalUrl"),this.dataReport.eventStart(n.streamReportSeq,"GetSignalUrl"),!0},t.prototype.startPublishingStream=function(e){this.logger.info("zsc.sps.0 call");var t=this.publisherList[e];if(!t)return this.logger.error("zsc.sps.0 publisher don't exist"),!1;var r=t.publisher;if(this.dataReport.eventEndWithMsg(r.reportSeq,"GetSignalUrl",{urls:t.serverUrls}),this.dataReport.eventEndWithMsg(r.streamReportSeq,"GetSignalUrl",{urls:t.serverUrls}),!t.serverUrls||0===t.serverUrls.length)return t.retryStreamHandler.publishStateHandle(c.ENUM_PUBLISH_STATE_UPDATE.error,e,h.errorCodeList.DISPATCH_ERROR),this.logger.info("zsc.sps.0 server don't have signal url"),!1;var i=t.serverUrls.indexOf(this.server);-1!==i&&(t.serverUrls.splice(i,1),t.serverUrls.unshift(this.server));var o=t.retryStreamHandler;return o.invalid(),o.init(this.stateCenter.streamRetryTime),o.initStream(!0,e,t.serverUrls),o.activePublish(0)},t.prototype.updateWaitingList=function(e,t,r,i,o){t?e.publishWaitingList.push({streamID:r,success:i,error:o}):e.playWaitingList.push({streamID:r,success:i,error:o})},t.prototype.publishStream=function(e){var t=this.publisherList[e].publisher;if(t){var r=null,i=null,o=this.publisherList[e].publishOption,s=this.checkPreview(this.publisherList[e].localStream);if(s){r=s.localStream,i=s.videoInfo;var a=this.stateCenter.reportSeqList.startPublish[e];this.dataReport.addMsgInfo(a,{cap_w:g.ZegoRTCLogEvent.kZegoTaskPublishStart.cap_w(s.videoInfo.width),cap_h:g.ZegoRTCLogEvent.kZegoTaskPublishStart.cap_h(s.videoInfo.height),w:g.ZegoRTCLogEvent.kZegoTaskPublishStart.w(s.videoInfo.width),h:g.ZegoRTCLogEvent.kZegoTaskPublishStart.h(s.videoInfo.height),video_en_fps:g.ZegoRTCLogEvent.kZegoTaskPublishStart.video_en_fps(s.videoInfo.frameRate),video_en_bps:g.ZegoRTCLogEvent.kZegoTaskPublishStart.video_en_bps(s.videoInfo.bitRate)}),r?(this.logger.info("zsc.ps.0 call success"),t.gwNodeTTL<(new Date).getTime()&&(t.gwNode="",t.gwNodeList=[],t.gwNodeTTL=0),t.startPublish(e,r,i,s.mediaStreamConfig,o)):this.logger.error("zsc.ps.0 no localStream found")}else this.logger.error("zsc.ps.0 no preview found")}else this.logger.info("zsc.ps.0 publisher don't exist")},t.prototype.connectPublishServer=function(e,t){var r=this,i=this.publisherList[e];return i?(this.dataReport.eventStart(i.publisher.reportSeq,"ConnectServer"),this.dataReport.eventStart(i.publisher.streamReportSeq,"ConnectServer"),this.connectWithReuseSignalServer(e,!0,t,(function(e,t,i){var o=r.publisherList[e];if(o){var s=o.publisher;if(s){r.dataReport.eventEndWithMsg(s.reportSeq,"ConnectServer",{result:0,server:i}),r.dataReport.eventEndWithMsg(s.streamReportSeq,"ConnectServer",{result:0,server:i});var a=t.tokenInfo;r.logger.info("zsc.cps.0 update token success"),a&&a.report&&(s.qualityUpload=a.report,s.qualityUploadInterval=a.report_interval),s.signal=t.signal,r.server=i,r.publishStream(e),r.getTokenSuccess()}else r.logger.info("zsc.cps.1 check publisher don't exist")}else r.logger.info("zsc.cps.0 after connect publisher don't exist")}),(function(e,t){r.logger.error("zsc.cps.0 "+e+" connect fail "+t);var i=r.publisherList[e];if(i){var o=i.publisher;o?(r.dataReport.eventEndWithMsg(o.reportSeq,"ConnectServer",{result:t}),r.dataReport.uploadReport(o.reportSeq),delete r.stateCenter.reportSeqList.startPublish[e],i.retryStreamHandler.publishStateHandle(c.ENUM_PUBLISH_STATE_UPDATE.error,e,h.errorCodeList.CONNECT_FAILED)):r.logger.info("zsc.cps.1 check publisher don't exist")}else r.logger.info("zsc.cps.0 after connect publisher don't exist")})),!0):(this.logger.error("zsc.cps.0 publisher don't exist"),!1)},t.prototype.getTokenSuccess=function(){this.logger.debug("zsc.gts.0 call")},t.prototype.stopPublishingStream=function(e){var t=this.publisherList[e];if(t){var r=t.retryStreamHandler;for(var i in r&&(r.stopMaxTime(),r.invalid()),this.signalList)this.signalList[i].publishWaitingList=this.signalList[i].publishWaitingList.filter((function(t){return t.streamID!==e}));delete this.publisherList[e],t.publisher&&(t.publisher.stopPublish(),delete t.publisher),this.removeStreamFromSignal(!0,e),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),this.logger.debug("zsc.sps.0.1 call success")}else this.logger.warn("zsc.sps.0.1 publisher don't exist")},t.prototype.connectWithReuseSignalServer=function(e,t,r,i,o){var s=this;this.logger.info("zsc.crss.0 begin "+r);var a=null;if(this.signalList[r])(a=this.signalList[r]).state==c.ENUM_SIGNAL_STATE.connected?(this.logger.info("zsc.crss.0 already connected "+r+" streamId: "+e),t?a.publishConnectedList.push(e):a.playConnectedList.push(e),i(e,a,r)):a.state==c.ENUM_SIGNAL_STATE.connecting&&(this.logger.info("zsc.crss.0 signal is connecting "+r+" streamId: "+e),this.updateWaitingList(a,t,e,i,o));else{this.logger.info("zsc.crss.0 new signal "+r+" streamId: "+e);var n=new d.ZegoSignal(this.logger,this.stateCenter);n.setSessionInfo(this.appid,this.userid),n.onUpdateHeartBeatInterval=this.onUpdateHeartBeatIntervalHandle.bind(this),n.onDisconnect=this.onDisconnectHandle;var l=this.publisherList[e]?this.publisherList[e].retryStreamHandler:this.playerList[e]?this.playerList[e].retryStreamHandler:null;if(this.stateCenter.streamConnectTime)n.tryConnectInterval=this.stateCenter.streamConnectTime;else if(l&&l.retryActiveCount){var u=l.retryActiveCount*(l.retryActiveCount-1)/2+2;u=u>c.MAX_RETRY_CONNECT_INTERVAL?c.MAX_RETRY_CONNECT_INTERVAL:u,n.tryConnectInterval=1e3*u}this.signalList[r]={signal:n,state:c.ENUM_SIGNAL_STATE.connecting,publishWaitingList:[],playWaitingList:[],publishConnectedList:[],playConnectedList:[],tokenInfo:null},this.updateWaitingList(this.signalList[r],t,e,i,o),n.connectServer(this.token,r,(function(e,t,i){a=s.signalList[r];var o,n,d=0;if(0!=e){for(s.logger.info("zsc.crss.0 connect failed "+t),d=0;d<a.publishWaitingList.length;d++)(o=a.publishWaitingList[d]).error&&o.error(o.streamID,e);for(d=0;d<a.playWaitingList.length;d++)(n=a.playWaitingList[d]).error&&n.error(n.streamID,e);delete s.signalList[r]}else{for(s.logger.debug("zsc.crss.0 connected success "+t),a.state=c.ENUM_SIGNAL_STATE.connected,a.tokenInfo=i,d=0;d<a.publishWaitingList.length;d++)(o=a.publishWaitingList[d]).success&&o.success(o.streamID,a,t),a.publishConnectedList.push(o.streamID);for(d=0;d<a.playWaitingList.length;d++)(n=a.playWaitingList[d]).success&&n.success(n.streamID,a,t),a.playConnectedList.push(n.streamID);a.publishWaitingList=[],a.playWaitingList=[],null==s.heartbeatTimer&&s.startSignalHeartbeat(),null==s.chargeInfosTimer&&s.startChargeInfosUpload(),null==s.soundLevelTimer&&s.soundLevelDelegate&&s.startSoundLevel()}}))}},t.prototype.setPlayStateStart=function(e,t){var r=this,i=this.playerList[e],o=this.stateCenter.reportSeqList.startPlay[e];if(this.dataReport.eventStart(o,"setPlayState"),i)return this.logger.error("zsc.pss.1 player already exist"),this.dataReport.eventEndWithMsgInfo(o,"setPlayState",{message:"player already exist"}),this.dataReport.uploadReport(o,void 0,g.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kIsPlaying),delete this.stateCenter.reportSeqList.startPlay[e],!1;var s=new l.ZegoPlayWeb(this.logger,null,this.dataReport,this.qualityTimerInterval,this,this.ac,this.stateCenter);t&&[0,2,3].includes(t.resourceMode)&&(s.resourceMode=t.resourceMode),s.state=c.ENUM_PLAY_STATE.start,s.isPeer=this.isPeer,s.reportSeq=this.stateCenter.reportSeqList.startPlay[e],s.beginTime=(new Date).getTime();var a=new u.RetryStreamHandler(this.logger,this.stateCenter,this);return this.playerList[e]={seq:0,player:s,signal:null,serverUrls:[],ttl:0,isCenterNode:!1,streamID:e,playOption:t,retryStreamHandler:a,retryDispatchHandler:new p.RetryDispatchHandler(this.logger,this.stateCenter,this.rtm,this)},s.onPlayStateUpdate=function(e,t,i,o){var s=r.playerList[t];s?a.playStateHandle(e,s.streamID,i,o):r.logger.error("zsc.pss.1 cannot find play "+t)},s.onPlayQualityUpdate=function(e,t){var i=r.playerList[e];i?r.onPlayQualityUpdate(i.streamID,t):r.logger.error("zsc.pss.1 cannot find play "+e)},s.onRemoteCameraStatusUpdate=function(e,t,i){var o=r.playerList[e];o?r.onRemoteCameraStatusUpdate(o.streamID,t,i):r.logger.error("zsc.pss.1 cannot find play "+e)},s.onRemoteMicStatusUpdate=function(e,t,i){var o=r.playerList[e];o?r.onRemoteMicStatusUpdate(o.streamID,t,i):r.logger.error("zsc.pss.1 cannot find play "+e)},this.dataReport.eventStart(s.reportSeq,"GetSignalUrl"),this.dataReport.eventStart(s.streamReportSeq,"GetSignalUrl"),!0},t.prototype.onRemoteMicStatusUpdate=function(e,t,r){},t.prototype.onRemoteCameraStatusUpdate=function(e,t,r){},t.prototype.startPlayingStream=function(e,t){this.logger.info("zsc.sps.1 start play called");var r=this.playerList[e];if(!r)return this.logger.error("zsc.sps.1 player don't exist"),!1;var i=r.player;if(this.dataReport.eventEndWithMsg(i.reportSeq,"GetSignalUrl",{urls:r.serverUrls}),this.dataReport.eventEndWithMsg(i.streamReportSeq,"GetSignalUrl",{urls:r.serverUrls}),0==r.serverUrls.length)return r.retryStreamHandler.playStateHandle(c.ENUM_PLAY_STATE_UPDATE.error,e,h.errorCodeList.DISPATCH_ERROR),this.logger.info("zsc.sps.1 server don't have signal url"),!1;var o=r.serverUrls.indexOf(this.server);-1!==o&&(r.serverUrls.splice(o,1),r.serverUrls.unshift(this.server));var s=r.retryStreamHandler;return s.invalid(),s.init(this.stateCenter.streamRetryTime),s.initStream(!1,e,r.serverUrls),s.activePull(0,t)},t.prototype.connectPlayServer=function(e,t,r){var i=this,o=this.playerList[e];return o?(this.dataReport.eventStart(o.player.reportSeq,"ConnectServer"),this.dataReport.eventStart(o.player.streamReportSeq,"ConnectServer"),this.connectWithReuseSignalServer(e,!1,r,(function(e,r,o){var s=i.playerList[e];if(s){var a=s.player;if(a){i.dataReport.eventEndWithMsg(a.reportSeq,"ConnectServer",{result:0,server:o}),i.dataReport.eventEndWithMsg(a.streamReportSeq,"ConnectServer",{result:0,server:o});var n=r.tokenInfo;i.logger.info("zsc.cps.1 update token success"),n&&n.report&&(a.qualityUpload=n.report,a.qualityUploadInterval=n.report_interval),a.signal=r.signal,i.server=o,i.playStream(e,t),i.getTokenSuccess()}else i.logger.error("zsc.cps.1 checkplayer don't exist")}else i.logger.error("zsc.cps.1 after connect player don't exist")}),(function(t,r){var o=i.playerList[t];o?(i.dataReport.eventEndWithMsg(o.player.reportSeq,"ConnectServer",{result:r}),i.dataReport.uploadReport(o.player.reportSeq),delete i.stateCenter.reportSeqList.startPlay[e],o.retryStreamHandler.playStateHandle(c.ENUM_PLAY_STATE_UPDATE.error,t,h.errorCodeList.CONNECT_FAILED)):i.logger.error("zsc.cps.1 after connect player don't exist")})),!0):(this.logger.error("zsc.cps.1 player don't exist"),!1)},t.prototype.playStream=function(e,t){var r=this.playerList[e].player;r?(this.logger.info("zsc.ps.1 call success"),r.gwNodeTTL<(new Date).getTime()&&(r.gwNode="",r.gwNodeList=[],r.gwNodeTTL=0),r.startPlay(e,t,this.playerList[e].playOption)):this.logger.warn("zsc.ps.1 player don't exist")},t.prototype.stopSignalHeartbeat=function(){this.logger.debug("zsc.ssh.1 call");var e=0;for(var t in this.signalList)e+=1;this.heartbeatTimer&&0==e&&(this.logger.info("zsc.ssh.1 stop"),clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},t.prototype.removeStreamFromSignal=function(e,t){var r=[];for(var i in this.signalList){var o=this.signalList[i];if(e){for(var s=0;s<o.publishConnectedList.length;s++)if(o.publishConnectedList[s]===t){this.logger.debug("zsc.rsfs.0 found from publish"),o.publishConnectedList.splice(s,1);break}for(s=0;s<o.publishWaitingList.length;s++)if(o.publishWaitingList[s].streamID===t){this.logger.debug("zsc.rsfs.0 found from publish"),o.publishWaitingList.splice(s,1);break}}else{for(var a=0;a<o.playConnectedList.length;a++)if(o.playConnectedList[a]===t){this.logger.debug("zsc.rsfs.0 found from play"),o.playConnectedList.splice(a,1);break}for(a=0;a<o.playWaitingList.length;a++)if(o.playWaitingList[a].streamID===t){this.logger.debug("zsc.rsfs.0 found from play"),o.playWaitingList.splice(a,1);break}}0==o.publishConnectedList.length&&0==o.playConnectedList.length&&0==o.publishWaitingList.length&&0==o.playWaitingList.length&&(o.signal.disconnectServer(),r.push(i))}for(var n=0;n<r.length;n++)delete this.signalList[r[n]]},t.prototype.stopPlayingStream=function(e){var t=this.playerList[e];if(t){var r=t.retryStreamHandler;for(var i in r&&(r.stopMaxTime(),r.invalid()),this.signalList)this.signalList[i].playWaitingList=this.signalList[i].playWaitingList.filter((function(t){return t.streamID!==e}));delete this.playerList[e],t.player&&(t.player.stopPlay(),delete t.player),this.removeStreamFromSignal(!1,e),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),delete this.playSuccessCallBackList[e],delete this.playErrorCallBackList[e],this.logger.debug("zsc.sps.1.1 call success")}else this.logger.info("zsc.sps.1.1 player don't exist")},t.prototype.reset=function(){for(var e in this.publisherList){(r=this.publisherList[e].retryStreamHandler)&&(r.stopMaxTime(),r.invalid()),this.publisherList[e].publisher&&this.publisherList[e].publisher.stopPublish()}for(var t in this.playerList){var r;(r=this.playerList[t].retryStreamHandler)&&(r.stopMaxTime(),r.invalid()),this.playerList[t].player&&this.playerList[t].player.stopPlay()}for(var i in this.signalList)this.signalList[i].signal&&this.signalList[i].signal.disconnectServer();this.playerList={},this.publisherList={},this.signalList={},this.server="",this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.probeList={}},t.prototype.startSignalHeartbeat=function(){var e=this;this.logger.debug("zsc.ssh.0 call"),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatTimer=setTimeout((function(){e.checkSignalHeartbeat()}),this.heartbeatInterval)},t.prototype.startChargeInfosUpload=function(){var e=this;this.logger.debug("zsc.sciu.0 call"),this.chargeInfosTimer&&(clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null),this.chargeInfosTimer=setTimeout((function(){e.checkChargeInfos()}),this.chargeInfosInterval)},t.prototype.checkChargeInfos=function(){this.logger.debug("zsc.cci.0 call");var e={is_publishing:0,play_max_audio_bitrate:0,play_stream_resolution_infos:[]};for(var t in this.chargeInfos.timestamp_begin=(new Date).getTime(),this.publisherList){this.publisherList[t].publisher.state===c.ENUM_PUBLISH_STATE.publishing&&(e.is_publishing=1);break}e.play_max_audio_bitrate=0;var r=function(t){var r=i.playerList[t].player.playStream,o=r&&0!==r.getVideoTracks().length?r.getVideoTracks()[0].getSettings():void 0,s={video_width:o&&o.width?o.width:0,video_height:o&&o.height?o.height:0,count:1};if(!e.play_stream_resolution_infos.find((function(e){return e.video_width==s.video_width&&e.video_height==s.video_height&&(e.count++,!0)}))&&e.play_stream_resolution_infos.push(s),0==s.video_width&&0==s.video_height){var a=1e3*i.playerList[t].player.lastPlayStats.audioBitrate;a>e.play_max_audio_bitrate&&(e.play_max_audio_bitrate=a)}},i=this;for(var o in this.playerList)r(o);0!==this.chargeInfos.timestamp_end?(this.chargeInfos.timestamp_diff=this.chargeInfos.timestamp_begin-this.chargeInfos.timestamp_end,this.chargeInfos.timestamp_diff_flag=1):(this.chargeInfos.timestamp_diff=0,this.chargeInfos.timestamp_diff_flag=0),this.chargeInfos.timestamp_end=(new Date).getTime(),this.chargeInfos.infos=[e],0!==e.play_stream_resolution_infos.length&&this.logger.report(this.chargeInfos),this.chargeInfosTimer&&this.startChargeInfosUpload()},t.prototype.checkSignalHeartbeat=function(){for(var e in this.logger.debug("zsc.csh.0 call"),this.signalList)this.signalList[e].signal&&this.signalList[e].signal.sendHeartbeat();this.heartbeatTimer&&this.startSignalHeartbeat()},t.prototype.stopChargeInfosUpload=function(){this.logger.debug("zsc.sciu.0 call");var e=0;for(var t in this.signalList)e+=1;this.chargeInfosTimer&&0==e&&(this.logger.info("zsc.sciu.0 stop"),clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null)},t.prototype.getPublisher=function(e){var t=null;return this.publisherList[e]&&this.publisherList[e].publisher&&(t=this.publisherList[e].publisher),t},t.prototype.checkPreview=function(e){for(var t=0;t<this.previewStreamList.length;t++)if(this.previewStreamList[t].localStream===e)return this.previewStreamList[t];return null},t.prototype.checkPublish=function(e){for(var t in this.publisherList)if(this.publisherList[t].localStream==e)return this.publisherList[t];return null},t.prototype.removePreview=function(e){for(var t=0;t<this.previewStreamList.length;t++)if(this.previewStreamList[t]===e){this.previewStreamList.splice(t,1);break}},t.prototype.onPlayerStreamUrlUpdate=function(e,t,r){},t.prototype.getScreenConstrains=function(e){var t={};if("boolean"==typeof e&&e)t={audio:!1,frameRate:15,bitRate:1500};else if("object"==typeof e){switch(e.videoQuality){case 1:t={frameRate:c.ENUM_SCREEM_RESOLUTION_TYPE.LOW.frameRate,bitRate:c.ENUM_SCREEM_RESOLUTION_TYPE.LOW.bitRate};break;case 2:t={frameRate:c.ENUM_SCREEM_RESOLUTION_TYPE.MEDIUM.frameRate,bitRate:c.ENUM_SCREEM_RESOLUTION_TYPE.MEDIUM.bitRate};break;case 3:t={frameRate:c.ENUM_SCREEM_RESOLUTION_TYPE.HIGH.frameRate,bitRate:c.ENUM_SCREEM_RESOLUTION_TYPE.HIGH.bitRate};break;case 4:t={frameRate:e.frameRate,bitRate:e.bitRate,width:e.width,height:e.height}}t.audio="boolean"==typeof e.audio&&e.audio}return t},t.prototype.createScreenPreviewer=function(e,t){var r=new s.ZegoPreview(this.logger),i=e.getVideoTracks()[0].getSettings();return this.previewStreamList.push(r),r.mediaStreamConfig=t,e.getAudioTracks().length>0&&(r.micTrack=e.getAudioTracks()[0]),r.localStream=e,r.videoInfo={width:i.width,height:i.height,frameRate:i.frameRate||15,bitRate:t.bitRate||1e3},r.previewSuc=!0,r.isScreen=!0,r},t.prototype.setSoundLevelDelegate=function(e,t){for(var r in this.logger.info("zsc.ssd.0 call"),t&&(this.soundLevelInterval=t),this.soundLevelDelegate=e,this.publisherList){var i=this.publisherList[r].publisher;e?i.startSoundLevel():i.stopSoundLevel()}for(var r in this.playerList){var o=this.playerList[r].player;e?o.startSoundLevel():o.stopSoundLevel()}if(e){this.logger.info("zsc.ssd.0 start getting sound");var s=0;for(var a in this.signalList)s+=1;null==this.soundLevelTimer&&s>0&&this.startSoundLevel()}else this.logger.info("zsc.ssd.0 stop getting sound"),this.soundLevelTimer&&clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3},t.prototype.startSoundLevel=function(){var e=this;this.logger.debug("zsc.ssl.0 call"),this.soundLevelTimer&&(clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null),this.soundLevelTimer=setTimeout((function(){e.checkSoundLevel()}),this.soundLevelInterval)},t.prototype.checkSoundLevel=function(){this.logger.debug("zsc.csl.0 call");var e=[];for(var t in this.publisherList){var r=this.publisherList[t].publisher;e.push({streamID:this.getBackStreamId(r.streamId),soundLevel:r.soundLevel,type:"push"})}for(var t in this.playerList){var i=this.playerList[t].player;e.push({streamID:this.getBackStreamId(i.streamId),soundLevel:i.soundLevel,type:"pull"})}this.soundLevelDelegate&&e.length>0&&this.onSoundLevelUpdate(e),this.soundLevelDelegate&&this.startSoundLevel()},t.prototype.getBackStreamId=function(e){return this.testEnvironment&&e?e.replace("zegotest-"+this.appid+"-",""):e},t.prototype.onSoundLevelUpdate=function(e){},t.prototype.stopSoundLevel=function(){var e=0;for(var t in this.signalList)e+=1;this.soundLevelTimer&&0==e&&(this.logger.info("zsc.ssl.0 stop"),clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3)},t.prototype.startNetProbe=function(e,t,r){var i=this;if(this.isPeer){var o=!0;0==r.length&&(o=!1,r=e?this.publisherList[t.streamId].serverUrls:this.playerList[t.streamId].serverUrls),r.forEach((function(r){if(!(i.probeList[r]&&i.probeList[r].timeStamp+9e5<(new Date).getTime()||t.probeState==c.ENUM_PROBE_STATE.probed)){var s="zegoprobe_"+(new Date).getTime();i.setPlayStateStart(s);var a=i.playerList[s]?i.playerList[s].player:null;a&&(a.isProbe=!0,o?(a.gwNode=r,a.signal=t.signal,a.startPlay(s,(function(){}))):i.connectPlayServer(s,(function(){}),r),a.onCalNetQualityResult=function(o,n){i.logger.info("zc.ocnqr.0 "+a.gwNode+" "+o+" "+n),i.probeList[r]={result:o,netQuality:n,timeStamp:(new Date).getTime()},t.gwNode==r||t.signal.server==r?t.netQuality=n:i.handleCalNetQualityResult(e,o,n,t,r),i.stopPlayingStream(s)})}}))}},t.prototype.handleCalNetQualityResult=function(e,t,r,i,o){if(this.logger.info("zc.hcqr.0 "+i.netQuality+" probe "+r+" "+o),0===t){if(r>Math.max(75,i.netQuality+20)&&i.probeState==c.ENUM_PROBE_STATE.tryProbe)if(e){var s=i,a=s.streamId,n=s.localStream,d=s.videoInfo,l=s.mediaStreamConfig,u=s.publishOption;0!=s.sessionId&&s.signal&&s.shouldSendCloseSession()&&(s.signal.sendCloseSession(c.getSeq(),s.sessionId,1),s.signal.removeSession(s.sessionId),s.closeSessionSignal=!0),s.resetPublish(),this.publisherList[a].isCenterNode?(s.gwNode=o,s.startPublish(a,n,d,l,u)):this.connectPublishServer(a,o)}else{var p=i,h=(a=p.streamId,p.getRemoteStreamSuc),g=p.playOption;0!=p.sessionId&&p.signal&&p.shouldSendCloseSession()&&(p.signal.sendCloseSession(c.getSeq(),p.sessionId,1),p.signal.removeSession(p.sessionId),p.closeSessionSignal=!0),p.resetPlay(),this.playerList[a].isCenterNode?(p.gwNode=o,p.startPlay(a,h,g)):this.connectPlayServer(a,h,o)}else this.logger.error("zc.hcqr.0 "+i.netQuality+" probe "+r+" "+o);i.probeState=c.ENUM_PROBE_STATE.probed}},t}(n.ZegoStreamCenter);t.ZegoStreamCenterWeb=m},function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoPublish=void 0;var a=r(0),n=s(r(8)),c=r(19),d=r(5),l=r(2),u=r(1),p=r(3),h=function(){function e(e,t,r,i,o,s,n){this.state=a.ENUM_PUBLISH_STATE.stop,this.sessionId=0,this.sessionToken="",this.candidateInfo=[],this.qualityTimer=null,this.publishQualityList=[],this.maxQualityListCount=10,this.lastPublishStats={},this.reportSeq=NaN,this.streamReportSeq=a.getSeq(),this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.qualitySeq=0,this.videoInfo={width:0,height:0,frameRate:0,bitRate:0,channelCount:1,audioBitrate:48e3},this.mediaStreamConfig=null,this.offerSeq=0,this.audioMixList=[],this.arrayBufferMap={},this.effectList=[],this.qualityCount=0,this.closeSessionSignal=!1,this.channelCount=1,this.localSdpRevert=!1,this.remoteSdpRevert=!1,this.videoCodec="H264",this.stateNego=a.ENUM_PUBLISH_STATE_NEGO.stop,this.negoInterval=25e3,this.publishEvent=!1,this.soundLevel=0,this.script=null,this.mic=null,this.cameraState="on",this.microState="on",this.gwNode="",this.gwNodeList=[],this.gwNodeTTL=0,this.needIncMax=!1,this.probeCount=0,this.gotMax=!1,this.initFitCnt=0,this.targetRate=0,this.totalBitrateArray=[],this.totalTargetRateArray=[],this.totalRetransRateArray=[],this.isPeer=!1,this.peerFailCount=0,this.peerID=0,this.netQuality=0,this.probeTime=0,this.probeInterval=6e4,this.probeState=a.ENUM_PROBE_STATE.probed,this.logger=e,this.dataReport=t,this.qualityTimeInterval=r,this.ac=o,this.mediaEleSources=s,this.streamCenter=i,this.stateCenter=n,this.dataReport.newReport(this.streamReportSeq)}return e.prototype.publishStateUpdateError=function(e,t){this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_STATE_ERROR+"  call ",this.streamId,JSON.stringify(e)),this.streamId&&this.onPublishStateUpdate(a.ENUM_PUBLISH_STATE_UPDATE.error,this.streamId,e,t),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_STATE_ERROR+"  ended")},e.prototype.resetPublish=function(){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_RESET_PUBLISH+"   "+this.streamId+" call"),this.state=a.ENUM_PUBLISH_STATE.stop,this.publishEvent=!1,null==this.peerConnection&&null==this.peerConnection||(this.peerConnection.close(),this.peerConnection=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.clearPublishQualityTimer(),this.signal&&(this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId),this.signal.unregisterPushCallback("SessionResetPush",this.sessionId),this.signal.unregisterPushCallback("PublishEventPush",this.sessionId),this.signal.unregisterPushCallback("ClientInfoPush",this.sessionId)),this.sessionSeq=0,this.offerSeq=0,this.candidateInfo=[],this.publishQualityList=[],this.qualityUploadLastTime=0,this.stopSoundLevel(),this.resetEncBitrate()},e.prototype.clearPublishQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPublishStats={},this.qualityCount=0},e.prototype.shouldSendCloseSession=function(){return this.state!=a.ENUM_PUBLISH_STATE.stop&&this.state!=a.ENUM_PUBLISH_STATE.waitingSessionRsp},e.prototype.startPublish=function(e,t,r,i,o){var s=this;this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+e+" called"),this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),e?(this.streamId=e,this.localStream=t,this.mediaStreamConfig=i,this.channelCount=i.channelCount,this.publishOption=o||{},navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&i&&(i.externalCapture||i.externalMediaStream)&&(this.localStream.onaddtrack=function(){s.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+s.streamId+" Track added");var e=s.localStream.getVideoTracks(),t=s.localStream.getAudioTracks();if(e.length>1)s.peerConnection.getSenders().find((function(t){return t.track.kind===e[1].kind})).replaceTrack(e[1]),s.localStream.removeTrack(e[0]);else if(t.length>1){s.peerConnection.getSenders().find((function(e){return e.track.kind===t[1].kind})).replaceTrack(t[1]),s.localStream.removeTrack(t[0])}}),r&&(this.videoInfo=r),o&&o.videoCodec&&(this.videoCodec=o.videoCodec),this.dataReport.addMsgInfo(this.reportSeq,{video_en_codec_id:u.ZegoRTCLogEvent.kZegoTaskPublishStart.video_en_codec_id("VP8"==this.videoCodec?2:0),audio_c_channel_count:u.ZegoRTCLogEvent.kZegoTaskPublishStart.audio_c_channel_count(2==this.channelCount?2:1),audio_en_bps:u.ZegoRTCLogEvent.kZegoTaskPublishStart.audio_en_bps(this.videoInfo.audioBitrate),aec_level:u.ZegoRTCLogEvent.kZegoTaskPublishStart.aec_level(1==i.AEC?2:0==i.AEC?0:2),ans_level:u.ZegoRTCLogEvent.kZegoTaskPublishStart.ans_level(1==i.ANS?2:0==i.ANS?0:2),agc:u.ZegoRTCLogEvent.kZegoTaskPublishStart.agc(1==i.AGC?2:0==i.AGC?0:2),traffic_control_min_video_bitrate:u.ZegoRTCLogEvent.kZegoTaskPublishStart.traffic_control_min_video_bitrate(this.videoInfo.bitRate)}),this.isPeer?this.createOffer():this.createSession(),this.negoTimer=setTimeout((function(){s.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" waiting timeout"),s.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishNegoTimeoutError)}),this.negoInterval)):this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+e+" streamId is null")},e.prototype.createSession=function(e){var t=this;this.sessionSeq=a.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession"),this.dataReport.eventStart(this.streamReportSeq,"CreateSession");var r=this.streamId;1==this.streamCenter.testEnvironment&&(r="zegotest-"+this.streamCenter.appid+"-"+this.streamId),this.isPeer?this.signal.createSessionWithSdp({seq:this.sessionSeq,type:0,mode:0,streamId:r,videoInfo:this.videoInfo,strAuthParam:this.publishOption&&this.publishOption.streamParams||"",sdp:e.sdp,serverHost:this.gwNode},(function(e,r,i){t.handleCreateSessionWithSdpResp(e,r,i)}),(function(r,i){t.dataReport.eventEndWithMsg(t.reportSeq,"CreateSession",{error:r}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"CreateSession",{error:r}),r==a.SEND_MSG_TIMEOUT&&t.peerFailCount<2?(t.peerFailCount++,t.createSession(e)):r==a.SEND_MSG_TIMEOUT&&t.peerFailCount>=2?(t.isPeer=!1,t.streamCenter.isPeer=!1,t.createSession()):t.publishStateUpdateError(r==a.SEND_MSG_TIMEOUT?u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionTimeoutError:u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionRequestError)})):this.signal.createSession(this.sessionSeq,0,0,r,this.publishOption&&this.publishOption.streamParams,this.gwNode,(function(e,r,i){t.handleCreateSessionResp(e,r,i)}),(function(e,r){t.reportSeq,t.dataReport.eventEndWithMsg(t.reportSeq,"CreateSession",{error:e}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"CreateSession",{error:e}),t.publishStateUpdateError(e==a.SEND_MSG_TIMEOUT?u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionTimeoutError:u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionRequestError)})),this.state=a.ENUM_PUBLISH_STATE.waitingSessionRsp,this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+this.streamId+" called success"),this.stateNego=a.ENUM_PUBLISH_STATE_NEGO.start},e.prototype.handleCreateSessionResp=function(e,t,r){var i=r.turn_server,o=i.split("?")[0]&&i.split("?")[0].slice(5),s=this.streamCenter.server.split("?"),a=s[1]&&s[1].slice(2);this.dataReport.eventEndWithMsg(this.streamReportSeq,"CreateSession",{sessionId:r.session_id,url:"webrtc://"+o+"/"+a+"/"+this.streamId}),this.dataReport.eventEndWithMsg(this.reportSeq,"CreateSession",{sessionId:r.session_id,url:"webrtc://"+o+"/"+a+"/"+this.streamId}),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+this.streamId+" sessionId:"+r.session_id),this.sessionSeq==e?(this.gwNodeList=r.gw_nodes&&r.gw_nodes.length>0?r.gw_nodes:this.gwNodeList,this.gwNode=r.gw_nodes&&r.gw_nodes.length>0?this.gwNodeList[0]:this.gwNode,this.gwNodeTTL=r.gw_nodes_ttl?(new Date).getTime()+1e3*r.gw_nodes_ttl:this.gwNodeTTL,this.stateCenter.clientIP=r.clientip?r.clientip:this.stateCenter.clientIP,0!==r.result?(this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+this.streamId+" create session failed "+r.result),this.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionRequestError)):(this.sessionId=r.session_id,this.sessionToken=r.session_token,this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+this.streamId+" create session success "+this.sessionId),this.dataReport.addMsgInfo(this.reportSeq,{session_id:u.ZegoRTCLogEvent.kZegoTaskPublishStart.session_id(this.sessionId)}),this.onCreatePublishSessionSuccess(r))):this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" "+this.streamId+" seq is not match.")},e.prototype.handleCreateSessionWithSdpResp=function(e,t,r){var i=this;this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" sessionId:"+t),this.sessionSeq==e?(this.dataReport.eventEndWithMsg(this.streamReportSeq,"CreateSession",{sessionId:t}),this.dataReport.eventEndWithMsg(this.reportSeq,"CreateSession",{sessionId:t}),this.gwNodeList=r.gw_nodes&&r.gw_nodes.length>0?r.gw_nodes:this.gwNodeList,this.gwNode=r.gw_nodes&&r.gw_nodes.length>0?this.gwNodeList[0]:this.gwNode,this.gwNodeTTL=r.gw_nodes_ttl?(new Date).getTime()+1e3*r.gw_nodes_ttl:this.gwNodeTTL,this.stateCenter.clientIP=r.clientip?r.clientip:this.stateCenter.clientIP,0!==r.result?(this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" create session failed "+r.result),this.publishStateUpdateError({code:u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionRequestError.code,message:u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionRequestError.message+" result:"+r.result})):(this.sessionId=t,this.sessionToken=r.session_token,this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" get remote session success "+this.streamId),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,(function(e,t,r){i.onRecvCloseSession(e,t,r)})),this.signal.registerPushCallback("SessionResetPush",this.sessionId,(function(e,t,r){i.onRecvResetSession(e,t,r)})),this.signal.registerPushCallback("PublishEventPush",this.sessionId,(function(e,t,r){i.onRecvPublishEvent(e,t,r)})),this.signal.registerPushCallback("ClientInfoPush",this.sessionId,(function(e,t,r){i.onRecvClientInfo(e,t,r)})),this.onGetRemoteOfferSuccess(r.sdp))):this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_PUBLISH+" seq is not match.")},e.prototype.onCreatePublishSessionSuccess=function(e){var t=this;this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+this.streamId+" called");var r=[];if(e.turn_server){var i=e.turn_server;this.stateCenter.turnOverTcpOnly&&(i=i.replace("udp","tcp")),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" over tcp "+i),r.push(i)}e.stun_server&&r.push(e.stun_server);var o={iceTransportPolicy:"relay",iceServers:[{urls:r,username:e.turn_username,credential:e.turn_auth_key}]};this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+this.streamId+" username: "+e.turn_username),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+this.streamId+" credential: "+e.turn_auth_key),this.createOffer(o),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,(function(e,r,i){t.onRecvCandidateInfo(e,r,i)})),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,(function(e,r,i){t.onRecvCloseSession(e,r,i)})),this.signal.registerPushCallback("MediaDescPush",this.sessionId,(function(e,r,i){t.onRecvMediaDescription(e,r,i)})),this.signal.registerPushCallback("SessionResetPush",this.sessionId,(function(e,r,i){t.onRecvResetSession(e,r,i)})),this.signal.registerPushCallback("PublishEventPush",this.sessionId,(function(e,r,i){t.onRecvPublishEvent(e,r,i)})),this.signal.registerPushCallback("ClientInfoPush",this.sessionId,(function(e,r,i){t.onRecvClientInfo(e,r,i)})),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+this.streamId+" call success")},e.prototype.createOffer=function(e){var t=this;this.peerConnection=new RTCPeerConnection(e),this.peerConnection.onicecandidate=function(e){t.onIceCandidate(e)},this.peerConnection.onsignalingstatechange=function(e){t.onConnectionStateChange(e)},this.peerConnection.oniceconnectionstatechange=function(e){t.onIceConnectionStateChange(e)};var r=[],i=[];this.localStream&&(this.localStream.getTracks().forEach((function(e){t.peerConnection.addTrack(e,t.localStream)})),r=this.localStream.getVideoTracks(),i=this.localStream.getAudioTracks(),r.length>0&&this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+this.streamId+" video device: "+r[0].label),i.length>0&&this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+this.streamId+" audio device: "+i[0].label));var o={offerToReceiveAudio:i.length>0?1:0,offerToReceiveVideo:r.length>0?1:0};this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+this.streamId+" createOffer: "+JSON.stringify(o)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.dataReport.eventStart(this.streamReportSeq,"CreateOffer"),this.peerConnection.createOffer(o).then((function(e){t.dataReport.eventEnd(t.reportSeq,"CreateOffer"),t.dataReport.eventEnd(t.streamReportSeq,"CreateOffer"),t.onCreateOfferSuccess(e)}),(function(e){t.dataReport.eventEndWithMsg(t.reportSeq,"CreateOffer",{error:e.toString()}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"CreateOffer",{error:e.toString()}),t.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_PUBLISH_SESSION_SUCCESS+" "+t.streamId+" create offer error "+e.toString()),t.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kCreateOfferError,!0)}))},e.prototype.onCreateOfferSuccess=function(e){var t=this;0!=this.videoInfo.bitRate&&(e.sdp=this.updateBandwidthRestriction(e.sdp,this.videoInfo.bitRate)),e.sdp=e.sdp.replace(/sendrecv/g,"sendonly"),e.sdp=e.sdp.replace(/useinbandfec=\d+/,(this.videoInfo.audioBitrate?"maxaveragebitrate="+this.videoInfo.audioBitrate:"")+(2===this.videoInfo.channelCount?";stereo=1":"")),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_OFFER_SUCCESS+" "+this.streamId+" local sdp revert "+this.localSdpRevert),/m=video[\s\S]*m=audio/.test(e.sdp)&&(this.localSdpRevert=!0),e.sdp=d.SdpUtil.getSDPByVideDecodeType(e.sdp,this.videoCodec),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_OFFER_SUCCESS+" "+this.streamId+" localSdp1 "+e.sdp.substr(0,e.sdp.length/2)),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_OFFER_SUCCESS+" "+this.streamId+" localSdp2 "+e.sdp.substr(e.sdp.length/2)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.dataReport.eventStart(this.streamReportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(e).then((function(){t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription"),t.dataReport.eventEnd(t.streamReportSeq,"SetLocalDescription"),t.onSetLocalDescriptionSuccess(e)}),(function(e){t.dataReport.eventEndWithMsg(t.reportSeq,"SetLocalDescription",{error:e.toString()}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"SetLocalDescription",{error:e.toString()}),t.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CREATE_OFFER_SUCCESS+" "+t.streamId+" error "+e.toString()),t.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSetLocalDescError,!0)}))},e.prototype.updateBandwidthRestriction=function(e,t){var r="AS";return"firefox"===n.browserDetails.browser&&(t=1e3*(t>>>0),r="TIAS"),e=-1===e.indexOf("b="+r+":")?(e=e.replace(/c=IN (.*)\r\n/g,"c=IN $1\r\nb="+r+":"+t+"\r\n")).replace("b="+r+":"+t+"\r\n",""):(e=e.replace(new RegExp("b="+r+":.*\r\n","g"),"b="+r+":"+t+"\r\n")).replace("b="+r+":"+t+"\r\n","")},e.prototype.onSetLocalDescriptionSuccess=function(e){var t=this;if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+this.streamId+" success"),this.isPeer)this.createSession(e);else{var r={sdp:e.sdp,width:this.videoInfo.width,height:this.videoInfo.height,frameRate:this.videoInfo.frameRate,video_min_kpbs:this.videoInfo.bitRate,video_max_kpbs:this.videoInfo.bitRate,audio_kpbs:48,keyframe_intv:2};this.offerSeq=a.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.dataReport.eventStart(this.streamReportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.offerSeq,this.sessionId,0,r,(function(e,i,o){t.offerSeq==e&&t.sessionId==i?(t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+t.streamId+" send success"),t.dataReport.eventEndWithMsg(t.reportSeq,"SendMediaDesc",{mediaDescription:{width:r.width,height:r.height,frameRate:r.frameRate,video_min_kpbs:r.video_min_kpbs,video_max_kpbs:r.video_max_kpbs,audio_kpbs:r.audio_kpbs,keyframe_intv:r.keyframe_intv}}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"SendMediaDesc",{mediaDescription:{width:r.width,height:r.height,frameRate:r.frameRate,video_min_kpbs:r.video_min_kpbs,video_max_kpbs:r.video_max_kpbs,audio_kpbs:r.audio_kpbs,keyframe_intv:r.keyframe_intv}}),t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+t.streamId+" send success stateNego:waiterAnswer"),t.stateNego=a.ENUM_PUBLISH_STATE_NEGO.waiterAnswer,t.state=a.ENUM_PUBLISH_STATE.waitingServerAnswer):t.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+t.streamId+" seq or sessionId is not equal")}),(function(e,r){t.dataReport.eventEndWithMsg(t.reportSeq,"SendMediaDesc",{error:e}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"SendMediaDesc",{error:e}),t.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kMediaDescError)})),this.state=a.ENUM_PUBLISH_STATE.waitingOffserRsp,this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+this.streamId+" call success")}},e.prototype.onRecvMediaDescription=function(e,t,r){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_MEDIA_DESC+" "+this.streamId+" received"),this.state==a.ENUM_PUBLISH_STATE.waitingServerAnswer?(this.stateNego=a.ENUM_PUBLISH_STATE_NEGO.waitingCandidate,this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_MEDIA_DESC+" "+this.streamId+" received stateNego:waitingCandidate"),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.dataReport.addEvent(this.streamReportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(e,this.sessionId,0),1==r.type?this.onGetRemoteOfferSuccess(r.sdp):this.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kMediaDescError)):this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_MEDIA_DESC+" "+this.streamId+" current state "+this.state+" not allowed")},e.prototype.onGetRemoteOfferSuccess=function(e){var t,r,i=this;if(48e3!==this.videoInfo.audioBitrate&&(e=e.replace(/maxaveragebitrate=(\d+)/,"maxaveragebitrate="+this.videoInfo.audioBitrate)),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_GET_REMOTE_DESCRIPTION+" "+this.streamId+NaN+this.localSdpRevert),/m=video[\s\S]*m=audio/.test(e)&&(this.remoteSdpRevert=!0),this.logger.info("zp.oro.0 "+this.streamId+" sdp revert "+this.localSdpRevert+" "+this.remoteSdpRevert),this.localSdpRevert!==this.remoteSdpRevert){var o=void 0,s=void 0,c=void 0;if(this.remoteSdpRevert){s=(t=[/[\s\S]*m=audio/.exec(e)[0].replace("m=video",""),/m=video[\s\S]*m=audio/.exec(e)[0].replace("m=video",""),/m=audio[\s\S]*/.exec(e)[0]])[1],c=t[2];var d=/a=group:BUNDLE\s+(\w+)\s+(\w+)/.exec(o=t[0]);e=(o=o.replace(/a=group:BUNDLE\s+(\w+)\s+(\w+)/,"a=group:BUNDLE "+d[2]+" "+d[1]))+c+s}else{s=(r=[/[\s\S]*m=audio/.exec(e)[0].replace("m=audio",""),/m=video[\s\S]*/.exec(e)[0],/m=audio[\s\S]*m=video/.exec(e)[0].replace("m=video","")])[1],c=r[2];d=/a=group:BUNDLE\s+(\w+)\s+(\w+)/.exec(o=r[0]);e=(o=o.replace(/a=group:BUNDLE\s+(\w+)\s+(\w+)/,"a=group:BUNDLE "+d[2]+" "+d[1]))+s+c}this.localSdpRevert=!1,this.remoteSdpRevert=!1}if(this.videoInfo.bitRate>0&&"chrome"==n.browserDetails.browser){e=e.replace(/AS:(\d+)/,"AS:"+2*this.videoInfo.bitRate);var l=this.streamCenter.checkPreview(this.localStream),h=e.match(/m=video(.|\r|\n)*a=rtpmap(.|\r|\n)*(a=fmtp:(102|96).*)/);if(null!==h&&l&&l.isScreen){var g=h[3];e=e.replace(g,g+";x-google-start-bitrate="+this.videoInfo.bitRate)}var m=this.peerConnection.getSenders().find((function(e){return e.track&&"video"===e.track.kind}));if(m){var E=m.getParameters();E.encodings||(E.encodings=[{}]),E.encodings[0].maxBitrate=1e3*this.videoInfo.bitRate,m.setParameters(E)}}this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_GET_REMOTE_DESCRIPTION+" "+this.streamId+" remoteSdp:",e);var f={type:"answer",sdp:e,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.dataReport.eventStart(this.streamReportSeq,"SetRemoteDescription"),this.peerConnection.setRemoteDescription(new RTCSessionDescription(f)).then((function(){i.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_GET_REMOTE_DESCRIPTION+" "+i.streamId+" set success"),i.dataReport.eventEnd(i.reportSeq,"SetRemoteDescription"),i.dataReport.eventEnd(i.streamReportSeq,"SetRemoteDescription")}),(function(e){i.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_GET_REMOTE_DESCRIPTION+" "+i.streamId+" failed: "+e.toString()),i.dataReport.eventEndWithMsg(i.reportSeq,"SetRemoteDescription",{error:e.toString()}),i.dataReport.eventEndWithMsg(i.streamReportSeq,"SetRemoteDescription",{error:e.toString()}),i.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSetRemoteDescError,!0)})),this.state=a.ENUM_PUBLISH_STATE.waitingServerICE,this.logger.debug(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_GET_REMOTE_DESCRIPTION+" "+this.streamId+" call success")},e.prototype.onIceConnectionStateChange=function(e){var t=this;this.state!=a.ENUM_PUBLISH_STATE.stop&&null!=this.peerConnection&&(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CONNECTION_STATE_CHANGE+" "+this.streamId+" stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState?(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CONNECTION_STATE_CHANGE+" "+this.streamId+" connected state "+this.state),this.dataReport.eventEnd(this.reportSeq,"IceConnected"),this.dataReport.eventEnd(this.streamReportSeq,"IceConnected"),this.stateNego=a.ENUM_PUBLISH_STATE_NEGO.iceConnected,this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CONNECTION_STATE_CHANGE+" "+this.streamId+" stateNego:iceConnected"),this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.publishEvent?this.publishSuccess():(this.firstGetStatsTimer&&clearTimeout(this.firstGetStatsTimer),this.firstGetStatsTimer=null,this.firstGetStatsTimer=setTimeout((function(){t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CONNECTION_STATE_CHANGE+" get first stats state "+t.state),t.state!==a.ENUM_PUBLISH_STATE.publishing&&t.peerConnection.getStats().then((function(e){t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CONNECTION_STATE_CHANGE+" get first stats suc"),e.size>0&&t.publishSuccess()}))}),1e3))):"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.stateNego=a.ENUM_PUBLISH_STATE_NEGO.iceDisconnected,this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)))},e.prototype.onIceCandidate=function(e){if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CANDIDATE+" "+this.streamId+" candidate"+e.candidate),e.candidate)if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CANDIDATE+" "+this.streamId+" candidate"+e.candidate.candidate),this.state<a.ENUM_PUBLISH_STATE.connecting||this.state==a.ENUM_PUBLISH_STATE.stop)this.candidateInfo.push({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex});else{var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};this.sendCandidateInfo([t])}},e.prototype.sendCandidateInfo=function(e){var t=this;this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SEND_CANDIDATE_INFO+" "+this.streamId+" called"),!(e=e.filter((function(e){return e.candidate.indexOf("relay")>0})))||e.length<1?this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SEND_CANDIDATE_INFO+" "+this.streamId+" cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.dataReport.eventStart(this.streamReportSeq,"SendIceCandidate"),this.stateNego!==a.ENUM_PUBLISH_STATE_NEGO.iceConnected&&(this.stateNego=a.ENUM_PUBLISH_STATE_NEGO.sendCandidate),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SEND_CANDIDATE_INFO+" "+this.streamId+" stateNego:sendCandidate"),this.signal.sendCandidateInfo(a.getSeq(),this.sessionId,e,(function(e,r,i){t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SEND_CANDIDATE_INFO+" "+t.streamId+" send success"),t.dataReport.eventEnd(t.reportSeq,"SendIceCandidate"),t.dataReport.eventEnd(t.streamReportSeq,"SendIceCandidate")}),(function(e,r){t.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SEND_CANDIDATE_INFO+" "+t.streamId+" failed to send: "+e.toString()),t.dataReport.eventEndWithMsg(t.reportSeq,"SendIceCandidate",{error:e}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"SendIceCandidate",{error:e}),t.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kCandidateError)})))},e.prototype.onConnectionStateChange=function(e){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_CONNECTION_STATE_CHANGE+" "+this.streamId+" called "+e.target.signalingState)},e.prototype.onRecvCandidateInfo=function(e,t,r){var i=this;if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_CANDIDATE_INFO+" "+this.streamId+" received "+JSON.stringify(r.infos)),this.state==a.ENUM_PUBLISH_STATE.waitingServerICE){this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.dataReport.addEvent(this.streamReportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(e,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var o=0;o<r.infos.length;o++){var s={sdpMid:r.infos[o].sdpMid,sdpMLineIndex:r.infos[o].sdpMLineIndex,candidate:r.infos[o].candidate};this.logger.debug(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_CANDIDATE_INFO+""+this.streamId+" candidate "+s.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(s)).then((function(){i.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_CANDIDATE_INFO+" "+i.streamId+" add success")}),(function(e){i.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_CANDIDATE_INFO+" "+i.streamId+" add error "+e.toString()),i.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kCandidateError,!0)}))}this.state=a.ENUM_PUBLISH_STATE.connecting,this.dataReport.eventStart(this.reportSeq,"IceConnected"),this.dataReport.eventStart(this.streamReportSeq,"IceConnected")}else this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_CANDIDATE_INFO+" "+this.streamId+" current state "+this.state+" not allowed")},e.prototype.onRecvCloseSession=function(e,t,r){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_CLOSE_SESSION+""+this.streamId+" "+JSON.stringify(r)),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=r.err_info?JSON.parse(r.err_info.toLowerCase()):{},o=i.action?i.action:null,s=1*r.reason,a=JSON.parse(JSON.stringify(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishSessionClosedError));a.message+=" reason:"+s+" "+(o?" action:"+o:""),this.negoTimer&&clearTimeout(this.negoTimer);var n=![4,8,10,11,12,14,26,27].includes(s)&&![2,5,6].includes(o);this.publishStateUpdateError(a,n)},e.prototype.onRecvResetSession=function(e,t,r){if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_RESET_SESSION+" "+this.streamId+" received "),t==this.sessionId){this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishSessionClosedError;this.negoTimer&&clearTimeout(this.negoTimer),this.publishStateUpdateError(i)}else this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_RESET_SESSION+" "+this.streamId+" cannot find session")},e.prototype.onRecvPublishEvent=function(e,t,r){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_PUBLISH_EVENT+" "+this.streamId+" received"),this.publishEvent=!0,this.firstGetStatsTimer&&(clearTimeout(this.firstGetStatsTimer),this.firstGetStatsTimer=null),this.stateNego===a.ENUM_PUBLISH_STATE_NEGO.iceConnected&&0==r.event&&this.publishSuccess()},e.prototype.onRecvClientInfo=function(e,t,r){this.stateCenter.clientIP!==r.clientip&&this.logger.warn(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_RECV_CLIENT_INFO+" client ip changed "+this.stateCenter.clientIP+" "+r.clientip),this.stateCenter.clientIP=r.clientip},e.prototype.checkPublishConnectionFailedState=function(e){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_ICE_CONNECTION_STATE_CHANGE+" streamID "+this.streamId," state "+this.state+" connectionState "+e),this.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kMediaConnectionError)},e.prototype.setPublishQualityTimer=function(){var e=this;null==this.qualityTimer&&(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SET_PLAYER_QUALITY_TIMER+" "+this.streamId+" called"),this.clearPublishQualityTimer(),this.qualityTimer=setInterval((function(){e.peerConnectionGetStats()}),this.qualityTimeInterval),this.lastPublishStats={audioPacketsLost:0,videoPacketsLost:0,videoPacketsSent:0,audioPacketsSent:0,audioRetransmittedPacketsSent:0,videoTime:(new Date).getTime(),audioTime:(new Date).getTime(),time:0,audioBytesSent:0,videoBytesSent:0,framesEncoded:0,framesSent:0,videoRetransmittedPacketsSent:0},this.qualitySeq=a.getSeq(),this.qualityCount=0)},e.prototype.peerConnectionGetStats=function(e){var t=this;if(this.peerConnection){var r=[this.peerConnection.getStats(null)];"Chrome"==l.ClientUtil.getBrowser()&&r.push(new Promise((function(e,r){t.peerConnection.getStats((function(t){return e(t)}),(function(e){return r(e)}))}))),Promise.all(r).then((function(r){var i=t.getPublishStats(r[0],r[1]);e&&e(i,r[0],r[1])})).catch((function(e){t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SET_PLAYER_QUALITY_TIMER+" "+t.streamId+" getStats error "+e.toString())}))}},e.prototype.getPublishStats=function(e,t){var r=this;if(e){for(var i,o=document.querySelectorAll("video, audio"),s=0;s<o.length;s++)o[s].srcObject===this.localStream&&(i=o[s]);var c={audioCodec:"opus",audioTargetBitrate:this.videoInfo.audioBitrate/1e3||0,audioBitrate:0,videoTargetBitrate:this.videoInfo.bitRate||0,videoTargetFPS:this.videoInfo.frameRate||0,videoBitrate:0,audioFPS:0,audioLevel:0,audioInputLevel:0,audioPacketsLost:0,audioPacketsLostRate:0,sendLevel:0,samplingRate:0,videoFPS:0,nackCount:0,pliCount:0,audioQuality:0,videoQuality:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,videoPacketsLost:0,videoPacketsLostRate:0,totalRoundTripTime:0,currentRoundTripTime:0,googBandwidthLimitedResolution:void 0,videoCodecName:"",audioCodecName:"",googCpuLimitedResolution:void 0,googAvailableSendBandwidth:0,googActualEncBitrate:0,googTargetEncBitrate:0,googFrameWidthInput:0,googFrameHeightInput:0,googFrameRateInput:0,codecImplementationName:"",videoMuteState:this.localStream.getVideoTracks().length>0&&this.localStream.getVideoTracks()[0].enabled?"0":"1",audioMuteState:this.localStream.getAudioTracks().length>0&&this.localStream.getAudioTracks()[0].enabled?"0":"1",muted:i?i.muted:void 0,paused:i?i.paused:void 0,volume:i?i.volume:void 0,sinkId:i?i.sinkId:void 0},d=this.lastPublishStats.time,u=0,h=0,g=0,m=0,E=0,f=0;e.forEach((function(e){if(("outbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesSent)&&"audio"==e.mediaType)0!=d&&(c.audioBitrate=8*(e.bytesSent-r.lastPublishStats.audioBytesSent)/(e.timestamp-d),c.audioFPS=(e.packetsSent-(e.retransmittedPacketsSent-r.lastPublishStats.audioRetransmittedPacketsSent)-r.lastPublishStats.audioPacketsSent)/(e.timestamp-d)*1e3,g=(e.retransmittedPacketsSent-r.lastPublishStats.audioRetransmittedPacketsSent)/(e.packetsSent-r.lastPublishStats.audioPacketsSent)),c.audioBitrate<0&&(c.audioBitrate=0),r.lastPublishStats.audioBytesSent=e.bytesSent,r.lastPublishStats.time=e.timestamp,r.lastPublishStats.audioPacketsSentTimeStamp=e.packetsSent-r.lastPublishStats.audioPacketsSent,r.lastPublishStats.audioPacketsSent=e.packetsSent,r.lastPublishStats.audioRetransmittedPacketsSent=e.retransmittedPacketsSent;else if(("outbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesSent)&&"video"==e.mediaType)0!=d&&(c.videoBitrate=8*(e.bytesSent-r.lastPublishStats.videoBytesSent)/(e.timestamp-d),c.videoFPS=1e3*(e.framesEncoded-r.lastPublishStats.framesEncoded)/(e.timestamp-d),m=(e.retransmittedPacketsSent-r.lastPublishStats.videoRetransmittedPacketsSent)/(e.packetsSent-r.lastPublishStats.videoPacketsSent)),c.videoBitrate<0&&(c.videoBitrate=0),c.videoFPS<0&&(c.videoFPS=0),c.nackCount=e.nackCount,c.pliCount=e.pliCount,r.lastPublishStats.videoBytesSent=e.bytesSent,r.lastPublishStats.framesEncoded=e.framesEncoded,r.lastPublishStats.time=e.timestamp,r.lastPublishStats.videoPacketsSentTimeStamp=e.packetsSent-r.lastPublishStats.videoPacketsSent,r.lastPublishStats.videoPacketsSent=e.packetsSent,r.lastPublishStats.videoRetransmittedPacketsSent=e.retransmittedPacketsSent;else if("remote-inbound-rtp"==e.type&&"video"==e.kind){e.packetsLost>0&&(c.videoPacketsLost=e.packetsLost);var t=e.packetsLost-r.lastPublishStats.videoPacketsLost;c.videoPacketsLostRate=t>0?t/r.lastPublishStats.videoPacketsSentTimeStamp:0,e.packetsLost>0&&(r.lastPublishStats.videoPacketsLost=e.packetsLost),r.lastPublishStats.videoTime=e.timestamp,h=1e3*e.roundTripTime,f=e.jitter}else if("remote-inbound-rtp"==e.type&&"audio"==e.kind){e.packetsLost>0&&(c.audioPacketsLost=e.packetsLost);var i=e.packetsLost-r.lastPublishStats.audioPacketsLost;c.audioPacketsLostRate=i>0?i/r.lastPublishStats.audioPacketsSentTimeStamp:0,e.packetsLost>0&&(r.lastPublishStats.audioPacketsLost=e.packetsLost),r.lastPublishStats.audioTime=e.timestamp,u=1e3*e.roundTripTime,E=e.jitter}else"media-source"==e.type&&("audio"==e.kind||e.id.toLowerCase().indexOf("audio")>=0)?(c.audioLevel=e.audioLevel,c.sendLevel=e.totalAudioEnergy,c.audioInputLevel=32767*e.totalAudioEnergy,c.samplingRate=e.totalSamplesDuration):"track"==e.type&&("video"==e.kind||e.id.indexOf("video")>=0||e.frameWidth)?(c.frameHeight=e.frameHeight,c.frameWidth=e.frameWidth,0!=d&&(c.videoTransferFPS=1e3*(e.framesSent-r.lastPublishStats.framesSent)/(e.timestamp-d)),c.videoTransferFPS<0&&(c.videoTransferFPS=0),r.lastPublishStats.framesSent=e.framesSent):"candidate-pair"==e.type&&(null!=e.totalRoundTripTime&&(c.totalRoundTripTime=e.totalRoundTripTime),null!=e.currentRoundTripTime&&(c.currentRoundTripTime=e.currentRoundTripTime))})),t&&t.result().forEach((function(e){"ssrc"==e.type&&e.names().indexOf("googBandwidthLimitedResolution")>=0&&(c.googBandwidthLimitedResolution=e.stat("googBandwidthLimitedResolution")),"ssrc"==e.type&&"video"==e.stat("mediaType")&&e.names().indexOf("googCodecName")>=0&&(c.videoCodecName=e.stat("googCodecName")),"ssrc"==e.type&&"audio"==e.stat("mediaType")&&e.names().indexOf("googCodecName")>=0&&(c.audioCodecName=e.stat("googCodecName")),"ssrc"==e.type&&e.names().indexOf("googCpuLimitedResolution")>=0&&(c.googCpuLimitedResolution=e.stat("googCpuLimitedResolution")),"ssrc"==e.type&&e.names().indexOf("googFrameWidthInput")>=0&&(c.googFrameWidthInput=e.stat("googFrameWidthInput")),"ssrc"==e.type&&e.names().indexOf("googFrameHeightInput")>=0&&(c.googFrameHeightInput=e.stat("googFrameHeightInput")),"ssrc"==e.type&&e.names().indexOf("googFrameRateInput")>=0&&(c.googFrameRateInput=e.stat("googFrameRateInput")),"ssrc"==e.type&&e.names().indexOf("codecImplementationName")>=0&&(c.codecImplementationName=e.stat("codecImplementationName")),"VideoBwe"==e.type&&e.names().indexOf("googAvailableSendBandwidth")>=0&&(c.googAvailableSendBandwidth=e.stat("googAvailableSendBandwidth")),"VideoBwe"==e.type&&e.names().indexOf("googActualEncBitrate")>=0&&(c.googActualEncBitrate=e.stat("googActualEncBitrate")),"VideoBwe"==e.type&&e.names().indexOf("googTargetEncBitrate")>=0&&(c.googTargetEncBitrate=e.stat("googTargetEncBitrate")),"VideoBwe"==e.type&&e.names().indexOf("googRetransmitBitrate")>=0&&(c.googRetransmitBitrate=e.stat("googRetransmitBitrate"))})),"chrome"===n.browserDetails.browser&&this.handleEncBitrate(Number.parseInt(c.googTargetEncBitrate),Number.parseInt(c.googActualEncBitrate),Number.parseInt(c.googRetransmitBitrate)),h=isNaN(h)||h<0?0:h,m=isNaN(m)||m<0?0:m,f=isNaN(f)||f<0?0:f,u=isNaN(u)||u<0?0:u,g=isNaN(g)||g<0?0:g,E=isNaN(E)||E<0?0:E;var _=l.ClientUtil.getNetQuality(h,m,f),S=l.ClientUtil.getNetQuality(u,g,E);c.videoQuality=d>0?l.ClientUtil.quality2QualityGrade(_):0,c.audioQuality=d>0?l.ClientUtil.quality2QualityGrade(S):0;var T=Math.min(_,S);this.netQuality=T,d>0&&T<=a.QUALITY_CONSTANT.MiddleMinQuality&&(new Date).getTime()>this.probeTime+this.probeInterval&&(this.logger.info(p.ZEGO_WEBRTC_ACTION.PLAYER_SET_PLAYER_QUALITY_TIMER+" netQuality "+T+" start net probe"),this.probeState=a.ENUM_PROBE_STATE.tryProbe,this.streamCenter.startNetProbe(!0,this,this.gwNodeList),this.probeTime=(new Date).getTime()),0!==d&&this.uploadPublishQuality(c);var C={video:{videoBitrate:c.videoBitrate,videoFPS:c.videoFPS,videoTransferFPS:c.videoTransferFPS,frameHeight:c.frameHeight,frameWidth:c.frameWidth,muteState:c.videoMuteState,videoQuality:c.videoQuality,videoPacketsLost:c.videoPacketsLost,videoPacketsLostRate:c.videoPacketsLostRate},audio:{audioBitrate:c.audioBitrate,audioCodec:c.audioCodec,muteState:c.audioMuteState,audioQuality:c.audioQuality,audioPacketsLost:c.audioPacketsLost,audioPacketsLostRate:c.audioPacketsLostRate,audioFPS:c.audioFPS},nackCount:c.nackCount,pliCount:c.pliCount,totalRoundTripTime:c.totalRoundTripTime,currentRoundTripTime:c.currentRoundTripTime};return void 0!==c.videoPacketsLost&&(C.video.videoPacketsLost=c.videoPacketsLost,C.video.videoPacketsLostRate=c.videoPacketsLostRate,C.audio.audioPacketsLost=c.audioPacketsLost,C.audio.audioPacketsLostRate=c.audioPacketsLostRate),void 0!==c.muted&&(C.muted=c.muted,C.paused=c.paused,C.volume=c.volume,C.sinkId=c.sinkId),void 0!==c.googBandwidthLimitedResolution&&(C.googBandwidthLimitedResolution=c.googBandwidthLimitedResolution,C.video.googCodecName=c.videoCodecName,C.audio.googCodecName=c.audioCodecName,C.googCpuLimitedResolution=c.googCpuLimitedResolution,C.googFrameWidthInput=c.googFrameWidthInput,C.googFrameHeightInput=c.googFrameHeightInput,C.googFrameRateInput=c.googFrameRateInput,C.codecImplementationName=c.codecImplementationName,C.googAvailableSendBandwidth=c.googAvailableSendBandwidth,C.googActualEncBitrate=c.googActualEncBitrate,C.googTargetEncBitrate=c.googTargetEncBitrate),0!==d&&this.onPublishQualityUpdate(this.streamId,C,e,t),C}},e.prototype.uploadPublishQuality=function(e){var t=this;if(this.qualityUpload){var r=Date.parse(new Date+"");(0==this.qualityUploadLastTime||r-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(e.stream_type="publish",e.stream_id=this.streamId,e.timeStamp=r/1e3,this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_UPLOAD_PUBLISH_QUALITY+" "+this.streamId+" upload"+JSON.stringify(e)),this.signal.QualityReport(a.getSeq(),this.sessionId,e,(function(e,r,i){void 0!==i.report&&(t.qualityUpload=i.report,t.qualityUploadInterval=i.report_interval_ms)}),(function(e,r){t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_UPLOAD_PUBLISH_QUALITY+" "+t.streamId+" upload failed "+e)})),this.qualityUploadLastTime=r)}},e.prototype.stopPublish=function(){if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_STOP_PUBLISH+"  .1 "+this.streamId+" called"),Object.keys(this.streamCenter.publisherList).length=1)for(var e in this.streamCenter.playerList){var t=this.streamCenter.playerList[e].player;t.state==a.ENUM_PLAY_STATE.playing&&t.broadcasterStatus==a.ENUM_BROADCASTER_STATUS.start&&(this.signal&&this.signal.sendBroadcasterStatus(a.getSeq(),t.sessionId,0),t.broadcasterStatus=a.ENUM_BROADCASTER_STATUS.stop)}this.stopMixingAudio(),this.stopMixingBuffer(),this.stopEffect(),this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(a.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.streamReportSeq,"PublishState",{state:this.state+""}),this.dataReport.addEvent(this.streamReportSeq,"StopPublish"),this.dataReport.addMsgExt(this.streamReportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.addMsgInfo(this.streamReportSeq,{itemtype:"RTCPublishStream"}),this.dataReport.uploadReport(this.streamReportSeq,"RTCPublishStream"),this.resetPublish()},e.prototype.onPublishStateUpdate=function(e,t,r,i){},e.prototype.onPublishQualityUpdate=function(e,t,r,i){},e.prototype.onDisconnect=function(){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_DISCONNECT+" "+this.streamId+" call"),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_ON_DISCONNECT+" "+this.streamId+" websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.publishStateUpdateError(u.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kWebsocketDisconnectedError)},e.prototype.playEffect=function(e,t,r,i){if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_PLAY_EFFECT+""+this.streamId+" call"),this.effectList.find((function(r){return r.effectID==e.effectID&&r.audioBuffer==t})))this.logger.warn(p.ZEGO_WEBRTC_ACTION.PUBLISHER_PLAY_EFFECT+""+this.streamId+" effect alreadly exist ");else{this.streamCenter.soundLevelDelegate&&this.stopSoundLevel();var o=new c.AudioMix(this.logger,this.ac,this.mediaEleSources);o.localStream=this.localStream,o.peerConnection=this.peerConnection,o.audioBuffer=t,this.effectList.push({audioMix:o,effectID:e.effectID,audioBuffer:t}),o.playEffect(e.playTime,e.loop,!1,r,i),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_PLAY_EFFECT+""+this.streamId+" play effect "+e.effectID+" success")}},e.prototype.pauseEffect=function(e){var t=this.effectList.find((function(t){return t.effectID==e}));if(t)this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),t.audioMix.pauseEffect(),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_PAUSE_EFFECT+" "+this.streamId+" pause "+e+" success");else{if(void 0!==e)return this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_PAUSE_EFFECT+" "+this.streamId+" no effect ID found"),!1;this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),this.effectList.forEach((function(e){return e.audioMix.pauseEffect()})),this.streamCenter.soundLevelDelegate&&this.startSoundLevel()}return!0},e.prototype.resumeEffect=function(e){var t=this.effectList.find((function(t){return t.effectID==e}));if(t)this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),t.audioMix.resumeEffect(),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_RESUME_EFFECT+" "+this.streamId+" resume"+e+" success");else{if(void 0!==e)return this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_RESUME_EFFECT+" "+this.streamId+" no effect ID found"),!1;this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),this.effectList.forEach((function(e){return e.audioMix.resumeEffect()})),this.streamCenter.soundLevelDelegate&&this.startSoundLevel()}return!1},e.prototype.stopEffect=function(e){var t=this.effectList.find((function(t){return t.effectID==e}));if(t)this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),t.audioMix.stopMixingAudio(),this.effectList.splice(this.effectList.indexOf(t),1),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_STOP_EFFECT+" "+this.streamId+" pause "+e+" success");else{if(void 0!==e)return this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_STOP_EFFECT+" "+this.streamId+" no effect ID found"),!1;this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),this.effectList.forEach((function(e){return e.audioMix.stopMixingAudio()})),this.effectList=[],this.streamCenter.soundLevelDelegate&&this.startSoundLevel()}return!0},e.prototype.setEffectVolume=function(e,t){var r=this.effectList.find((function(e){return e.effectID==t}));if(r)r.audioMix.setMixingAudioVolume(e),this.logger.info("zp.sev.0 "+this.streamId+" set volume "+t+" success");else{if(void 0!==t)return this.logger.error("zp.sev.0 "+this.streamId+" no effect ID found"),!1;this.effectList.forEach((function(t){return t.audioMix.setMixingAudioVolume(e)}))}return!0},e.prototype.startMixingAudio=function(e){var t=this;return this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_MIXING_AUDIO+" "+this.streamId+" call"),this.localStream?(this.micTrack||(this.micTrack=this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks()[0]:null),e.forEach((function(e){if(t.audioMixList.find((function(t){return t.media==e})))t.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_MIXING_AUDIO+" "+t.streamId+" mix audio already exist");else{t.streamCenter.soundLevelDelegate&&t.stopSoundLevel();var r=new c.AudioMix(t.logger,t.ac,t.mediaEleSources);r.localStream=t.localStream,r.peerConnection=t.peerConnection,t.audioMixList.push({audioMix:r,media:e}),r.startMixingAudio(e),t.streamCenter.soundLevelDelegate&&t.startSoundLevel()}})),!0):(this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_MIXING_AUDIO+" localStream not found"),!1)},e.prototype.stopMixingAudio=function(e){var t=this;return this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_STOP_MIXING_AUDIO+" "+this.streamId+" call"),e?e.forEach((function(e){for(var r=0;r<t.audioMixList.length;r++)if(t.audioMixList[r].media==e){t.audioMixList[r].audioMix.stopMixingAudio()&&t.audioMixList.splice(r--,1);break}})):(this.audioMixList.forEach((function(e){return e.audioMix.stopMixingAudio()})),this.audioMixList=[]),!0},e.prototype.mixingBuffer=function(e,t,r){var i=this;if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_MIXING_BUFFER+" "+this.streamId+" call"),this.micTrack||(this.micTrack=this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks()[0]:null),this.arrayBufferMap[e])this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),this.arrayBufferMap[e].mixingBuffer(t,(function(){i.streamCenter.soundLevelDelegate&&i.startSoundLevel(),r&&r()}));else{this.streamCenter.soundLevelDelegate&&this.stopSoundLevel();var o=new c.AudioMix(this.logger,this.ac,this.mediaEleSources);o.localStream=this.localStream,o.peerConnection=this.peerConnection,this.arrayBufferMap[e]=o,o.mixingBuffer(t,(function(){i.streamCenter.soundLevelDelegate&&i.startSoundLevel(),r&&r()}))}},e.prototype.stopMixingBuffer=function(e){if(e&&this.arrayBufferMap[e])return this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),this.arrayBufferMap[e].stopMingBuffer(),delete this.arrayBufferMap[e],this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),!0;if(void 0===e){for(var t in this.streamCenter.soundLevelDelegate&&this.stopSoundLevel(),this.arrayBufferMap)this.arrayBufferMap[t].stopMingBuffer();return this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),!0}return this.logger.warn(p.ZEGO_WEBRTC_ACTION.PUBLISHER_MIXING_BUFFER+" "+this.streamId+" arrayBuffer no found"),!1},e.prototype.setMixingAudioVolume=function(e,t){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SET_MIXING_AUDIO_VOLUME+" "+this.streamId+" call");var r=this.audioMixList.find((function(e){return e.media===t}));return r?(r.audioMix.setMixingAudioVolume(e),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SET_MIXING_AUDIO_VOLUME+" "+this.streamId+" call success"),!0):(this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_SET_MIXING_AUDIO_VOLUME+" "+this.streamId+" audio is not mixing"),!1)},e.prototype.publishSuccess=function(){for(var e in this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_PUBLISH_SUCCESS+" call"),this.state!=a.ENUM_PUBLISH_STATE.publishing&&this.onPublishStateUpdate(a.ENUM_PUBLISH_STATE_UPDATE.start,this.streamId,{code:0,message:""},!0),this.isPeer&&(this.peerFailCount=0),this.state=a.ENUM_PUBLISH_STATE.publishing,this.dataReport.eventStart(this.reportSeq,"PublishState"),this.dataReport.eventStart(this.streamReportSeq,"PublishState"),this.streamCenter.playerList){var t=this.streamCenter.playerList[e].player;t.state==a.ENUM_PLAY_STATE.playing&&t.broadcasterStatus==a.ENUM_BROADCASTER_STATUS.stop&&(this.signal&&this.signal.sendBroadcasterStatus(a.getSeq(),t.sessionId,1),t.broadcasterStatus=a.ENUM_BROADCASTER_STATUS.start)}this.setPublishQualityTimer();var r=2,i=2;0!==this.localStream.getVideoTracks().length&&1==this.localStream.getVideoTracks()[0].enabled&&(r=0),0!==this.localStream.getAudioTracks().length&&1==this.localStream.getAudioTracks()[0].enabled&&(i=0),this.signal.sendStreamStatus(a.getSeq(),this.sessionId,r,i,this.streamId),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_PUBLISH_SUCCESS+" call success")},e.prototype.startSoundLevel=function(){var e=this;if(this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_SOUND_LEVEL+" call streamID: "+this.streamId),this.localStream&&0!=this.localStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null);try{this.mic=this.ac.createMediaStreamSource(this.localStream),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(t){for(var r=t.inputBuffer.getChannelData(0),i=0,o=0;o<r.length;o++)i<r[o]&&(i=r[o]);e.soundLevel=100*i},this.ac.resume()}catch(e){this.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_SOUND_LEVEL+" "+this.streamId+" get sound level failed "+e)}}else this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_START_SOUND_LEVEL+" "+this.streamId+" local stream no found")},e.prototype.stopSoundLevel=function(){this.logger.info(p.ZEGO_WEBRTC_ACTION.PUBLISHER_STOP_SOUND_LEVEL+" call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.script=null,this.mic=null},e.prototype.rebackMic=function(){var e=this;if(this.peerConnection&&this.micTrack instanceof MediaStreamTrack&&0==this.audioMixList.length&&0==Object.keys(this.arrayBufferMap).length&&0==this.effectList.length){var t=this.peerConnection.getSenders().find((function(t){return t.track.kind===e.micTrack.kind}));t&&(t.replaceTrack(this.micTrack),this.localStream.removeTrack(this.localStream.getAudioTracks()[0]),this.localStream.addTrack(this.micTrack))}},e.prototype.handleEncBitrate=function(e,t,r){var i=this,o=1e3*this.videoInfo.bitRate,s=0;if(t>0){this.needIncMax||this.gotMax||(this.probeCount++,t>=.75*e?(this.probeCount>=10&&this.initFitCnt>=.6*this.probeCount&&(this.gotMax=!0,this.targetRate=o),this.initFitCnt++):this.probeCount>=10&&this.initFitCnt/this.probeCount<.3&&(this.needIncMax=!0));var a=l.ClientUtil.arrAvg(this.totalBitrateArray,t,10);if(this.needIncMax)if(a>=1.05*o){if(this.targetRate>o){var n=void 0;a>e?(n=a-e,this.targetRate-=n):(n=a-o,this.targetRate-=n),this.targetRate=Math.max(this.targetRate,o),this.targetRate=Math.min(this.targetRate,2*o),s=this.targetRate}}else a<.8*o&&(0===this.targetRate&&(this.targetRate=e),this.targetRate>=o?this.targetRate=this.targetRate+.08*o:this.targetRate=1.05*this.targetRate,this.targetRate=Math.min(this.targetRate,2*o),s=this.targetRate)}if(r>0&&r<o){var c=l.ClientUtil.arrAvg(this.totalRetransRateArray,r,5);if(this.needIncMax){if(c+t>1.05*o){n=c+t-o;this.targetRate-=n,this.targetRate=Math.max(this.targetRate,o-c),s=this.targetRate}}else s=this.targetRate-c}else this.targetRate<o&&(this.targetRate=o,s=this.targetRate);if(s>0){s=l.ClientUtil.arrAvg(this.totalTargetRateArray,s,5);var d=this.peerConnection.getSenders().find((function(e){return e.track&&"video"===e.track.kind}));if(!d)return;var u=d.getParameters();u.encodings||(u.encodings=[{}]),u.encodings[0].maxBitrate=s,d.setParameters(u).catch((function(e){i.logger.error(p.ZEGO_WEBRTC_ACTION.PUBLISHER_HANDLE_ENC_BITRATE+" "+e)}))}},e.prototype.resetEncBitrate=function(){this.needIncMax=!1,this.probeCount=0,this.gotMax=!1,this.initFitCnt=0,this.targetRate=0,this.totalBitrateArray=[],this.totalTargetRateArray=[],this.totalRetransRateArray=[]},e}();t.ZegoPublish=h},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioMix=void 0;var i=r(2),o=r(4),s=function(){function e(e,t,r){this.audioBufferList=[],this.loop=!1,this.replace=!1,this.effectEndedCallBack=null,this.effectEndedListener=null,this.startTimes=0,this.startOffset=0,this.pauseTimes=0,this.resumeOffset=0,this.paused=!1,this.isMixAudio=!1,this.isMixingBuffer=!1,this.audioCurrentTimer=null,this.logger=e,this.ac=t,this.mediaEleSources=r}return e.prototype.preloadEffect=function(e,t){var r=this;this.logger.info("amu.pe.0 start preload effect");var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){if(200==i.status||304==i.status){var e=i.response;r.ac.resume(),r.ac.decodeAudioData(e,(function(e){r.logger.info("amu.pe.0 effect preload success"),t("",e)}),(function(e){t(e)}))}else{var o=i.statusText;t(o)}},i.send()},e.prototype.playEffect=function(e,t,r,i,o){var s=this;!0!==this.isMixAudio?this.audioBuffer?(this.startOffset=e||0,this.loop=t||!1,this.replace=r||!1,this.effectEndedCallBack=o,this.mixEffect(this.audioBuffer,(function(){s.buffSource.loop=!!t,e?s.buffSource.start(0,e/1e3):s.buffSource.start(0),s.startTimes=Date.now(),s.effectEndedListener=s.effectEndedHandler.bind(s),s.buffSource.addEventListener("ended",s.effectEndedListener),i&&i()}))):this.logger.error("amu.pe.1 no audio buffer found"):this.logger.error("amu.pe.1 audio is mixing")},e.prototype.mixingBuffer=function(e,t){var r=this;!0!==this.isMixAudio||0!=this.audioBufferList.length||0!=this.isMixingBuffer?(this.ac.resume(),this.ac.decodeAudioData(e,(function(e){r.audioBufferList.push(e),1==r.audioBufferList.length&&r.playRealTimeEffect(r.audioBufferList[0]),r.isMixingBuffer=!0,t&&t()}),(function(e){r.logger.error("amu.mb.0 "+e),t&&t({code:o.errorCodeList.PUBLISHER_DECODE_AUDIO_FAIL.code,message:o.errorCodeList.PUBLISHER_DECODE_AUDIO_FAIL.message+" "+e})}))):this.logger.error("amu.mb.0 audio is mixing")},e.prototype.stopMingBuffer=function(){return this.isMixingBuffer=!1,this.stopMixingAudio()},e.prototype.playRealTimeEffect=function(e){var t=this;this.mixEffect(e,(function(){t.buffSource&&t.buffSource.start(0),t.buffSource&&t.buffSource.addEventListener("ended",(function(){t.audioBufferList.shift(),t.audioBufferList.length>0&&t.isMixAudio&&t.playRealTimeEffect(t.audioBufferList[0])}))}))},e.prototype.pauseEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be paused"):(this.stopMixingAudio(),this.resumeOffset=(this.pauseTimes-this.startTimes+this.startOffset)%(1e3*this.audioBuffer.duration),this.paused=!0)},e.prototype.resumeEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be resume"):(this.playEffect(this.resumeOffset,this.loop,this.replace,void 0,this.effectEndedCallBack),this.startOffset=this.resumeOffset,this.paused=!1)},e.prototype.mixEffect=function(e,t){this.localStream?(this.ac.resume(),this.gainNode=this.ac.createGain(),this.buffSource=this.ac.createBufferSource(),this.buffSource.buffer=e,this.buffSource.connect(this.gainNode),this.gainNode.connect(this.ac.destination),this.replaceTrack()&&t()):this.logger.error("amu.me.0 localStream can not be found")},e.prototype.startMixingAudio=function(e,t){if(this.replace=t||!1,this.isMixAudio)return this.logger.error("amu.sma.0 audio is mixing"),!1;if(!this.localStream)return this.logger.error("amu.sma.0 localStream can not be found"),!1;if(e.captureStream=e.captureStream||e.mozCaptureStream||e.webkitCaptureStream,this.ac.resume(),this.gainNode=this.ac.createGain(),"Safari"===i.ClientUtil.getBrowser()){var r=this.mediaEleSources.find((function(t){return t.audio===e}));if(r)this.mixAudio=r.node;else{var o=this.ac.createMediaElementSource(e);this.mixAudio=o,this.mediaEleSources.push({audio:e,node:o})}e.currentTime=e.currentTime,this.audioCurrentTimer=setInterval((function(){e.currentTime=e.currentTime+.45}),6e3)}else this.mixAudio=this.ac.createMediaStreamSource(e.captureStream());return this.mixAudio.connect(this.gainNode),this.replaceTrack()},e.prototype.replaceTrack=function(){this.streamSource=this.ac.createMediaStreamSource(this.localStream),this.destination=this.ac.createMediaStreamDestination(),!this.replace&&this.streamSource.connect(this.destination),this.gainNode.connect(this.destination);var e=this.destination.stream.getAudioTracks()[0],t=this.peerConnection.getSenders().find((function(t){return t.track.kind===e.kind}));return t?(this.micTrack=this.localStream.getAudioTracks()[0],t.replaceTrack(e),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(e),this.isMixAudio=!0,!0):(this.logger.error("amu.rt.0 no sender"),!1)},e.prototype.stopMixingAudio=function(){var e=this;if(this.paused)return this.logger.info("amu.sma.1 audioEffect paused"),!0;if(!this.isMixAudio)return this.logger.warn("amu.sma.1 no mixing audio found"),!0;if(!this.localStream)return this.logger.error("amu.sma.1 localStream can not be found"),!1;this.peerConnection.getSenders().find((function(t){return t.track.kind===e.micTrack.kind}));return this.mixAudio?(this.mixAudio.disconnect(this.gainNode),this.mixAudio=null,this.audioCurrentTimer&&(clearInterval(this.audioCurrentTimer),this.audioCurrentTimer=null)):this.buffSource&&(this.buffSource.removeEventListener("ended",this.effectEndedListener),this.buffSource.stop(),this.pauseTimes=Date.now(),this.buffSource.disconnect(this.gainNode),this.buffSource=null),this.gainNode.disconnect(this.destination),this.isMixAudio=!1,this.audioBufferList=[],!0},e.prototype.setMixingAudioVolume=function(e){return this.gainNode?(this.gainNode.gain.value=e,!0):(this.logger.error("amu.sma.2 no mixing audio found"),!1)},e.prototype.effectEndedHandler=function(){this.stopMixingAudio(),this.effectEndedCallBack&&this.effectEndedCallBack()},e}();t.AudioMix=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoStreamCenter=void 0;var i=function(){this.publisherList={},this.playerList={}};t.ZegoStreamCenter=i},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoSignal=void 0;var o=r(0),s=r(3),a=function(){function e(e,t){this.sendDataMap={},this.sendDataList=new o.LinkedList,this.sendDataCheckOnceCount=100,this.signalSeq=0,this.pushCallback={},this.sessionInfos={},this.tryHeartbeatCount=0,this.heartbeatInterval=1e4,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.checkMessageList=["ActivateVideoPlayStreamReq","ActivateAudioPlayStreamReq","CreateSessionReq","CreateSessionWithSdpReq"],this.tryConnectCount=1,this.tryConnectTimer=null,this.tryConnectInterval=3e3,this.state=o.ENUM_CONNECT_STATE.disconnect,this.tokenType=0,this.browser=this.getBrowserAndVersion(),this.platform=navigator.platform,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.logger=e,this.stateCenter=t,this.stateCenter.streamConnectTime&&(this.tryConnectInterval=this.stateCenter.streamConnectTime)}return e.prototype.getBrowserAndVersion=function(){var e,t=navigator.userAgent,r=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*([\d\.]+)/i)||[];return/trident/i.test(r[1])?{name:"IE",version:(e=/\brv[ :]+([\d\.]+)/g.exec(t)||[])[1]||""}:"Chrome"===r[1]&&null!=(e=t.match(/\bOPR|Edge\/([\d\.]+)/))?{name:"Opera",version:e[1]}:(r=r[2]?[r[1],r[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/([\d+\.]+)/i))&&r.splice(1,1,e[1]),{name:r[0],version:r[1]})},e.prototype.setSessionInfo=function(e,t){this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_SET_SESSION_INFO+" call"),this.appid=e+"",this.userid=t},e.prototype.onDisconnect=function(e){},e.prototype.onUpdateHeartBeatInterval=function(e){},e.prototype.resetConnectTimer=function(){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_RESET_CONNECT_TIMER+" call"),clearTimeout(this.tryConnectTimer),this.tryConnectTimer=null,this.tryConnectCount=0},e.prototype.bindWebSocketHandle=function(){var e=this;this.tryHeartbeatCount=0,this.tryConnectInterval=this.stateCenter.streamConnectTime?this.stateCenter.streamConnectTime:3e3,this.websocket.onmessage=function(t){var r=JSON.parse(t.data);e.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_BIND_WEBSOCKET_HANDLE+" signmsg= ",r.header.cmd),e.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_BIND_WEBSOCKET_HANDLE+" signmsg= "+JSON.stringify(r)),r.header.appid==e.appid&&r.header.user_id===e.userid?e.handleServerPush(r):e.logger.warn(s.ZEGO_WEBRTC_ACTION.SIGNAL_BIND_WEBSOCKET_HANDLE+" check header failed")},this.websocket.onclose=function(t){e.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_BIND_WEBSOCKET_HANDLE+" close msg = "+JSON.stringify(t.code?t.code:t)),e.state!=o.ENUM_CONNECT_STATE.disconnect&&(e.resetConnectTimer(),e.startConnectTimer(),e.resetCheckMessage())},this.websocket.onerror=function(t){e.logger.error(s.ZEGO_WEBRTC_ACTION.SIGNAL_BIND_WEBSOCKET_HANDLE+" msg = "+JSON.stringify(t))}},e.prototype.resetCheckMessage=function(){this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_RESET_CHECK_MESSAGE+" call"),clearTimeout(this.sendDataCheckTimer),this.sendDataCheckTimer=null;for(var e=this.sendDataList.getFirst();null!=e;)this.sendDataList.remove(e),e._data.error&&e._data.error(o.SEND_MSG_RESET,e._data.seq),e=this.sendDataList.getFirst();this.sendDataMap={}},e.prototype.handleServerPush=function(e){switch(e.header.cmd){case"LoginRsp":this.handleRespondData("LoginReq",e);break;case"CreateSessionRsp":this.handleRespondData("CreateSessionReq",e),0===e.body.result&&this.addSession(e.header.session_id,e.body.session_token);break;case"CreateSessionWithSdpRsp":this.handleRespondData("CreateSessionWithSdpReq",e),0===e.body.result&&this.addSession(e.header.session_id,e.body.session_token);break;case"MediaDescRsp":this.handleRespondData("MediaDescReq",e);break;case"CandidateInfoRsp":this.handleRespondData("CandidateInfoReq",e);break;case"CloseSessionRsp":this.handleRespondData("CloseSessionReq",e),this.removeSession(e.header.session_id);break;case"ClientHBRsp":this.handleRespondData("ClientHBReq",e);break;case"MediaDescPush":case"CandidateInfoPush":this.handlePushData(e);break;case"CloseSessionPush":this.handlePushData(e),this.removeSession(e.header.session_id);break;case"QualityReportRsp":this.handleRespondData("QualityReportReq",e);break;case"SessionResetPush":this.handlePushResetSessionData(e);break;case"StreamStatusNotifyPush":case"PublishEventPush":case"PlayEventPush":case"ClientInfoPush":this.handlePushData(e);break;case"ActivateVideoPlayStreamRsp":this.handleRespondData("ActivateVideoPlayStreamReq",e);break;case"ActivateAudioPlayStreamRsp":this.handleRespondData("ActivateAudioPlayStreamReq",e);break;case"NetQualityProbeRsp":this.handleRespondData("NetQualityProbeReq",e);break;case"NetQualityInfoPush":this.handlePushData(e)}},e.prototype.disconnectCallback=function(){this.connectCallback&&(this.connectCallback(-1,this.server,void 0),this.connectCallback=null);var e=this.server;this.disconnectServer(),this.onDisconnect(e)},e.prototype.updateToken=function(){var e=this;this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_UPDATE_TOKEN+" call");var t={token:this.token,tokenType:this.tokenType,roomid:this.stateCenter.roomid,anchorname:this.stateCenter.anchor_info.anchor_id,sdkversion:o.PROTO_VERSION,osinfo:navigator.appVersion};if(0!=Object.keys(this.sessionInfos).length){var r=[];for(var i in this.sessionInfos){var a=parseInt(i);r.push({session_id:a,session_token:this.sessionInfos[a].token})}t.sessions=r}this.sendMessageWithCallback("LoginReq",o.getSeq(),0,t,(function(t,r,i){if(0==i.result){e.token=i.token,e.tokenType=i.tokenType;var o={report:i.report,report_interval:i.report_interval_ms};i.negoInterval&&(e.negoInterval=i.negoInterval),i.negoTryCount&&(e.negoTryCount=i.negoTryCount),i.negoTryMaxCount&&(e.negoTryMaxCount=i.negoTryMaxCount),null!=e.connectCallback&&(e.connectCallback(0,e.server,o),e.connectCallback=null),e.checkMessageTimeout()}else{var s={error:i.strError};null!=e.connectCallback&&(e.connectCallback(i.result,e.server,s),e.connectCallback=null)}}),(function(){null!=e.connectCallback&&(e.connectCallback(-1,e.server,void 0),e.connectCallback=null)}))},e.prototype.sendMessageWithCallback=function(e,t,r,i,a,n){if(this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MESSAGE_WITH_CALLBACK+" call "+e),!this.websocket||1!==this.websocket.readyState)return this.logger.error(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MESSAGE_WITH_CALLBACK+" connect not establish"),void(n&&n(o.SEND_MSG_TIMEOUT,t));var c={header:this.getHeader(e,t,r),body:i};null==a&&(a=null),null==n&&(n=null);var d={seq:t,deleted:!1,cmd:e,time:Date.parse(new Date+""),success:a,error:n},l=this.sendDataList.push(d);this.sendDataMap[d.seq]=l;var u=JSON.stringify(c);this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MESSAGE_WITH_CALLBACK+" "+u),this.websocket.send(u),this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MESSAGE_WITH_CALLBACK+" success")},e.prototype.getHeader=function(e,t,r){return this.globalHeader={version:"1.0.1",cmd:e,appid:this.appid+"",seq:t,user_id:this.userid,session_id:r},this.globalHeader},e.prototype.connectServer=function(e,t,r){var i=this;if(this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" "+t),this.token=e,this.server=t,this.state=o.ENUM_CONNECT_STATE.connecting,this.connectCallback=r,this.websocket&&1===this.websocket.readyState)this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" websocket is connected"),this.resetConnectTimer(),this.state=o.ENUM_CONNECT_STATE.connected;else{this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" need new websocket");try{this.websocket&&(this.logger.warn(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" close error websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.websocket=new WebSocket(this.server),this.websocket.onopen=function(){i.resetConnectTimer(),i.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" websocket open call"),i.bindWebSocketHandle(),i.updateToken(),i.state=o.ENUM_CONNECT_STATE.connected},this.websocket.onclose=function(e){i.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" websocket close call  "+JSON.stringify(e))},this.websocket.onerror=function(e){i.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" websocket onerror call  "+JSON.stringify(e))}}catch(e){this.logger.error(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" websocket error "+e)}}this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CONNECT_SERVER+" "+this.tryConnectInterval),this.tryConnectTimer=setTimeout((function(){i.startConnectTimer(r)}),this.tryConnectInterval)},e.prototype.startConnectTimer=function(e){if(this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_START_CONNECT_TIMER+" call"),this.tryConnectCount>=o.MAX_TRY_CONNECT_COUNT)return this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_START_CONNECT_TIMER+" beyond "+this.server+"max limit"),void this.disconnectCallback();this.websocket&&1===this.websocket.readyState?(this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_START_CONNECT_TIMER+" websocket is connected"),this.resetConnectTimer()):(this.tryConnectCount+=1,this.connectServer(this.token,this.server,e))},e.prototype.disconnectServer=function(){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_DISCONNECT_SERVER+" call"),this.connectCallback=null,this.resetCheckMessage(),this.resetConnectTimer(),this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.token="",this.sessionInfos={},this.tokenType=0,this.tryHeartbeatCount=0,this.tryConnectCount=0,this.state=o.ENUM_CONNECT_STATE.disconnect},e.prototype.isServerConnected=function(){return!(!this.websocket||1!==this.websocket.readyState)},e.prototype.createSession=function(e,t,r,i,a,n,c,d){void 0===a&&(a=""),void 0===n&&(n=""),this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CREATE_SESSION+" call: "+i);var l="";o.PROTO_VERSION.split(".").forEach((function(e,t){return 1==e.length&&1==t?l+="0"+e:l+=e}));var u={type:t,stream_id:i,platform:this.platform,browser:this.browser.name,version:this.browser.version,app_id:this.appid,negotiate_mode:r,strAuthParam:a,sdk_version:1*l,turn_server_host:"string"==typeof n?n:""};this.sendMessageWithCallback("CreateSessionReq",e,0,u,c,d)},e.prototype.createSessionWithSdp=function(e,t,r){var i=e.seq,a=e.type,n=e.streamId,c=e.strAuthParam,d=e.sdp,l=e.serverHost,u=e.playBufLevel;this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CREATE_SESSION+" call: "+n);var p="";o.PROTO_VERSION.split(".").forEach((function(e,t){return 1==e.length&&1==t?p+="0"+e:p+=e}));var h={type:a,app_id:this.appid,stream_id:n,sdp:d,user_id:this.userid,platform:this.platform,browser:this.browser.name,sdk_vers:parseInt(p),clientIp:"",media_server_host:"string"==typeof l?l:"",strAuthParam:c};u&&(h.min_play_buf_level_ms=u),this.sendMessageWithCallback("CreateSessionWithSdpReq",i,0,h,t,r)},e.prototype.removeSession=function(e){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_REMOVE_SESSION+" call"+e),this.sessionInfos[e]&&delete this.sessionInfos[e]},e.prototype.sendCloseSession=function(e,t,r,i,o){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_REMOVE_SESSION+" call: "+t);var a={reason:r};this.removeSession(t),this.sendMessageWithCallback("CloseSessionReq",e,t,a,i,o)},e.prototype.sendMessage=function(e,t,r,i){if(this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MESSAGE+" call "+e),this.websocket&&1===this.websocket.readyState){var o={header:this.getHeader(e,t,r),body:i},a=JSON.stringify(o);this.websocket.send(a),this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MESSAGE+" success")}else this.logger.error(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MESSAGE+" connect not establish")},e.prototype.handleRespondData=function(e,t){this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_RESPOND_DATA+" call");var r=this.sendDataMap[t.header.seq];if(null!=r){var i=r._data;i.cmd!==e?this.logger.error(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_RESPOND_DATA+" command is not match"):i.success&&i.success(t.header.seq,t.header.session_id,t.body),delete this.sendDataMap[t.header.seq],this.sendDataList.remove(r)}else{if("CloseSessionRsp"==t.header.cmd)return;this.logger.error(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_RESPOND_DATA+" cannot find data "+e)}},e.prototype.addSession=function(e,t){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_ADD_SESSION+" call"+e),this.sessionInfos[e]={token:t}},e.prototype.handlePushData=function(e){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_PUSH_DATA+" call "+e.header.cmd+" session "+e.header.session_id);var t=this.pushCallback[e.header.cmd+e.header.session_id];t?t.callback&&t.callback(e.header.seq,e.header.session_id,e.body):this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_PUSH_DATA+" no callbackData "+e.header.cmd+" session: "+e.header.session_id)},e.prototype.handlePushResetSessionData=function(e){this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_PUSH_RESET_SESSION_DATA+" call ");var t=[];if(0==e.body.cResetType)t=Object.keys(this.sessionInfos);else if(1==e.body.cResetType)for(var r=0;r<e.body.session_ids.length;r++)t.push(e.body.session_ids[r]);if(this.sendResetSessionAck(e.header.seq,0,0),0!=t.length)for(var i=0;i<t.length;i++){var o=this.pushCallback[e.header.cmd+t[i]];null==o?this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_PUSH_RESET_SESSION_DATA+" no callbackData "+t[i]):o.callback&&o.callback(e.header.seq,t[i],e.body)}else this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_HANDLE_PUSH_RESET_SESSION_DATA+" no session to callback")},e.prototype.sendMediaDesc=function(e,t,r,i,o,a){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MEDIA_DESC+" call: "+t);var n={type:r,sdp:i.sdp};null!=i.width&&(n.width=i.width),null!=i.height&&(n.height=i.height),null!=i.frameRate&&(n.framerate=i.frameRate),null!=i.video_min_kpbs&&(n.video_min_kpbs=i.video_min_kpbs),null!=i.video_max_kpbs&&(n.video_max_kpbs=i.video_max_kpbs),null!=i.audio_kpbs&&(n.audio_kpbs=i.audio_kpbs),null!=i.keyframe_intv&&(n.keyframe_intv=i.keyframe_intv),null!=i.min_play_buf_level_ms&&(n.min_play_buf_level_ms=i.min_play_buf_level_ms),this.sendMessageWithCallback("MediaDescReq",e,t,n,o,a)},e.prototype.sendCandidateInfo=function(e,t,r,i,o){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_CANDIDATE_INFO+" call: "+t);for(var a=[],n=0;n<r.length;n++){var c={candidate:r[n].candidate,sdpMid:r[n].sdpMid,sdpMLineIndex:r[n].sdpMLineIndex};a.push(c)}var d={infos:a};this.sendMessageWithCallback("CandidateInfoReq",e,t,d,i,o)},e.prototype.sendMediaDescAck=function(e,t,r){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_MEDIA_DESC_ACK+" call: "+t);var i={result:r};this.sendMessage("MediaDescAck",e,t,i)},e.prototype.sendCandidateInfoAck=function(e,t,r){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_CANDIDATE_INFO_ACK+" call: "+t);var i={result:r};this.sendMessage("CandidateInfoAck",e,t,i)},e.prototype.sendCloseSessionAck=function(e,t,r){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_CLOSE_SESSION_ACK+" call: "+t);var i={result:r};this.sendMessage("CloseSessionAck",e,t,i)},e.prototype.sendResetSessionAck=function(e,t,r){this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_RESET_SESSION_ACK+" call: "+t);var i={result:r};this.sendMessage("SessionResetAck",e,t,i)},e.prototype.registerPushCallback=function(e,t,r){r&&"function"==typeof r&&(this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_REGISTER_PUSH_CALLBACK+" set callback "+t),this.pushCallback[e+t]={callback:r})},e.prototype.unregisterPushCallback=function(e,t){delete this.pushCallback[e+t]},e.prototype.checkMessageTimeout=function(){for(var e=this,t=this.sendDataList.getFirst(),r=Date.parse(new Date+""),i=0,a=0,n=0;null!=t&&!(t._data.time+this.sendDataTimeout>r);)if(delete this.sendDataMap[t._data.seq],this.sendDataList.remove(t),++a,-1!=this.checkMessageList.indexOf(t._data.cmd)){if(null==t._data.error||this.sendDataDropTimeout>0&&t._data.time+this.sendDataDropTimeout<r?++n:(this.logger.warn(s.ZEGO_WEBRTC_ACTION.SIGNAL_CHECK_MESSAGE_TIMEOUT+" error cmd = "+t._data.cmd),t._data.error&&t._data.error(o.SEND_MSG_TIMEOUT,t._data.seq)),++i>=this.sendDataCheckOnceCount)break;t=this.sendDataList.getFirst()}else t=this.sendDataList.getFirst();this.sendDataCheckTimer=setTimeout((function(){e.checkMessageTimeout()}),this.sendDataCheckInterval),0==a&&0==n||this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_CHECK_MESSAGE_TIMEOUT+" call success, state: timeout="+a+" drop="+n)},e.prototype.sendHeartbeat=function(){var e=this;if(this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_HEARTBEAT+"call tryHeartbeatCount:"+this.tryHeartbeatCount),0!=Object.keys(this.sessionInfos).length)if(this.state===o.ENUM_CONNECT_STATE.connected){if(++this.tryHeartbeatCount>o.MAX_TRY_HEARTBEAT_COUNT)return this.logger.error(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_HEARTBEAT+" heartbeat try limit"),void this.disconnectCallback();var t=[];for(var r in this.sessionInfos)t.push(parseInt(r));var i={session_ids:t};this.sendMessageWithCallback("ClientHBReq",o.getSeq(),0,i,(function(t,r,i){e.heartbeatInterval!=i.hb_interval&&(e.heartbeatInterval=i.hb_interval,e.onUpdateHeartBeatInterval(i.hb_interval)),e.tryHeartbeatCount=0}),(function(e,t){}))}else this.logger.warn(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_HEARTBEAT+" state error");else this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_HEARTBEAT+" no need to heartbeat")},e.prototype.QualityReport=function(e,t,r,o,a){this.logger.debug(s.ZEGO_WEBRTC_ACTION.SIGNAL_QUALITY_REPORT+" call");var n={streams:[i(i({},r),{aid:t})]};this.sendMessageWithCallback("QualityReportReq",e,t,n,o,a)},e.prototype.sendStreamStatus=function(e,t,r,i,o){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_STREAM_STATUS+" call "+t);var a={mic_status:i,camera_status:r};this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_STREAM_STATUS+" stream "+(o||"")+" status "+JSON.stringify(a)),this.sendMessage("StreamStatusNotify",e,t,a)},e.prototype.ActivatePlayVideoStream=function(e,t,r,i,o){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_ACTIVE_PLAY_VIDEO_STREAM+" call");var a={active:r?0:1,layer:0};this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_ACTIVE_PLAY_VIDEO_STREAM+" activate video "+JSON.stringify(a)),this.sendMessageWithCallback("ActivateVideoPlayStreamReq",e,t,a,i,o)},e.prototype.ActivatePlayAudioStream=function(e,t,r,i,o){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_ACTIVE_PLAY_AUDIO_STREAM+" call");var a={active:r?0:1,layer:0};this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_ACTIVE_PLAY_AUDIO_STREAM+" activate audio "+JSON.stringify(a)),this.sendMessageWithCallback("ActivateAudioPlayStreamReq",e,t,a,i,o)},e.prototype.sendBroadcasterStatus=function(e,t,r){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_BROADCAST_STATUS+" call "+t);var i={status:r};this.sendMessage("BroadcasterStatusNotify",e,t,i)},e.prototype.sendNetProbe=function(e,t,r,i,o){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_NET_PROBE+" call "+t);var a={peer_id:r,action:1};this.sendMessageWithCallback("NetQualityProbeReq",e,t,a,i,o)},e.prototype.sendNetQualityInfoPushAck=function(e,t,r,i){this.logger.info(s.ZEGO_WEBRTC_ACTION.SIGNAL_SEND_NET_PROBE+" call "+t);var o={peer_id:r,result:i};this.sendMessage("NetQualityInfoAck",e,t,o)},e}();t.ZegoSignal=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoPlayWeb=void 0;var i=r(0),o=r(5),s=r(2),a=r(1),n=r(3),c=function(){function e(e,t,r,o,s,a,n){this.state=i.ENUM_PLAY_STATE.stop,this.candidateInfo=[],this.qualityTimer=null,this.broadcasterStatus=i.ENUM_BROADCASTER_STATUS.stop,this.playQualityList=[],this.maxQualityListCount=10,this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,audioPacketsReceived:0,videoPacketsReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0},this.reportSeq=NaN,this.streamReportSeq=i.getSeq(),this.videoSizeCallback=!1,this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.remoteStream=null,this.playStream=null,this.playOption={},this.closeSessionSignal=!1,this.stateNego=i.ENUM_PLAY_STATE_NEGO.stop,this.negoTimer=null,this.negoInterval=25e3,this.playEvent=!1,this.gotStreamStatus=!1,this.soundLevel=0,this.mic=null,this.script=null,this.beginTime=0,this.firstFrameTime=0,this.resourceMode=0,this.gwNode="",this.gwNodeList=[],this.gwNodeTTL=0,this.isPeer=!1,this.peerFailCount=0,this.isProbe=!1,this.peerID=0,this.netQuality=0,this.probeTime=0,this.probeInterval=6e4,this.probeState=i.ENUM_PROBE_STATE.probed,this.isRecvClientInfo=!1,this.probeTimer=null,this.probeTimeoutInterval=3e4,this.logger=e,this.signal=t,this.dataReport=r,this.qualityTimeInterval=o,this.streamCenter=s,this.ac=a,this.stateCenter=n,this.dataReport.newReport(this.streamReportSeq),this.dataReport.addMsgInfo(this.streamReportSeq,{abs_time:Date.now()})}return e.prototype.startPlay=function(e,t,r){var i=this;this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" called ",e),this.playEvent=!1,this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),e?(this.streamId=e,this.getRemoteStreamSuc=t,this.playOption=r||{},r&&r.videoCodec&&(this.playOption.videoCodec=r.videoCodec),this.dataReport.addMsgInfo(this.reportSeq,{audio_activate:a.ZegoRTCLogEvent.kZegoTaskPlayStart.audio_activate(1==this.playOption.audio?1:0==this.playOption.audio?0:1),video_activate:a.ZegoRTCLogEvent.kZegoTaskPlayStart.video_activate(1==this.playOption.video?1:0==this.playOption.video?0:1)}),this.isPeer?this.createOffer():this.createSession(),this.negoTimer=setTimeout((function(){i.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" waiting timeout"),i.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayNegoTimeoutError)}),this.negoInterval),this.isProbe&&(this.probeTimer=setTimeout((function(){i.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" probe timeout"),i.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kProbeTimeOutError)}),this.probeTimeoutInterval))):this.logger.warn(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" streamId is null")},e.prototype.onCreatePlaySessionSuccess=function(e){var t=this;this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS+" "+this.streamId+" success");var r=[];if(e.turn_server){var i=e.turn_server;this.stateCenter.turnOverTcpOnly&&(i=i.replace("udp","tcp")),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS+" turn over tcp "+i),r.push(i)}e.stun_server&&r.push(e.stun_server);var o={iceTransportPolicy:"relay",iceServers:[{urls:r,username:e.turn_username,credential:e.turn_auth_key}]};this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS+" "+this.streamId+" username: "+e.turn_username),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS+" "+this.streamId+" credential: "+e.turn_auth_key),this.createOffer(o),this.signal.registerPushCallback("MediaDescPush",this.sessionId,(function(e,r,i){t.onRecvMediaDesc(e,r,i)})),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,(function(e,r,i){t.onRecvCandidateInfo(e,r,i)})),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,(function(e,r,i){t.onRecvCloseSession(e,r,i)})),this.signal.registerPushCallback("SessionResetPush",this.sessionId,(function(e,r,i){t.onRecvResetSession(e,r,i)})),this.signal.registerPushCallback("StreamStatusNotifyPush",this.sessionId,(function(e,r,i){t.gotStreamStatus=!0,t.streamStatus=i,t.playStream&&t.onRecvStreamStatus(i)})),this.signal.registerPushCallback("PlayEventPush",this.sessionId,(function(e,r,i){t.onRecvPlayEvent(e,r,i)})),this.signal.registerPushCallback("ClientInfoPush",this.sessionId,(function(e,r,i){t.onRecvClientInfo(e,r,i)})),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS+" "+this.streamId+" call success")},e.prototype.createOffer=function(e){var t=this;this.peerConnection=new RTCPeerConnection(e),this.peerConnection.onicecandidate=function(e){t.onIceCandidate(e)},this.peerConnection.onsignalingstatechange=function(e){t.onConnectionStateChange(e)},this.peerConnection.oniceconnectionstatechange=function(e){t.onIceConnectionStateChange(e)},this.peerConnection.ontrack=function(e){t.onGotRemoteStream(e.streams[0])};var r={offerToReceiveAudio:1,offerToReceiveVideo:1};this.playOption&&!1===this.playOption.video&&(r.offerToReceiveVideo=0),this.playOption&&!1===this.playOption.audio&&(r.offerToReceiveAudio=0),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS+" "+this.streamId+" createOffer: "+JSON.stringify(r)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.dataReport.eventStart(this.streamReportSeq,"CreateOffer"),this.peerConnection.createOffer(r).then((function(e){t.dataReport.eventEnd(t.reportSeq,"CreateOffer"),t.dataReport.eventEnd(t.streamReportSeq,"CreateOffer"),t.onCreateOfferSuccess(e)}),(function(e){t.dataReport.eventEndWithMsg(t.reportSeq,"CreateOffer",{error:e.toString()}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"CreateOffer",{error:e.toString()}),t.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_PLAY_SESSION_SUCCESS+" "+t.streamId+" create offer error "+e.toString()),t.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kCreateOfferError,!0)}))},e.prototype.createSession=function(e){var t=this;this.sessionSeq=i.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession"),this.dataReport.eventStart(this.streamReportSeq,"CreateSession");var r=this.streamId;1==this.streamCenter.testEnvironment&&(r="zegotest-"+this.streamCenter.appid+"-"+this.streamId),this.isPeer?this.signal.createSessionWithSdp({seq:this.sessionSeq,type:this.isProbe?2:1,mode:0,streamId:r,strAuthParam:this.playOption&&this.playOption.streamParams||"",sdp:e.sdp,serverHost:this.gwNode,playBufLevel:2==this.resourceMode?500:void 0},(function(e,r,i){t.handleCreateSessionWithSdpResp(e,r,i)}),(function(r,o){t.dataReport.eventEndWithMsg(t.reportSeq,"CreateSession",{error:r}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"CreateSession",{error:r}),!t.isProbe&&r==i.SEND_MSG_TIMEOUT&&t.peerFailCount<2?(t.peerFailCount++,t.createSession(e)):!t.isProbe&&r==i.SEND_MSG_TIMEOUT&&t.peerFailCount>=2?(t.isPeer=!1,t.streamCenter.isPeer=!1,t.createSession()):t.playStateUpdateError(r==i.SEND_MSG_TIMEOUT?a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSessionTimeoutError:a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSessionRequestError)})):this.signal.createSession(this.sessionSeq,1,0,r,this.playOption&&this.playOption.streamParams,this.gwNode,(function(e,r,i){t.handleCreateSessionResp(e,r,i)}),(function(e,r){t.dataReport.eventEndWithMsg(t.reportSeq,"CreateSession",{error:e}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"CreateSession",{error:e}),t.playStateUpdateError(e==i.SEND_MSG_TIMEOUT?a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSessionTimeoutError:a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSessionRequestError)})),this.state=i.ENUM_PLAY_STATE.waitingSessionRsp,this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" "+this.streamId+" called success"),this.stateNego=i.ENUM_PLAY_STATE_NEGO.start},e.prototype.handleCreateSessionResp=function(e,t,r){var i=r.turn_server,o=i.split("?")[0]&&i.split("?")[0].slice(5),s=this.streamCenter.server.split("?"),c=s[1]&&s[1].slice(2);this.dataReport.eventEndWithMsg(this.streamReportSeq,"CreateSession",{sessionId:r.session_id,url:"webrtc://"+o+"/"+c+"/"+this.streamId}),this.dataReport.eventEndWithMsg(this.reportSeq,"CreateSession",{sessionId:r.session_id,url:"webrtc://"+o+"/"+c+"/"+this.streamId}),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" "+this.streamId+" sessionId:"+r.session_id),this.sessionSeq==e?(this.gwNodeList=r.gw_nodes&&r.gw_nodes.length>0?r.gw_nodes:this.gwNodeList,this.gwNode=r.gw_nodes&&r.gw_nodes.length>0?this.gwNodeList[0]:this.gwNode,this.gwNodeTTL=r.gw_nodes_ttl?(new Date).getTime()+1e3*r.gw_nodes_ttl:this.gwNodeTTL,this.stateCenter.clientIP=r.clientip?r.clientip:this.stateCenter.clientIP,0!==r.result?(this.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" "+this.streamId+" create error"),this.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSessionRequestError)):(this.sessionId=r.session_id,this.sessionToken=r.session_token,this.dataReport.addMsgInfo(this.reportSeq,{session_id:a.ZegoRTCLogEvent.kZegoTaskPlayStart.session_id(this.sessionId)}),this.onCreatePlaySessionSuccess(r))):this.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_START_PLAY+" seq is not match.")},e.prototype.handleCreateSessionWithSdpResp=function(e,t,r){var i=this;this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_HANDLE_CREATE_SESSION_WITH_SDP+" sessionId:"+t),this.sessionSeq==e?(this.dataReport.eventEndWithMsg(this.streamReportSeq,"CreateSession",{sessionId:t}),this.dataReport.eventEndWithMsg(this.reportSeq,"CreateSession",{sessionId:t}),this.gwNodeList=r.gw_nodes&&r.gw_nodes.length>0?r.gw_nodes:this.gwNodeList,this.gwNode=r.gw_nodes&&r.gw_nodes.length>0?this.gwNodeList[0]:this.gwNode,this.gwNodeTTL=r.gw_nodes_ttl?(new Date).getTime()+1e3*r.gw_nodes_ttl:this.gwNodeTTL,this.stateCenter.clientIP=r.clientip?r.clientip:this.stateCenter.clientIP,0!==r.result?(this.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_HANDLE_CREATE_SESSION_WITH_SDP+" create session failed "+r.result),this.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSessionRequestError)):(this.sessionId=t,this.sessionToken=r.session_token,this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_HANDLE_CREATE_SESSION_WITH_SDP+" create session success ",this.streamId),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,(function(e,t,r){i.onRecvCloseSession(e,t,r)})),this.signal.registerPushCallback("SessionResetPush",this.sessionId,(function(e,t,r){i.onRecvResetSession(e,t,r)})),this.signal.registerPushCallback("StreamStatusNotifyPush",this.sessionId,(function(e,t,r){i.gotStreamStatus=!0,i.streamStatus=r,i.playStream&&i.onRecvStreamStatus(r)})),this.signal.registerPushCallback("PlayEventPush",this.sessionId,(function(e,t,r){i.onRecvPlayEvent(e,t,r)})),this.signal.registerPushCallback("ClientInfoPush",this.sessionId,(function(e,t,r){i.onRecvClientInfo(e,t,r)})),this.signal.registerPushCallback("NetQualityProbeRsp",this.sessionId,(function(e,t,r){i.onRecvPlayEvent(e,t,r)})),this.signal.registerPushCallback("NetQualityInfoPush",this.sessionId,(function(e,t,r){i.onRecvNetQualityInfo(e,t,r)})),this.onGetRemoteOfferSuccess(r.sdp))):this.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_HANDLE_CREATE_SESSION_WITH_SDP+" seq is not match.")},e.prototype.onCreateOfferSuccess=function(e){var t=this;this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_OFFER_SUCCESS+" "+this.streamId+" localSdp1 "+e.sdp.substr(0,e.sdp.length/2)),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_OFFER_SUCCESS+" "+this.streamId+" localSdp2 "+e.sdp.substr(e.sdp.length/2)),e.sdp=e.sdp.replace(/sendrecv/g,"recvonly"),e.sdp=e.sdp.replace(/useinbandfec=/,"stereo=1;useinbandfec="),this.playOption.videoCodec&&(e.sdp=o.SdpUtil.getSDPByVideDecodeType(e.sdp,this.playOption.videoCodec)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.dataReport.eventStart(this.streamReportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(e).then((function(){t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription"),t.dataReport.eventEnd(t.streamReportSeq,"SetLocalDescription"),t.onSetLocalDescriptionSuccess(e)}),(function(e){t.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CREATE_OFFER_SUCCESS+" "+t.streamId+" set error "+e.toString()),t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription",{error:e.toString()}),t.dataReport.eventEnd(t.streamReportSeq,"SetLocalDescription",{error:e.toString()}),t.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSetLocalDescError,!0)}))},e.prototype.onSetLocalDescriptionSuccess=function(e){var t=this;if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+this.streamId+" success"),this.isPeer)this.createSession(e);else{var r={sdp:e.sdp};2==this.resourceMode&&(r.min_play_buf_level_ms=500),this.answerSeq=i.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.dataReport.eventStart(this.streamReportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.answerSeq,this.sessionId,0,r,(function(e,r,o){t.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+t.streamId+" sendMediaDesc resp"),t.answerSeq==e&&t.sessionId==r?(t.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+t.streamId+" send success stateNego:waiterAnswer"),t.stateNego=i.ENUM_PLAY_STATE_NEGO.waiterAnswer,t.dataReport.eventEnd(t.reportSeq,"SendMediaDesc"),t.dataReport.eventEnd(t.streamReportSeq,"SendMediaDesc"),t.state=i.ENUM_PLAY_STATE.waitingServerAnswer):t.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+t.streamId+" seq or sessionId is not equal "+t.answerSeq+" "+e,0+t.sessionId+" "+r)}),(function(e,r){t.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_SET_LOCAL_DESCRIPTION_SUCCESS+" "+t.streamId+" failed to send "+e),t.dataReport.eventEndWithMsg(t.reportSeq,"SendMediaDesc",{error:e}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"SendMediaDesc",{error:e}),t.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kMediaDescError)})),this.state=i.ENUM_PLAY_STATE.waitingOffserRsp}},e.prototype.onRecvMediaDesc=function(e,t,r){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_MEDIA_DESC+" "+this.streamId+" received ",r),this.stateNego=i.ENUM_PLAY_STATE_NEGO.waitingCandidate,this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_MEDIA_DESC+" "+this.streamId+" received stateNego:waitingCandidate"),this.state===i.ENUM_PLAY_STATE.waitingServerAnswer?(this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.dataReport.addEvent(this.streamReportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(e,this.sessionId,0),this.onGetRemoteOfferSuccess(r.sdp)):this.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_MEDIA_DESC+" "+this.streamId+" current state "+this.state+" not allowed")},e.prototype.onGetRemoteOfferSuccess=function(e){var t=this,r={type:"answer",sdp:e,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.dataReport.eventStart(this.streamReportSeq,"SetRemoteDescription"),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_MEDIA_DESC+" "+this.streamId+" remoteSdp ",r.sdp),this.peerConnection.setRemoteDescription(new RTCSessionDescription(r)).then((function(){t.dataReport.eventEnd(t.reportSeq,"SetRemoteDescription"),t.dataReport.eventEnd(t.streamReportSeq,"SetRemoteDescription"),t.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_MEDIA_DESC+" "+t.streamId+" set success")}),(function(e){t.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_MEDIA_DESC+" "+t.streamId+" set remote error "+e.toString()),t.dataReport.eventEndWithMsg(t.reportSeq,"SetRemoteDescription",{error:e.toString()}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"SetRemoteDescription",{error:e.toString()}),t.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSetRemoteDescError,!0)})),this.state=i.ENUM_PLAY_STATE.waitingServerICE,this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_MEDIA_DESC+" "+this.streamId+" call success")},e.prototype.onRecvCandidateInfo=function(e,t,r){var o=this;if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CANDIDATE_INFO+" "+this.streamId+" received "),this.state==i.ENUM_PLAY_STATE.waitingServerICE){this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.dataReport.addEvent(this.streamReportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(e,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var s=0;s<r.infos.length;s++){var c={sdpMid:r.infos[s].sdpMid,sdpMLineIndex:r.infos[s].sdpMLineIndex,candidate:r.infos[s].candidate};this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CANDIDATE_INFO+" "+this.streamId+" candidate "+c.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(c)).then((function(){o.logger.debug(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CANDIDATE_INFO+" "+o.streamId+" add success")}),(function(e){o.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CANDIDATE_INFO+" "+o.streamId+" add error "+e.toString()),o.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kCandidateError,!0)}))}this.state=i.ENUM_PLAY_STATE.connecting,this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CANDIDATE_INFO+" "+this.streamId+" call success")}else this.logger.warn(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CANDIDATE_INFO+" "+this.streamId+" current state "+this.state+" not allowed")},e.prototype.onRecvPlayEvent=function(e,t,r){if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_PLAY_EVENT+" "+this.streamId+" received"),!0===this.playEvent&&0==r.event){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_PLAY_EVENT+" "+this.streamId+" retry: "+this.streamId);var o=this.streamId,s=this.playOption;this.signal.sendCloseSession(i.getSeq(),this.sessionId,1),this.resetPlay(),this.startPlay(o,this.getRemoteStreamSuc,s)}else this.playEvent=!0},e.prototype.onRecvClientInfo=function(e,t,r){this.stateCenter.clientIP!==r.clientip&&this.logger.warn(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CLIENT_INFO+" client ip changed "+this.stateCenter.clientIP+" "+r.clientip),this.stateCenter.clientIP=r.clientip,this.peerID=r.peer_id,this.isProbe&&this.stateNego==i.ENUM_PLAY_STATE_NEGO.iceConnected&&this.signal.sendNetProbe(i.getSeq(),this.sessionId,this.peerID,(function(){}),(function(){})),this.isRecvClientInfo=!0},e.prototype.onRecvNetQualityInfo=function(e,t,r){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_NET_QUALITY_INFO+" call"),this.probeTimer&&(clearTimeout(this.probeTimer),this.probeTimer=null);var o=0,a=r.lossrate,c=r.rtt;this.peerID===r.peer_id&&null!=typeof a&&null!=typeof c||(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_NET_QUALITY_INFO+" local peerID:"+this.peerID+" remote peerID:"+r.peer_id+" lossrate:"+a+" rtt:"+c),o=1),this.signal.sendNetQualityInfoPushAck(i.getSeq(),this.sessionId,this.peerID,o),0==o&&"number"==typeof a&&"number"==typeof c?this.onCalNetQualityResult(0,s.ClientUtil.getNetQuality(c,a)):this.onCalNetQualityResult(1)},e.prototype.onIceCandidate=function(e){if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_ICE_CANDIDATE+" "+this.streamId+" called"),null!=e.candidate)if(this.logger.debug(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_ICE_CANDIDATE+" "+this.streamId+" candidate "+e.candidate.candidate),this.state<i.ENUM_PLAY_STATE.connecting||this.state==i.ENUM_PLAY_STATE.stop)this.logger.debug(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_ICE_CANDIDATE+" "+this.streamId+" cached"),this.candidateInfo.push({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex});else{this.logger.debug(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_ICE_CANDIDATE+" "+this.streamId+" send");var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};this.sendCandidateInfo([t])}},e.prototype.onConnectionStateChange=function(e){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_CONNECTION_STATE_CHANGE+" "+this.streamId+" called "+e.target.signalingState)},e.prototype.onIceConnectionStateChange=function(e){if(this.state!=i.ENUM_PLAY_STATE.stop&&null!=this.peerConnection)if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_ICE_CONNECTION_STATE_CHANGE+" "+this.streamId+" stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState){if(this.stateNego=i.ENUM_PLAY_STATE_NEGO.iceConnected,this.isProbe&&this.isPeer&&this.isRecvClientInfo)return this.signal.sendNetProbe(i.getSeq(),this.sessionId,this.peerID,(function(){}),(function(){})),void(this.negoTimer&&clearTimeout(this.negoTimer));for(var t in this.negoTimer&&clearTimeout(this.negoTimer),this.dataReport.addEvent(this.reportSeq,"IceConnected"),this.dataReport.addEvent(this.streamReportSeq,"IceConnected"),this.state!=i.ENUM_PLAY_STATE.playing&&this.onPlayStateUpdate(i.ENUM_PLAY_STATE_UPDATE.start,this.streamId,{code:0,message:""},!0),this.state=i.ENUM_PLAY_STATE.playing,this.dataReport.eventStart(this.reportSeq,"PlayState"),this.dataReport.eventStart(this.streamReportSeq,"PlayState"),this.streamCenter.publisherList){if(this.streamCenter.publisherList[t].publisher.state==i.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==i.ENUM_BROADCASTER_STATUS.stop){this.signal&&this.signal.sendBroadcasterStatus(i.getSeq(),this.sessionId,1),this.broadcasterStatus=i.ENUM_BROADCASTER_STATUS.start;break}}if(this.setPlayQualityTimer(),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_ICE_CONNECTION_STATE_CHANGE+" "+this.streamId+" stateNego:iceConnected"),this.isPeer&&(this.peerFailCount=0),0==this.firstFrameTime){this.firstFrameTime=(new Date).getTime()-this.beginTime;var r=i.getReportSeq();this.dataReport.newReport(r,a.ZegoRTCLogEvent.kZegoTaskPlayDecodeFirstVideoFrame.event),this.dataReport.addMsgInfo(r,{session_id:a.ZegoRTCLogEvent.kZegoTaskPlayDecodeFirstVideoFrame.session_id(this.sessionId),fft_consumed:a.ZegoRTCLogEvent.kZegoTaskPlayDecodeFirstVideoFrame.fft_consumed(this.firstFrameTime)}),this.dataReport.uploadReport(r)}}else"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.stateNego=i.ENUM_PLAY_STATE_NEGO.iceDisconnected,this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState))},e.prototype.checkPlayConnectionFailedState=function(e){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_ICE_CONNECTION_STATE_CHANGE+"  state "+this.state+" connectionState "+e),this.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kMediaConnectionError)},e.prototype.clearPlayQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,videoPacketsReceived:0,audioPacketsReceived:0,framesDecoded:0,framesDropped:0,framesReceived:0,audioBitrate:0}},e.prototype.resetPlay=function(){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_RESET_PLAY+" "+this.streamId+" call"),this.state=i.ENUM_PLAY_STATE.stop,this.playEvent=!1,this.isRecvClientInfo=!1,null!=this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.probeTimer&&(clearTimeout(this.probeTimer),this.probeTimer=null),this.clearPlayQualityTimer(),this.signal&&(this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId),this.signal.unregisterPushCallback("SessionResetPush",this.sessionId),this.signal.unregisterPushCallback("PublishEventPush",this.sessionId),this.signal.unregisterPushCallback("ClientInfoPush",this.sessionId),this.signal.unregisterPushCallback("NetQualityProbeRsp",this.sessionId),this.signal.unregisterPushCallback("NetQualityInfoPush",this.sessionId)),this.sessionSeq=0,this.answerSeq=0,this.videoSizeCallback=!1,this.stopSoundLevel()},e.prototype.setPlayQualityTimer=function(){var e=this;null==this.qualityTimer&&(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_SET_PLAYER_QUALITY_TIMER+" "+this.streamId+" startTimer"),this.clearPlayQualityTimer(),this.qualityTimer=setInterval((function(){if(e.peerConnection){var t=[e.peerConnection.getStats(null)];"Chrome"==s.ClientUtil.getBrowser()&&t.push(new Promise((function(t,r){e.peerConnection.getStats((function(e){return t(e)}),(function(e){return r(e)}))}))),Promise.all(t).then((function(t){e.getPlayStats(t[0],t[1])})).catch((function(t){e.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_SET_PLAYER_QUALITY_TIMER+" "+e.streamId+" getStats error "+t.toString())}))}}),this.qualityTimeInterval),this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:(new Date).getTime(),audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,videoPacketsReceived:0,audioPacketsReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0})},e.prototype.getPlayStats=function(e,t){var r=this;if(null!=e){for(var o,a=document.querySelectorAll("video, audio"),c=0;c<a.length;c++)a[c].srcObject===this.playStream&&(o=a[c]);var d={audioFractionLost:0,audioPacketsLost:0,audioPacketsLostRate:0,audioBitrate:0,audioLevel:0,audioSendLevel:0,audioSamplingRate:0,audioCodec:"opus",audioQuality:0,audioFPS:0,videoQuality:0,videoPacketsLost:0,videoPacketsLostRate:0,videoBitrate:0,videoFPS:0,playData:0,nackCount:0,pliCount:0,audioJitter:0,videoFractionLost:0,videoFramesDecoded:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,videoFramesDropped:0,totalRoundTripTime:0,currentRoundTripTime:0,googBandwidthLimitedResolution:void 0,videoCodecName:"",audioCodecName:"",googCpuLimitedResolution:void 0,googAvailableSendBandwidth:0,audioMuteState:this.playStream&&this.playStream.getAudioTracks().length>0&&this.playStream.getAudioTracks()[0].enabled?"0":"1",videoMuteState:this.playStream&&this.playStream.getVideoTracks().length>0&&this.playStream.getVideoTracks()[0].enabled?"0":"1",muted:o?o.muted:void 0,paused:o?o.paused:void 0,volume:o?o.volume:void 0,sinkId:o?o.sinkId:void 0},l=this.lastPlayStats.time,u=0,p=0,h=0,g=0,m=0;e.forEach((function(e){if(("inbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesReceived)&&("audio"==e.mediaType||e.id.indexOf("AudioStream")>=0)){if(0!=l)d.audioBitrate=8*(e.bytesReceived-r.lastPlayStats.audioBytesReceived)/(e.timestamp-l),(i=e.packetsLost-r.lastPlayStats.audioPacketsLost)>0&&(p=i/(i+e.packetsReceived-r.lastPlayStats.audioPacketsReceived));d.audioBitrate<0&&(d.audioBitrate=0),d.audioJitter=e.jitter,e.packetsLost>0&&(d.audioPacketsLost=e.packetsLost),d.audioFractionLost=e.fractionLost;var t=e.packetsLost-r.lastPlayStats.audioPacketsLost;d.audioFPS=(e.packetsReceived-r.lastPlayStats.audioPacketsReceived)/(e.timestamp-l)*1e3,d.audioPacketsLostRate=t>0?t/(e.packetsReceived-r.lastPlayStats.audioPacketsReceived+t):0,r.lastPlayStats.audioBytesReceived=e.bytesReceived,e.packetsLost>0&&(r.lastPlayStats.audioPacketsLost=e.packetsLost),r.lastPlayStats.audioPacketsReceived=e.packetsReceived,r.lastPlayStats.audioTime=e.timestamp,r.lastPlayStats.time=e.timestamp,r.lastPlayStats.audioBitrate=d.audioBitrate,g=e.jitter}else if(("inbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesReceived)&&("video"==e.mediaType||e.id.indexOf("VideoStream")>=0)){var i;if(0!=l)d.videoBitrate=8*(e.bytesReceived-r.lastPlayStats.videoBytesReceived)/(e.timestamp-l),d.videoFPS=1e3*(e.framesDecoded-r.lastPlayStats.framesDecoded)/(e.timestamp-l),(i=e.packetsLost-r.lastPlayStats.videoPacketsLost)>0&&(h=i/(i+e.packetsReceived-r.lastPlayStats.videoPacketsReceived));d.videoBitrate<0&&(d.videoBitrate=0),d.videoFPS<0&&(d.videoFPS=0),d.nackCount=e.nackCount,d.pliCount=e.pliCount,d.videoFractionLost=e.fractionLost,d.videoFramesDecoded=e.framesDecoded,e.packetsLost>0&&(d.videoPacketsLost=e.packetsLost);t=e.packetsLost-r.lastPlayStats.videoPacketsLost;d.videoPacketsLostRate=t>0?t/(e.packetsReceived-r.lastPlayStats.videoPacketsReceived+t):0,r.lastPlayStats.videoBytesReceived=e.bytesReceived,r.lastPlayStats.framesDecoded=e.framesDecoded,e.packetsLost>0&&(r.lastPlayStats.videoPacketsLost=e.packetsLost),r.lastPlayStats.videoPacketsReceived=e.packetsReceived,r.lastPlayStats.videoTime=e.timestamp,r.lastPlayStats.time=e.timestamp,m=e.jitter}else"track"==e.type&&("video"==e.kind||e.id.indexOf("video")>=0)||e.frameWidth?(d.frameHeight=e.frameHeight,d.frameWidth=e.frameWidth,0!=l&&(d.videoTransferFPS=1e3*(e.framesReceived-r.lastPlayStats.framesReceived)/(e.timestamp-l),d.videoFramesDropped=e.framesDropped-r.lastPlayStats.framesDropped),d.videoTransferFPS<0&&(d.videoTransferFPS=0),d.videoFramesDropped<0&&(d.videoFramesDropped=0),r.lastPlayStats.framesReceived=e.framesReceived,r.lastPlayStats.framesDropped=e.framesDropped):"track"==e.type&&("audio"==e.kind||e.id.indexOf("audio")>=0)?(d.audioLevel=e.audioLevel,d.audioSendLevel=e.totalAudioEnergy,d.audioSamplingRate=e.totalSamplesDuration):"candidate-pair"==e.type&&(null!=e.totalRoundTripTime&&(d.totalRoundTripTime=e.totalRoundTripTime),null!=e.currentRoundTripTime&&(d.currentRoundTripTime=e.currentRoundTripTime,u=1e3*d.currentRoundTripTime))})),t&&t.result().forEach((function(e){"ssrc"==e.type&&e.names().indexOf("googBandwidthLimitedResolution")>=0&&(d.googBandwidthLimitedResolution=e.stat("googBandwidthLimitedResolution")),"ssrc"==e.type&&e.names().indexOf("codecImplementationName")>=0&&(d.codecImplementationName=e.stat("codecImplementationName")),"ssrc"==e.type&&"video"==e.stat("mediaType")&&e.names().indexOf("googCodecName")>=0&&(d.videoCodecName=e.stat("googCodecName")),"ssrc"==e.type&&"audio"==e.stat("mediaType")&&e.names().indexOf("googCodecName")>=0&&(d.audioCodecName=e.stat("googCodecName")),"ssrc"==e.type&&e.names().indexOf("googCpuLimitedResolution")>=0&&(d.googCpuLimitedResolution=e.stat("googCpuLimitedResolution")),"VideoBwe"==e.type&&e.names().indexOf("googAvailableSendBandwidth")>=0&&(d.googAvailableSendBandwidth=e.stat("googAvailableSendBandwidth"))})),h=isNaN(h)||h<0?0:h,m=isNaN(m)||m<0?0:m,p=isNaN(p)||p<0?0:p,g=isNaN(g)||g<0?0:g;var E=s.ClientUtil.getNetQuality(u,h,m),f=s.ClientUtil.getNetQuality(u,p,g);d.audioQuality=l>0?s.ClientUtil.quality2QualityGrade(E):0,d.videoQuality=l>0?s.ClientUtil.quality2QualityGrade(f):0;var _=Math.min(E,f);this.netQuality=_,l>0&&_<=i.QUALITY_CONSTANT.MiddleMinQuality&&(new Date).getTime()>this.probeTime+this.probeInterval&&(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_SET_PLAYER_QUALITY_TIMER+" netQuality "+_+" start net probe"),this.probeState=i.ENUM_PROBE_STATE.tryProbe,this.streamCenter.startNetProbe(!1,this,this.gwNodeList),this.probeTime=(new Date).getTime()),this.uploadPlayQuality(d);var S={video:{videoBitrate:d.videoBitrate,videoFPS:d.videoFPS,videoTransferFPS:d.videoTransferFPS,videoFramesDecoded:d.videoFramesDecoded,videoFramesDropped:d.videoFramesDropped,videoPacketsLost:d.videoPacketsLost,videoPacketsLostRate:d.videoPacketsLostRate,videoQuality:d.videoQuality,frameHeight:d.frameHeight,frameWidth:d.frameWidth,muteState:d.videoMuteState},audio:{audioBitrate:d.audioBitrate,audioCodec:d.audioCodec,audioJitter:d.audioJitter,audioLevel:d.audioLevel,audioPacketsLost:d.audioPacketsLost,audioPacketsLostRate:d.audioPacketsLostRate,audioQuality:d.audioQuality,audioSamplingRate:d.audioSamplingRate,audioSendLevel:d.audioSendLevel,muteState:d.audioMuteState,audioFPS:d.audioFPS},nackCount:d.nackCount,pliCount:d.pliCount,totalRoundTripTime:d.totalRoundTripTime,playData:d.playData,currentRoundTripTime:d.currentRoundTripTime};void 0!==d.muted&&(S.muted=d.muted,S.paused=d.paused,S.volume=d.volume,S.sinkId=d.sinkId),void 0!==d.videoCodecName&&(S.video.googCodecName=d.videoCodecName,S.audio.googCodecName=d.audioCodecName,S.codecImplementationName=d.codecImplementationName,S.googAvailableSendBandwidth=d.googAvailableSendBandwidth),0!=l&&this.onPlayQualityUpdate(this.streamId,S)}},e.prototype.uploadPlayQuality=function(e){var t=this;if(this.qualityUpload){var r=Date.parse(new Date+"");(0==this.qualityUploadLastTime||r-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(e.stream_type="play",e.stream_id=this.streamId,e.timeStamp=r/1e3,this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_UPLOAD_PLAYER_QUALITY+" "+this.streamId+" upload"+JSON.stringify(e)),this.signal.QualityReport(i.getSeq(),this.sessionId,e,(function(e,r,i){void 0!==i.report&&(t.qualityUpload=i.report,t.qualityUploadInterval=i.report_interval_ms)}),(function(e,r){t.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_UPLOAD_PLAYER_QUALITY+" "+t.streamId+" upload failed "+e)})),this.qualityUploadLastTime=r)}},e.prototype.onRecvResetSession=function(e,t,r){if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_RESET_SESSION+" "+this.streamId+" received "),t==this.sessionId){this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=JSON.parse(JSON.stringify(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlaySessionClosedError));this.negoTimer&&clearTimeout(this.negoTimer),this.playStateUpdateError(i)}else this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_RESET_SESSION+" "+this.streamId+" cannot find session")},e.prototype.onRecvCloseSession=function(e,t,r){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_CLOSE_SESSION+" "+this.streamId+" "+JSON.stringify(r)),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=r.err_info?JSON.parse(r.err_info.toLowerCase()):{},o=i.action?i.action:null,s=1*r.reason,c=JSON.parse(JSON.stringify(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlaySessionClosedError));c.message+=" reason:"+s+" "+(o?" action:"+o:""),this.negoTimer&&clearTimeout(this.negoTimer);var d=![4,8,10,11,12,14,24,26,27,28].includes(s)&&![2,5,6].includes(o);this.playStateUpdateError(c,d)},e.prototype.onRecvStreamStatus=function(e){if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_STREAM_STATUS+" "+this.streamId+" call"),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_STREAM_STATUS+" "+this.streamId+" status camera_status: "+e.camera_status+" mic_status: "+e.mic_status),this.cameraStatus!==e.camera_status&&this.onRemoteCameraStatusUpdate(this.streamId,this.getCameraMicStatus(e.camera_status),e.camera_status),this.micStatus!==e.mic_status&&this.onRemoteMicStatusUpdate(this.streamId,this.getCameraMicStatus(e.mic_status),e.mic_status),this.cameraStatus=e.camera_status,this.micStatus=e.mic_status,"boolean"!=typeof this.playOption.video&&"boolean"!=typeof this.playOption.audio){var t=this.playStream;if(0!==e.camera_status&&t.getVideoTracks().forEach((function(e){e.enabled=!1,e.stop(),t.removeTrack(e)})),0==e.camera_status&&0==t.getVideoTracks().length&&t.addTrack(this.remoteStream.clone().getVideoTracks()[0]),"Safari"===s.ClientUtil.getBrowser())for(var r=document.querySelectorAll("video, audio"),i=0;i<r.length;i++)r[i].srcObject===this.playStream&&(r[i].srcObject=this.playStream);this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_STREAM_STATUS+" "+this.streamId+" call success")}else this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_RECV_STREAM_STATUS+" "+this.streamId+" has set playType, ignore stream status")},e.prototype.onGotRemoteStream=function(e){var t=this;this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_GOT_REMOTE_STREAM+" "+this.streamId+" called "+e),e?(this.playStream?(this.playStream.getTracks().forEach((function(e){return t.playStream.removeTrack(e)})),e.clone().getTracks().forEach((function(e){return t.playStream.addTrack(e)}))):this.playStream=e.clone(),this.remoteStream=e,this.getRemoteStreamSuc(this.playStream),this.gotStreamStatus&&this.onRecvStreamStatus(this.streamStatus),this.dataReport.addEvent(this.reportSeq,"GetRemoteStream"),this.streamCenter.soundLevelDelegate&&this.startSoundLevel()):this.logger.warn(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_GOT_REMOTE_STREAM+" "+this.streamId+" remote stream is empty")},e.prototype.sendCandidateInfo=function(e){var t=this;this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_SEND_CANDIDATE_INFO+" "+this.streamId+" called"),!(e=e.filter((function(e){return!(e.candidate.indexOf("tcp")>0)&&(!!e.candidate||void 0)})))||e.length<1?this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_SEND_CANDIDATE_INFO+" "+this.streamId+" cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.dataReport.eventStart(this.streamReportSeq,"SendIceCandidate"),this.stateNego!==i.ENUM_PLAY_STATE_NEGO.iceConnected&&(this.stateNego=i.ENUM_PLAY_STATE_NEGO.sendCandidate),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_SEND_CANDIDATE_INFO+" "+this.streamId+" stateNego:sendCandidate"),this.signal.sendCandidateInfo(i.getSeq(),this.sessionId,e,(function(e,r,i){t.logger.debug(n.ZEGO_WEBRTC_ACTION.PLAYER_SEND_CANDIDATE_INFO+" "+t.streamId+" send success"),t.dataReport.eventEnd(t.reportSeq,"SendIceCandidate"),t.dataReport.eventEnd(t.streamReportSeq,"SendIceCandidate")}),(function(e,r){t.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_SEND_CANDIDATE_INFO+" "+t.streamId+" failed to send: "+e.toString()),t.dataReport.eventEndWithMsg(t.reportSeq,"SendIceCandidate",{error:e}),t.dataReport.eventEndWithMsg(t.streamReportSeq,"SendIceCandidate",{error:e}),t.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kCandidateError)})))},e.prototype.shouldSendCloseSession=function(){return this.state!=i.ENUM_PLAY_STATE_UPDATE.stop&&this.state!=i.ENUM_PLAY_STATE.waitingSessionRsp},e.prototype.playStateUpdateError=function(e,t){this.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_STATE_ERROR+" call ",this.streamId,JSON.stringify(e)),this.isProbe?this.onCalNetQualityResult(1):this.streamId&&this.onPlayStateUpdate(i.ENUM_PLAY_STATE_UPDATE.error,this.streamId,e,t),this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_STATE_ERROR+" "+this.streamId+" ended")},e.prototype.getCameraMicStatus=function(e){return 0==e?"OPEN":"MUTE"},e.prototype.onPlayStateUpdate=function(e,t,r,i){},e.prototype.onPlayQualityUpdate=function(e,t){},e.prototype.onRemoteCameraStatusUpdate=function(e,t,r){},e.prototype.onRemoteMicStatusUpdate=function(e,t,r){},e.prototype.stopPlay=function(){for(var e in this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_STOP_PLAY+" "+this.streamId+" called"),this.streamCenter.publisherList){if(this.streamCenter.publisherList[e].publisher.state==i.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==i.ENUM_BROADCASTER_STATUS.start){this.signal&&this.signal.sendBroadcasterStatus(i.getSeq(),this.sessionId,0),this.broadcasterStatus=i.ENUM_BROADCASTER_STATUS.stop;break}}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(i.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.streamReportSeq,"PlayState",{state:this.state+""}),this.dataReport.addEvent(this.streamReportSeq,"StopPlay"),this.dataReport.addMsgExt(this.streamReportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.addMsgInfo(this.streamReportSeq,{itemtype:"RTCPlayStream"}),this.dataReport.uploadReport(this.streamReportSeq,"RTCPlayStream"),this.resetPlay()},e.prototype.onDisconnect=function(){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_ON_DISCONNECT+" "+this.streamId+" call"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.playStateUpdateError(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kWebsocketDisconnectedError)},e.prototype.startSoundLevel=function(){var e=this;if(this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_START_SOUND_LEVEL+" call streamID: "+this.streamId),!this.isProbe)if(this.remoteStream&&0!=this.remoteStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null);try{this.mic=this.ac.createMediaStreamSource(this.remoteStream),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(t){for(var r=t.inputBuffer.getChannelData(0),i=0,o=0;o<r.length;o++)i<r[o]&&(i=r[o]);e.soundLevel=100*i},this.ac.resume()}catch(e){this.logger.error(n.ZEGO_WEBRTC_ACTION.PLAYER_START_SOUND_LEVEL+" get sound level failed "+e)}}else this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_START_SOUND_LEVEL+" "+this.streamId+" remote stream no found")},e.prototype.stopSoundLevel=function(){this.logger.info(n.ZEGO_WEBRTC_ACTION.PLAYER_STOP_SOUND_LEVEL+" call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.script=null,this.mic=null},e.prototype.onCalNetQualityResult=function(e,t){},e}();t.ZegoPlayWeb=c},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.RetryStreamHandler=void 0;var s=r(0),a=r(9),n=r(1),c=r(3),d=r(2),l=function(e){function t(t,r,i){var o=e.call(this)||this;return o.logger=t,o.stateCenter=r,o.streamCenter=i,o}return o(t,e),t.prototype.initStream=function(e,t,r){this.isPublish=e,this.streamID=t,this.serverUrls=r},t.prototype.activePublish=function(e){var t=this;if(this.logger.info("zc.tsh.a retry call "+this.streamID),this.stateCenter.networkState==s.ENUM_NETWORK_STATE.offline)return this.logger.info("zc.tsh.a network is broken, stop retry"),!1;if(this.retryTimer)return this.logger.info("zc.tsh.a has active, ignore"),!1;if(this.isOverTime)return this.logger.warn("zc.tsh.a retry over time, stop retry"),!1;if(1==this.retryActiveCount)this.retryActiveInterval=Math.floor(Math.random()*(1-this.RETRY_START_TIME_INTERVAL)+this.RETRY_START_TIME_INTERVAL);else{var r=Math.pow(2,Math.round(this.retryActiveCount/this.RETRY_CONTINUE_COUNT+1));this.retryActiveInterval=r>this.RETRY_MAX_TIME_INTERVAL?this.RETRY_MAX_TIME_INTERVAL:r}var i=this.streamCenter.publisherList[this.streamID].publisher,o=this.serverUrls,a=i.signal?i.signal.server:"";o.forEach((function(e,r){return r<=o.indexOf(a)&&t.serverUrls.push(e)})),o.splice(0,o.indexOf(a)+1);var n=this.serverUrls[this.retryActiveCount%this.serverUrls.length==0?this.serverUrls.length-1:this.retryActiveCount%this.serverUrls.length-1];return this.retryTimer=setTimeout((function(){t.logger.warn("zc.tsh.a stream "+t.streamID+" connect signal server "+n),t.retryTimer&&clearTimeout(t.retryTimer),t.retryTimer=null,t.retryActiveCount++,t.streamCenter.connectPublishServer(t.streamID,n)}),"number"==typeof e?e:1e3*this.retryActiveInterval),this.logger.info("zc.tsh.a call success"),!0},t.prototype.activePull=function(e,t){var r=this;if(this.logger.info("zc.tsh.a retry call "+this.streamID),t&&(this.playStreamSuccess=t),this.stateCenter.networkState==s.ENUM_NETWORK_STATE.offline)return this.logger.info("zc.tsh.a network is broken, stop retry"),!1;if(this.retryTimer)return this.logger.info("zc.tsh.a has active, ignore"),!1;if(this.isOverTime)return this.logger.warn("zc.tsh.a retry over time, stop retry"),!1;if(1==this.retryActiveCount)this.retryActiveInterval=Math.floor(Math.random()*(1-this.RETRY_START_TIME_INTERVAL)+this.RETRY_START_TIME_INTERVAL);else{var i=Math.pow(2,Math.round(this.retryActiveCount/this.RETRY_CONTINUE_COUNT+1));this.retryActiveInterval=i>this.RETRY_MAX_TIME_INTERVAL?this.RETRY_MAX_TIME_INTERVAL:i}var o=this.streamCenter.playerList[this.streamID].player,a=this.serverUrls,n=o.signal?o.signal.server:"";a.forEach((function(e,t){return t<=a.indexOf(n)&&r.serverUrls.push(e)})),a.splice(0,a.indexOf(n)+1);var c=this.serverUrls[this.retryActiveCount%this.serverUrls.length==0?this.serverUrls.length-1:this.retryActiveCount%this.serverUrls.length-1];return this.retryTimer=setTimeout((function(){r.logger.warn("zc.tsh.a stream "+r.streamID+" connect signal server "+c),r.retryTimer&&clearTimeout(r.retryTimer),r.retryTimer=null,r.retryActiveCount++,r.streamCenter.connectPlayServer(r.streamID,r.playStreamSuccess,c)}),"number"==typeof e?e:1e3*this.retryActiveInterval),this.logger.info("zc.tsh.a call success"),!0},t.prototype.startMaxTime=function(){var e=this;this.maxTimer||(this.maxTimer=setTimeout((function(){if(e.logger.warn(e.streamID+" over max time "+e.RETRY_MAX_TIME+"s, stop retry"),e.isOverTime=!0,e.invalid(),e.isPublish){if(!e.streamCenter.publisherList[e.streamID])return void e.logger.info("zc.tsh.smt streamID "+e.streamID+" publish no found");e.publishStateHandle(s.ENUM_PUBLISH_STATE_UPDATE.error,e.streamID,n.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishRetryTimeoutError,!0)}else{if(!e.streamCenter.playerList[e.streamID])return void e.logger.info("zc.tsh.smt streamID "+e.streamID+" play no found");e.playStateHandle(s.ENUM_PLAY_STATE_UPDATE.error,e.streamID,n.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayRetryTimeoutError,!0)}}),1e3*this.RETRY_MAX_TIME))},t.prototype.stopMaxTime=function(){this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},t.prototype.onactive=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},t.prototype.retryNextSignal=function(e){if(this.stateCenter.networkState==s.ENUM_NETWORK_STATE.offline)return!0;if(this.isPublish){var t=this.streamCenter.publisherList[this.streamID];if(t.publisher.state==s.ENUM_PUBLISH_STATE.stop&&[n.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kSessionTimeoutError.code,n.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishNegoTimeoutError.code].includes(e.code))return!0;if(t.isCenterNode&&t.publisher.signal&&t.publisher.signal.websocket&&1==t.publisher.signal.websocket.readyState)return!1;if(!t.isCenterNode&&[n.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishSessionClosedError].includes(e)){var r=(o=e.message.match(/reason:(\d+)/))?o[1]:"";return!["26"].includes(r)}return!0}var i=this.streamCenter.playerList[this.streamID];if(i.player.state==s.ENUM_PLAY_STATE.stop&&[n.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kSessionTimeoutError.code,n.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayNegoTimeoutError.code].includes(e.code))return!0;if(i.isCenterNode&&i.player.signal&&i.player.signal.websocket&&1==i.player.signal.websocket.readyState)return!1;if(!i.isCenterNode&&[n.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlaySessionClosedError].includes(e)){var o;r=(o=e.message.match(/reason:(\d+)/))?o[1]:"";return!["24","26","28"].includes(r)}return!0},t.prototype.publishStateHandle=function(e,t,r,i){this.logger.info(c.ZEGO_WEBRTC_ACTION.PUBLISH_STATE_HANDLE+" call "+t+" "+(r?r.code+"":""));var o=i||this.RETRY_MAX_TIME<3;if(!o&&r&&d.ClientUtil.isReDispatch(r))return this.stopMaxTime(),this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=null,void this.streamCenter.onPublishStateUpdate(e,t,r);if(!o&&r&&0!==r.code){!this.maxTimer&&!o&&this.startMaxTime(),this.stateCenter.publishStreamList[t].state=s.ENUM_PUBLISH_STREAM_STATE.retryPublish;var a=this.streamCenter.publisherList[t],l=a.publisher,u=l.localStream,p=l.videoInfo,h=l.mediaStreamConfig,g=l.publishOption;if(0!=l.sessionId&&l.signal&&l.shouldSendCloseSession()&&(l.signal.sendCloseSession(s.getSeq(),l.sessionId,1),l.signal.removeSession(l.sessionId),l.closeSessionSignal=!0),l.resetPublish(),!o&&!this.retryNextSignal(r)){if(a.isCenterNode&&l.gwNodeTTL<(new Date).getTime()&&0!==l.gwNodeList.length)l.gwNode="",l.gwNodeList=[],l.gwNodeTTL=0;else if(a.isCenterNode){var m=l.gwNodeList.findIndex((function(e){return e==l.gwNode}));l.gwNode=l.gwNodeList[++m%l.gwNodeList.length]}return void setTimeout((function(){l.startPublish(t,u,p,h,g)}),3e3)}this.streamCenter.removeStreamFromSignal(!0,t)}if(o)return this.stopMaxTime(),this.invalid(),void this.streamCenter.onPublishStateUpdate(e,t,r);if(r&&0!==r.code&&this.activePublish(void 0)){var E=s.getReportSeq();this.streamCenter.dataReport.newReport(E),this.streamCenter.dataReport.addMsgInfo(E,{stream:n.ZegoRTCLogEvent.kZegoTaskRePublish.stream(this.streamID)}),this.streamCenter.dataReport.uploadReport(E,n.ZegoRTCLogEvent.kZegoTaskRePublish.event),this.streamCenter.onPublishStateUpdate(2,t,r)}this.logger.info(c.ZEGO_WEBRTC_ACTION.PUBLISH_STATE_HANDLE+" end "+t)},t.prototype.playStateHandle=function(e,t,r,i){this.logger.info(c.ZEGO_WEBRTC_ACTION.PLAY_STATE_HANDLE+" call "+t+" "+(r?r.code+"":""));var o=i||this.RETRY_MAX_TIME<3;if(!o&&r&&d.ClientUtil.isReDispatch(r))return this.stopMaxTime(),this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=null,void this.streamCenter.onPlayStateUpdate(e,t,r);if(r&&0!==r.code){!this.maxTimer&&!o&&this.startMaxTime();var a=this.streamCenter.playerList[t],l=a.player,u=l.playOption;if(0!=l.sessionId&&l.signal&&l.shouldSendCloseSession()&&(l.signal.sendCloseSession(s.getSeq(),l.sessionId,1),l.signal.removeSession(l.sessionId),l.closeSessionSignal=!0),l.resetPlay(),!o&&!this.retryNextSignal(r)){if(a.isCenterNode&&l.gwNodeTTL<(new Date).getTime()&&0!==l.gwNodeList.length)l.gwNode="",l.gwNodeList=[],l.gwNodeTTL=0;else if(a.isCenterNode){var p=l.gwNodeList.findIndex((function(e){return e==l.gwNode}));l.gwNode=l.gwNodeList[++p%l.gwNodeList.length]}return void setTimeout((function(){l.startPlay(t,l.getRemoteStreamSuc,u)}),3e3)}this.streamCenter.removeStreamFromSignal(!1,t)}if(o)return this.stopMaxTime(),this.invalid(),void this.streamCenter.onPlayStateUpdate(e,t,r);if(r&&0!==r.code&&this.activePull(void 0)){var h=s.getReportSeq();this.streamCenter.dataReport.newReport(h),this.streamCenter.dataReport.addMsgInfo(h,{stream:n.ZegoRTCLogEvent.kZegoTaskRePlay.stream(this.streamID)}),this.streamCenter.dataReport.uploadReport(h,n.ZegoRTCLogEvent.kZegoTaskRePlay.event),this.streamCenter.onPlayStateUpdate(2,t,r)}this.logger.info(c.ZEGO_WEBRTC_ACTION.PLAY_STATE_HANDLE+" end "+t)},t}(a.RetryHandler);t.RetryStreamHandler=l},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.RetryDispatchHandler=void 0;var s=r(9),a=r(0),n=r(3),c=r(1),d=r(4),l=function(e){function t(t,r,i,o){var s=e.call(this)||this;return s.retryActiveCount=1,s.RETRY_MAX_TIME=90,s.logger=t,s.stateCenter=r,s.rtm=i,s.streamCenter=o,s}return o(t,e),t.prototype.initStream=function(e,t,r){this.streamID=e,this.playOption=t,this.isPublish=r},t.prototype.active=function(e){var t=this;if(this.logger.info(n.ZEGO_WEBRTC_ACTION.RDH_ACTIVE+" retry call "+this.streamID),this.stateCenter.networkState==a.ENUM_NETWORK_STATE.offline)return this.logger.info(n.ZEGO_WEBRTC_ACTION.RDH_ACTIVE+" network is broken, stop retry"),!1;if(this.retryTimer)return this.logger.info(n.ZEGO_WEBRTC_ACTION.RDH_ACTIVE+" has active, ignore"),!1;if(this.isOverTime)return this.logger.warn(n.ZEGO_WEBRTC_ACTION.RDH_ACTIVE+" retry over time, stop retry"),!1;this.rtm.isLogin()||(this.stopMaxTime(),this.invalid(),this.isPublish?this.streamCenter.publisherList[this.streamID].isReDispatch=!0:this.streamCenter.playerList[this.streamID].isReDispatch=!0);var r=this.retryActiveCount-1,i=this.playOption&&2==this.playOption.resourceMode?1:0,o={stream_id:this.streamID,ptype:this.isPublish?"push":"pull",signals:this.streamCenter.getAllInUseUrl(),header_kvs:[{key:"grpc-metadata-push",value:this.playOption&&this.playOption.cdnUrl||""}],retry:r,center_ability:!0,dispatch_type:i};return this.retryTimer=setTimeout((function(){t.retryTimer&&clearTimeout(t.retryTimer),t.retryTimer=null,t.retryActiveCount++;var e=t.rtm.modules.service.sendMessage("webrtc_url",o,(function(e,r){t.handleFetchWebRtcUrlRsp(e)}),(function(e,r){t.handleFetchWebRtcUrlRsp(e)}));t.isPublish&&e?t.streamCenter.publisherList[t.streamID]&&(t.streamCenter.publisherList[t.streamID].seq=e):e&&t.streamCenter.playerList[t.streamID]&&(t.streamCenter.playerList[t.streamID].seq=e)}),"number"==typeof e?e:1e3*this.retryActiveInterval),this.logger.info(n.ZEGO_WEBRTC_ACTION.RDH_ACTIVE+" call success"),!0},t.prototype.startMaxTime=function(){var e=this;this.maxTimer||(this.maxTimer=setTimeout((function(){e.logger.warn(n.ZEGO_WEBRTC_ACTION.RDH_MAX_TIME+" "+e.streamID+" dispatch over max time "+e.RETRY_MAX_TIME+"s stop retry"),e.isOverTime=!0,e.invalid(),e.isPublish?e.streamCenter.onPublishStateUpdate(a.ENUM_PUBLISH_STATE_UPDATE.error,e.streamID,c.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishDispatchError):e.streamCenter.onPlayStateUpdate(a.ENUM_PLAY_STATE_UPDATE.error,e.streamID,c.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayDispatchError)}),1e3*this.RETRY_MAX_TIME))},t.prototype.stopMaxTime=function(){this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},t.prototype.onactive=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},t.prototype.handleFetchWebRtcUrlRsp=function(e){if(e.code&&[d.errorCodeList.TIMEOUT.code].includes(e.code))this.active();else{if(e.code&&[d.errorCodeList.SOCKET_CLOSE.code].includes(e.code))return this.stopMaxTime(),this.invalid(),void(this.isPublish?this.streamCenter.publisherList[this.streamID].isReDispatch=!0:this.streamCenter.playerList[this.streamID].isReDispatch=!0);var t=e,r=t.body.stream_id,i=!1;if(this.isPublish&&(!this.streamCenter.publisherList[r]||t.header.seq!==this.streamCenter.publisherList[this.streamID].seq))return this.logger.warn(n.ZEGO_WEBRTC_ACTION.RDH_WEBRTC_URL_RSP+" seq is not match, ignore "+this.streamID),this.stopMaxTime(),void this.invalid();if(!(this.isPublish||this.streamCenter.playerList[this.streamID]&&t.header.seq===this.streamCenter.playerList[this.streamID].seq))return this.logger.warn(n.ZEGO_WEBRTC_ACTION.RDH_WEBRTC_URL_RSP+" seq is not match, ignore "+this.streamID),this.stopMaxTime(),void this.invalid();if(this.stateCenter.clientIP=t.body.clientip||"",0!==t.body.err_code&&2==t.body.need_action)return this.retryActiveInterval=t.body.action_delay/1e3||Math.floor(3*Math.random())+3,void this.active();if(0!==t.body.err_code&&1!==t.body.need_action)return this.retryActiveInterval=Math.floor(3*Math.random())+3,void this.active();if(this.stopMaxTime(),this.invalid(),t.body.urls&&Array.isArray(t.body.urls)&&t.body.urls.length>0?i=!0:this.logger.error(n.ZEGO_WEBRTC_ACTION.RDH_WEBRTC_URL_RSP+" signal url is empty"),"push"===t.body.ptype&&this.streamCenter.publisherList[r]){if(!i)return void this.streamCenter.onPublishStateUpdate(a.ENUM_PUBLISH_STATE_UPDATE.error,r,c.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishDispatchError);var o=this.streamCenter.publisherList[r];this.stateCenter.publishStreamList[r]?(o.ttl=t.body.hosts_ttl?(new Date).getTime()+1e3*t.body.hosts_ttl:0,o.isCenterNode="boolean"==typeof t.body.is_center_node&&t.body.is_center_node,o.serverUrls=t.body.urls,this.streamCenter.startPublishingStream(r)):this.logger.error(n.ZEGO_WEBRTC_ACTION.RDH_WEBRTC_URL_RSP+" no streamid to publish")}else if("pull"==t.body.ptype&&this.streamCenter.playerList[r]){if(!i)return void this.streamCenter.onPlayStateUpdate(a.ENUM_PLAY_STATE_UPDATE.error,r,c.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayDispatchError);var s=this.streamCenter.playerList[r];s.ttl=t.body.hosts_ttl?(new Date).getTime()+1e3*t.body.hosts_ttl:0,s.isCenterNode="boolean"==typeof t.body.is_center_node&&t.body.is_center_node,s.serverUrls=t.body.urls,this.streamCenter.startPlayingStream(r,this.streamCenter.playSuccessCallBackList[r])}}},t}(s.RetryHandler);t.RetryDispatchHandler=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PublishModule=void 0;var i=r(3),o=r(0),s=r(1),a=r(2),n=r(4),c=r(7),d=r(6),l=function(){function e(e,t,r,i,o,s){this.logger=e,this.dataReport=t,this.stateCenter=r,this.streamCenter=i,this.streamHandler=o,this.rtm=s}return e.prototype.createStream=function(e){var t=this;return this.logger.info(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" call"),e&&e.camera&&e.camera.audioBitRate&&(e.camera.audioBitrate=e.camera.audioBitRate),e&&e.camera&&e.camera.bitrate&&(e.camera.bitRate=e.camera.bitrate),e&&e.screen&&"object"==typeof e.screen&&e.screen.bitrate&&(e.screen.bitRate=e.screen.bitrate),e&&e.custom&&e.custom.bitrate&&(e.custom.bitRate=e.custom.bitrate),new Promise((function(r,n){var c=o.getReportSeq();t.dataReport.newReport(c,s.ZegoRTCLogEvent.kZegoTaskCreateStream.event);var l=function(e){if(0==e.getAudioTracks().length){var i=t.streamCenter.ac.createMediaStreamDestination(),o=i?i.stream:null,s=o?o.getAudioTracks()[0]:null;s&&e.addTrack(s)}t.dataReport.uploadReport(c),!t.stateCenter.deviceInfos&&t.recordDevices(),r(e)},u=function(e,r){void 0===r&&(r=""),t.dataReport.addMsgInfo(c,{error:e.code,message:e.message+r}),t.dataReport.uploadReport(c),n({code:e.code,msg:e.message+r})};if("https:"!==window.location.protocol&&"file:"!==window.location.protocol&&-1==window.location.hostname.indexOf("127.0.0.1")&&-1==window.location.hostname.indexOf("localhost"))return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" https or localhost required "),void u({code:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kBrowserNotSupportError.code,message:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kBrowserNotSupportError.message+" https or localhost required"});if(e&&e.screen){if(!a.ClientUtil.checkScreenParams(e.screen,u))return;var p=a.ClientUtil.getBrowser(),h=t.streamCenter.getScreenConstrains(e.screen);t.dataReport.addMsgInfo(c,{stream_type:s.ZegoRTCLogEvent.kZegoTaskCreateStream.stream_type("screen"),screen:s.ZegoRTCLogEvent.kZegoTaskCreateStream.screen(h)});var g=function(e){t.streamCenter.createScreenPreviewer(e,h)&&l(e),e.getVideoTracks()[0].onended=function(){var r=o.getReportSeq();t.dataReport.newReport(r),t.dataReport.uploadReport(r,s.ZegoRTCLogEvent.kZegoTaskScreenSharingEnded),e&&t.stopPreview(e),t.stateCenter.actionListener("screenSharingEnded",e)}};"Firefox"==p||"object"==typeof e.screen&&"firefox"==e.screen.type?t.startScreenShotFirFox("screen",h,(function(e,t,r){e?t&&g(t):r&&u(r)})):"Chrome"==p&&d.ZegoWebRTC.screenShotReady||"object"==typeof e.screen&&"shot"==e.screen.type?t.startScreenShotChrome((function(r,o,a){r?(t.logger.info(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" using extension"),o&&g(o)):(a&&t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" extension "+a),"SS_DIALOG_CANCEL"===a||"object"==typeof e.screen&&"shot"==e.screen.type?a&&u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenCancelError):t.startScreenSharing(h,(function(e,r,o){e?r&&g(r):(t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" "+o),o&&u(o))})))})):t.startScreenSharing(h,(function(e,t,r){e?t&&g(t):r&&u(r)}))}else{if(e&&"object"==typeof e.camera&&void 0!==e.camera.videoQuality&&!a.ClientUtil.checkInteger(e.camera.videoQuality))return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" videoQuality must be integer number"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," videoQuality must be integer number");if(e&&e.camera&&e.camera.audioBitrate){if(!a.ClientUtil.checkInteger(e.camera.audioBitrate))return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" audioBitrate must be integer number"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," audioBitrate must be integer number");if(e.camera.audioBitrate<6)return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" audioBitrate cannot less 6 kbps"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," audioBitrate cannot less 6 kbps");if(e.camera.audioBitrate>510)return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" audioBitrate cannot greater than 510 kbps"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," audioBitrate cannot greater than 510 kbps");t.stateCenter.audioBitRate=1e3*e.camera.audioBitrate}if(e&&e.camera&&e.camera.bitRate){if("number"!=typeof e.camera.bitRate)return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" bitrate must be integer number"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate must be integer number");if(e.camera.bitRate>10240)return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" bitrate cannot greater than 10 Mbps"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate cannot greater than 10 Mbps")}if(e&&e.camera&&void 0!==e.camera.channelCount&&!a.ClientUtil.checkInteger(e.camera.channelCount))return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" channelCount must be integer number"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," channelCount must be integer number");if(e&&e.camera&&4===e.camera.videoQuality&&!a.ClientUtil.checkCameraParams(e.camera,u))return;if(e&&e.custom&&e.custom.bitRate){if(!a.ClientUtil.checkInteger(e.custom.bitRate))return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" bitrate must be integer number"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate must be integer number");if(e.custom.bitRate>10240)return t.logger.error(i.ZEGO_WEBRTC_ACTION.CREATE_STREAM+" bitrate cannot greater than 10 Mbps"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," bitrate cannot greater than 10 Mbps")}if(e&&e.custom&&e.custom.audioBitrate){if(!a.ClientUtil.checkInteger(e.custom.audioBitrate))return t.logger.error("ze.cs.0 audioBitrate must be integer number"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," audioBitrate must be integer number");if(e.custom.audioBitrate<6)return t.logger.error("ze.cs.0 audioBitrate cannot less 6 kbps"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," audioBitrate cannot less 6 kbps");if(e.custom.audioBitrate>510)return t.logger.error("ze.cs.0 audioBitrate cannot greater than 510 kbps"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," audioBitrate cannot greater than 510 kbps")}if(e&&e.custom&&void 0!==e.custom.channelCount&&1!==e.custom.channelCount&&2!==e.custom.channelCount)return t.logger.error("ze.cs.0 channelCount must number 1 or 2"),void u(s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kParamError," channelCount must number 1 or 2");var m={};e&&e.camera?(m=e.camera,t.dataReport.addMsgInfo(c,{stream_type:s.ZegoRTCLogEvent.kZegoTaskCreateStream.stream_type("camera"),camera:s.ZegoRTCLogEvent.kZegoTaskCreateStream.camera(e.camera)}),"boolean"!=typeof m.video&&(m.video=!0),"boolean"!=typeof m.audio&&(m.audio=!0)):e&&e.custom&&(m=e.custom,t.dataReport.addMsgInfo(c,{stream_type:s.ZegoRTCLogEvent.kZegoTaskCreateStream.stream_type("custom"),custom:s.ZegoRTCLogEvent.kZegoTaskCreateStream.custom(e.custom)})),t.startPreview(m,l,u)}}))},e.prototype.destroyStream=function(e){this.logger.info(i.ZEGO_WEBRTC_ACTION.DESTROY_STREAM+" call");var t=o.getReportSeq();if(this.dataReport.newReport(t),!(e instanceof MediaStream))return this.logger.error(i.ZEGO_WEBRTC_ACTION.DESTROY_STREAM+" localStream is not mediaStream or tracks is null"),this.dataReport.addMsgInfo(t,s.ZegoRTCLogEvent.kZegoTaskDestroyStream.error.kLocalStreamError),void this.dataReport.uploadReport(t,s.ZegoRTCLogEvent.kZegoTaskDestroyStream.event);e instanceof MediaStream&&0==e.getTracks().length&&this.logger.info(i.ZEGO_WEBRTC_ACTION.DESTROY_STREAM+" tracks is null"),this.stopPreview(e),this.dataReport.uploadReport(t,s.ZegoRTCLogEvent.kZegoTaskDestroyStream.event)},e.prototype.startPublishingStream=function(e,t,r){this.logger.info(i.ZEGO_WEBRTC_ACTION.START_PUBLISHING_STREAM+" call ",e);var n,c=!0,d="",l=o.getReportSeq();if(this.stateCenter.reportSeqList.startPublish[e]=l,this.dataReport.newReport(l,s.ZegoRTCLogEvent.kZegoTaskPublishStart.event),c&&void 0===e&&(d="stream id required",this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+d),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError),!c||e&&"string"==typeof e||(d="stream id type wrong",this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PUBLISHING_STREAM+" "+d),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError),c&&e.length>o.MAX_STREAM_ID_LENGTH&&(d="stream id length limit",this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PUBLISHING_STREAM+" "+d),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError),c&&!a.ClientUtil.checkIllegalCharacters(e)&&(d="stream ID contains illegal characters",this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PUBLISHING_STREAM+" "+d),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError),c&&(!t||t instanceof MediaStream&&0==t.getTracks().length)&&(d="localStream wrong",this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PUBLISHING_STREAM+" "+d),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError),c&&!this.streamCenter.checkPreview(t)&&(d="stream is not from zego",this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PUBLISHING_STREAM+" "+d),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishNoPreviewError),c&&void 0!==r&&"object"!=typeof r&&(c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError,d="publishOption must be object"),c&&void 0!==r&&void 0!==r.streamParams&&"string"!=typeof r.streamParams&&(this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+" publishOption streamParams must be string"),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError,d=" publishOption streamParams must be string"),c&&void 0!==r&&void 0!==r.extraInfo&&"string"!=typeof r.extraInfo&&(this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+" publishOption extraInfo must be string"),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError,d=" publishOption extraInfo must be string"),c&&void 0!==r&&void 0!==r.videoCodec&&"string"!=typeof r.videoCodec&&(this.logger.error(i.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+" publishOption videoCodec must be string"),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishParamError,d=" publishOption videoCodec must be string"),r&&r.videoCodec&&(r.videoCodec=r.videoCodec.toUpperCase()),c&&this.rtm.modules.service.isDisConnect()&&(this.logger.error("zc.p.sps.1 not login"),c=!1,n=s.ZegoRTCLogEvent.kZegoTaskPublishStart.error.kPublishNoLoginError),!c)return this.dataReport.uploadReport(l,void 0,n,d),delete this.stateCenter.reportSeqList.startPublish[e],!1;if(r||(r={}),this.dataReport.addMsgInfo(l,{stream:s.ZegoRTCLogEvent.kZegoTaskPublishStart.stream(e),publishOption:s.ZegoRTCLogEvent.kZegoTaskPublishStart.publishOption(r)}),r.audioBitRate=this.stateCenter.audioBitRate,this.stateCenter.customUrl&&0!=this.stateCenter.customUrl.length)return this.stateCenter.publishStreamList[e]={state:o.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:r.extraInfo?r.extraInfo:null},this.streamCenter.setPublishStateStart(e,t,r)?(this.streamHandler.onPublishStateUpdate(o.ENUM_PUBLISH_STATE_UPDATE.retry,e,{code:0,message:""}),this.streamCenter.publisherList[e].serverUrls=this.stateCenter.customUrl,this.streamCenter.startPublishingStream(e)):(this.logger.info("zc.p.sps.1 cannot start publish"),!1);if(this.stateCenter.publishStreamList[e]={state:o.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:r.extraInfo?r.extraInfo:null},!this.streamCenter.setPublishStateStart(e,t,r))return this.logger.error("zc.p.sps.1 cannot start publish"),!1;this.logger.info("zc.p.sps.1 start publish"),this.streamHandler.onPublishStateUpdate(o.ENUM_PUBLISH_STATE_UPDATE.retry,e,{code:0,message:""});var u=this.streamCenter.publisherList[e].retryDispatchHandler;return u.stopMaxTime(),u.invalid(),u.initStream(e,r,!0),u.startMaxTime(),u.active(0)},e.prototype.stopPublishingStream=function(e){this.logger.info(i.ZEGO_WEBRTC_ACTION.STOP_PUBLISHING_STREAM+" call ",e);var t=o.getReportSeq();if(this.stateCenter.reportSeqList.stopPublish[e]=t,this.dataReport.newReport(t,s.ZegoRTCLogEvent.kZegoTaskPublishStop.event),this.dataReport.addMsgInfo(t,{streamID:s.ZegoRTCLogEvent.kZegoTaskPublishStop.stream(e)}),"string"!=typeof e||""==e)return this.logger.error(i.ZEGO_WEBRTC_ACTION.STOP_PUBLISHING_STREAM+" streamID must be string and not empty"),this.dataReport.uploadReport(t,void 0,s.ZegoRTCLogEvent.kZegoTaskPublishStop.error.kParamError,"stream id type error"),delete this.stateCenter.reportSeqList.stopPublish[e],!1;var r=this.streamCenter.publisherList[e],a=r&&r.publisher&&r.publisher.state!==o.ENUM_PUBLISH_STATE.stop;if(this.streamCenter.stopPublishingStream(e),this.stateCenter.publishStreamList[e]){if(this.stateCenter.publishStreamList[e].state>=o.ENUM_PUBLISH_STREAM_STATE.update_info){this.streamHandler.updateStreamInfo(e,o.ENUM_STREAM_SUB_CMD.liveEnd);for(var n=0;n<this.stateCenter.streamList.length;n++)if(this.stateCenter.streamList[n].stream_id==e){this.stateCenter.streamList.splice(n--,1);break}}delete this.stateCenter.publishStreamList[e]}return this.dataReport.uploadReport(t),a&&this.streamHandler.onPublishStateUpdate(o.ENUM_PUBLISH_STATE_UPDATE.error,e,{code:0,message:""}),!0},e.prototype.setCaptureVolume=function(e,t){var r=this;return new Promise((function(o){r.logger.info(i.ZEGO_WEBRTC_ACTION.PUBLISH_SET_CAPTURE_VOLUME+" call");var a=function(e){r.logger.error(i.ZEGO_WEBRTC_ACTION.PUBLISH_SET_CAPTURE_VOLUME+" "+e),o({errorCode:s.ZegoRTCLogEvent.kZegoSetCaptureVolume.error.kParamError.code,extendedData:JSON.stringify({fail_reason:s.ZegoRTCLogEvent.kZegoSetCaptureVolume.error.kParamError.message+" "+e})})},n=r.streamCenter.ac,c=r.streamCenter.checkPreview(e);if(e instanceof MediaStream&&c)if(0!=e.getAudioTracks().length)if("number"!=typeof t||t<0||t>100)a(" volume must be number between 0 to 100");else{if(c.gainNode)c.gainNode.gain.value=t/100;else{var d=n.createMediaStreamSource(e),l=n.createGain(),u=n.createMediaStreamDestination();d.connect(l),l.connect(u);var p=u.stream.getAudioTracks()[0];for(var h in r.streamCenter.publisherList){var g=r.streamCenter.publisherList[h];if(g.localStream==e){var m=g.publisher.peerConnection.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));m&&(m.replaceTrack(p),g.localStream.removeTrack(g.publisher.localStream.getAudioTracks()[0]),g.localStream.addTrack(p));break}}e.removeTrack(e.getAudioTracks()[0]),e.addTrack(p),c.gainNode=l,c.gainNode.gain.value=t/100}n.resume(),o({errorCode:0,extendedData:""}),r.logger.info(i.ZEGO_WEBRTC_ACTION.PUBLISH_SET_CAPTURE_VOLUME+" call success")}else a(" stream audioTrack no found");else a(" stream must be created by zego")}))},e.prototype.startScreenShotChrome=function(e){if(d.ZegoWebRTC.screenShotReady)window.postMessage({type:"SS_UI_REQUEST",text:"start"},"*"),a.ClientUtil.registerCallback("screenShare",{success:e},this.stateCenter.callbackList);else{var t='zc.b.ss Please install the extension:1. Go to chrome://extensions  2. Check: "Enable Developer mode   3. Click: "Load the unpacked extension... 4. Choose "extension" folder from the repository 5. Reload this page';this.logger.error(t),e(!1,null,{code:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenFailedError.code,message:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenFailedError.message+" "+t})}},e.prototype.startScreenSharing=function(e,t){var r=this;"getDisplayMedia"in navigator.mediaDevices?navigator.mediaDevices.getDisplayMedia({audio:e.audio,video:{frameRate:e.frameRate,width:e.width,height:e.height}}).then((function(e){t(!0,e)})).catch((function(e){r.logger.error("zc.b.sss "+e),e.message&&"permission denied"==e.message.toLowerCase()?t(!1,null,s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenCancelError):t(!1,null,{code:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenFailedError.code,message:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenFailedError.message+" "+e})})):(this.logger.error("zc.b.sss brower does not support getDisplayMedia"),t(!1,null,s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kBrowserNotSupportError))},e.prototype.startScreenShotFirFox=function(e,t,r){var i=this,o={video:{frameRate:t.frameRate,bitRate:t.bitRate,width:t.width,height:t.height},audio:t.audio};o.video.mediaSource=e,navigator.mediaDevices.getUserMedia(o).then((function(e){r(!0,e)})).catch((function(e){i.logger.error("ze.ssf.1 "+e),r(!1,null,{code:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenFailedError.code,message:s.ZegoRTCLogEvent.kZegoTaskCreateStream.error.kScreenFailedError.message+" "+e})}))},e.prototype.startPreview=function(e,t,r){var i=this,o=null;return o=new c.ZegoPreview(this.logger),this.streamCenter.previewStreamList.push(o),o.startPreview(e,(function(e){i.logger.debug("zsc.sp.0 call success"),!i.stateCenter.deviceInfos&&i.recordDevices(),t&&t(e)}),(function(e){i.streamCenter.previewStreamList=i.streamCenter.previewStreamList.filter((function(e){return e!==o})),r&&r(e)})),!0},e.prototype.stopPreview=function(e){if(!e)return this.logger.warn("zsc.sp.0 localStream null"),!1;for(var t in this.streamCenter.publisherList)this.streamCenter.publisherList[t].localStream===e&&(this.streamCenter.publisherList[t].localStream=null);var r=this.streamCenter.checkPreview(e);return r?(r.previewSuc&&(r.stopPreview(),this.streamCenter.removePreview(r)),!0):(this.logger.warn("zsc.sp.0 no preview"),!1)},e.prototype.recordDevices=function(){var e=this;this.logger.info("zsc.rd.0 call"),a.ClientUtil.getDevices((function(t){e.stateCenter.deviceInfos={microphones:t.microphones,speakers:t.speakers,cameras:t.cameras}}),(function(t){e.logger.warn("zsc.rd.0 getDevices err:",t)})),void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=null,navigator.mediaDevices.ondevicechange=function(t){e.logger.info("zsc.rd.0 devicechange"),e.stateCenter.deviceChangeTimer&&(clearTimeout(e.stateCenter.deviceChangeTimer),e.stateCenter.deviceChangeTimer=null),e.stateCenter.deviceChangeTimer=setTimeout((function(){a.ClientUtil.getDevices((function(t){for(var r=[],i=function(i){var o=e.stateCenter.deviceInfos.cameras[i];t.cameras.find((function(e){return e.deviceID===o.deviceID}))||r.push(o)},a=0;a<e.stateCenter.deviceInfos.cameras.length;a++)i(a);e.stateCenter.deviceStateOut=!1;var c=!1;r.length>0&&(c=!0),r.forEach((function(t){for(var r in e.streamCenter.publisherList){var i=e.streamCenter.publisherList[r],a=i.publisher;i.localStream&&i.cameraLabel===t.deviceName&&(c=!1,a.signal.sendStreamStatus(o.getSeq(),a.sessionId,-6,i.localStream.getAudioTracks()[0]&&1==i.localStream.getAudioTracks()[0].enabled?0:2,a.streamId),e.stateCenter.actionListener("deviceError",n.errorCodeList.DEVICE_ERROR_TYPE_UNPLUGGED.code,t.deviceName),e.stateCenter.actionListener("_deviceError",n.errorCodeList.DEVICE_ERROR_TYPE_UNPLUGGED.code,t.deviceName,"camera"));var d=o.getReportSeq();e.dataReport.newReport(d,s.ZegoRTCLogEvent.kZegoTaskDeviceInterrupt.event),e.dataReport.addMsgInfo(d,{interrupt:0}),e.dataReport.uploadReport(d),e.stateCenter.actionListener("videoDeviceStateChanged","DELETE",t),i.localStream&&0===i.localStream.getAudioTracks().length&&(c=!1)}})),c&&(e.stateCenter.deviceStateOut=!0);var d=e.stateCenter.deviceInfos.microphones.filter((function(e){return!t.microphones.find((function(t){return t.deviceID===e.deviceID}))}));d.forEach((function(t){for(var r in e.streamCenter.publisherList){var i=e.streamCenter.publisherList[r],a=i.publisher;i.localStream&&(i.microLabel===t.deviceName||i.microLabel.includes(t.deviceName))&&(a.signal.sendStreamStatus(o.getSeq(),a.sessionId,i.localStream.getVideoTracks()[0]&&1==i.localStream.getVideoTracks()[0].enabled?0:2,-6,a.streamId),e.stateCenter.actionListener("deviceError",n.errorCodeList.DEVICE_ERROR_TYPE_UNPLUGGED.code,e.streamCenter.publisherList[r].microLabel),e.stateCenter.actionListener("_deviceError",n.errorCodeList.DEVICE_ERROR_TYPE_UNPLUGGED.code,e.streamCenter.publisherList[r].microLabel,"micro"));var c=o.getReportSeq();e.dataReport.newReport(c,s.ZegoRTCLogEvent.kZegoTaskDeviceInterrupt.event),e.dataReport.addMsgInfo(c,{interrupt:0}),e.dataReport.uploadReport(c),e.stateCenter.actionListener("audioDeviceStateChanged","DELETE","Input",d)}}));var l=e.stateCenter.deviceInfos.speakers.filter((function(e){return!t.speakers.find((function(t){return t.deviceID===e.deviceID}))})),u=t.cameras.filter((function(t){return!e.stateCenter.deviceInfos.cameras.find((function(e){return e.deviceID===t.deviceID}))})),p=t.microphones.filter((function(t){return!e.stateCenter.deviceInfos.microphones.find((function(e){return e.deviceID===t.deviceID}))})),h=t.speakers.filter((function(t){return!e.stateCenter.deviceInfos.speakers.find((function(e){return e.deviceID===t.deviceID}))}));l.forEach((function(t){var r=o.getReportSeq();e.dataReport.newReport(r,s.ZegoRTCLogEvent.kZegoTaskAudioOutputChanged.event),e.dataReport.addMsgInfo(r,{reason:s.ZegoRTCLogEvent.kZegoTaskAudioOutputChanged.reason("delete"),device:s.ZegoRTCLogEvent.kZegoTaskAudioOutputChanged.device(t)}),e.dataReport.uploadReport(r),e.stateCenter.actionListener("audioDeviceStateChanged","DELETE","Output",t)})),u.forEach((function(t){var r=o.getReportSeq();e.dataReport.newReport(r,s.ZegoRTCLogEvent.kZegoTaskDeviceInterrupt.event),e.dataReport.addMsgInfo(r,{interrupt:1}),e.dataReport.uploadReport(r),e.stateCenter.actionListener("videoDeviceStateChanged","ADD",t)})),p.forEach((function(t){var r=o.getReportSeq();e.dataReport.newReport(r,s.ZegoRTCLogEvent.kZegoTaskDeviceInterrupt.event),e.dataReport.addMsgInfo(r,{interrupt:1}),e.dataReport.uploadReport(r),e.stateCenter.actionListener("audioDeviceStateChanged","ADD","Input",t)})),h.forEach((function(t){var r=o.getReportSeq();e.dataReport.newReport(r,s.ZegoRTCLogEvent.kZegoTaskAudioOutputChanged.event),e.dataReport.addMsgInfo(r,{reason:s.ZegoRTCLogEvent.kZegoTaskAudioOutputChanged.reason("add"),device:s.ZegoRTCLogEvent.kZegoTaskAudioOutputChanged.device(t)}),e.dataReport.uploadReport(r),e.stateCenter.actionListener("audioDeviceStateChanged","ADD","Output",t)})),e.stateCenter.deviceInfos={microphones:t.microphones,speakers:t.speakers,cameras:t.cameras}}),(function(t){e.logger.warn("zsc.rd.0 getDevices err:",t)}))}),500)})},e}();t.PublishModule=l},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.PlayModule=void 0;var o=r(3),s=r(0),a=r(1),n=r(2),c=function(){function e(e,t,r,i,o){this.logger=e,this.dataReport=t,this.stateCenter=r,this.streamCenter=i,this.rtm=o}return e.prototype.startPlayingStream=function(e,t){var r=this;return this.logger.info(o.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+" call ",e),new Promise((function(i,o){return r._handlePlayStream(e,t,i,o)}))},e.prototype._startPlayingStream=function(e,t,r){return this.logger.info(o.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+" call ",e),this._handlePlayStream(e,t,r)},e.prototype._handlePlayStream=function(e,t,r,c){var d=this,l=s.getReportSeq();this.stateCenter.reportSeqList.startPlay[e]=l,this.dataReport.newReport(l,a.ZegoRTCLogEvent.kZegoTaskPlayStart.event);var u=function(t,r){d.logger.error(o.ZEGO_WEBRTC_ACTION.START_PLAYING_STREAM+" "+(r||t.message)),d.dataReport.uploadReport(l,void 0,t,r),delete d.stateCenter.reportSeqList.startPlay[e],c&&c(i(i({},t),{errorCode:t.code,extendedData:t.message+(r?" "+r:"")}))};if(void 0===e||"string"!=typeof e||""===e)return u(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayParamError,"stream id type error"),!1;if(e.length>s.MAX_STREAM_ID_LENGTH)return u(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayStreamIDToLongError,"stream id length limit "+s.MAX_STREAM_ID_LENGTH),!1;if(!n.ClientUtil.checkIllegalCharacters(e))return u(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayStreamIDInvalidCharacterError),!1;if(void 0!==t&&"object"!=typeof t)return u(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayParamError,"playOption must be object"),!1;if(this.stateCenter.customUrl&&this.stateCenter.customUrl.length>0){if(!this.streamCenter.setPlayStateStart(e,t))return u(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayRepeatedPullError,"cannot start play"),!1;this.streamCenter.onPlayStateUpdate(s.ENUM_PLAY_STATE_UPDATE.retry,e,{code:0,message:""}),this.streamCenter.startPlayingStream(e,(function(e){r&&r(e)}))}if(this.dataReport.addMsgInfo(l,{stream:a.ZegoRTCLogEvent.kZegoTaskPlayStart.stream(e),playOption:a.ZegoRTCLogEvent.kZegoTaskPlayStart.playOption(t)}),this.rtm.modules.service.isDisConnect())return u(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayNoLoginError),!1;if(this.stateCenter.pullLimited||(e=NaN+e),t&&t.videoCodec&&(t.videoCodec=t.videoCodec.toUpperCase()),!this.streamCenter.setPlayStateStart(e,t))return u(a.ZegoRTCLogEvent.kZegoTaskPlayStart.error.kPlayRepeatedPullError,"cannot start play"),!1;this.streamCenter.onPlayStateUpdate(s.ENUM_PLAY_STATE_UPDATE.retry,e,{code:0,message:""}),this.streamCenter.playSuccessCallBackList[e]=function(e){r&&r(e)},c&&(this.streamCenter.playErrorCallBackList[e]=c);var p=this.streamCenter.playerList[e].retryDispatchHandler;return p.stopMaxTime(),p.invalid(),p.initStream(e,t,!1),p.startMaxTime(),p.active(0)},e.prototype.stopPlayingStream=function(e){this.logger.info(o.ZEGO_WEBRTC_ACTION.STOP_PLAYING_STREAM+" call",e);var t=s.getReportSeq();if(this.stateCenter.reportSeqList.stopPlay[e]=t,this.dataReport.newReport(t,a.ZegoRTCLogEvent.kZegoTaskPlayStop.event),this.dataReport.addMsgInfo(t,{stream:a.ZegoRTCLogEvent.kZegoTaskPlayStop.stream(e)}),"string"!=typeof e||""===e)return this.logger.error(o.ZEGO_WEBRTC_ACTION.STOP_PLAYING_STREAM+" streamid must be string and not empty"),this.dataReport.uploadReport(t,void 0,a.ZegoRTCLogEvent.kZegoTaskPlayStop.error.kParamError,"stream id type error"),void delete this.stateCenter.reportSeqList.stopPlay[e];var r=this.streamCenter.playerList[e],i=r&&r.player&&r.player.state!==s.ENUM_PLAY_STATE.stop;for(var n in this.streamCenter.stopPlayingStream(e),this.stateCenter.streamUrlMap)if(this.stateCenter.streamUrlMap[n]===e){delete this.stateCenter.streamUrlMap[n];break}this.dataReport.uploadReport(t),i&&this.streamCenter.onPlayStateUpdate(s.ENUM_PLAY_STATE_UPDATE.error,e,{code:0,message:""}),this.logger.debug(o.ZEGO_WEBRTC_ACTION.STOP_PLAYING_STREAM+" call success")},e.prototype.mutePlayStream=function(e,t,r){var i=this;return this.logger.info("zsc.mps.0 call "+t+" "+r),new Promise((function(o,n){if("string"!=typeof e||""==e)return i.logger.error("zsc.mps.0 streamID must be string and not empty"),void n(!1);if("boolean"!=typeof r)return i.logger.error("zsc.mps.0 mute must be boolean"),void n(!1);var c=i.streamCenter.playerList[e];if(!c)return i.logger.error("zsc.mps.0 player not found"),void n(!1);if("video"===t){if(c.playOption&&!1===c.playOption.video||c.player&&0!==c.player.cameraStatus)return i.logger.error("zsc.mps.0 stream no contain video"),void n(!1);c.player.signal.ActivatePlayVideoStream(s.getSeq(),c.player.sessionId,r,(function(){i.logger.info("zsc.mps.0 suc");var e=s.getReportSeq();i.dataReport.newReport(e,a.ZegoRTCLogEvent.kZegoPlayContentChanged.event),i.dataReport.addMsgInfo(e,{session_id:a.ZegoRTCLogEvent.kZegoPlayContentChanged.session_id(c.player.sessionId),video_activate:a.ZegoRTCLogEvent.kZegoPlayContentChanged.video_activate(r?0:1),audio_activate:a.ZegoRTCLogEvent.kZegoPlayContentChanged.audio_activate(1==c.player.playOption.audio?1:0==c.player.playOption.audio?0:1)}),i.dataReport.uploadReport(e),o(!0)}),(function(){i.logger.error("zsc.mps.0 fail"),n(!1)}))}else{if(c.playOption&&!1===c.playOption.audio||c.player&&0!==c.player.micStatus)return i.logger.error("zsc.mps.0 stream no contain audio"),void n(!1);c.player.signal.ActivatePlayAudioStream(s.getSeq(),c.player.sessionId,r,(function(){i.logger.info("zsc.mps.0 suc");var e=s.getReportSeq();i.dataReport.newReport(e,a.ZegoRTCLogEvent.kZegoPlayContentChanged.event),i.dataReport.addMsgInfo(e,{session_id:a.ZegoRTCLogEvent.kZegoPlayContentChanged.session_id(c.player.sessionId),video_activate:a.ZegoRTCLogEvent.kZegoPlayContentChanged.video_activate(1==c.player.playOption.video?1:0==c.player.playOption.video?0:1),audio_activate:a.ZegoRTCLogEvent.kZegoPlayContentChanged.audio_activate(r?0:1)}),i.dataReport.uploadReport(e),o(!0)}),(function(){i.logger.error("zsc.mps.0 fail"),n(!1)}))}}))},e.prototype.setStreamAudioOutput=function(e,t){var r=this;return!(null==t||0==t.length||!e)&&(this.logger.debug("zsc.ssao.0 device "+t),e?"undefined"!==e.sinkId?(e.setSinkId(t).then((function(){r.logger.info("zsc.ssao.0 success device: "+t)})).catch((function(e){r.logger.info("zsc.ssao.0 "+e.name)})),!0):(this.logger.error("zsc.ssao.0 browser does not suppport"),!1):(this.logger.error("zsc.ssao.0 no localVideo"),!1))},e}();t.PlayModule=c},function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioMixModule=void 0;var a=r(3),n=r(0),c=r(1),d=s(r(8)),l=function(){function e(e,t,r,i,o){this.logger=e,this.dataReport=t,this.stateCenter=r,this.streamCenter=i,this.ac=o,this.buffer=null,this.blank=null,"safari"==d.browserDetails.browser&&null==this.blank&&null==this.buffer&&(this.ac.resume(),this.buffer=this.ac.createBuffer(1,1,this.ac.sampleRate),this.blank=this.ac.createBufferSource(),this.blank.buffer=this.buffer,this.blank.connect(this.ac.destination),this.blank.start())}return e.prototype.preloadEffect=function(e,t,r){e&&"string"==typeof e&&t&&"string"==typeof t?this.stateCenter.audioEffectBuffer[e]?this.logger.error(a.ZEGO_WEBRTC_ACTION.PRELOAD_EFFECT+" audio buffer already exists"):(this.logger.info(a.ZEGO_WEBRTC_ACTION.PRELOAD_EFFECT+" start preload effect"),this._preloadEffect(this.ac,e,t,r)):this.logger.error(a.ZEGO_WEBRTC_ACTION.PRELOAD_EFFECT+" params error")},e.prototype.playEffect=function(e,t,r){e.streamID&&"string"==typeof e.streamID&&e.effectID&&"string"==typeof e.effectID?this.stateCenter.audioEffectBuffer[e.effectID]?this._playEffect(e,t,r):this.logger.error(a.ZEGO_WEBRTC_ACTION.PLAY_EFFECT+" audio buffer doesn't exists"):this.logger.error(a.ZEGO_WEBRTC_ACTION.PLAY_EFFECT+" params error")},e.prototype.pauseEffect=function(e,t){return e&&"string"==typeof e?(t&&"string"!=typeof t&&this.logger.error(a.ZEGO_WEBRTC_ACTION.PAUSE_EFFECT+" effect "),this._pauseEffect(e,t)):(this.logger.error(a.ZEGO_WEBRTC_ACTION.PAUSE_EFFECT+" streamID format error"),!1)},e.prototype.resumeEffect=function(e,t){return e&&"string"==typeof e?(t&&"string"!=typeof t&&this.logger.error(a.ZEGO_WEBRTC_ACTION.RESUME_EFFECT+" effect "),this._resumeEffect(e,t)):(this.logger.error(a.ZEGO_WEBRTC_ACTION.RESUME_EFFECT+" streamID format error"),!1)},e.prototype.stopEffect=function(e,t){return e&&"string"==typeof e?(t&&"string"!=typeof t&&this.logger.error(a.ZEGO_WEBRTC_ACTION.STOP_EFFECT+" effect "),this._stopEffect(e,t)):(this.logger.error(a.ZEGO_WEBRTC_ACTION.STOP_EFFECT+" streamID format error"),!1)},e.prototype.unloadEffect=function(e){return e&&"string"==typeof e?(delete this.stateCenter.audioEffectBuffer[e],!0):(this.logger.error(a.ZEGO_WEBRTC_ACTION.UNLOAD_EFFECT+" params error"),!1)},e.prototype.setEffectVolume=function(e,t,r){if(!e||"string"!=typeof e)return this.logger.error(a.ZEGO_WEBRTC_ACTION.SET_EFFECT_VOLUME+" streamID format error"),!1;r&&"string"!=typeof r&&this.logger.error(a.ZEGO_WEBRTC_ACTION.SET_EFFECT_VOLUME+" effect ");var i=this.streamCenter.getPublisher(e);return i?i.setEffectVolume(t/100,r):(this.logger.error(a.ZEGO_WEBRTC_ACTION.SET_EFFECT_VOLUME+" publisher doesn't exist"),!1)},e.prototype.startMixingAudio=function(e,t){return this.logger.info(a.ZEGO_WEBRTC_ACTION.START_MIXING_AUDIO+" call "+e),e&&"string"==typeof e?t?(this.logger.info(a.ZEGO_WEBRTC_ACTION.START_MIXING_AUDIO+" end "+e),Array.isArray(t)&&0!==t.length?this._startMixingAudio(e,t):(this.logger.error(a.ZEGO_WEBRTC_ACTION.START_MIXING_AUDIO+" audio param type error"),!1)):(this.logger.error(a.ZEGO_WEBRTC_ACTION.START_MIXING_AUDIO+" no audio"),!1):(this.logger.error(a.ZEGO_WEBRTC_ACTION.START_MIXING_AUDIO+" stream id type error"),!1)},e.prototype.stopMixingAudio=function(e,t){return e&&"string"==typeof e?Array.isArray(t)&&0!==t.length||void 0===t?this._stopMixingAudio(e,t):(this.logger.error(a.ZEGO_WEBRTC_ACTION.STOP_MIXING_AUDIO+" audio param type error"),!1):(this.logger.error(a.ZEGO_WEBRTC_ACTION.STOP_MIXING_AUDIO+" param streamID format error"),!1)},e.prototype.mixingBuffer=function(e,t,r,i){this.logger.info(a.ZEGO_WEBRTC_ACTION.MIXING_BUFFER+" call streamID: "+e+" sourceID:"+t),e&&"string"==typeof e?t&&"string"==typeof t?(this._mixingBuffer(e,t,r,i),this.logger.info(a.ZEGO_WEBRTC_ACTION.MIXING_BUFFER+" end")):this.logger.error(a.ZEGO_WEBRTC_ACTION.MIXING_BUFFER+" param source id format error"):this.logger.error(a.ZEGO_WEBRTC_ACTION.MIXING_BUFFER+" param streamid format error")},e.prototype.stopMixingBuffer=function(e,t){return this.logger.info(a.ZEGO_WEBRTC_ACTION.STOP_MIXING_BUFFER+" call streamID: "+e+" sourceID:"+t),e&&"string"==typeof e?t&&"string"==typeof t?this._stopMixingBuffer(e,t):(this.logger.error(a.ZEGO_WEBRTC_ACTION.STOP_MIXING_BUFFER+" param source id format error"),!1):(this.logger.error(a.ZEGO_WEBRTC_ACTION.STOP_MIXING_BUFFER+" param streamid format error"),!1)},e.prototype.setMixingAudioVolume=function(e,t,r){return this.logger.info(a.ZEGO_WEBRTC_ACTION.SET_MIXING_AUDIO_VOLUME+" call"),"string"!=typeof e||""==e?(this.logger.error(a.ZEGO_WEBRTC_ACTION.SET_MIXING_AUDIO_VOLUME+" stream ID must be string and not empty"),!1):"number"!=typeof t||t<0||t>100?(this.logger.error(a.ZEGO_WEBRTC_ACTION.SET_MIXING_AUDIO_VOLUME+" volume must be a number between 0 and 100"),!1):r&&r instanceof HTMLMediaElement?this._setMixingAudioVolume(e,t,r):(this.logger.error(a.ZEGO_WEBRTC_ACTION.SET_MIXING_AUDIO_VOLUME+" no audio"),!1)},e.prototype.getSoundLevel=function(e,t,r){this.logger.info("zc.gsl call");var i=n.getReportSeq();this.dataReport.newReport(i,c.ZegoRTCLogEvent.kZegoTaskGetSoundLevel.event);try{this.ac.resume();var o=this.ac.createMediaStreamSource(e),s=this.ac.createScriptProcessor(4096,1,1);this.stateCenter.audioStreamList[e.id]={mic:o,script:s},o.connect(s),s.connect(this.ac.destination),s.onaudioprocess=function(e){for(var r=e.inputBuffer.getChannelData(0),i=0,o=0;o<r.length;o++)i<r[o]&&(i=r[o]);t(i)},this.dataReport.uploadReport(i)}catch(e){r(e),this.dataReport.addMsgInfo(i,c.ZegoRTCLogEvent.kZegoTaskGetSoundLevel.error.kGetSoundLevelError),this.dataReport.uploadReport(i)}this.logger.info("zc.gsl call success")},e.prototype._preloadEffect=function(e,t,r,i){var o=this,s=new XMLHttpRequest;s.open("GET",r,!0),s.responseType="arraybuffer",s.onload=function(){if(200==s.status||304==s.status){var r=s.response;e.decodeAudioData(r,(function(e){o.logger.info("zc.pe.0 effect preload success"),o.stateCenter.audioEffectBuffer[t]=e,i&&i()}),(function(e){o.logger.error("zc.pe.0 effect preload fail "+e),i&&i(e)}))}else{var a=s.statusText;o.logger.error("zc.pe.0 effect preload fail "+a),i&&i(a)}},s.send()},e.prototype._playEffect=function(e,t,r){var i=this.stateCenter.audioEffectBuffer[e.effectID],o=this.streamCenter.getPublisher(e.streamID);o?i?o.playEffect(e,i,t,r):this.logger.error("zc.pe.1 no audio buffer found"):this.logger.error("zc.pe.1 publisher doesn't exist")},e.prototype._pauseEffect=function(e,t){var r=this.streamCenter.getPublisher(e);return r?r.pauseEffect(t):(this.logger.error("zc.pe.2 publisher doesn't exist"),!1)},e.prototype._resumeEffect=function(e,t){var r=this.streamCenter.getPublisher(e);return r?r.resumeEffect(t):(this.logger.error("zc.re.0 publisher doesn't exist"),!1)},e.prototype._stopEffect=function(e,t){var r=this.streamCenter.getPublisher(e);return r?r.stopEffect(t):(this.logger.error("zc.re.0 publisher doesn't exist"),!1)},e.prototype._setMixingAudioVolume=function(e,t,r){var i=this.streamCenter.getPublisher(e);return i?i.setMixingAudioVolume(t/100,r):(this.logger.error("zc.sma.2 publisher doesn't exist"),!1)},e.prototype._startMixingAudio=function(e,t){var r=this.streamCenter.getPublisher(e);return r?r.startMixingAudio(t):(this.logger.error("zc.sma.0 publisher doesn't exist"),!1)},e.prototype._stopMixingAudio=function(e,t){var r=this.streamCenter.getPublisher(e);return r?r.stopMixingAudio(t):(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},e.prototype._mixingBuffer=function(e,t,r,i){var o=this.streamCenter.getPublisher(e);o?r instanceof ArrayBuffer?o.mixingBuffer(t,r,i):this.logger.error("zc.mb.0 array buffer not found"):this.logger.error("zc.mb.0 publisher doesn't exist")},e.prototype._stopMixingBuffer=function(e,t){var r=this.streamCenter.getPublisher(e);return r?r.stopMixingBuffer(t):(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},e}();t.AudioMixModule=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdvancedModule=void 0;var i=r(3),o=r(0),s=r(1),a=r(2),n=r(4),c=function(){function e(e,t,r){this.logger=e,this.dataReport=t,this.streamCenter=r,this.screenShotReady=!1}return e.prototype.setVideoConfig=function(e,t){var r=this;return this.logger.info(i.ZEGO_WEBRTC_ACTION.SET_VIDEO_CONFIG+" call"),new Promise((function(n,c){var d=o.getReportSeq();if(r.dataReport.newReport(d,s.ZegoRTCLogEvent.kZegoSetVideoConfig.event),!(e instanceof MediaStream))return r.logger.error(i.ZEGO_WEBRTC_ACTION.SET_VIDEO_CONFIG+" localStream not found"),r.dataReport.addMsgInfo(d,s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kLocalStreamError),r.dataReport.uploadReport(d),void c({errorCode:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.message+" localStream no found"});if(!t||"object"!=typeof t||0==Object.keys(t).length)return r.logger.error(i.ZEGO_WEBRTC_ACTION.SET_VIDEO_CONFIG+" constraints wrong"),r.dataReport.addMsgInfo(d,s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError),r.dataReport.uploadReport(d),void c({errorCode:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.message+" constraints wrong"});if(t.width&&!a.ClientUtil.checkValidNumber(t.width))return r.logger.error(i.ZEGO_WEBRTC_ACTION.SET_VIDEO_CONFIG+" constraints width integer number, range[1, 10000]"),r.dataReport.addMsgInfo(d,{error:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.code,message:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.message+" constraints width integer number, range[1, 10000]"}),r.dataReport.uploadReport(d),void c({errorCode:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.message+" constraints wrong"});if(t.height&&!a.ClientUtil.checkValidNumber(t.height))return r.logger.error(i.ZEGO_WEBRTC_ACTION.SET_VIDEO_CONFIG+" constraints height integer number, range[1, 10000]"),r.dataReport.addMsgInfo(d,{error:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.code,message:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.message+" constraints height integer number, range[1, 10000]"}),r.dataReport.uploadReport(d),void c({errorCode:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoSetVideoConfig.error.kParamError.message+" constraints wrong"});r.setPublishStreamConstraints(e,t,(function(e){r.dataReport.uploadReport(d),n(e)}))}))},e.prototype.setAudioConfig=function(e,t){var r=this;return this.logger.info(i.ZEGO_WEBRTC_ACTION.SET_AUDIO_CONFIG+" call"),new Promise((function(a){var n=o.getReportSeq();if(r.dataReport.newReport(n,s.ZegoRTCLogEvent.kZegoSetAudioConfig.event),!(e instanceof MediaStream))return r.logger.error(i.ZEGO_WEBRTC_ACTION.SET_AUDIO_CONFIG+" localStream not found"),r.dataReport.addMsgInfo(n,s.ZegoRTCLogEvent.kZegoSetAudioConfig.error.kParamError),r.dataReport.uploadReport(n),void a({errorCode:s.ZegoRTCLogEvent.kZegoSetAudioConfig.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoSetAudioConfig.error.kParamError.message+" localStream no found"});if(!t||"object"!=typeof t||0==Object.keys(t).length||void 0!==t.AEC&&"boolean"!=typeof t.AEC||void 0!==t.AGC&&"boolean"!=typeof t.AGC||void 0!==t.ANS&&"boolean"!=typeof t.ANS)return r.logger.error(i.ZEGO_WEBRTC_ACTION.SET_AUDIO_CONFIG+" constraints wrong"),r.dataReport.addMsgInfo(n,s.ZegoRTCLogEvent.kZegoSetAudioConfig.error.kParamError),r.dataReport.uploadReport(n),void a({errorCode:s.ZegoRTCLogEvent.kZegoSetAudioConfig.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoSetAudioConfig.error.kParamError.message+" constraints wrong"});r.setPublishStreamConstraints(e,t,(function(e){r.dataReport.uploadReport(n),a(e)}))}))},e.prototype.enableStream=function(e,t){if(this.logger.info(i.ZEGO_WEBRTC_ACTION.ENABLE_STREAM+" call"),"boolean"!=typeof t.video&&"boolean"!=typeof t.audio)return this.logger.error(i.ZEGO_WEBRTC_ACTION.ENABLE_STREAM+" option error"),!1;var r=!0,o=!0;return"boolean"==typeof t.video&&(r=this.enableCamera(e,t.video)),"boolean"==typeof t.audio&&(o=this.enableMicrophone(e,t.audio)),r&&o},e.prototype.replaceTrack=function(e,t){var r=this;return new Promise((function(a){var n=o.getReportSeq();if(r.dataReport.newReport(n,s.ZegoRTCLogEvent.kZegoReplaceTrack.event),!(e instanceof MediaStream))return r.logger.error(i.ZEGO_WEBRTC_ACTION.REPLACE_TRACK+" localStream not found"),r.dataReport.uploadReport(n,void 0,s.ZegoRTCLogEvent.kZegoReplaceTrack.error.kParamError),void a({errorCode:s.ZegoRTCLogEvent.kZegoReplaceTrack.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoReplaceTrack.error.kParamError.message+" localStream no found"});if(!(t&&t instanceof MediaStreamTrack))return r.logger.error(i.ZEGO_WEBRTC_ACTION.REPLACE_TRACK+" mediastream track no found"),r.dataReport.uploadReport(n,void 0,s.ZegoRTCLogEvent.kZegoReplaceTrack.error.kParamError),void a({errorCode:s.ZegoRTCLogEvent.kZegoReplaceTrack.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoReplaceTrack.error.kParamError.message+" mediastream track no found"});r._replaceTrack(e,t,(function(e){r.dataReport.uploadReport(n),a(e)}))}))},e.prototype.setPublishStreamConstraints=function(e,t,r){var i=this,a=(/Safari/.test(navigator.userAgent)&&/Chrome/.test(navigator.userAgent),null);for(var c in this.logger.info("zsc.spsc.0 constraints",JSON.stringify(t)),this.streamCenter.publisherList)this.streamCenter.publisherList[c].localStream==e&&(a=this.streamCenter.publisherList[c]);if(!a)return this.logger.error("zsc.spsc.0 publisher not found"),void(r&&r({errorCode:n.errorCodeList.PUBLISH_NOT_PUBLISH.code,extendedData:n.errorCodeList.PUBLISH_NOT_PUBLISH.message}));this.logger.info("zsc.spsc.0 streamId ",a.streamID);var d=this.streamCenter.checkPreview(e);if(!d)return this.logger.error("zsc.spsc.0 preview no found"),void(r&&r({errorCode:n.errorCodeList.PUBLISH_NO_PREVIEW.code,extendedData:n.errorCodeList.PUBLISH_NO_PREVIEW.message}));var l=!1,u=!1;(t.width||t.height||t.frameRate)&&(d.mediaStreamConfig.videoQuality=4,l=!0),void 0===t.ANS&&void 0===t.AGC&&void 0===t.AEC||(u=!0);var p=d.localStream,h=p.getVideoTracks()[0],g=p.getAudioTracks()[0];l&&!h?(this.logger.error("zsc.spsc.0 video track not found"),r&&r({errorCode:n.errorCodeList.TRACK_NOT_FOUND.code,extendedData:n.errorCodeList.TRACK_NOT_FOUND.message})):t.video=!0,u&&!g?(this.logger.error("zsc.spsc.0 audio track not found"),r&&r({errorCode:n.errorCodeList.TRACK_NOT_FOUND.code,extendedData:n.errorCodeList.TRACK_NOT_FOUND.message})):t.audio=!0;var m=JSON.parse(JSON.stringify(d.mediaStreamConfig)),E=Object.assign(d.mediaStreamConfig,t),f=d.getMediaStreamConstraints(E,!0);this.logger.info("zsc.spsc.0 applyConstraints ",JSON.stringify(f));var _=[];if(l&&_.push(h.applyConstraints(f.video)),u&&(g.stop(),_.push(navigator.mediaDevices.getUserMedia({video:!1,audio:f.audio}))),t.maxBitrate){var S=a.publisher.peerConnection.getSenders().find((function(e){return e.track&&"video"===e.track.kind})),T=S.getParameters();S?(T.encodings||(T.encodings=[{}]),T.encodings[0].maxBitrate=1e3*t.maxBitrate,_.push(S.setParameters(T))):this.logger.error("zsc.spsc.0 video sender no found")}if(_.length>0)Promise.all(_).then((function(e){if(i.logger.info("zsc.spsc.0 set constraints success",e[1]),u){var n=(l?e[1]:e[0]).getAudioTracks()[0],c=a.publisher.peerConnection.getSenders().find((function(e){return"audio"===e.track.kind}));if(c&&(c.replaceTrack(n),p)){var d=p.getAudioTracks()[0];p.removeTrack(d),p.addTrack(n);var g=i.streamCenter.checkPreview(p);g&&(g.gainNode=null)}}if(l&&(t.width||t.height)){var m=o.getReportSeq();i.dataReport.newReport(m,s.ZegoRTCLogEvent.kZegoTaskVideoCaptureSize.event),i.dataReport.addMsgInfo(m,{session_id:s.ZegoRTCLogEvent.kZegoTaskVideoCaptureSize.session_id(a.publisher.sessionId),w:s.ZegoRTCLogEvent.kZegoTaskVideoCaptureSize.w(h.getSettings().width),h:s.ZegoRTCLogEvent.kZegoTaskVideoCaptureSize.h(h.getSettings().height)}),i.dataReport.uploadReport(m)}t.maxBitrate&&a.publisher&&(a.publisher.videoInfo.bitRate=t.maxBitrate),r&&r({errorCode:0,extendedData:""})})).catch((function(e){i.logger.error("zsc.spsc.0 fail reason ",e.name,JSON.stringify(e)),r&&r({errorCode:n.errorCodeList.PUBLISHER_CONSTRAINTS_ERROR.code,extendedData:e.name+" "+(e.constraint?"constraint:"+e.constraint:"")})}));else{if(this.logger.warn("zsc.spsc.0 constaints is no changes"),u){var C=d.getMediaStreamConstraints(m);this.logger.info("zsc.spsc.0 oldMediaStreamConstraints ",JSON.stringify(C)),navigator.mediaDevices.getUserMedia({video:!1,audio:C.audio}).then((function(e){e.getTracks().forEach((function(e){var t=p.getTracks().find((function(t){return t.kind===e.kind})),r=a.publisher.peerConnection.getSenders().find((function(t){return null!==t.track&&t.track.kind===e.kind}));r&&(r.replaceTrack(e),t&&p.removeTrack(t),p.addTrack(e))})),i.logger.info("zsc.spsc.0.1 setbackup suc ")})).catch((function(e){i.logger.error("zsc.spsc.0.1 setbackup fail "+e.name)}))}r&&r({errorCode:n.errorCodeList.PUBLISHER_CONSTRAINTS_ERROR.code,extendedData:"constraints is no changes"})}},e.prototype.useVideoDevice=function(e,t){var r=this;return this.logger.info("zc.uvd.0 call"),new Promise((function(i){var n=o.getReportSeq();if(r.dataReport.newReport(n,s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.event),r.dataReport.addMsgInfo(n,{device:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.device(t)}),!(e instanceof MediaStream))return r.logger.error("zc.uvd.0 localStream not found"),r.dataReport.addMsgInfo(n,s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kLocalStreamError),r.dataReport.uploadReport(n),void i({errorCode:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kParamError.message});if("string"!=typeof t)return r.logger.error("zc.uvd.0 deviceID must be string"),r.dataReport.addMsgInfo(n,{error:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kParamError.code,message:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kParamError.message+" deviceID must be string"}),r.dataReport.uploadReport(n),void i({errorCode:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kParamError.code,extendedData:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kParamError.message});var c=function(e){r.dataReport.uploadReport(n),i(e)};a.ClientUtil.getDevices((function(o){if(!o.cameras.find((function(e){return e.deviceID==t})))return r.logger.error("zc.uvd.0 device is not found"),void i({errorCode:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kDevicesNoFoundError.code,extendedData:s.ZegoRTCLogEvent.kZegoTaskUseVideoDevice.error.kDevicesNoFoundError.message});r.switchDevice("video",e,t,c)}),(function(i){r.logger.warn("zc.uvd.0 getDevices err:",i),r.switchDevice("video",e,t,c)}))}))},e.prototype.useAudioDevice=function(e,t){var r=this;return this.logger.info("zc.uad.1 call"),new Promise((function(i){var n=o.getReportSeq();r.dataReport.newReport(n,s.ZegoRTCLogEvent.kZegoTaskUseAudioDevice.event),r.dataReport.addMsgInfo(n,{device:s.ZegoRTCLogEvent.kZegoTaskUseAudioDevice.device(t)});var c=function(e,t){r.logger.error("zc.uad.1 "+t);var o=e;o.message=o.message+(t?" "+t:""),r.dataReport.addMsgInfo(n,o),r.dataReport.uploadReport(n),i({errorCode:o.code,extendedData:o.message})},d=function(e){r.dataReport.uploadReport(n),i(e)};e instanceof MediaStream?"string"==typeof t?a.ClientUtil.getDevices((function(o){if(!o.microphones.find((function(e){return e.deviceID==t})))return r.logger.error("zc.uad.1 device is not found"),void i({errorCode:s.ZegoRTCLogEvent.kZegoTaskUseAudioDevice.error.kDevicesNoFoundError.code,extendedData:s.ZegoRTCLogEvent.kZegoTaskUseAudioDevice.error.kDevicesNoFoundError.message});r.switchDevice("audio",e,t,d)}),(function(i){r.logger.warn("zc.uad.1 getDevices err:",i),r.switchDevice("audio",e,t,d)})):c(s.ZegoRTCLogEvent.kZegoTaskUseAudioDevice.error.kParamError,"deviceID must be string"):c(s.ZegoRTCLogEvent.kZegoTaskUseAudioDevice.error.kLocalStreamError,"localStream not found")}))},e.prototype.switchDevice=function(e,t,r,i){var o=this,s=this.streamCenter.checkPreview(t);if(!s)return this.logger.error("zsc.sd.0 preview no found"),void(i&&i({errorCode:n.errorCodeList.PUBLISH_NO_PREVIEW.code,extendedData:n.errorCodeList.PUBLISH_NO_PREVIEW.message}));var c=null;for(var d in this.streamCenter.publisherList)this.streamCenter.publisherList[d].localStream==t&&(c=this.streamCenter.publisherList[d]);if("video"===e&&0==s.mediaStreamConfig.video)return this.logger.error("zsc.sd.0 camera can not be changed when video is false"),void(i&&i({errorCode:n.errorCodeList.VIDEO_DEVICE_FALSE.code,extendedData:n.errorCodeList.VIDEO_DEVICE_FALSE.message}));if("audio"===e&&0==s.mediaStreamConfig.audio)return this.logger.error("zsc.sd.0 microphone can not be changed when audio is false"),void(i&&i({errorCode:n.errorCodeList.AUDIO_DEVICE_FALSE.code,extendedData:n.errorCodeList.AUDIO_DEVICE_FALSE.message}));s.mediaStreamConfig.videoInput!==r&&delete s.mediaStreamConfig.facingMode;var l,u={};"video"===e?(u.videoInput=r,l=t.getVideoTracks()[0]):(u.audioInput=r,l=t.getAudioTracks()[0]);var p=t.clone(),h=a.ClientUtil.getBrowser();this.logger.info("zsc.sd.0 browser "+h),"Firefox"===h&&l.stop();var g=Object.assign(s.mediaStreamConfig,u),m=s.getMediaStreamConstraints(g);navigator.mediaDevices.getUserMedia(m).then((function(r){r.getTracks().forEach((function(e){var r=t.getTracks().find((function(t){return t.kind===e.kind}));if(r&&(e.enabled=r.enabled,t.removeTrack(r),r.stop()),c){var i=c.publisher.peerConnection.getSenders().find((function(t){return null!==t.track&&t.track.kind===e.kind}));i?(i.replaceTrack(e),s.gainNode=null):o.logger.warn("zsc.sd.0 no sender found, only swithcing device on localMediaElement")}t.addTrack(e)})),p.getTracks().forEach((function(e){return e.stop()})),o.logger.info("zsc.sd.0 swtich "+e+" device success"),i&&i({errorCode:0,extendedData:""})}),(function(r){o.logger.error("zsc.sd.0 swtich "+e+"device fail ",r.name,JSON.stringify(r)),"Firefox"===h&&p.getTracks().forEach((function(e){var r=t.getTracks().find((function(t){return t.kind===e.kind}));c&&c.publisher.peerConnection.getSenders().find((function(t){return null!==t.track&&t.track.kind===e.kind})).replaceTrack(e);r&&t.removeTrack(r),t.addTrack(e)})),i&&i({errorCode:n.errorCodeList.AUDIO_DEVICE_FALSE.code,extendedData:n.errorCodeList.AUDIO_DEVICE_FALSE.message+JSON.stringify(r)})}))},e.prototype._replaceTrack=function(e,t,r){var i=this.streamCenter.checkPreview(e),s=this.streamCenter.checkPublish(e);/Safari/.test(navigator.userAgent)&&/Chrome/.test(navigator.userAgent);if(s){var a=s.publisher.localStream;if(!s.publisher.peerConnection.getSenders||!s.publisher.peerConnection.getSenders()[0].replaceTrack)return this.logger.error("zc.rt.0 replack track is not supported"),void(r&&r({errorCode:n.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT.code,extendedData:n.errorCodeList.PUBLISHER_BROWSER_NOT_SUPPORT.message+" replack track is not supported"}));p=a.getTracks().find((function(e){return e.kind===t.kind}));var c=s.publisher.peerConnection.getSenders().find((function(e){return e.track.kind===t.kind}));if(p&&c){var d=0,l=0,u=t.enabled!==p.enabled;"video"===t.kind?(d=!0===t.enabled?0:2,l=a.getAudioTracks()[0]&&1==a.getAudioTracks()[0].enabled?0:2):"audio"===t.kind&&(l=!0===t.enabled?0:2,d=a.getVideoTracks()[0]&&1==a.getVideoTracks()[0].enabled?0:2),c.replaceTrack(t),a.removeTrack(p),a.addTrack(t),u&&s.publisher.signal&&s.publisher.signal.sendStreamStatus(o.getSeq(),s.publisher.sessionId,d,l,s.publisher.streamId),r&&r({errorCode:0,extendedData:""})}else this.logger.error("zc.rt.0 publisher track no found"),r&&r({errorCode:n.errorCodeList.TRACK_NOT_FOUND.code,extendedData:n.errorCodeList.TRACK_NOT_FOUND.message})}else{if(!i)return this.logger.error("zc.rt.0 preview no found"),void(r&&r({errorCode:n.errorCodeList.PUBLISH_NO_PREVIEW.code,extendedData:n.errorCodeList.PUBLISH_NO_PREVIEW.message}));var p,h=i.localStream;(p=h.getTracks().find((function(e){return e.kind===t.kind})))?(h.removeTrack(p),h.addTrack(t),r&&r({errorCode:0,extendedData:""})):(this.logger.error("zc.rt.0 track no found"),r&&r({errorCode:n.errorCodeList.TRACK_NOT_FOUND.code,extendedData:n.errorCodeList.TRACK_NOT_FOUND.message}))}},e.prototype.enableMicrophone=function(e,t){var r=this.streamCenter.checkPreview(e);return r?r.enableMicrophone(t,this.streamCenter):(this.logger.error("zsc.em.0 no preview"),!1)},e.prototype.enableCamera=function(e,t){var r=this.streamCenter.checkPreview(e);return r?r.enableCamera(t,this.streamCenter):(this.logger.error("zsc.ec.0 no preview"),!1)},e}();t.AdvancedModule=c}])}));